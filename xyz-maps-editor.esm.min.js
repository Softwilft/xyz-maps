/*
 * @here/xyz-maps-editor
 * (c) 2019-2022 HERE
 */
import{vec3 as e,geotools as t,geometry as r,JSUtils as i,global as n,Listener as o,Map as s,Set as a}from"@here/xyz-maps-common";import{Feature as d,webMercator as u,LocalProvider as p,TileLayer as l,EditableFeatureProvider as c,GeoPoint as h,PixelPoint as f}from"@here/xyz-maps-core";import{styleTools as v}from"@here/xyz-maps-display";
/******************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var g=function(e,t){return g=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},g(e,t)};function y(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}g(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var A=function(){return A=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},A.apply(this,arguments)};function m(e,t,r){if(r||2===arguments.length)for(var i,n=0,o=t.length;n<o;n++)!i&&n in t||(i||(i=Array.prototype.slice.call(t,0,n)),i[n]=t[n]);return e.concat(i||Array.prototype.slice.call(t))}var _=function(e,t,r){e.editState("modified",Date.now());var i=e._e(),n=i.objects.history;if(t.isGeoMod&&!t.isMarking){t.isMarking=!0;var o=n.getHistoryFeature(e).geometry.coordinates;i.hooks.trigger("Coordinates.update",{feature:e,previousCoordinates:o},e.getProvider()),t.isGeoMod=!1,t.isMarking=!1}return(null==r||r)&&n.saveChanges(),e};function S(e,t,r){e._e().listeners.trigger(t,e,r)}function L(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,isGeoMod:!1}),t?r[t]:r}function b(e){this.editState("hovered","pointerenter"==e.type),this._e().listeners.trigger(e,this)}var k,C={private:L,_evl:{pointerdown:function(e){var t=L(this);t.moved=!1;var r=this.geometry.coordinates,i=e.detail.display.geoToPixel(r[0],r[1]);t.x=i.x,t.y=i.y,t.button=e.button,t.z=r[2]||0,S(this,e,"pointerdown")},pointerup:function(e){var t=L(this),r=t.moved;!t.isSelected&&this._e()._config.featureSelectionByDefault?C._select(this):r&&C.markAsModified(this),S(this,e,r?"dragStop":"pointerup")},pointerenter:b,pointerleave:b},deHighlight:function(e){var t=L(e);t.selector&&(e.editState("selected",!1),e._e().objects.overlay.remove(t.selector),t.selector=null,t.pointerdown=undefined,t.pressmove=undefined)},_editable:function(e,t){var r=L(e);return null!=t&&(r.isEditable=!!t),C.deHighlight(e),r.isEditable},_select:function(e){var t=e._e();if(t.objects.selection.select(e)){var r=L(e),i=t.getStyleProperty(e,"altitude");if(e.editState("selected",!0),r.pressmove=function(n,o,s){if(r.isEditable&&r.isSelected&&!t._config.editRestrictions(e,1)){var a=m([],e.geometry.coordinates,!0);"number"==typeof i&&(a[2]=i),a=vt(n.mapX,n.mapY,e,a,t),C._setCoords(e,a),S(e,n,r.moved?"dragMove":"dragStart"),r.moved=!0}},!r.selector){var n=t.getZLayer(e);r.selector=t.objects.overlay.addCircle(e.coord(),undefined,{type:"MARKER_SELECTOR",parentType:"MARKER",MARKER:{properties:e.prop(),altitude:i,zLayer:n}})}}},_setCoords:function(e,t){e._e().objects.history.origin(e);var r=L(e,"selector");r&&r._provider.setFeatureCoordinates(r,t),e.getProvider().setFeatureCoordinates(e,t.slice()),L(e).isGeoMod=!0},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),C.deHighlight(e)},markAsModified:function(e,t){return _(e,L(e),t)}},E=Math,x=E.PI,P=E.pow,I=E.sqrt,R=function(e,r,i,n,o){void 0===i&&(i=0),void 0===n&&(n=e.length),void 0===o&&(o=[]);var s=0,a=0;n--;for(var d=i+1;d<n;d++){var u=G(e[d],e[i],e[n],t.distance);u>s&&(a=d,s=u)}return s>r?(R(e,r,i,a,o),R(e,r,a,n+1,o)):(o.push(e[i]),n-i>0&&o.push(e[n])),o},w=function(e,t,r,i,n,o,s,a){return e<=o&&n<=t&&r<=a&&s<=i},O=function(t,r,i){null==t[2]&&(t=[t[0],t[1],0]);var n=[r[0]-t[0],r[1]-t[1],(r[2]||0)-t[2]];return e.scale(n,e.normalize(n,n),i),e.add(n,n,t)},N=function(e,t){for(var r=999999,i=!1,n=0;n<e.length-1;n++){var o=n+1,s=M(e[n],e[o],t);if(s){var a=K(s,t);a<r&&(r=a,i=n)}}return i},F=function(t,r,i,n){var o=e.sub([],r,t),s=e.sub([],n,i),a=e.sub([],t,i),d=e.dot(a,o),u=e.dot(a,s),p=e.dot(o,s),l=e.dot(o,o),c=e.dot(s,s),h=(u*p-d*c)/(l*c-p*p),f=(u+h*p)/c,v=e.add([],t,e.scale([],o,h)),g=e.add([],i,e.scale([],s,f)),y=0<=h&&h<=1&&0<=f&&f<=1,A=e.length(e.sub([],v,g));return{p0:v,p1:g,onSegment:y,intersects:A<=1e-7,distance:A}},T=function(e,t,r,i,n){var o=(i[1]-r[1])*(t[0]-e[0])-(i[0]-r[0])*(t[1]-e[1]);if(0!=o){var s=((i[0]-r[0])*(e[1]-r[1])-(i[1]-r[1])*(e[0]-r[0]))/o,a=((t[0]-e[0])*(e[1]-r[1])-(t[1]-e[1])*(e[0]-r[0]))/o,d=e[2]||0,u=t[2]||0;if(0<=s&&s<=1&&0<=a&&a<=1)return!n||[e[0]+s*(t[0]-e[0]),e[1]+s*(t[1]-e[1]),d+s*(u-d)]}return!1},M=function(e,t,r){if(e[0]==t[0]){var i=[e[0],r[1]];return!!H(e,t,i)&&i}if(e[1]==t[1]){var n=[r[0],e[1]];return!!H(e,t,n)&&n}var o=(t[1]-e[1])/(t[0]-e[0]),s=e[1]-o*e[0],a=-1/o,d=(r[1]-a*r[0]-s)/(o-a),u=[d,o*d+s];return!!H(e,t,u)&&u},D=function(t,r,i,n){var o=e.sub([],i,t),s=e.sub([],r,t),a=e.sub([],r,t),d=e.dot(s,o)/e.dot(s,s);return n&&(d=Math.max(0,Math.min(1,d))),e.scale(a,a,d),e.add(a,a,t)},B=function(t,r,i,n,o){var s=e.sub([],r,n),a=e.dot(s,i)/e.dot(t,i);return a==1/0?null:e.sub([],r,e.scale([],t,a))},j=function(e,t,r){var i=e[2]||0,n=t[2]||0;return[(t[0]-e[0])*r+e[0],(t[1]-e[1])*r+e[1],i+(n-i)*r]},G=function(e,t,r,i){void 0===i&&(i=K);var n=e[0],o=e[1],s=t[0],a=t[1],d=r[0],u=r[1],p=d-s,l=u-a,c=((n-s)*p+(o-a)*l)/(p*p+l*l);return i([n,o],c<0?[s,a]:c>1?[d,u]:[s+c*p,a+c*l])},z=function(e,t){for(var r=1/0,i=t.length-1,n=0;n<i;n++){var o=G(e,t[n],t[n+1]);o<r&&(r=o)}return r},K=function(e,t){return I(P(e[0]-t[0],2)+P(e[1]-t[1],2))},H=function(e,t,r,i){i=i||1e-7;var n=r[0]-e[0],o=r[1]-e[1],s=t[0]-e[0],a=t[1]-e[1],d=(n*s+o*a)/(s*s+a*a);return(d=(s=n-(d=d<0?0:d>1?1:d)*s)*s+(a=o-d*a)*a)<i*i},V=function(e){for(var t=0,r=0;r<e.length-1;r++)t+=K(e[r],e[r+1]);return t},Y=function(e,t,r){var i;void 0===r&&(r=!0);for(var n,o,s,a=0,d=0;d<e.length-1;d++)if(n=e[d],o=e[d+1],a+=i=K(n,o),!r||a>=t)return s=(t-(a-i))/i,[(o[0]-n[0])*s+n[0],(o[1]-n[1])*s+n[1]];return o},U=function(e,t,r){var i,n,o,s,a=K(r,e),d=(i=e,o=(n=r)[0]-i[0],s=n[1]-i[1],o||s?(180+180*E.atan2(s,o)/x)%360:0);return[r[0]+a*E.cos((t+d)/180*x),r[1]+a*E.sin((t+d)/180*x)]};function Z(e,t,r){for(var i=0,n=r.length-1;i<n;i++)if(T(e,t,r[i],r[i+1]))return 1}function W(e,t){for(var r=0,i=e.length-1;r<i;r++)if(Z(e[r],e[r+1],t))return 1}function Q(e,t){for(var r=e[0],i=e[1],n=!1,o=0,s=t.length-1;o<t.length;s=o++){var a=t[o][0],d=t[o][1],u=t[s][0],p=t[s][1];d>i!=p>i&&r<(u-a)*(i-d)/(p-d)+a&&(n=!n)}return n}function X(e,t,r){for(var i=0^r,n=e.length;i<n;i++)for(var o=0;o<e[i].length;o++)if(!Q(e[i][o],t))return 0;return 1}var J=function(e,t,r,i,n,o){void 0===i&&(i=0),void 0===n&&(n=0);var s=k.getCoords(e),a=s[n],d=a[i],u=d[r];if(!k.willSelfIntersect(d,t,r)){if(d[r]=t,r||(d[d.length-1]=t),!function(e,t,r){for(var i=0,n=t.length;i<n;i++)if(i!=r&&W(e,t[i]))return 1}(d,a,i)&&X(a,a[0],1)){var p=k.private(e,"shapePnts");if(o=o||k.getConnectedAreas(e,u),e.behavior("snapCoordinates"))for(var l=0;l<o.length;l++){var c=o[l],h=c.coordinates,f=c.polyIndex,v=c.lineIndex,g=c.coordIndex,y=h[f],A=y[v];if(c.area.behavior("snapCoordinates")){if(A[g][0]=t[0],A[g][1]=t[1],g||(A[A.length-1]=t),!(!k.willSelfIntersect(A,t,g)&&X(y,y[0],1)))return!1}else h.splice(l,1)}for(var m=0,_=o;m<_.length;m++){var S=_[m],L=S.area,b=S.coordinates;k._setCoords(L,b,!1)}k._setCoords(e,s,!1);for(var C=0,E=p;C<E.length;C++){var x=E[C],P=x.geometry.coordinates;P[0]==u[0]&&P[1]==u[1]&&x.getProvider().setFeatureCoordinates(x,t.slice())}}return!0}},q=function(e){function t(t,r,i,n,o){var s=this;k=o;var a=t._e(),d=a.display.getLayers().indexOf(a.getLayer(t))+1,u={type:"Feature",geometry:{type:"Point",coordinates:[r,i]},properties:{type:"AREA_SHAPE",poly:n[0],index:n[1],hole:n[2],AREA:{style:a.getStyle(t),zLayer:d?d+1:undefined}}},p=s=e.call(this,u,a.objects.overlay.layer.getProvider())||this,l=a.objects.overlay;function c(e){var t,r=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete r.hovered,t="default"):(r.hovered=!0,t="move"),document.body.style.cursor=t,a.setStyle(this)}function h(e,t){a.listeners.trigger(e,p,t)}var f=!1;return s.__={area:t,pointerdown:function(){f=!1,p.__.cAreas=k.getConnectedAreas(t,p.geometry.coordinates)},pressmove:function(e,r,i,n,o){var s;f||(f=!0,k.hideShape(k.private(t,"midShapePnts"),l),null===(s=t.__.hk)||void 0===s||s.hide(),h(e,"dragStart"));var d=a._config,u=p.getIndex(),c=p.properties.poly,v=p.properties.hole,g=a.map.getGeoCoord(e.mapX,e.mapY);t.behavior("snapCoordinates")&&(g=k.snapShape(p,g,d.snapTolerance)||g),J(t,g,u,v,c,p.__.cAreas)},pointerup:function(e){var r;if(f){if(t.behavior("snapCoordinates"))for(var i=0,n=p.__.cAreas;i<n.length;i++){var o=n[i].area;k.markAsModified(o,!1)}k.markAsModified(t)}null===(r=t.__.hk)||void 0===r||r.show(),k.addVShapes(t),h(e,f?"dragStop":undefined)},pointerenter:c,pointerleave:c},p}return y(t,e),t.prototype.getArea=function(){return this.__.area},t.prototype.remove=function(){return k.deleteShape(this.getArea(),this)},t.prototype.getIndex=function(){return this.properties.index},t.prototype.removeGeometry=function(){var e=this.getArea(),t=this.properties.poly,r=this.properties.hole,i=e.coord();i[t].splice(r,1),k._setCoords(e,i,!1),k.deHighlight(e),k._select(e),k.markAsModified(e)},t}(d);q.prototype.class="AREA_SHAPE";var $,ee=function(e){function t(t,r,i,n,o){var s,a,d=t._e(),u=d.display.getLayers().indexOf(d.getLayer(t))+1,p=d.objects.overlay,l={type:"Feature",geometry:{type:"Point",coordinates:[r,i]},properties:{type:"AREA_VIRTUAL_SHAPE",poly:n[0],index:n[1],hole:n[2],AREA:{style:d.getStyle(t),zLayer:u?u+1:undefined}}},c=s=e.call(this,l,p.layer.getProvider())||this;function h(e){var t,r=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete r.hovered,t="default"):(r.hovered=!0,t="move"),document.body.style.cursor=t,d.setStyle(this)}return c.__={pointerdown:function(){a=null},pressmove:function(e,r,i,n,s){var d=c.properties,u=d.index+1,p=d.poly,l=c.geometry.coordinates;if(!a){for(var h=o.private(t,"midShapePnts"),f=0,v=void 0,g=void 0,y=void 0;f<h.length;f++)(g=(v=h[f]).geometry.coordinates)[0]==l[0]&&g[1]==l[1]&&(y=v.properties,o.addShp(t,l.slice(),y.poly,y.hole,y.index+1));(a=o.getShp(t,p,d.hole,u)).__.pointerdown.apply(a)}a.__.pressmove.apply(a,arguments)},pointerup:function(e){if(a){var r=c.properties,i=r.poly,n=r.hole,s=r.index,d=o.getShp(t,i,n,s+1);d.__.pointerup.call(d,e)}},pointerenter:h,pointerleave:h},s}return y(t,e),t}(d),te=r.centroid,re=function(e){var t=e.geometry;return te("Polygon"==t.type?t.coordinates:t.coordinates[0])},ie=function(e){function t(t,r,i){var n=this;$=i;var o=t._e(),s=o.display.getLayers().indexOf(o.getLayer(t))+1,a=re(t),d={type:"Feature",geometry:{type:"Point",coordinates:[a[0],a[1],r]},properties:{type:"AREA_HEIGHT_KNOB",offsetZ:0,AREA:{style:o.getStyle(t),zLayer:s?s+1:undefined}}};function u(e){var t,r=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete r.hovered,t="default"):(r.hovered=!0,t="move"),document.body.style.cursor=t,o.setStyle(this)}return(n=e.call(this,d,o.objects.overlay.layer.getProvider())||this).__={area:t,iEditor:o,overlay:o.objects.overlay,pointerdown:function(){this.properties.isMoved=!1,this.properties.offsetZ=this.__.iEditor.getStyleProperty(this,"offsetZ")||0},pressmove:function(e,t,r,i,n){var o=this.__,s=o.area,a=o.iEditor,d=this.properties.offsetZ,u=a.map.translateZ(this.geometry.coordinates,d);u=vt(e.mapX,e.mapY,this,u,a,{axis:[0,0,1]});var p=a.map.translateZ(u,-d)[2];p=Math.max(0,p),this.update(p),s.getProvider().writeFeatureHeight(s,p),$._setCoords(s,s.geometry.coordinates),this.properties.isMoved=!0},pointerup:function(e){this.properties.isMoved&&$.markAsModified(this.__.area)},pointerenter:u,pointerleave:u},n}return y(t,e),t.prototype.update=function(e){var t=re(this.__.area);t[2]=e,this.__.overlay.setFeatureCoordinates(this,t)},t.prototype.remove=function(){this.__.overlay.remove(this)},t.prototype.hide=function(){this.__.overlay.hideFeature(this)},t.prototype.show=function(){this.update(this.geometry.coordinates[2]),this.__.overlay.showFeature(this)},t}(d);function ne(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,allowEdit:!0,shapePnts:[],midShapePnts:[]}),t?r[t]:r}function oe(e){var t=ne(e),r=e._e().objects.overlay;he.hideShape(t.shapePnts,r),he.hideShape(t.midShapePnts,r)}function se(e,t,r,i){for(var n=e._e().objects.overlay,o=0;o<r.length;o++)for(var s=r[o],a=0;a<s.length-1;a++){var d=i(s[a],s[a+1],a,o);n.addFeature(d),t.push(d)}}function ae(e){for(var t=ne(e,"midShapePnts"),r=he.getCoords(e),i=function(i){se(e,t,r[i],(function(t,r,n,o){return new ee(e,(t[0]+r[0])/2,(t[1]+r[1])/2,[i,n,o],he)}))},n=0;n<r.length;n++)i(n)}function de(e){if(ne(e,"isSelected")){oe(e),function(e){for(var t=ne(e,"shapePnts"),r=he.getCoords(e),i=function(i){se(e,t,r[i],(function(t,r,n,o){return new q(e,t[0],t[1],[i,n,o],he)}))},n=0;n<r.length;n++)i(n)}(e),ae(e);var t=e.getProvider().readFeatureHeight(e);if(he.isExtruded(e)&&"number"==typeof t){var r=e.__.hk;if(r)r.show();else r=e.__.hk=new ie(e,t,he),e._e().objects.overlay.addFeature(r);r.update(t)}}}function ue(e){var t=this,r=ne(t);r.allowEdit&&!r.isSelected&&(t._e().listeners.trigger(e,t),t.editState("hovered","pointerenter"==e.type),t._e().setStyle(this))}function pe(e){var t=this,r=ne(t);r.isSelected||this._e()._config.featureSelectionByDefault&&r.allowEdit&&he._select(t),t._e().listeners.trigger(e,t)}var le,ce,he={private:ne,_evl:{pointerenter:ue,pointerleave:ue,dbltap:pe,pointerup:pe},deHighlight:function(e){var t,r=ne(e);r.isSelected&&(oe(e),null===(t=e.__.hk)||void 0===t||t.remove(),e.__.hk=null,e.editState("hovered",!1),e.editState("selected",!1),e._e().setStyle(e),r.isSelected=!1)},_editable:function(e,t){var r=ne(e);t&&t!=r.allowEdit?document.body.style.cursor="pointer":t||t==r.allowEdit||(he.deHighlight(e),document.body.style.cursor="default"),r.allowEdit=t},isExtruded:function(e){if("number"==typeof e._e().getStyleProperty(e,"extrude"))return!0},_select:function(e){var t=ne(e),r=e._e();t.isSelected||(r.objects.selection.select(e),r.dump(e,"info"),t.isSelected=!0,e.editState("selected",!0),r.setStyle(e),de(e))},_setCoords:function(e,t,r){"number"==typeof t[0][0][0]&&(t=[t]);for(var i=t.length;i--;)for(var n=t[i],o=n.length;o--;){var s=n[o];s[s.length-1]=s[0]}e._e().objects.history.origin(e),"Polygon"==e.geometry.type&&(1==t.length?t=t[0]:e.geometry.type="MultiPolygon"),ne(e).isGeoMod=!0,e.getProvider().setFeatureCoordinates(e,t),r&&de(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),he.deHighlight(e)},markAsModified:function(e,t){return _(e,ne(e),t)},deleteShape:function(e,t){var r=t.properties,i=he.getCoords(e),n=i[r.poly][r.hole];return!(n.length<=4)&&(n.splice(t.getIndex(),1),he._setCoords(e,i),he.deHighlight(e),he._select(e),he.markAsModified(e),!0)},getCoords:function(e){var t=e.coord();return"Polygon"==e.geometry.type?[t]:t},isClockwise:function(e){for(var t=0,r=0,i=void 0,n=e.length-1;r<n;r++)i=(r+1)%n,t+=e[r][0]*e[i][1],t-=e[i][0]*e[r][1];return t<0},getMaxSpace:function(e,t,r){var i=e._e(),n=t[0],o=t[1],s=1e5,a=[[n+s,o-s],[n-s,o+s],[n+s,o+s],[n-s,o-s]];s=1/0;for(var d=0,u=r.length-1;d<u;d++)for(var p=(d+1)%u,l=i.map.getPixelCoord(r[d]),c=i.map.getPixelCoord(r[p]),h=0;h<4;){var f=T(a[h++],a[h++],l,c,!0);if(f){var v=K(t,f);v<s&&(s=0^v)}}return s},getPoly:function(e,t){for(var r=he.getCoords(e),i=1/0,n=null,o=0,s=void 0;o<r.length;o++)(s=z(t,r[o][0]))<i&&(i=s,n=o);return n},addVShapes:ae,getShp:function(e,t,r,i){for(var n=ne(e,"shapePnts"),o=0,s=void 0;o<n.length;o++)if((s=n[o].properties).poly==t&&s.index==i&&s.hole==r)return n[o]},addShp:function(e,t,r,i,n){for(var o=he.getCoords(e),s=o[r][i],a="number"==typeof n?n:N(s,t)+1,d=0;d<s.length;d++)if(s[d][0]==t[0]&&s[d][1]==t[1])return!1;return s.splice(a,0,t),he._setCoords(e,o),de(e),a},hideShape:function(e,t){Array.isArray(e)||(e=[e]);for(var r=0;r<e.length;r++)t.remove(e[r]);e.length=0},snapShape:function(e,t,r){for(var i=e.getArea(),n=e.__.cAreas,o=i._e(),s=r,a=function(e){if(e.id!=i.id&&"AREA"==e.class)for(var r=0,a=he.getCoords(e);r<a.length;r++){var d=a[r][0],u=o.map.searchPointOnLine(d,t,s,undefined,s);if(u&&!n.find((function(t){return t.area==e})))return{value:u.point}}},d=0,u=i.getProvider().search({point:t,radius:s});d<u.length;d++){var p=a(u[d]);if("object"==typeof p)return p.value}},willSelfIntersect:function(e,t,r){for(var i=0==r?e.length-2:r-1,n=r+1,o=0,s=void 0,a=e.length-1;o<a;o++){if(s=o+1,n==a){if(o&&o<i&&T(t,e[n],e[o],e[o+1]))return!0}else if(o!=n&&r!=(s%=a)&&o!=r&&T(t,e[n],e[o],e[s]))return!0;if(o>r){if((s%=a)!=i&&o!=i&&T(e[i],t,e[o],e[s]))return!0}else if(s<i&&o!=r&&T(e[i],t,e[o],e[s]))return!0}return!1},validateGeometry:function(e){for(var t=1;t<e.length-1;t+=1)if(he.willSelfIntersect(e,e[t],t))return!1;return!0},getConnectedAreas:function(e,t){for(var r=[],i=e._e(),n=i.getLayer(e),o=function(e){return Math.round(1e9*e)},s=o(t[0]),a=o(t[1]),d=i.objects.getInBBox([t[0],t[1],t[0],t[1]],n),u=d.length;u--;)for(var p=d[u],l=he.getCoords(p),c=l.length;c--;)for(var h=l[c].length;h--;)for(var f=l[c][h],v=f.length-1;v--;)o(f[v][0])==s&&o(f[v][1])==a&&p!=e&&r.push({area:p,polyIndex:c,lineIndex:h,coordIndex:v,coordinates:l});return r}},fe={dragPlane:"XY"},ve=function(e,t){var r=e.__||(e.__={b:A({},fe)});return t?r[t]:r},ge=function(t){function r(e,r,i,n,o,s){var a=this;le=s;var d=e._e().getStyle(e);return(a=t.call(this,{type:"Feature",properties:{lineStringIndex:i,index:n,LINE:{properties:e.prop(),style:d,zLayer:o}},geometry:{type:"Point",coordinates:r}})||this)._l=e,a.properties["@ns:com:here:editor"]={selected:a.isSelected()},a}return y(r,t),r.prototype.behavior=function(e,t){var r=ve(this,"b");switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];break;case 2:var i={};i[e]=t,e=i}r=A(A({},r),e),e.dragPlane?delete r.dragAxis:e.dragAxis&&delete r.dragPlane,this.__.b=r},r.prototype.getLine=function(){return this._l},r.prototype.getLength=function(){return this._l.geometry.coordinates.length},r.prototype.getIndex=function(){return this.properties.index},r.prototype.getLineStringIndex=function(){return this.properties.lineStringIndex},r.prototype.remove=function(){var e=this.getLine();le.removeCoord(e,this.properties.index,this.properties.lineStringIndex),le.markAsModified(e)},r.prototype.select=function(){var e=this,t=e.getLine(),r=le.private(t,"selectedShapes"),i=e.properties,n=i.lineStringIndex,o=i.index;r[n]||(r[n]=[]),r[n][o]=!0,e.properties["@ns:com:here:editor"].selected=!0,le.displayShapes(t)},r.prototype.unselect=function(){var e=this,t=e.getLine();t._e(),e.properties["@ns:com:here:editor"].selected=!1;var r=le.private(t,"selectedShapes"),i=e.properties,n=i.lineStringIndex,o=i.index;r[n]&&(r[n][o]=!1),le.displayShapes(t)},r.prototype.isSelected=function(){var e,t=le.private(this.getLine(),"selectedShapes"),r=this.properties,i=r.lineStringIndex,n=r.index;return!!(null===(e=t[i])||void 0===e?void 0:e[n])},r.prototype.pointerdown=function(e){var t=this,r=t.properties,i=t.geometry.coordinates,n=e.detail.display,o=t.getLine();r.moved=!1;var s=n.geoToPixel.apply(n,i);r.x=s.x,r.y=s.y,r.button=e.button,r.z=i[2]||0,le.removeShapes(o,"vShps","LINE_VIRTUAL_SHAPE"==t.class&&this),o._e().listeners.trigger(e,this,"pointerdown")},r.prototype.getSelectedShapes=function(e,t){for(var r,i=this.getLine(),n=le.private(i,"selectedShapes"),o=le.private(i,"shps"),s=[],a=0;a<n.length;a++)for(var d=0;d<(null===(r=n[a])||void 0===r?void 0:r.length);d++)n[a][d]&&(arguments.length&&t==a&&e==d||s.push(o[a][d]));return s},r.prototype.pressmove=function(t,r,i){var n=this,o=this.properties,s=o.lineStringIndex,a=o.index,d=n.getLine(),u=d._e(),p=le.getCoordinates(d),l=p[s],c=!u.getStyleProperty(d,"altitude"),h=l[a][2],f=n.geometry.coordinates;o.moved||(o.moved=!0,u.listeners.trigger(t,this,"dragStart"));var v=l[a]=vt(t.mapX,t.mapY,n,f,u);if(c&&"number"==typeof h&&(v[2]=h),this.isSelected())for(var g=u.display,y=g._g2w(f),A=g._g2w(v),m=e.sub(A,A,y),_=0,S=this.getSelectedShapes(o.index,s);_<S.length;_++){var L=S[_],b=L.properties,k=g._g2w(L.geometry.coordinates);e.add(k,k,m);var C=g._w2g(k);p[b.lineStringIndex][b.index]=C,L.getProvider().setFeatureCoordinates(L,C)}n.getProvider().setFeatureCoordinates(n,v.slice()),le._setCoords(d,p)},r.prototype.pointerup=function(e){var t=this.getLine(),r=this.properties.moved;r&&le.markAsModified(t),le.displayShapes(t),t._e().listeners.trigger(e,this,r?"dragStop":undefined)},r}(d);ge.prototype.class="LINE_SHAPE";var ye=function(e){function t(t,r,i,n,o,s){return ce=s,e.call(this,t,r,i,n,o,s)||this}return y(t,e),t.prototype.pointerdown=function(t){e.prototype.pointerdown.call(this,t)},t.prototype.pressmove=function(t,r,i){var n=this.properties,o=this,s=o.getLine();n.moved||(n.index++,ce.addCoord(s,o.geometry.coordinates.slice(),n.index,n.lineStringIndex),ce.removeShapes(s,"vShps",o)),e.prototype.pressmove.call(this,t,r,i)},t.prototype.pointerup=function(t){this.getProvider().removeFeature(this),e.prototype.pointerup.call(this,t)},t}(ge);function Ae(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,highlight:!0,moved:!1,shps:[],vShps:[],selectedShapes:[],isGeoMod:!1}),t?r[t]:r}ye.prototype.class="LINE_VIRTUAL_SHAPE";var me=function(e,t,r){void 0===r&&(r=!1),t&&e.editState(t,r),e._e().setStyle(e,undefined)};function _e(e){Ae(this,"isEditable")&&this._e().listeners.trigger(e,this)}var Se,Le,be,ke={private:Ae,_evl:{pointerenter:_e,pointerleave:_e,pointerup:function(e){var t=this,r=Ae(t);r.isEditable&&(!r.isSelected&&t._e()._config.featureSelectionByDefault&&ke._select(t),t._e().listeners.trigger(e,t))}},addCoord:function(e,t,r,i){var n,o=ke.getCoordinates(e,i);if(null==r){var s=N(o,t);if(!1===s)return s;r=s+1}return o.splice(r,0,t),ke._setCoords(e,o,i),null===(n=Ae(e,"selectedShapes")[i])||void 0===n||n.splice(r,0,undefined),r},removeCoord:function(e,t,r){var i,n,o=ke.getCoordinates(e,r),s=o.length;return s>2&&t>=0&&t<s&&(n=o.splice(t,1),null===(i=Ae(e,"selectedShapes")[r])||void 0===i||i.splice(t,1),ke._setCoords(e,o,r),ke.displayShapes(e)),n},createShapes:function(e,t,r,i,n){for(var o=Ae(e,i),s=o[t]=o[t]||[],a=e._e(),d=a.getZLayer(e)-1,u=a.getStyleProperty(e,"altitude"),p=0;p<r.length;p++){var l=r[p].slice();"number"==typeof u&&(l[2]=u),s[p]=new n(e,l,t,p,d,ke),a.objects.overlay.addFeature(s[p])}},createVShapes:function(e,t,r){void 0===t&&(t=0);for(var i=[],n=1;n<r.length;n++)i.push(j(r[n-1],r[n],.5));ke.createShapes(e,t,i,"vShps",ye)},displayShapes:function(e){if(Ae(e,"isSelected")){var t=e.geometry,r=void 0;r="LineString"==t.type?[t.coordinates]:t.coordinates,ke.removeShapes(e,"shps"),ke.removeShapes(e,"vShps");for(var i=0;i<r.length;i++)ke.createShapes(e,i,r[i],"shps",ge),ke.createVShapes(e,i,r[i])}},removeShapes:function(e,t,r){var i=Ae(e,t);i.forEach((function(t){t!=r&&e._e().objects.overlay.remove(t)})),i.length=0},deHighlight:function(e){Ae(e,"isSelected")&&(me(e,"selected",!1),ke.removeShapes(e,"shps"),ke.removeShapes(e,"vShps"))},_editable:function(e,t){var r=Ae(e);return null!=t&&(r.isEditable=!!t),ke.deHighlight(e),r.isEditable},_select:function(e){e._e().objects.selection.select(e)&&(Ae(e,"selectedShapes").length=0,me(e,"selected",!0),ke.displayShapes(e))},isMultiLineString:function(e){return"MultiLineString"==e.geometry.type},getCoordinates:function(e,t){var r=e.coord();return ke.isMultiLineString(e)||(r=[r]),t>=0?r[t]:r},_setCoords:function(e,t,r){e._e().objects.history.origin(e),Ae(e).isGeoMod=!0;var i=t;ke.isMultiLineString(e)?r>=0&&((i=e.coord())[r]=t):"number"!=typeof i[0][0]&&(i=i[0]),e.getProvider().setFeatureCoordinates(e,i)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),ke.deHighlight(e),e.getProvider().removeFeature(e)},markAsModified:function(e,t){return _(e,Ae(e),t)}},Ce=function(e,t){this.offset=e,this.distance=t},Ee=function(e,t){for(var r=0,i=0,n=0;n<t.length-1;n++){var o=t[n],s=t[n+1];0!=H(t[n],t[n+1],e)&&(i=r+K(o,e)),r+=K(o,s)}return i/r},xe=function(e,t){for(var r=0,i={lenPntToLine:1/0,lenTotal:0,shp:0},n=0;n<e.length-1;n++){var o=e[n],s=e[n+1],a=M(e[n],e[n+1],t);if(0!=a){var d=K(a,t);d<i.lenPntToLine&&(i.shp=n,i.lenPntToLine=d,i.lenTotal=r+K(o,a))}r+=K(o,s)}var u=0,p={shp:-1,distancePoi:1/0,length:-1};for(n=0;n<e.length;n++){var l=K(e[n],t);n>0&&(u+=K(e[n],e[n-1])),l<p.distancePoi&&(p.shp=n,p.distancePoi=l,p.length=u)}return i.lenPntToLine<p.distancePoi?new Ce(i.lenTotal/r,i.lenPntToLine):new Ce(p.length/r,p.distancePoi)},Pe=function(e,t,r,i){e.target=r||"display",e._e().listeners.trigger(t,e,i)},Ie=function(){function e(e,t,r){Le=r,Se=t,this.location=e,this.iEditor=e._e()}return e.prototype.updateDisplayedRoutingPoint=function(){var e=this.getLink(),t=this.coord();if(e){var r=e.coord(),i=V(r),n=0^xe(r,t).offset,o=Y(r,i*n),s=Y(r,i*n+(n<1?1:-1));if(o[0]!=s[0]||s[1]!=o[1]){var a=this.rpFeature;a&&(this.updateStreetLine(),this.iEditor.objects.overlay.setFeatureCoordinates(a,t.slice()))}}},e.prototype.createDisplayedRoutingPoint=function(e,t,r){var i=this,n=this.iEditor;i.rpFeature=i.iEditor.objects.overlay.addPoint(i.routingPoint.slice(),A({type:e,zLayer:t},r));var o=i.rpFeature;return o.pointerdown=function(){i.dragged=!1},o.pressmove=function(e,t,r){var o=i.cLink,s=i.location,a=i.ignoreZ;if(o&&!n._config.editRestrictions(s,1)){i.dragged||(i.dragged=!0,Pe(s,e,"routing","dragStart"));var d=n.display.pixelToGeo(e.mapX,e.mapY),u=d.longitude,p=d.latitude,l=n.objects.searchLine([u,p],o.getProvider(),{ignoreZ:a},s.geometry.coordinates);if(l||(l=n.objects.searchLine([u,p],[o],{ignoreZ:a},s.geometry.coordinates)),l){var c=l.line,h=l.point;c!=o&&(Le.defaults(o),Le.displayAsSelected(c,s.id,!0)),i.setRoutingPoint(c,h),i.updateDisplayedRoutingPoint()}}},o.pointerup=function(e){i.dragged&&(Se.setRoutingData(i.location),i.updateDisplayedRoutingPoint(),Se.markAsModified(i.location)),Pe(i.location,e,"routing",i.dragged?"dragStop":undefined)},i.rpFeature},e.prototype.updateStreetLine=function(){var e=this.iEditor,t=this.location,r=e.display;if(this.streetLine){var i=t.coord(),n=Se.private(t),o=this.coord();if(n.isSelected){var s=e.getStyle(n.selector)[0]||{},a=s.radius||s.width/2,d=s.scaleByAltitude,u=r._g2w(i),p=r._scaleOffsetXYByAltitude(u,d);i=r._w2g(O(u,r._g2w(o),a*p))}e.objects.overlay.setFeatureCoordinates(this.streetLine,[o].concat([i]))}},e.prototype.getLink=function(){return this.cLink},e.prototype.coord=function(){return this.routingPoint},e.prototype.show=function(){var e=this,t=e.cLink,r=e.location,i=e.iEditor;if(t){var n=i.getStyleProperty(r,"altitude"),o=r.class;if(e.ignoreZ=!n,!e.rpFeature){var s=i.display.getLayers().indexOf(i.getLayer(e.getLink()))+1;s=s?s+1:undefined;var a={parentType:o};a[o]={altitude:n},e.streetLine=i.objects.overlay.addPath([r.coord().slice(),this.routingPoint.slice()],undefined,A(A({},a),{type:o+"_LINE",zLayer:s})),e.rpFeature=this.createDisplayedRoutingPoint(o+"_ROUTING_POINT",s,a)}e.updateDisplayedRoutingPoint(),Le.displayAsSelected(t,r.id)}return e.cLink},e.prototype.hide=function(){var e=this,t=e.rpFeature,r=e.iEditor;t&&(t.pointerdown=t.pressmove=t.pointerup=undefined,r.objects.overlay.remove(t),r.objects.overlay.remove(e.streetLine),e.rpFeature=e.streetLine=null)},e.prototype.updateRoutingPoint=function(){var e,t,r=Se.getRoutingData(this.location),i=r.link,n=Se.getRoutingProvider(this.location),o=r.position;if(this.cLink=this.routingPoint=null,i&&n&&(this.cLink=n.search(i)),this.cLink){if(o){t=this.cLink.coord();for(var s=0;s<t.length-1;s++)if(H(t[s],t[s+1],o,1e-6))return this.routingPoint=o,this.cLink;e=o}else e=this.location.coord();var a=this.iEditor.objects.getNearestLine(e,[this.cLink]);a&&(this.cLink=a.line,this.routingPoint=a.point)}return this.cLink},e.prototype.searchLink=function(){var e=this.iEditor,t=this.location,r=Se.getRoutingProvider(t);return r&&e.objects.getNearestLine(t.coord(),r,{maxDistance:e._config.maxRoutingPointDistance})},e.prototype.setRoutingPoint=function(e,t){if(this.routingPoint=this.cLink=null,e)this.cLink=e,this.routingPoint=t;else{var r=this.searchLink();r&&(this.cLink=r.line,this.routingPoint=r.point)}return this.cLink},e.prototype.clearRoutingPoint=function(){this.cLink=this.routingPoint=null,this.hide()},e}(),Re=function(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,allowEdit:!0,isGeoMod:!1,isHovered:!1,cLink:null,moved:!1}),t?r[t]:r};var we=function(e){return"PLACE"==e.class},Oe=function(e){var t=Re(e);return null==t._rp&&(t._rp=new Ie(e,je,be)),t._rp};function Ne(e,t){var r=!we(e),i=je.getRoutingData(e).link,n=Re(e);n.isHovered=t;var o=i||r;if(i||r){var s=Oe(e);(s.updateRoutingPoint()||s.setRoutingPoint())&&(n.cLink=s.show(),o&&je.setRoutingData(e))}t&&Pe(e,t)}function Fe(e,t){var r=Re(e,"cLink");Re(e).isHovered=!t,r&&be.defaults(r,e.id)&&be.private(r,"isSelected")&&be.displayAsSelected(r),t&&Pe(e,t),Oe(e).hide()}function Te(e){var t=this,r=Re(t),i="pointerenter"==e.type;r.allowEdit&&(t.editState("hovered",i),r.isSelected||(i?Ne(t,e):Fe(t,e)))}function Me(e,t,r,i,n){var o=this,s=Re(o),a=o._e();if(s.isSelected&&!a._config.editRestrictions(o,1)){s.moved||null!=je.getRoutingData(o).link&&je.connect(o,null),Pe(o,e,"display",s.moved?"dragMove":"dragStart");var d=m([],o.geometry.coordinates,!0);a.getStyleProperty(o,"altitude")||(d[2]=0),d=vt(e.mapX,e.mapY,o,d,a),je._setCoords(o,d),s.moved=!0,Oe(o).updateStreetLine()}}var De,Be,je={private:Re,setLinkTools:function(e){be=e},_evl:{pointerenter:Te,pointerleave:Te,dbltap:function(e){Pe(this,e)},pointerup:function(e){var t=Re(this),r=t.moved,i=this._e();t.allowEdit&&(t.isSelected||(i.dump(this),i._config.featureSelectionByDefault&&je._select(this)),r&&(Oe(this).show(),je.markAsModified(this)),Pe(this,e,"display",r?"dragStop":"pointerup"),t.moved=!1)},pointerdown:function(e){var t=Re(this);t.allowEdit&&(t.isSelected&&(t.moved=!1),Pe(this,e,"display","pointerdown"))}},deHighlight:function(e){var t=Re(e);return t.selector&&e._e().objects.overlay.remove(t.selector),t.selector=null,t.isSelected&&(Fe(e),t.pressmove=null,t.isSelected=!1,e.editState("selected",!1),t.cLink&&be.defaults(t.cLink,e.id)),e},_editable:function(e,t){var r=Re(e);t!=r.allowEdit&&(t||(je.deHighlight(e),r.isHovered&&(r.isHovered.type="mouseout",Fe(e,r.isHovered))),r.allowEdit=t)},_select:function(e){e._e().objects.selection.select(e)&&(e.editState("selected",!0),Re(e).pressmove=Me,je.highlight(e),Ne(e))},_setCoords:function(e,t){return C._setCoords(e,t)},markAsRemoved:C.markAsRemoved,markAsModified:function(e,t){return _(e,Re(e),t)},_props:function(e,t){var r=arguments.length,n=e.getProvider().getFeatureProperties(e);if(r>1){if(2==r&&"string"==typeof t)return n[t];if(3==r){var o=t;(t={})[o]=arguments[2]}e._e().objects.history.origin(e),i.extend(n,t)}return n},highlight:function(e){var t=Re(e);if(!t.selector){var r={type:e.class+"_SELECTOR",parentType:e.class},i=e._e(),n=i.display.getLayers().indexOf(i.getLayer(e));r[e.class]={altitude:e._e().getStyleProperty(e,"altitude"),zLayer:n},t.selector=e._e().objects.overlay.addCircle(e.geometry.coordinates,undefined,r)}},getRoutingProvider:function(e){var t=e._e(),r=e.getProvider().readRoutingProvider(e,t.layers.map((function(e){return e.getProvider()})));return t.getProviderById(r)},getRoutingData:function(e){return e.getProvider().readRoutingPoint(e)},setRoutingData:function(e){var t=Oe(e),r=t.getLink(),i=t.coord(),n=Re(e);n.cLink=r;var o=Number("1e"+e._e()._config.routingPointPrecision),s=function(e){return Math.round(e*o)/o},a=i?[s(i[0]),s(i[1]),0|i[2]]:[],d=je.getRoutingData(e),u=d.position||[],p=r?r.id:null;d.link==p&&a[0]==s(u[0])&&a[1]==s(u[1])||(e._e().objects.history.ignore((function(){n.writeProp=!0,e.getProvider().writeRoutingPoint(e,r,i?a:i),delete n.writeProp})),je._setCoords(e,e.geometry.coordinates))},connect:function(e,t,r){var i=Re(e);if(!i.writeProp){var n=Oe(e),o=n.getLink(),s=(je.getRoutingData(e).position||[]).slice();o&&be.defaults(o),t?i.cLink=n.setRoutingPoint(t,r):(i.cLink=n.updateRoutingPoint())||!1===t||(i.cLink=n.setRoutingPoint()),(we(e)||i.cLink)&&je.setRoutingData(e),i.isSelected&&(i.cLink?Ne(e):Fe(e));var a=je.getRoutingData(e).position||[];o==i.cLink&&s[0]==a[0]&&s[1]==a[1]||je.markAsModified(e,!1)}},disconnect:function(e){var t=Re(e);t.writeProp||(Fe(e),Oe(e).clearRoutingPoint(),t.cLink=null,we(e)||Oe(e).setRoutingPoint(),je.setRoutingData(e),je.markAsModified(e,!1))},getRoutingPosition:function(e){var t=Oe(e),r=t.coord();return r||(t.updateRoutingPoint(),r=t.coord()),r&&[r[0],r[1],r[2]||0]||undefined}},Ge=function(){function e(e,t,r,i){}return e.prototype.isPntInFence=function(){return!0},e.prototype.isHidden=function(){return!0},e.prototype.remove=function(){},e}(),ze="@ns:com:here:editor",Ke=function(e){return e.__||(e.__={})};function He(e,t){Ke(this).line._e().listeners.trigger(e,this,t)}function Ve(e){var t=this,r=(n=Ke(t)).line,i=r._e();n._cls=n.cLinks.map((function(e){return e.link})),n.drg=!1;var n,o=this.geometry.coordinates,s=i.display.geoToPixel.apply(i.display,o);(n=Ke(t)).x=s.x,n.y=s.y,n.z=o[2],i.dump(t),De.removeShapePnts(r,!0),i.listeners.trigger("_clearOverlay"),De.hideDirection(r),Be=new Ge(i,o[0],o[1]),He.call(t,e,"pointerdown")}function Ye(t,r,i){var n=this,o=Ke(n),s=o.line,a=s._e(),d=a._config,u=De.ignoreZ(s),p=n.geometry.coordinates.slice(0,u?2:3),l=vt(t.mapX,t.mapY,n,p,a);if(!d.editRestrictions(s,1))if(Be.isPntInFence(l)){if(!Be.isHidden()&&Be.hide(),d.snapOnDrag&&s.behavior("snapCoordinates")&&(l=De.snapShape(n,l,u,d.snapTolerance)||l),De.moveShapeAtIndexTo(s,o.index,l),this.isSelected())for(var c=a.display,h=c._g2w(p),f=c._g2w(l),v=e.sub(f,f,h),g=0,y=function(e,t){for(var r=De.private(e,"selectedShapes"),i=De.private(e,"shps"),n=[],o=0;o<r.length;o++)!r[o]||void 0!==t&&t==o||n.push(i[o]);return n}(s,o.index);g<y.length;g++){var A=y[g],m=c._g2w(A.geometry.coordinates);e.add(m,m,v);var _=c._w2g(m);De.moveShapeAtIndexTo(s,Ke(A).index,_)}o.drg||(o.drg=!0,He.call(n,t,"dragStart"))}else Be.isHidden()&&Be.show()}function Ue(e){var t,r,i=Ke(this),n=i.index,o=i.drg,s=!1,a=i.line,d=!1,u=!1,p=i.cLinks;i._cls=null,o&&("boolean"==typeof(r=De.fixGeo(a,n))?d=!r:(d=r>=0,(u=n!=r)&&(n=r))),De.showDirection(a),a.behavior("snapCoordinates")&&Be.isHidden()&&!d&&o&&(t=function(e,t){var r,i,n=e.coord()[t],o=De.ignoreZ(e),s=e.getConnectedLinks(t),a=e._e();return s.push(e),null!=(r=a.objects.getNearestLine(n,e.getProvider(),{maxDistance:a._config.snapTolerance,ignore:function(e){return"NAVLINK"==e.class&&(-1!=s.indexOf(e)||!e.behavior("snapCoordinates"))},ignoreZ:o}))&&((i=r.point)[2]||(i[2]=0),null===De.connectShpToLink(e,t,r=r.line,i,void 0,o)&&(r=null)),r}(a,n)),t||(o&&((!1===r?p:a.getConnectedLinks(n,!0)).forEach((function(e){var t=De.fixGeo(e.link,e.index);u="number"==typeof t||!t||u,De.markAsModified(e.link,!1,!1)})),s=!0),De.createAddShapePnts(a)),Be&&Be.remove(),i.drg=!1,(u||o)&&De.refreshGeometry(a),a._e().listeners.trigger(e,a.editState("removed")?this:De.private(a,"shps")[n],o?"dragStop":void 0),s&&De.markAsModified(a,!0,!1)}function Ze(){var e=Ke(this);document.body.style.cursor="default",e.cLinks.forEach((function(e){De.defaults(e.link)})),delete this.properties[ze].hovered,e.line._e().setStyle(this)}function We(){var e=Ke(this),t=e.line._e();document.body.style.cursor="move",e.cLinks.forEach((function(e){for(var r=t.getStyle(e.link),i=0;i<r.length;i++)r[i].opacity=.5;t.setStyle(e.link,r)})),this.properties[ze].hovered=!0,t.setStyle(this)}var Qe=function(e){function r(t,r,n,o){var s;De=o;var a=t._e(),d=t.getConnectedLinks(n,!0),u=0==n||n==t.geometry.coordinates.length-1,p={type:"Feature",geometry:{type:"Point",coordinates:r.slice()},properties:{isNode:u,isConnected:!!d.length,NAVLINK:{properties:i.extend(!0,{},t.properties),style:a.getStyle(t)},parent:t,"@ns:com:here:editor":{selected:!!De.private(t,"selectedShapes")[n]}}};s=e.call(this,p,a.objects.overlay.layer.getProvider())||this;var l=Ke(s);return l.index=n,l.line=t,l.drg=!1,l.cLinks=d,l.dblclick=He,l.pressmove=Ye,l.pointerdown=Ve,l.pointerup=Ue,a._config.editRestrictions(t,1)||(l.pointerenter=We,l.pointerleave=Ze),s}return y(r,e),r.prototype.behavior=function(e,t){var r=De.private(this,"b")||A({},fe);switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];break;case 2:var i={};i[e]=t,e=i}r=A(A({},r),e),e.dragPlane?delete r.dragAxis:e.dragAxis&&delete r.dragPlane,this.__.b=r},r.prototype.getLink=function(){return this.properties.parent},r.prototype.isNode=function(){return this.properties.isNode},r.prototype.isOverlapping=function(){return De.checkOverlapping(this.properties.parent,this.getIndex())},r.prototype.getIndex=function(){return Ke(this).index},r.prototype.editTurnRestrictions=function(){if(this.isNode())return this.getLink().editTurnRestrictions(this.getIndex())[0]},r.prototype.getConnectedLinks=function(){return this.getLink().getConnectedLinks(this.getIndex())},r.prototype.remove=function(){var e=this.getLink();e._e()._config.editRestrictions(e||this,2)||De.deleteShape(e,this)},r.prototype.disconnect=function(){var e=Ke(this),r=e.line._e();if(this.isNode()&&e.cLinks.length){var i=e.line,n=e.index,o=i.coord(),s=o[n],a=o[n+(n?-1:1)],d=90-t.calcBearing(s,a),u=r.map.movePoint(s,r._config.disconnectShapeDistance,d);r.hooks.trigger("Navlink.disconnect",{link:i,index:n},i.getProvider()),o[n][0]=u[0],o[n][1]=u[1],De._setCoords(i,o),De.fixGeo(i),De.refreshGeometry(i),De.markAsModified(i)}},r.prototype.select=function(){var e=this,t=e.getLink();De.private(t,"selectedShapes")[Ke(e).index]=!0,e.properties[ze].selected=!0,De.refreshGeometry(t)},r.prototype.unselect=function(){var e=this,t=e.getLink();e.properties[ze].selected=!1,De.private(t,"selectedShapes")[Ke(e).index]=!1,De.refreshGeometry(t)},r.prototype.splitLink=function(){var e,t=this.getLink(),r=t._e();return this.isNode()||(e=r.objects.splitLinkAt({link:t,index:this.getIndex()})).length&&r.objects.history.saveChanges(),e},r.prototype.isSelected=function(){return!!De.private(this.getLink(),"selectedShapes")[Ke(this).index]},r}(d);Qe.prototype.class="NAVLINK_SHAPE";var Xe=function(e){function t(t,r,n,o){var s,a,d=t._e(),u=d.display;var p=s=e.call(this,{type:"Feature",geometry:{type:"Point",coordinates:r.slice()},properties:{type:"NAVLINK_VIRTUAL_SHAPE",NAVLINK:{properties:i.extend(!0,{},t.properties),style:d.getStyle(t)},parent:t}},d.objects.overlay.layer.getProvider())||this;return p.pointerdown=function(){var e=p.properties.parent,t=p.geometry.coordinates;p.moved=!1,o.hideDirection(e);var r=u.geoToPixel.apply(u,t);a=new Ge(d,p.x=r.x,p.y=r.y,p.z=t[2])},p.pressmove=function(e,t,r,i,s){var d=p.properties.parent,u=p.geometry.coordinates.slice();if(a.isPntInFence(u)){a.isHidden()||a.hide();var l=o.private(d,"shps");if(!p.moved){o.addShp(d,u,n,!1,!0),o.removeShapePnts(d,!0,p.id),p.pointerenter=p.pointerleave=undefined,p.moved=!0;var c=l[n];c.x=p.x,c.y=p.y,c.z=p.z,c.__.pointerdown.apply(c,arguments)}var h=l[n];h.__.pressmove.apply(h,arguments)}else a.isHidden()&&a.show()},p.pointerup=function(e){var t=p.properties.parent,r=o.private(t);if(p.moved){var i=r.shps[n];i.__.pointerup.call(i,e),this.getProvider().removeFeature(this)}else r.isSelected&&o.showDirection(t)},d._config.editRestrictions(t,1)||(p.pointerenter=p.pointerleave=function(e){var t="pointerenter"==e.type;document.body.style.cursor=t?"move":"default",this.properties["@ns:com:here:editor"].hovered=t,d.setStyle(this)}),s}return y(t,e),t.prototype.getLink=function(){return this.properties.parent},t}(d),Je=function(){},qe=function(e,t){var r=e.__;return r||(r=e.__={isSelected:!1,isEditable:!0,allowEdit:!0,shps:[],vShps:[],selectedShapes:[],isHovered:null,_cPnt:null,arrows:null,prevBBox:null,isGeoMod:!1,dh:null,xt:null}),t?r[t]:r};function $e(e,t){var r=arguments.length,n=e.getProvider().getFeatureProperties(e);if(r>1){if(2==r&&"string"==typeof t)return n[t];if(3==r){var o=t;(t={})[o]=arguments[2]}e._e().objects.history.origin(e),i.extend(n,t)}return n}function et(e){var t=this,r=e.type;qe(t,"allowEdit")&&t._e()._config.featureSelectionByDefault&&("dbltap"==r||"pointerup"==r)&&dt._select(t),t._e().listeners.trigger(e,t)}function tt(e,t){if(t)for(var r in t)e.editState(r,t[r]);e._e().setStyle(e,"default")}function rt(e){var r=qe(e);return dt.getConnectedObjects(e,t.mergeBBoxes(r.prevBBox=r.prevBBox||e.bbox.slice(),e.bbox))}function it(e,t){qe(e).isGeoMod=!0,e._e().objects.history.origin(e),e._provider.setFeatureCoordinates(e,t)}function nt(e,t){if(e._e().objects.overlay.remove(t),t.class){for(var r in t)"id"!=r&&"type"!=r&&"class"!=r&&"properties"!=r&&"geometry"!=r&&(t[r]=undefined);t.isDeleted=!0}}function ot(e,t){var r=e.__.ol;e.properties.isOverlapping=t,r!=(e.__.ol=t)&&e.getLink()._e().setStyle(e,undefined)}function st(e){e.listeners.trigger("featureUnselected",{featureUnselected:!0})}function at(e){var t=this,r=qe(t);r.allowEdit&&(document.body.style.cursor="default",et.call(t,e),r.isSelected||function(e){for(var t=dt.getConnectedObjects(e),r=0;r<t.length;r++)if(je.private(t[r],"isSelected"))return!0}(t)||tt(t,{hovered:!1}),r.isHovered=null)}var dt={private:qe,_evl:{pointerenter:function(e){var t=this,r=qe(t);r.allowEdit&&(document.body.style.cursor="Pointer",r.isHovered=e,et.call(t,e),tt(t,{hovered:!0}))},pointerleave:at,dbltap:et,pointerup:et},deHighlight:function(e){return qe(e,"isSelected")&&(tt(e,{selected:!1,hovered:!1}),dt.removeShapePnts(e),dt.hideDirection(e)),e},_editable:function(e,t){var r=qe(e);if(t!=r.allowEdit){if(!t){var i=r.isHovered;i&&(i.type="mouseout",at.call(i.target,i)),dt.deHighlight(e)}r.allowEdit=t}},_select:function(e){qe(e,"isSelected")||(qe(e,"selectedShapes").length=0,e._e().objects.selection.select(e),e._e().dump(e,"info"),dt.refreshGeometry(e))},_setCoords:function(e,t){for(var r=t.length;r--;)t[r][2]=t[r][2]||0;rt(e),it(e,t),dt.refreshGeometry(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),dt.hideDirection(e),rt(e).forEach((function(e){je.disconnect(e)})),dt._editable(e,!1);var t=e.coord(),r=t[0],i=t[t.length-1];r[0]==i[0]&&r[1]==i[1]&&(t[0][0]+=1e-5,t[0][1]+=1e-5,it(e,t))},markAsModified:function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=!0);var i=e.editState("modified"),n=qe(e);if(n.isGeoMod){var o=e.coord();rt(e).forEach((function(t){var r=Y(o,V(o)*xe(o,je.getRoutingPosition(t)).offset);je.connect(t,e,r)}))}return _(e,n,t),i||(tt(e),!n.isSelected&&r&&dt.defaults(e)),e},ignoreZ:function(e){return!e._e().getStyleProperty(e,"altitude")},_props:$e,getConnectedObjects:function(e,r){var i=e._e();return i.objects.getInBBox(t.extendBBox(r||e.bbox,i._config.maxRoutingPointDistance)).filter((function(t){var r=t.class;if("PLACE"==r||"ADDRESS"==r)return t.getLink()==e}))},refreshGeometry:function(e){dt.removeShapePnts(e),qe(e,"isSelected")&&(dt.displayAsSelected(e),dt.showDirection(e),dt.createShapes(e),dt.createAddShapePnts(e))},checkOverlapping:function(e,t){var r=e.coord(),i=null==t,n=i?1:t,o=i?r.length-1:n+1,s=[];o==r.length&&o--;for(var a,d=e._e().objects.getInBBox(e.bbox,e.getProvider()),u=d.length;u--;)if((a=d[u]).id!=e.id&&"NAVLINK"==a.class)for(var p=n;p<o;p++)for(var l=0,c=a.coord();l<c.length;l++)if(r[p][0]==c[l][0]&&r[p][1]==c[l][1]){s.push(p);break}return i?s:!!s.pop()},createLinkShape:function(e,t,r){return e._e().objects.overlay.addFeature(new Qe(e,t,r,dt))},createShapes:function(e){var t=qe(e,"shps"),r=e.geometry.coordinates,i=r.length;if(!e.editState("removed")){var n=dt.checkOverlapping(e);if(t.length)t.forEach((function(t,r){t.__.cLinks=e.getConnectedLinks(r,!0)}));else for(var o=0;o<i;o++){var s=dt.createLinkShape(e,m([],r[o],!0),o);ot(s,n.indexOf(o)>=0),t[o]=s}}},createAddShapePnts:function(e){var t=qe(e,"vShps");if(!t.length&&!e.editState("removed")&&!e._e()._config.editRestrictions(e,1))for(var r=e.geometry.coordinates,i=1,n=void 0,o=void 0;i<r.length;i++)n=r[i-1],o=r[i],t.push(e._e().objects.overlay.addFeature(new Xe(e,j(n,o,.5),i,dt)))},removeShapePnts:function(e,t,r){function i(t){for(var i=0;i<t.length;i++)t[i].id!=r&&nt(e,t[i]);t.length=0}var n=qe(e),o=n.vShps;return t||i(n.shps),(o.length||t)&&i(o),e},moveShapeAtIndexTo:function(e,t,r,i){var n=e.coord(),o=qe(e,"shps"),s=(r=m([],r,!0))[0],a=r[1],d=r[2],u=n[t][0]!=s||n[t][1]!=a||(n[t][2]||0)!=(d||0);n[t][0]=s,n[t][1]=a,"number"==typeof d&&(n[t][2]=d),rt(e),it(e,n),dt.hideDirection(e);var p=o[t];return!i&&p&&(e._e().objects.overlay.setFeatureCoordinates(p,r),p.__.cLinks.forEach((function(t){var i=t.link;!e._e()._config.editRestrictions(i,1)&&dt.moveShapeAtIndexTo(i,t.index,r)})),ot(p,dt.checkOverlapping(e,t))),u},deleteShape:function(e,t,r){var i="number"==typeof t?t:t.getIndex(),n=e.coord();if(n.length>2){n.splice(i,1);var o=qe(e),s=o.shps;s.length&&(nt(e,s[i]),s.splice(i,1),s.forEach((function(e){e.__.index-=Number(e.getIndex()>=i)})),qe(e,"selectedShapes").splice(i,1)),rt(e),it(e,n);var a=e.getZLevels();a.splice(i,1),e._e().objects.history.ignore((function(){e.getProvider().writeZLevels(e,a)})),r||dt.markAsModified(e),o.isSelected&&dt.refreshGeometry(e)}},showDirection:function(e){if(!e.editState("removed")){var r=(""+e.getProvider().readDirection(e)).toUpperCase(),i=void 0,n=void 0,o=void 0,s=void 0,a=void 0;if(dt.hideDirection(e),"START_TO_END"==r?s=90:"END_TO_START"==r&&(s=-90),null!=s){var d=qe(e).arrows=[];i=e.geometry.coordinates;for(var u=0;u<i.length-1;u++)n=i[u],o=i[u+1],a=t.calcBearing(n,o)-s,d.push(e._e().objects.overlay.addPoint(j(n,o,.5),{type:"NAVLINK_DIRECTION",bearing:a}))}}return e},displayAsSelected:function(e,t,r){var i=qe(e);i.isSelected||(i._cPnt=t),tt(e,{selected:!0})},addShp:function(e,t,r,i,n,o){var s=e.coord(),a=e._e(),d=dt.ignoreZ(e),u=a.map.searchPointOnLine(s,t,a._config.snapTolerance,o,undefined,d);if(r="number"==typeof r?r:null==u?void 0:u.index,!(null==u?void 0:u.existingShape)||n){var p=e.getZLevels();(null==u?void 0:u.existingShape)&&(r=N(s,t)+1),a.map.clipGeoCoord(t),s.splice(r,0,t),function(e,t){for(var r=$e(e,"bn")||[],i=0;i<r.length;i++)r[i]+=r[i]>=t}(e,r),rt(e),it(e,s);var l=Math.round(t[2]<10&&t[2])||0;p.splice(r,0,l),a.objects.history.ignore((function(){e.getProvider().writeZLevels(e,p)}));var c=qe(e,"shps");c.length&&(c.splice(r,0,dt.createLinkShape(e,t,r)),c.forEach((function(e){e.__.index+=Number(e.getIndex()>r)})),c.forEach((function(t){ot(t,dt.checkOverlapping(e,t.getIndex()))})),qe(e,"selectedShapes").splice(r,0,!1)),dt.refreshGeometry(e)}else if(!i)return!1;return r},snapShape:function(e,t,r,i){for(var n,o=e.getLink(),s=qe(e),a=o._e(),d=o.getProvider().search({point:t,radius:i}),u=d.length;n=d[--u];)if("NAVLINK"==n.class&&n.id!=o.id&&-1==s._cls.indexOf(n)&&n.behavior("snapCoordinates")){var p=a.map.searchPointOnLine(n.geometry.coordinates,t,i,undefined,i,r);if(p)return p.point}},defaults:function(e,t){var r=qe(e);return(!t||t==r._cPnt)&&(r._cPnt=null,tt(e,{selected:!1,hovered:!1}),e)},hideDirection:function(e){var t=qe(e,"arrows");if(t){for(var r=0;r<t.length;r++)e._e().objects.overlay.remove(t[r]);t.length=0}return e},fixGeo:function(e,t,r,i){return ut(e,t,r,i)},connectShpToLink:function(e,t,r,i,n,o){void 0===o&&(o=dt.ignoreZ(e));var s,a=new Je,d=e._e().objects;if(r.id!=e.id){var u=function(e,t,r,i,n,o){var s=e._e(),a=e.coord(),d=null,u=e.getConnectedLinks(t,!0),p=i[0],l=i[1],c=i[2],h=s._config.snapTolerance,f=s.map.searchPointOnLine(r.coord(),i,h,n,undefined,o);if(a[t][0]=p,a[t][1]=l,a[t][2]=c||0,dt._setCoords(e,a),f){var v=s.map.clipGeoCoord(f.point),g=f.existingShape;d=s.objects.splitLinkAt(g?{link:r,index:f.index,avoidSnapping:!0,ignoreZ:o}:{link:r,point:v,preferSegment:n,avoidSnapping:!0,ignoreZ:o}),dt.moveShapeAtIndexTo(e,t,v),u.forEach((function(e){var t=e.link;dt.moveShapeAtIndexTo(t,e.index,v),ut(t,e.index),dt.markAsModified(t,!1,!1),dt.defaults(t)}))}return d}(e,t,r,i,n,o);if(null===u)return null;t>0&&t<e.geometry.coordinates.length-1&&(qe(e,"isSelected")&&st(e._e()),dt.deHighlight(e),s=d.splitLinkAt({link:e,index:t}));var p=e.geometry.coordinates;2==p.length&&p[0][0]==p[1][0]&&p[0][1]==p[1][1]&&d.remove(e),dt.markAsModified(e),qe(e,"isSelected")&&dt.refreshGeometry(e),u&&(a.targetSplittedInto=u),s&&(a.splittedInto=s)}return a},isIntersection:function(e,t,r,i){var n=Math.pow(10,e._config.intersectionScale),o=function(e){return Math.round(e*n)};return o(t[0])==o(r[0])&&o(t[1])==o(r[1])&&(i||o(t[2]||0)==o(r[2]||0))}};function ut(e,t,r,i){var n=e._e(),o=n.objects,s=!r,a=t||0,d=e.getZLevels(),u=d.length,p=undefined===t?u:a+1,l=!0,c=n._config.snapTolerance;function h(a){if(i==a)return!0;function u(e){return 0==e||e==g-1}function p(t){for(var r=e.getConnectedLinks(t,!0),i=0,n=r;i<n.length;i++){var o=n[i],s=o.link,a=o.index;dt.moveShapeAtIndexTo(s,a,h,!0)&&dt.markAsModified(s,!1)}return r}for(var l,h,f=e.coord(),v=qe(e),g=f.length,y=!1,A=!1,m=function(i){if(a!=i&&function(e,t,r,i,o){return void 0===o&&(o=1),Number(r)==Number(i)&&n.map.distance(e,t)<=o}(f[i],f[a],d[i],d[a],c)){if(l=Math.abs(a-i)-1,u(i)&&u(a)?1==l?y=a:A=i:u(a)?l<=1?y=a:A=i:u(i)?(1==l&&a>i&&(y=i),0==l?y=a:l>0?A=a:y=i):0==l?y=a:A=i,!1!==A){var m,_,S=void 0;if(h=f[A],2==g){var L=p(t);dt.moveShapeAtIndexTo(e,a==A?i:a,h),st(e._e()),o.remove(dt.deHighlight(e)),L.forEach((function(e){s||ut(e.link,e.index)}))}else p(a),dt.moveShapeAtIndexTo(e,a,h),(_=o.splitLinkAt({link:e,index:A===g-1||0===A?~~(g/2):A})).forEach((function(t,i){ut(t,undefined,r.concat(e,_[Number(0==i)]))})),!(S=_[Number(a>=A)]).editState("removed")&&Math.abs(a-A)>=2&&(S.coord().forEach((function(e,t){e[0]==h[0]&&e[1]==h[1]&&(m=t)})),m&&o.splitLinkAt({link:S,index:m}));return{value:!1}}if(!1!==y){var b=f[i][0],k=f[i][1],C=!1;e.getConnectedLinks(y,!0).forEach((function(e){var t,i=e.link;dt.markAsModified(i,!1),dt.moveShapeAtIndexTo(i,e.index,[b,k],!0),t=i,C=!(s||-1!=r.indexOf(t))})),dt.moveShapeAtIndexTo(e,a==i?i:a,[b,k],!0),dt.deleteShape(e,y,!0),u(y)&&(!u(a)&&a-1>0&&dt.moveShapeAtIndexTo(e,a-1,[b,k],!0),v.isSelected&&dt.refreshGeometry(e),C&&f.length>2&&o.splitLinkAt({link:e,index:i-Number(0===y)}));var E=a-i,x=void 0;return E>0?x=a-1-l:E<0&&(x=a+l),{value:x}}}},_=0;_<g;_++){var S=m(_);if("object"==typeof S)return S.value}return!0}if(null==c&&(c=2),!e.editState("removed")&&a<u)for(r=s||!r?[]:r;a<p&&!0===(l=h(a));a++);return l}var pt={MARKER:C,AREA:he,LINE:ke,NAVLINK:dt,PLACE:je,ADDRESS:je};je.setLinkTools(dt);var lt=function(e){return function(t){var r=t.class,i=pt[r][e];if(i)return i.apply(i,arguments)}},ct={getTools:function(e){return pt[e.class]},getTool:function(e,t){var r=this.getTools(e);return r&&t?r[t]:r},private:lt("private"),getEventListener:function(e,t){var r=this.getTools(e);return r?r._evl[t]||r.private(e,t):e.__&&e.__[t]||e[t]}};for(var ht in pt)for(var ft in pt[ht])ct[ft]||(ct[ft]=lt(ft));var vt=function(t,r,i,n,o,s){void 0===s&&(s=function(e){var t=function(t,r){var i=e.behavior&&e.behavior(t);if(i)return"string"==typeof i&&(i=r[i.split("").sort().join("").toUpperCase()]),i},r=t("dragPlane",{XY:[0,0,1],XZ:[0,1,0],YZ:[1,0,0]});if(r)return{plane:r};var i=t("dragAxis",{X:[1,0,0],Y:[0,1,0],Z:[0,0,1]});return i?{axis:i}:{plane:[0,0,1]}}(i));var a,d=(o=o||i._e()).display,u=d._unprj(t,r,-1),p=d._unprj(t,r,0),l=e.sub([],p,u),c=d._g2w(n),h=void 0===n[2];if(s.plane)a=B(l,u,s.plane,c);else{var f=s.axis,v=d._prj(c)[2],g=c,y=e.add([],c,f),A=d._unprj(t,r,v),m=e.normalize([],e.cross([],e.sub([],A,y),e.sub([],g,y))),_=B(l,u,m,c);if(_){var S=e.add([],c,f);a=D(S,c,_)}}return a&&((n=o.map.clipGeoCoord(d._w2g(a),!0))[2]<0&&(n[2]=0),h&&0===n[2]&&n.pop()),n},gt=function(){},yt=gt.prototype;yt.created=!1,yt.modified=!1,yt.removed=!1,yt.split=!1,yt.selected=!1,yt.hovered=!1;var At=function(e){return 3==e.length?[e[0],e[1],e[2]]:[e[0],e[1]]},mt=function(e){for(var t=[],r=0;r<e.length;r++)for(var i=e[r],n=t[t.length]=[],o=0;o<i.length;o++)n[o]=At(i[o]);return t},_t=function(e){function t(t,r){var i=e.call(this,t,r)||this;return i.properties=i.properties||{},i.properties["@ns:com:here:editor"]=new gt,i}return y(t,e),t.prototype.toString=function(){return this.class+"  "+this.id},t.prototype.getProvider=function(){return this._provider},t.prototype._e=function(){return this._provider._e},t.prototype._t=function(e){return e?ct.getTool(this,e):ct.getTools(this)},t.prototype.editState=function(e,t){var r=arguments.length,i=this,n=i.properties["@ns:com:here:editor"];if(!r)return n;if(2==r){if(this._esu)return;t?n[e]=t:delete n[e],"hovered"!=e&&"selected"!=e&&i._e().objects.history.ignore((function(){i._esu=!0,i.getProvider().writeEditState(i,e),i._esu=undefined}))}return n[e]},t.prototype.style=function(e){var t=this;if("string"==typeof e||0==arguments.length)return this._e().getStyle(t,undefined);this._e().setStyle(t,e,!0)},t.prototype.prop=function(e,t){var r=this,n=!1,o=arguments.length,s=r.getProvider().getFeatureProperties(r);if(!o||1==o&&"string"==typeof e)return"object"==typeof(e=e?s[e]:s)?i.extend(!0,new e.constructor,e):e;if(2==o){var a={};a[e]=arguments[1],e=a}for(var d in e){var u=e[d],p="object"==typeof u,l=s[d];(p&&JSON.stringify(u)!=JSON.stringify(l)||!p&&l!==u)&&(n||(this._e().objects.history.origin(r),n=!0),s[d]=u)}n&&(this._e().setStyle(r),ct.markAsModified(r))},t.prototype.getCoordinates=function(){return this.coord()},t.prototype.coord=function(e){var t=this,r=t.geometry.type;if(!(e instanceof Array))return e=t.getProvider().decCoord(t),"Point"==r?At(e):"Polygon"==r||"MultiLineString"==r?mt(e):"MultiPolygon"==r?e.map((function(e){return mt(e)})):mt([e])[0];ct.deHighlight(t),ct._setCoords(t,e),ct.markAsModified(t)},t.prototype.editable=function(e){return ct._editable(this,e),this.unselect(),this},t.prototype.select=function(){ct._select(this)},t.prototype.unselect=function(){ct.private(this,"isSelected")&&this._e().objects.selection.clearSelected()},t.prototype.transform=function(){this._e().transformer.show(this)},t.prototype.remove=function(){this._e().objects.remove(this,{save:!0})},t}(d);_t.prototype.id=null;var St=function(e,t,r,i,n,o,s){this.type=e,this.timeStamp=Date.now(),this.mapX=t,this.mapY=r,this.nativeEvent=i,this.button=n,this.target=o,this.detail=s},Lt=St.prototype;Lt.nativeEvent=null,Lt.detail=null,Lt.target=null,Lt.mapX=null,Lt.mapY=null,Lt.type=null,Lt.button=null,Lt.timeStamp=null,Lt.toString=function(){return"EditorEvent "+this.type};var bt=function(e){function t(t,r,n,o,s){var a=e.call(this,{type:"Feature",geometry:{type:"Point",coordinates:o},properties:{"@ns:com:here:editor":{},index:n,isMoved:!1}},t.overlay.getProvider())||this,d=t.getFeature().geojson,u=a,p=s.toUpperCase();return u.properties[p]={properties:i.extend(!0,{},d.properties),style:r.getStyle(d)},u._b=t,u.__={pointerdown:function(){this.properties.isMoved=!1,this.properties.p=r.display.geoToPixel.apply(r.display,this.geometry.coordinates)},pressmove:function(e,i,n,o,s){var a=this,d=this.properties.p,u=r.map.getGeoCoord(d.x+i,d.y+n);t.getFeature().update(this.properties.index,u),a._provider.setFeatureCoordinates(a,u.slice()),a.isMoved=!0},pointerup:function(e){this.properties.isMoved||r.listeners.trigger(e,this)}},a.class=p+"_SHAPE",a}return y(t,e),t.prototype.remove=function(){var e=this;e.__=null,e._b.removeShape(e.properties.index)},t.prototype.getLength=function(){return this._b.getLength()},t.prototype.getIndex=function(){return this.properties.index},t}(d),kt=function(){function e(e,t){this.type="LineString",this.path=[],this.geojson=e.addFeature({type:"feature",geometry:{type:"LineString",coordinates:[t,[t[0]-1e-6,t[1]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}return e.prototype.update=function(e,t){var r=this.path;t&&(r[e]=t),r.length>1&&this.overlay.setFeatureCoordinates(this.geojson,this.createGeo(r))},e.prototype.removeAt=function(e){this.path.splice(e,1)},e.prototype.createGeo=function(e){if(e.length>1)return e.slice()},e.prototype.isValid=function(e){return!!e||this.path.length>1},e}(),Ct=function(){function e(e,t){this.path=[],this.type="MultiPolygon",this.geojson=e.addFeature({type:"feature",geometry:{type:"MultiPolygon",coordinates:[[[t,[t[0]-1e-6,t[1]],[t[0]-1e-6,t[1]-1e-6],t]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}return e.prototype.update=function(e,t){var r=this.path;if(t&&(r[e]=t),r.length>2){var i=this.createGeo(r);i&&this.overlay.setFeatureCoordinates(this.geojson,i)}},e.prototype.createGeo=function(e){if(e.length>2)return[[e.concat([e[0]])]]},e.prototype.removeAt=function(e){this.path.splice(e,1)},e.prototype.isValid=function(e){return e?(e.push(e[0].slice()),e.length<4||he.validateGeometry(e)):this.path.length>2},e}(),Et=[{type:"Circle",zIndex:0,stroke:"#FFFFFF",fill:"#000000",strokeWidth:2,radius:6}],xt=[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#ffffff"}];function Pt(e,t){var r=i.clone(e||Et);return r.forEach((function(e){return e.zIndex=(0^e.zIndex)+t})),r}var It=function(){function e(e,t,r){this.shapes=[],this.originLink=null,this.originPos=null;var i=this;i.overlay=e,i.iEdit=t,i.display=r,i.onBoardUp=i.onBoardUp.bind(i),i.updateCursor=i.updateCursor.bind(i)}return e.prototype.onBoardUp=function(){this.mousedown=!1},e.prototype.updateCursor=function(e){var t=this,r=t.iEdit,i=t.feature,n=t.shapes,o=t.display,s=t.cursor,a=t.mousedown,d=t.overlay;if(a){var u=r.map.getEventsMapXY(e),p=s.properties.prevPos;o.lockViewport().pan||o.pan(u[0]-p[0],u[1]-p[1],0,0),p[0]=u[0],p[1]=u[1]}else{var l=r.map.getGeoCoord(r.map.getEventsMapXY(e)),c=n.map((function(e){return e.geometry.coordinates}));c.push(l);var h=i.isValid(c);if(h!=!this.inValid){var f=this.style.feature;h?(f=this.inValid,this.inValid=!1):(this.inValid=f,f=[A(A({},f[0]),{fill:"rgba(0,0,0,0)"})]),r.setStyle(i.geojson,f)}i.update(n.length,l),d.setFeatureCoordinates(s,l)}},e.prototype.init=function(){var e=this,t=e.iEdit,r=e.display,i=e.overlay,o=e.updateCursor,s=r.getViewBounds(),a=[s.minLon,s.maxLat];this.feature=new this.FeatureClass(i,a);var d=i.addCircle(a,Pt(Et,1));d.pointerdown=function(r){var i=d.properties;i.prevPos=t.map.getEventsMapXY(r),e.mousedown=!0,i.panned=!1},d.pressmove=function(e){o(e),d.properties.panned=!0},d.pointerup=function(r){d.properties.panned||e.addShape(t.map.getGeoCoord(r.mapX,r.mapY),undefined,r),e.onBoardUp()},this.cursor=d,this.inValid=!1,n.addEventListener("mousemove",this.updateCursor),n.addEventListener("mouseup",this.onBoardUp)},e.prototype.addShape=function(e,t,r){var i,n=this,o=n.iEdit,s=n.settings,a=n.shapes,d=n.feature;if(t){if(this.originLink=t,i=t.geometry.coordinates,"number"==typeof e)e=i[e].slice(0);else{var u=o.map.searchPointOnLine(i,e,o._config.snapTolerance);!(null==u?void 0:u.existingShape)||0!=u.index&&u.index!=i.length-1||(this.originLink=null),e=null==u?void 0:u.point}this.originPos=e}var p=this.overlay.addFeature(new bt(this,o,a.length,e,s.mode),Pt(this.style.shape,9));return d.update(a.length,e),a.push(p),s.onShapeAdd&&s.onShapeAdd(new St("onShapeAdd",e[0],e[1],r,r&&r.button,p,{index:p.properties.index})),p},e.prototype.setGeom=function(e,t){var r=this.settings;if(e==this.feature.type){this.hide(),this.show(r);var i="LineString"==e?t:t[0][0].slice(0,-1),n=r.onShapeAdd;r.onShapeAdd=null;for(var o=0,s=i;o<s.length;o++){var a=s[o];this.addShape(a)}r.onShapeAdd=n}},e.prototype.removeShape=function(e){var t=this,r=t.shapes,i=t.iEdit,n=t.overlay,o=t.feature,s=t.settings;null==e&&(e=r.length-1);var a=r[e],d=i.map.getGeoCoord(a.geometry.coordinates);n.remove(a),r.splice(e,1),o.removeAt(e);for(var u=e;u<r.length;u++)r[u].properties.index--;o.update(),s.onShapeRemove&&s.onShapeRemove(new St("onShapeRemove",d[0],d[1],undefined,undefined,undefined,{index:e}))},e.prototype.getFeature=function(){return this.feature},e.prototype.getLength=function(){return this.shapes.length},e.prototype.setAttributes=function(e){var t=this,r=t.feature,n=t.iEdit,o=t.cursor,s=t.settings,a=t.shapes;if(e){i.extend(r.properties,e);var d=function(e,t){var r,n,o,s,a=e.mode;if(e.styleGroup)r=e.styleGroup;else if("Navlink"!=a&&"Area"!=a||(t.editState=function(){return{}},t.class=a),r=e.layer.getStyleGroup(t),"Area"!=a)return(s=i.clone(Et))[0].fill=r[0].stroke,(o=i.clone(xt))[0].stroke=(r[1]||r[0]).stroke,{feature:o,shape:s};var d=function(e){return-1!=["Circle","Image","Rect","Text"].indexOf(e.type)};if(o=r.filter((function(e){return!d(e)})),s=r.filter(d),o.length||(o=e.layer.getStyleGroup(t)),!e.styleGroup||!s.length){s=i.clone(Et);var u=o[0];n=u.stroke;var p=void 0;"Area"==a?(p=u.fill,n&&(s[0].stroke=n)):p=n,p&&(s[0].fill=p)}return{feature:o,shape:s}}(s,r.geojson);this.style=d,r.geojson.class=undefined,n.setStyle(r.geojson,d.feature),a.concat(o).forEach((function(e){n.setStyle(e,Pt(d.shape,n.getStyle(e)[0].zIndex))}))}},e.prototype.createGeom=function(){var e=this,t=e.feature,r=e.shapes,i=e.settings,n=i.tolerance,o=r.map((function(e){return e.geometry.coordinates}));"Area"!=i.mode&&n&&(o=R(o,n));var s=t.createGeo(o);if(s)return{type:t.type,coordinates:s}},e.prototype.create=function(e){var t=this,r=t.iEdit,i=t.FeatureClass,n=t.shapes,o=t.feature,s=t.originLink,a=t.originPos,d=t.settings;if(this.setAttributes(e),i==kt){var u=n[0].geometry.coordinates;s&&a[0]==u[0]&&a[1]==u[1]&&r.objects.splitLinkAt({link:r.objects.get(s),point:u})}var p=n.map((function(e){return e.geometry.coordinates}));if(o.isValid(p)){var l=this.createGeom(),c=void 0;return l&&((c=r.objects.create({feature:{type:"Feature",geometry:l,properties:o.properties},provider:d.layer.getProvider()}))&&r.objects.history.saveChanges(),this.hide()),c}throw new Error("Invalid Geometry")},e.prototype.isActive=function(){return this.active},e.prototype.show=function(e){if(!this.active){var t=this.overlay.layer,r=this.iEdit,i=this.display;r.objects.listenDisplay(!1),i.removeLayer(t),i.addLayer(t),r.objects.listenDisplay(!0),this.settings=e,"Area"==e.mode?this.FeatureClass=Ct:this.FeatureClass=kt,this.originLink=null,this.originPos=null,this.active=!0,this.init(),this.setAttributes(e.attributes)}},e.prototype.hide=function(){var e=this,t=e.display,r=e.overlay,i=e.shapes,o=e.feature;if(e.active){e.active=!1;var s=r.layer;t.removeLayer(s),t.addLayer(s),r.remove(o.geojson),e.feature=null,i.forEach((function(e){return r.remove(e)})),i.length=0,r.remove(e.cursor),e.cursor=null,n.removeEventListener("mousemove",e.updateCursor),n.removeEventListener("mouseup",e.onBoardUp)}},e}(),Rt=n.here.xyz.maps.editor,wt=function(){function e(e){this._e=e,this._b=new It(e.objects.overlay,e,e.display),this._a=!1}return e.prototype.addShape=function(e,t){if(this._a)return this._b.addShape(this._e.map.getGeoCoord(e),t)},e.prototype.removeShape=function(e){this._a&&this._b.removeShape(e)},e.prototype.getLength=function(){return this._b.getLength()},e.prototype.cancel=function(){this._b.hide(),this._a=!1},e.prototype.setProperties=function(e){this._a&&this._b.setAttributes(e)},e.prototype.setAttributes=function(e){return this.setProperties(e)},e.prototype.create=function(e){if(this._a){var t=this._b.create(e);return t&&(this._a=!1),t}},e.prototype.start=function(e){var t=(e=A({tolerance:1},e||{})).connectTo,r=e.mode||"Navlink";return r="string"!=typeof r?r===Rt.features.Area?"Area":"Navlink":r.charAt(0).toUpperCase()+r.slice(1).toLowerCase(),e.mode=r,e.attributes=e.properties||e.attributes||{},this.cancel(),e.layer=e.layer||this._e.getLayerForClass(r.toUpperCase()),("Area"!=r||e.layer)&&(this._e.listeners.trigger("_clearOverlay"),this._b.show(e),this._a=!0,e.position&&this.addShape(e.position,t)),this._a},e.prototype.isActive=function(){return this._a},e.prototype.getGeometry=function(){return this._b.createGeom()},e.prototype.setGeometry=function(e){this._b.setGeom(e.type,e.coordinates)},e}();function Ot(e,t){var r,i=4096,n=e.coord().map((function(e){var t=u.geoToPixel(e[0],e[1],i);return[t.x,t.y]}));if("number"==typeof t)r=t;else{var o=u.geoToPixel(t.longitude,t.latitude,i);r=xe(n,[o.x,o.y]).offset}var s=Y(n,V(n)*r),a=u.pixelToGeo(s[0],s[1],i);return{coordinate:[a.longitude,a.latitude],offset:r}}var Nt,Ft=function(e){function r(t,i,n,o,s,a,d,u){var p=e.call(this,{type:"Feature",properties:{relPos:n,dragged:!1,style:r.initStyle(o)},geometry:{type:"Point",coordinates:Ot(i.getMultiLink(),n).coordinate}})||this;return p.snapped=[],p.range=i,p.iEditor=t,p.isLocked=s,p.dragStart=a,p.dragMove=d,p.dragEnd=u,t.objects.overlay.addFeature(p,p.properties.style),p.updatePosition(p.geometry.coordinates,n),p}return y(r,e),r.initStyle=function(e){for(var t=0,r=e=i.clone(e);t<r.length;t++){var n=r[t];n._offsetX=n.offsetX||0,n._offsetY=n.offsetY||0}return e},r.prototype.isSnapped=function(e){return e?this.snapped.indexOf(e)>=0:Boolean(this.snapped.length)},r.prototype.getSnapped=function(e){return this.snapped.find((function(t){return t.range==e}))},r.prototype.snap=function(e){if(!this.isSnapped(e)){for(var t=0,r=this.snapped;t<r.length;t++){if(r[t].range==e.range)return!1}return this.snapped.push(e),!0}},r.prototype.validatePosition=function(e,r){var i,n=this,o=n.range,s=o.options.snapTolerance||1,a={coordinate:e=e||n.geometry.coordinates,offset:r,adjusted:!1},d=o.getOffsets(),u=o.getFromMarker()==this;d[Number(!u)]=r,d=d.sort((function(e,t){return e-t}));for(var p=0,l=n.range.getMultiLink().getRanges();p<l.length;p++){var c=l[p];if(c!=n.range){var h=c.getOffsets(),f=c.getMarkers(),v=f[0],g=f[1],y=c.getSide();if(o.allowSnap(y)&&!this.isSnapped(v)&&!this.isSnapped(g)){var A=t.distance(e,v.geometry.coordinates),m=t.distance(e,g.geometry.coordinates);if(Math.min(A,m)<s||o.overlaps(h,d)){var _=A<m?v:g;this.snap(_)}}var S=this.getSnapped(c);if(S){var L=h.indexOf(S.getRelPos());h[L]=r,h=h.sort((function(e,t){return e-t}))}if(!o.allowOverlap(y)&&o.overlaps(h,d)){i=c;break}}}if(i){var b=i.getMarkers(),k=(v=b[0],g=b[1],this.range.getFromMarker()==this?g:v);a.offset=k.getRelPos(),a.coordinate=k.geometry.coordinates,a.adjusted=!0}return a},r.prototype.updatePosition=function(e,t){var r=this,i=r.properties.style,n=r.range.getMultiLink().coord(),o=N(n,e),s=r.range.getSide(),a=n[o],d=n[o+1],u=d[0]-a[0],p=d[1]-a[1],l=180*-Math.atan2(p,u)/Math.PI,c=Math.sqrt(u*u+p*p),h=p,f=u;c&&(h/=c,f/=c);for(var v=0,g=i;v<g.length;v++){var y=g[v];if(y.rotation=l,"B"!=s){var A=y._offsetX,m=y._offsetY;m+=y.lineOffset,y.offsetX=h*m+f*A,y.offsetY=f*m+-h*A}}r.getProvider().setFeatureCoordinates(r,e),r.properties.relPos=t;for(var _=0,S=this.snapped;_<S.length;_++){var L=S[_];L.updatePosition([e[0],e[1]],t),L.range.update()}return e.slice()},r.prototype.pressmove=function(e){var t=this;if(!t.isLocked()){var r=e.detail.display,i=Ot(t.range.getMultiLink(),r.pixelToGeo(e.mapX,e.mapY)),n=i.offset,o=i.coordinate,s=this.validatePosition(o,n);t.updatePosition(s.coordinate,s.offset),t.dragMove(e),t.properties.dragged=!0}},r.prototype.pointerdown=function(e){this.dragStart(e),this.properties.dragged=!1,this.validatePosition(this.geometry.coordinates,this.getRelPos())},r.prototype.pointerup=function(e){this.properties.dragged&&this.dragEnd(e),this.snapped.length=0},r.prototype.remove=function(){this.getProvider().removeFeature(this)},r.prototype.getRelPos=function(){return this.properties.relPos},r.prototype.getRelPosOfSubLink=function(e){var t=this.iEditor,r=this.geometry.coordinates,i=t.map.getPixelCoord(r),n=N(this.range.getMultiLink().coord().map((function(e){return t.map.getPixelCoord(e)})),i);if(n>=e.from&&n<e.to){var o=e.lineString.map((function(e){return t.map.getPixelCoord(e)})),s=Ee(i,e.reversed?o.reverse():o);return s>.995?1:Math.round(1e9*s)/1e9}return n<e.from?0:1},r}(d);!function(e){e.L="#ff4040",e.R="#4cdd4c",e.B="#35b2ee"}(Nt||(Nt={}));var Tt=function(){function e(e,t,r){var i=this;this.options=A({_dragStart:function(e,t){},_dragMove:function(e,t){},_dragStop:function(e,t){}},r);var n=r.id;null!=n&&(this.id=n);var o=JSON.parse(JSON.stringify(r.style||{}));this.ml=e;var s=this.getSide(),a=o.opacity,d=o.fill,u=o.stroke;d&&!u&&(u=d,d=!1),d||(d=u,u="#fff"),d=d||Nt[s];var p=r.lineStyle||function(e,t,r){return void 0===t&&(t=.75),[{zIndex:4,type:"Line",strokeWidth:9,opacity:t,stroke:e}]}(d,a);this.line=t.addPath(e.coord(),this.style=p);for(var l=0,c=0,h=p;c<h.length;c++){l=h[c].offset||l}for(var f=r.markerStyle||function(e,t,r,i){var n="R"==i?8:"L"==i?-8:0;return[{zIndex:110,type:"Rect",fill:t,width:2,height:20,alignment:"map",offsetY:n},{zIndex:111,type:"Circle",fill:e,radius:7,alignment:"map",stroke:t,strokeWidth:1,offsetY:2.5*n},{zIndex:110,type:"Circle",stroke:t,radius:5,alignment:"map"}]}(d,u,0,s),v=0,g=f;v<g.length;v++){var y=g[v];null==y.lineOffset&&(y.lineOffset=l)}this.markers=["from","to"].map((function(t){return new Ft(e.iEdit,i,r[t],f,(function(){return i.locked()}),(function(e){i.options._dragStart(e,i)}),(function(e){i.update(),i.updateSegments(),i.options._dragMove(e,i)}),(function(e){i.options._dragStop(e,i)}))})),this.overlay=t,this.updateSegments()}return e.prototype.updateSegments=function(){this.segments=this.ml.getZoneSegments(this)},e.prototype.getSide=function(){return this.options.side.toUpperCase()},e.prototype.getOffsets=function(){var e=this.markers[0].getRelPos(),t=this.markers[1].getRelPos();if(e>t){var r=e;e=t,t=r}return[e,t]},e.prototype.allowSide=function(e,t){var r=[];return"boolean"==typeof(t=t||[])?t:("string"==typeof t?r.push(t):Array.isArray(t)&&(r=t),-1!=r.indexOf(e))},e.prototype.allowOverlap=function(e){return this.allowSide(e,this.options.allowOverlap)},e.prototype.allowSnap=function(e){return this.allowSide(e,this.options.snap)},e.prototype.getMarkers=function(){return this.markers.sort((function(e,t){return e.getRelPos()-t.getRelPos()}))},e.prototype.getFromMarker=function(){var e=this.markers,t=e[0].getRelPos(),r=e[1].getRelPos();return e[Number(t>r)]},e.prototype.getMultiLink=function(){return this.ml},e.prototype.remove=function(){this.overlay.remove(this.line),this.markers[0].remove(),this.markers[1].remove()},e.prototype.locked=function(){return!!this.options.locked},e.prototype.overlaps=function(e,t){t=Array.isArray(t)?t:this.getOffsets(),e=Array.isArray(e)?e:e.getOffsets();var r=t.sort((function(e,t){return e-t})),i=r[0],n=r[1],o=e.sort((function(e,t){return e-t})),s=o[0],a=o[1];return Math.max(0,Math.min(n,a)-Math.max(i,s))>0},e.prototype.update=function(){for(var e=this.getOffsets(),t=e[0],r=e[1],i=0,n=this.style;i<n.length;i++){var o=n[i];o.from=t,o.to=r}this.overlay.layer.setStyleGroup(this.line,this.style),this.updateSegments()},e}();function Mt(e,t){return e.concat(t.slice(1))}function Dt(e,t,r,i){return{zIndex:e,type:"Line",stroke:t,strokeWidth:r,strokeDasharray:i||"none",strokeLinejoin:"round",strokeLinecap:i?"butt":"round"}}var Bt,jt=function(){return[Dt(0,"white",23),Dt(1,"grey",20),Dt(2,"white",3,[5,4])]},Gt=function(){function e(e,t,r,i){this.ranges=[],this.links=[];var n=e.objects.overlay;this.iEdit=e,this.completePath=t;var o=this.style=r||jt();this.overlay=n,this.feature=n.addPath(t,o),this.hide(),this.links.push({from:0,to:t.length-1,feature:i,lineString:t,reversed:!1}),n.setFeatureCoordinates(this.feature,this.completePath)}return e.prototype.updateStyle=function(e){e=e||jt(),this.style=e,this.overlay.layer.setStyleGroup(this.feature,e)},e.prototype.removeZones=function(){this.ranges.forEach((function(e){e.remove()})),this.ranges.length=0},e.prototype.coord=function(){return this.completePath.map((function(e){return e.slice()}))},e.prototype.hide=function(){this.overlay.remove(this.feature)},e.prototype.show=function(e){var t=this,r=this.overlay;this.removeZones(),r.addFeature(this.feature,this.style),e.forEach((function(e){if(-1!=["L","R","B"].indexOf(e.side)){var i=new Tt(t,r,e);t.ranges.push(i),i.update()}}))},e.prototype.addLink=function(e,t){var r=this,n=this.links;function o(e,t){return e[0]===t[0]&&e[1]===t[1]}t instanceof d&&dt.defaults(t);var s=function(o,s,d){var u=i.clone(e);if(d&&u.reverse(),0===o){for(var p=0;p<n.length;p++)n[p].from+=s,n[p].to+=s;r.completePath=Mt(u,a)}else r.completePath=Mt(a,u);n.unshift({from:o,to:s,feature:t,lineString:e,reversed:!!d})},a=this.completePath;o(e[e.length-1],a[0])?s(0,e.length-1):o(e[0],a[0])?s(0,e.length-1,!0):o(e[0],a[a.length-1])?s(a.length-1,a.length+e.length-2):o(e[e.length-1],a[a.length-1])&&s(a.length-1,a.length+e.length-2,!0),this.overlay.setFeatureCoordinates(this.feature,this.completePath)},e.prototype.destroy=function(){this.hide(),this.removeZones()},e.prototype.getRanges=function(){return this.ranges},e.prototype.getZoneSegments=function(e){var t=e.markers[0],r=e.markers[1],i=[];function n(e){var t=e[0];e[0]=e[1],e[1]=t}return this.links.forEach((function(e){var o=[t.getRelPosOfSubLink(e),r.getRelPosOfSubLink(e)];o[0]>o[1]&&n(o),e.reversed&&(n(o),o[0]=1-o[0],o[1]=1-o[1]),i.push({navlink:e.feature,feature:e.feature,from:o[0],to:o[1],reversed:e.reversed})})),i},e}(),zt=function(){function e(e){this.multiLink=null,this.lines=[],this.iEditor=e,this.display=e.display}return e.prototype.isConnected=function(e,t,r){for(var i=[0,e.length-1],n=0,o="number"==typeof r?[r]:[0,t.length-1];n<o.length;n++)for(var s=o[n],a=t[s],d=0,u=i;d<u.length;d++){var p=u[d];if(dt.isIntersection(this.iEditor,e[p],a))return{i1:p,i2:s}}return null},e.prototype.getOppositeNodeIndex=function(e,t){return 0==t?e.length-1:0},e.prototype.getCollection=function(){return this.multiLink},e.prototype.show=function(e){this.multiLink&&this.multiLink.show(e)},e.prototype.hide=function(){for(var e=this.multiLink,t=0,r=this.lines;t<r.length;t++){var i=r[t].feature;i instanceof _t&&dt.defaults(i)}this.lines=[],e&&(e.destroy(),this.multiLink=null)},e.prototype.addLineSegment=function(e){var t,r,i=this.multiLink,n=this.lines,o=e.coordinates,s=e.feature;if(null!=o){if(t=!n.length)i=new Gt(this.iEditor,o,this.mlStyle,s),this.multiLink=i,this.first={lineString:o,index:null},r=!0;else{for(var a=0,d=n;a<d.length;a++){var u=d[a].id;if(e.id==u)return!1}var p=this.first.lineString,l=this.isConnected(o,p,this.first.index);l?this.last?this.first={lineString:o,index:this.getOppositeNodeIndex(o,l.i1)}:(this.first.index=this.getOppositeNodeIndex(p,l.i2),this.last={lineString:o,index:this.getOppositeNodeIndex(o,l.i1)}):this.last&&(l=this.isConnected(o,this.last.lineString,this.last.index))&&(this.last={lineString:o,index:this.getOppositeNodeIndex(o,l.i1)}),l&&i.addLink(o,s)}r&&(s instanceof _t&&dt.deHighlight(s),n.push(e))}return!!t},e.prototype.setMLStyle=function(e){this.mlStyle=e,this.multiLink&&this.multiLink.updateStyle(e)},e}(),Kt=function(){function e(){this.listeners=new o(["tap","dbltap","pointerdown","pointerup","pointerenter","pointerleave","dragStart","dragStop","dragMove","featureUnselected","error","_domResize","_panMap","_layerAdd","_layerRemove","_clearOverlay","_beforeSubmit","_afterSubmit"]).sync(!0)}return e.createEditorEvent=function(e,t,r,i){return new St(r||e.type,e.mapX,e.mapY,e.nativeEvent,e.button,t,i||e.detail)},e.prototype.trigger=function(t,r,i){var n,o,s,a,d=i||t.type||t;return(a=r)&&a.class?(o=t.detail,s=r):o=r,"touchend"==t.type&&(t=t.changedTouches[0]),n=this.listeners.trigger(d,e.createEditorEvent(t,s,d,o),function(e){return"_"==e[0]}(d)),"pointerup"==d&&(n=this.listeners.trigger("tap",[new St("tap",t.mapX,t.mapY,t.nativeEvent,t.button,s,o)],!1)||n),n},e.prototype.add=function(e,t,r){return this.listeners.add(e,t,r)},e.prototype.remove=function(e,t,r){return this.listeners.remove(e,t,r)},e.prototype.supported=function(){return this.listeners.getEvents()},e.prototype.destroy=function(){this.listeners=null},e}(),Ht=function(e){var t=e.options;return{id:t.id,from:t.from,to:t.to,side:t.side,style:t.style,segments:e.segments}},Vt=function(){function e(e){this.links=new zt(e)}return e.prototype.add=function(e){for(var t,r=Array.isArray(e)?e:[].slice.call(arguments),i=0,n=r;i<n.length;i++){var o=n[i],s=void 0;(o instanceof _t||"LineString"==(null===(t=o.geometry)||void 0===t?void 0:t.type))&&(s=o.geometry.coordinates),s&&this.links.addLineSegment({id:o.id||1e9*Math.random()^0,coordinates:s,feature:o})}},e.prototype.show=function(e){var t=this.ranges=e instanceof Array?e:[].slice.call(arguments);t.forEach((function(e){e.from=e.from||0,e.to=(null==e.to?1:e.to)||0,null==e.allowOverlap&&(e.allowOverlap=!0);for(var t=0,r=["markerStyle","lineStyle"];t<r.length;t++){var i=r[t],n=e[i];n&&!Array.isArray(n)&&(e[i]=[n])}for(var o=function(t){var r=e[t];r&&(e["_"+t]=function(e,i){e.detail.range=e.detail.zone=Ht(i),r(Kt.createEditorEvent(e,e.target,t))})},s=0,a=["dragStart","dragMove","dragStop"];s<a.length;s++){o(a[s])}})),this.links.show(t)},e.prototype.hide=function(){return this.links.hide()},e.prototype.info=function(){var e=[],t=this.links.getCollection();t&&t.getRanges().forEach((function(t){e.push(Ht(t))}));return e},e.prototype.setStyleGroup=function(e){this.links.setMLStyle(e)},e}(),Yt=function(e){function t(t,r,i,n,o,s){void 0===o&&(o={});var a=this,d={type:"Feature",geometry:{type:"Point",coordinates:r},properties:o};return(a=e.call(this,d,i.layer.getProvider())||this)._o=i,a.transformer=n,i.addFeature(a,s),a}return y(t,e),t.prototype.setPosition=function(e,t){this.getProvider().setFeatureCoordinates(this,[e,t])},t.prototype.getCenter=function(){return this.geometry.coordinates.slice()},t.prototype.hide=function(){this._o.hideFeature(this)},t.prototype.show=function(){this._o.showFeature(this)},t.prototype.remove=function(){this._o.remove(this)},t.prototype.enableHover=function(e,t){var r=this;this.__.pointerenter=this.__.pointerleave=function(t){var i="pointerenter"==t.type;document.body.style.cursor=i?e:"default",r.properties["@ns:com:here:editor"].hovered=i,r.properties.hovered=i,r._o.layer.setStyleGroup(r)}},t}(d),Ut=function(e){function r(r,i,n,o){var s,a,d,u,p=e.call(this,r,i,n,o,{type:"TRANSFORMER_ROTATE_KNOB"})||this,l=null;return u=0,p.__={pressmove:function(e,i,n){s=!0;var p=t.calcBearing(d,r.map.getGeoCoord(e.mapX,e.mapY))-l;o.setRotation(p);for(var c=0,h=a;c<h.length;c++){var f=h[c];ct._setCoords(f,r.map.rotateGeometry(f.geometry,d,p-u))}u=p},pointerdown:function(e){s=!1,d=o.getCenter(),null==l&&(l=t.calcBearing(d,r.map.getGeoCoord(e.mapX,e.mapY))),a=o.getFeatures()},pointerup:function(){s&&(a.length>1||"Point"!=a[0].geometry.type)&&o.markObjsAsMod(),a=null,d=null}},p.enableHover("move"),p}return y(r,e),r.prototype.update=function(){var e=this.transformer.getCorner(Bt.bottomRight,15,15);this.setPosition(e[0],e[1])},r}(Yt),Zt=function(e){function t(t,r,i,n){var o,s,a,d,u,p,l=e.call(this,t,r,i,n,{type:"TRANSFORMER_SCALE_KNOB"})||this;return l.__={pressmove:function(e,r,i){var a=t.map.getGeoCoord(e.mapX,e.mapY),l=D(u,d,a),c=K(l,d)/p,h=c/s;o||n.visible(!(o=!0)),n.scale(h,h),s=c},pointerdown:function(e){o=!1,(d=n.getCenter())[2]=0,(u=l.geometry.coordinates.slice(0,2))[2]=0,p=K(u,d),a=n.getFeatures(),s=1},pointerup:function(){o&&(a.length>1||"Point"!=a[0].geometry.type)&&n.markObjsAsMod(),a=null,d=null,n.visible(!0)}},l.enableHover("nwse-resize"),l}return y(t,e),t.prototype.update=function(){var e=this.transformer.getCorner(Bt.topLeft,-15,-15);this.setPosition(e[0],e[1])},t}(Yt),Wt=function(e){function t(t,r,i,n){var o=e.call(this,t,r,i,n,{type:"TRANSFORMER_TRANSLATE_KNOB"})||this;return o.internalEditor=t,o.__={pointerdown:function(){var e=o.properties;e.moved=!1,e._dx=0,e._dy=0},pressmove:function(e,t,r){var i=o.properties;i.moved=!0,n.pan(t-i._dx,r-i._dy),i._dx=t,i._dy=r},pointerup:function(){o.properties.moved&&n.markObjsAsMod()}},o.enableHover("move"),o}return y(t,e),t.prototype.update=function(){var e=this.transformer.getRotatedBoundingBox(),t=[e[0],e[2]],r=Y(t,.5*V(t));this.setPosition(r[0],r[1])},t}(Yt),Qt=function(){function e(e,t,r,i){var n,o=this,s=r.map,a=!1;this.transformer=e,this.buffer=t;for(var d,u=[i.addRect(0,0,0,0,{type:"TRANSFORMER_SCALE_BOX"})],p=r.getStyle(u[0]),l=0;l<4;l++)u.push(i.addPath([[0,0],[0,0]],[{zIndex:p[0].zIndex+1,zLayer:p[0].zLayer||0,type:"Line",strokeWidth:6}],{index:l,vertical:l%2}));var c=!1;function h(t,r,i){if(!a){var p=this.properties,l=p.index,h=p.vertical,f=l==Bt.topLeft?Bt.bottomLeft:l-1,v=u[f+1].geometry.coordinates;c&&(v=v.reverse(),f=h?f==Bt.bottomRight?Bt.bottomLeft:Bt.bottomRight:f==Bt.bottomLeft?Bt.topRight:Bt.bottomRight);var g=v[0],y=v[1],A=e.getCenter(),m=e.rotation,_=s.getPixelCoord(A),S=s.getPixelCoord(g),L=s.getPixelCoord(y),b=D(S,L,[t.mapX,t.mapY,0]);S=U(S,m,_),L=U(L,m,_),b=U(b,m,_);var k,C=1,E=1;if(h){var x=L[0]-S[0];C=(k=b[0]-S[0])/x}else{var P=L[1]-S[1];E=(k=b[1]-S[1])/P}d!=k>0&&(d=!d,c=!c),Math.abs(k)>o.buffer+6&&(e.scale(C,E,e.getCorner(f)),n=!0)}}function f(){var t=e.getFeatures();a=1==t.length&&"Point"==t[0].geometry.type,n=!1;var r=this.properties,i=r.index,o=r.vertical,p=i==Bt.topLeft?Bt.bottomLeft:i-1,l=u[p+1].geometry.coordinates,h=l[0],f=l[1],v=s.getPixelCoord(h),g=s.getPixelCoord(f),y=e.getCenter(),A=e.rotation,m=s.getPixelCoord(y);v=U(v,A,m),g=U(g,A,m),d=o?g[0]-v[0]>0:g[1]-v[1]>0,c=!1}function v(){n&&e.markObjsAsMod()}function g(){document.body.style.cursor="move"}function y(){document.body.style.cursor="default"}for(l=1;l<u.length;l++){var A=u[l];A.pointerdown=f,A.pressmove=h,A.pointerup=v,A.pointerenter=g,A.pointerleave=y}this.overlay=i,this.features=u,this.iEdit=r,this.update()}return e.prototype.setScale=function(e,t,r){this.transformer.scaleFeatures(this.features,e,t,r)},e.prototype.setRotation=function(e,t){for(var r=0,i=this.features;r<i.length;r++){var n=i[r];n.getProvider().setFeatureCoordinates(n,this.iEdit.map.rotateGeometry(n.geometry,t,e))}},e.prototype.update=function(){var e=this,t=e.buffer,r=e.transformer,i=e.features,n=e.overlay.getProvider(),o=r.getCorner(Bt.topLeft,-t,-t),s=r.getCorner(Bt.topRight,t,-t),a=r.getCorner(Bt.bottomRight,t,t),d=r.getCorner(Bt.bottomLeft,-t,t);n.setFeatureCoordinates(i[0],[[o,s,a,d,o]]),n.setFeatureCoordinates(i[1],[o,s]),n.setFeatureCoordinates(i[2],[s,a]),n.setFeatureCoordinates(i[3],[a,d]),n.setFeatureCoordinates(i[4],[d,o])},e.prototype.hide=function(){var e=this.overlay,t=this.features;e.hideFeature(t)},e.prototype.show=function(){var e=this.overlay,t=this.features;e.showFeature(t)},e.prototype.remove=function(){var e=this.overlay,t=this.features;e.remove(t)},e.prototype.pan=function(e,t){for(var r=0,i=this.features;r<i.length;r++){var n=i[r];this.iEdit.map.pixelMove(n,e,t)}},e}();!function(e){e[e.topLeft=0]="topLeft",e[e.topRight=1]="topRight",e[e.bottomRight=2]="bottomRight",e[e.bottomLeft=3]="bottomLeft"}(Bt||(Bt={}));var Xt=function(){function e(e){this.buffer=15,this.features=null,this.scaleBox=null,this.moveKnob=null,this.rotateKnob=null,this.scaleKnob=null,this.allowEditIds=[],this.rotation=0,this.iEditor=e}return e.prototype.scaleFeatures=function(e,t,r,i){var n=[t,r],o=this.iEditor.map,s=this.rotation,a=this.getCenter();i=o.rotatePoint(i,a,-s);for(var d=0,u=e;d<u.length;d++){var p=u[d],l={type:p.geometry.type,coordinates:p.geometry.coordinates};l.coordinates=o.rotateGeometry(l,a,-s),l.coordinates=o.scaleGeometry(l,n,i),l.coordinates=o.rotateGeometry(l,a,s);try{ct._setCoords(p,l.coordinates)}catch(e){p.geometry.coordinates=l.coordinates}}},e.prototype.restoreFeaturesEditable=function(){for(var e=0,t=this.features;e<t.length;e++){var r=t[e];this.allowEditIds.indexOf(r.id)>=0&&ct._editable(r,!0)}},e.prototype.setRotation=function(e){var t=e-this.rotation,r=this.getCenter(),i=this.bbox.geometry;i.coordinates=this.iEditor.map.rotateGeometry(i,r,t),this.scaleBox.setRotation(t,r),this.scaleKnob.update(),this.rotateKnob.update(),this.rotation=e},e.prototype.markObjsAsMod=function(){for(var e=this.features,t=0,r=e;t<r.length;t++){var i=r[t];ct.markAsModified(i,!1)}e.length&&this.iEditor.objects.history.saveChanges()},e.prototype.getFeatures=function(){return this.features},e.prototype.visible=function(e){var t=this,r=t.rotateKnob,i=t.scaleKnob,n=t.moveKnob,o=t.scaleBox;r&&(e?(o.show(),r.show(),i.show(),n.show()):(o.hide(),r.hide(),i.hide(),n.hide()))},e.prototype.isActive=function(){return null!==this.scaleBox},e.prototype.hide=function(){var e=this,t=e.features,r=e.rotateKnob,i=e.scaleKnob,n=e.moveKnob,o=e.scaleBox;o&&(o.remove(),r.remove(),i.remove(),n.remove()),this.scaleBox=this.moveKnob=this.rotateKnob=null,this.rotation=0,null!=t&&(this.restoreFeaturesEditable(),this.allowEditIds.length=0,this.features=null)},e.prototype.update=function(){this.scaleBox.update(),this.scaleKnob.update(),this.rotateKnob.update(),this.moveKnob.update()},e.prototype.offsetCorner=function(e,t,r){var i=this.iEditor.map,n=this.getCenter(),o=this.rotation;return e=i.rotateGeometry({type:"Point",coordinates:e},n,-o),e=[(e=i.getPixelCoord(e))[0]-t,e[1]-r],e=i.getGeoCoord(e),i.rotateGeometry({type:"Point",coordinates:e},n,o)},e.prototype.scale=function(e,t,r){void 0===r&&(r=this.getCenter()),this.scaleFeatures(this.getFeatures(),e,t,r),this.scaleFeatures([this.bbox],e,t,r),this.update()},e.prototype.getCorner=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=0);var i=this.bbox.geometry.coordinates[e][0];return(t||r)&&(i=this.offsetCorner(i,-t,-r)),i},e.prototype.getRotatedBoundingBox=function(e){return e?this.bbox.geometry.coordinates.slice():this.bbox.geometry.coordinates.map((function(e){return e[0]}))},e.prototype.pan=function(e,t){for(var r=this.iEditor.map,i=0,n=this.getFeatures();i<n.length;i++){var o=n[i];r.pixelMove(o,e,t)}var s=this.bbox.geometry;s.coordinates=r.translateGeo(s.coordinates,e,t),this.update()},e.prototype.getCenter=function(){return this.moveKnob.getCenter()},e.prototype.getBBox=function(){for(var e=[1/0,1/0,-1/0,-1/0],t=0,r=this.features;t<r.length;t++){var i=r[t],n=i.getBBox?i.getBBox():i.bbox;n[0]<e[0]&&(e[0]=n[0]),n[1]<e[1]&&(e[1]=n[1]),n[2]>e[2]&&(e[2]=n[2]),n[3]>e[3]&&(e[3]=n[3])}return e},e.prototype.show=function(e){Array.isArray(e)||(e=[e]);var t,r=this.allowEditIds;this.iEditor.listeners.trigger("_clearOverlay"),null!=this.features&&this.restoreFeaturesEditable(),r.length=0,this.features=e;for(var i=0,n=void 0;i<e.length;i++)t=e[i],n=ct.private(t),ct.deHighlight(t),n.isSelected=!1,n.allowEdit&&(r.push(t.id),ct._editable(t,!1));this.initUI()},e.prototype.initUI=function(){var e=this,t=e.iEditor,r=t.objects.overlay;if(!this.scaleBox){var i=this.getBBox(),n=i[0],o=i[1],s=i[2],a=i[3],d=n+(s-n)/2,u=o+(a-o)/2,p=function(e,t,r,i){return[[[e,i],[r,i]],[[r,i],[r,t]],[[r,t],[e,t]],[[e,t],[e,i]]]}(n,o,s,a);this.bbox={type:"Feature",geometry:{type:"MultiLineString",coordinates:p}};var l=new Wt(t,[d,u],r,e);l.update(),e.moveKnob=l;var c=new Qt(e,e.buffer,t,r),h=new Ut(t,[s,o],r,e),f=new Zt(t,[n,a],r,e);h.update(),f.update(),e.rotateKnob=h,e.scaleKnob=f,e.scaleBox=c}},e}(),Jt=["ready","active","history.current","history.length","changes.length"],qt={ready:void 0,active:null},$t=function(){function e(){this.listeners=new o(Jt).sync(!0),this.val={};for(var e,t,r=this.val,i=Jt.length;e=Jt[--i];)t=qt[e],r[e]=undefined!==t&&t}return e.prototype.addObserver=function(e,t,r){var i=this,n=i.val;if("*"==e)for(var o in n)i.addObserver(o,t,r);else i.listeners.add(e,t,r)},e.prototype.removeObserver=function(e,t,r){var i=this,n=i.val;if("*"==e)for(var o in n)i.removeObserver(o,t,r);else i.listeners.remove(e,t,r)},e.prototype.get=function(e){return this.val[e]},e.prototype.change=function(e,t,r){var i=this,n=i.val[e];(r||n!=t&&i.get("active"))&&(i.val[e]=t,i.listeners.trigger(e,[e,t,n]))},e}(),er=function(){function e(e,t){this.s=[],this.zClearFeat=null,this.ie=e,this.display=t;var r=this;if(e._config.keepFeatureSelection){var i=t.getZoomlevel();t.addEventListener("mapviewchangeend",(function(){var e=t.getZoomlevel();if(e!=i){var n=r.getCurSelObj()||r.zClearFeat,o=void 0;n&&(o=n.getProvider().minLevel,i>=o?e<o&&(r.clearSelected(),r.zClearFeat=n):e>=o&&ct._select(n))}i=e}))}}return e.prototype.add=function(e){ct.private(e).isSelected=!0,this.s.push(e)},e.prototype.remove=function(e){var t=this.s;ct.private(e).isSelected=!1,t.splice(t.indexOf(e),1)},e.prototype.select=function(e){var t=this,r=t.display.getZoomlevel(),i=e.getProvider();if(r>=i.minLevel&&r<=i.maxLevel)return t.clearSelected(),this.add(e),!0;t.zClearFeat=e},e.prototype.getCurSelObj=function(){return this.s[0]},e.prototype.unselectFeature=function(e){var t,r=this,i=r.ie;if(e||!i._config.keepFeatureSelection){if(t=r.getCurSelObj()){var n=ct.private(t,"xt");n&&n.clear(),i.listeners.trigger("featureUnselected",{featureUnselected:!0})}r.clearSelected()}},e.prototype.clearSelected=function(){var e,t,r=this,i=this.s,n=this.ie;return n.listeners.trigger("_clearOverlay"),i.forEach((function(e){var i=ct.getTool(e,"deHighlight");i&&(t=e,i(e,!0),r.remove(e)),ct.private(e).isSelected=!1})),i.length=0,this.zClearFeat=null,n.transformer.hide(),null===(e=n._rngSel)||void 0===e||e.hide(),t},e}(),tr="@ns:com:here:editor",rr=function(){function e(){this.steps={}}return e.prototype.clone=function(e){return e?JSON.parse(JSON.stringify(e)):e},e.prototype.add=function(e,t,r){var i=this.steps[e]||{},n=i[t]=i[t]||{},o=r.id;if(!n[o])return n[o]=r,this.set(e,i),!0},e.prototype.remove=function(e,t,r){try{var i=this.steps[e][t],n=r.id;if(i[n])return delete i[n],this.set(e,this.steps[e]),!0}catch(e){}return!1},e.prototype.get=function(e){return this.clone(this.steps[e])},e.prototype.set=function(e,t){this.steps[e]=this.clone(t)},e.prototype.clear=function(){var e=this.steps;for(var t in e)delete e[t]},e}(),ir=function(e){return e.properties[tr]},nr=function(e){var t=e.toJSON(),r=ir(t);return t.class=e.class,r&&(delete r.hovered,delete r.selected),t},or=function(e){var t=ir(e);return t.modified||t.removed||t.split||t.created},sr=function(){function e(e){this.current=0,this.total=0,this.changes={},this.cached=null,this._a=!0;this.iEdit=e,this.storage=new rr}return e.prototype.updateObservers=function(e){var t=this,r=t.iEdit.observers;r.change("changes.length",t.getLength()),r.change("history.length",t.total),r.change("history.current",t.current,e)},e.prototype.getTotal=function(){return this.total},e.prototype.getLength=function(){var e=this.getChanges(),t=0;for(var r in e)for(var i in e[r])ir(e[r][i]).origin||t++;return t},e.prototype.remove=function(e){var t=e.getProvider().id;this.storage.remove(this.current,t,e)&&(delete this.changes[t][e.id],this.cached=null)},e.prototype.origin=function(e,t){var r=e.id,i=e.getProvider().id,n=this.storage,o=this.changes,s=this.current,a=n[s],d=o[i];if(d||(d=o[i]={}),d[r]=e,!a||!a[i]||!a[i][r]){var u=nr(e),p=ir(u);t&&(p.removed=!0),p.origin=!0,n.add(s,i,u)}},e.prototype.saveChanges=function(){var e=this,t=0;if(e.active()){e.cached=null;var r=function(e){var t={},r=0;for(var i in e)for(var n in t[i]={},e[i])t[i][n]=nr(e[i][n]),r++;return{data:t,length:r}}(e.changes);if(t=r.length){var i=++e.current;e.storage.set(i,r.data),i>e.total?e.total++:e.total=i,e.iEdit.dump("History step saved...",i,"warn"),e.changes={},e.updateObservers()}}return t},e.prototype.getHistoryFeature=function(e,t){void 0===t&&(t=this.current);var r=this.storage.get(t),i=e.getProvider().id;return r&&r[i][e.id]},e.prototype.getChanges=function(){if(!this.cached){for(var e=this.storage,t=this.current,r={},i=1,n=void 0;i<=t;i++)for(var o in n=e.get(i))for(var s in n[o]){var a=n[o][s];d=void 0,(d=ir(a)).created&&d.removed?r[o]&&r[o][s]&&delete r[o][s]:or(a)&&((r[o]=r[o]||{})[s]=a)}this.cached=r}var d;return this.cached},e.prototype.clear=function(){var e=this;e.storage.clear(),e.current=0,e.total=0,e.changes={},e.cached=null,this.updateObservers(!0)},e.prototype.import=function(e){var t=this,r=t.storage;for(var n in e)for(var o in e[n]){var s=t.iEdit.objects.get(o,n);if(s)t.origin(s);else{var a=i.extend(!0,{},e[n][o]),d=a.properties[tr]=a.properties[tr]||{};d.removed=!0,d.origin=!0,r.add(t.current,n,a)}}t.total=++t.current,r.set(t.current,e),t.recoverViewport(0)},e.prototype.recoverViewport=function(e,t){var r=+new Date,i=this.current+e,n=this.storage.get(i),o=this.iEdit;if(this.cached=null,i>=0&&i<=this.total){o.objects.selection.unselectFeature(),o.dump(arguments,i,"REBUILDED VIEW IN",+new Date-r,"ms"),o.objects.selection.getCurSelObj()&&o.listeners.trigger("featureUnselected",{featureUnselected:!0}),o.objects.selection.clearSelected();var s=[];for(var a in n){var d=n[a];for(var u in d){s["NAVLINk"==(h=d[u]).class?"unshift":"push"]({provider:o.getProviderById(a),feature:h})}}for(var p=0,l=s;p<l.length;p++){var c=l[p],h=c.feature,f=c.provider,v=f.search(h.id);v&&f.removeFeature(v);var g=ir(h);if(!g.removed){for(var y in h=o.objects.create({feature:h,provider:f,history:!0}),g)h.properties[tr][y]=g[y];o.setStyle(h)}}this.current=i,t||this.updateObservers()}},e.prototype.active=function(e){return arguments.length&&(this._a=!!e),this._a},e.prototype.ignore=function(e){var t=this.active();this.active(!1),e(),this.active(t)},e}(),ar=function(){function e(e){this.type="CONTAINER",this.length=0,this._e=e}return e.prototype.push=function(e,t){var r,i,n=this,o={};t&&"Feature"==t.type&&(e=arguments,t=undefined),null==e.length&&(e=[e]);for(var s=n._e,a=0,d=e;a<d.length;a++){var u=d[a];(i=s.objects.add(u,t,o))&&(u=i,r=!0),n[n.length++]=u}return r&&s.objects.history.saveChanges(),n.length},e.prototype.forEach=function(e,t){for(var r=0;r<this.length;r++)e.call(t,this[r],r)},e.prototype.toArray=function(){for(var e=[],t=0;t<this.length;t++)e[e.length]=this[t];return e},e.prototype.highlight=function(){for(var e,t=this.length;e=this[--t];)ct.highlight(e)},e.prototype.remove=function(){for(var e=this,t=e._e.objects,r=!1,i=e.length;i--;)r=t.remove(e[i],{animation:!1,save:!1})||r,delete e[i];r&&(e.length=0,t.history.saveChanges())},e.prototype.transform=function(){var e=this;e.length&&e._e.transformer.show(e.toArray())},e.prototype.unHighlight=function(){for(var e,t=this.length;e=this[--t];)ct.deHighlight(e)},e.prototype.unhighlight=function(){return this.unHighlight()},e.prototype.pop=function(){var e=this;if(e.length){var t=e[--e.length];return delete e[e.length],t}},e.prototype.getBBox=function(){for(var e,t=this,r=[1/0,1/0,-1/0,-1/0],i=0;i<t.length;i++)(e=t[i].getBBox?t[i].getBBox():t[i].bbox)[0]<r[0]&&(r[0]=e[0]),e[1]<r[1]&&(r[1]=e[1]),e[2]>r[2]&&(r[2]=e[2]),e[3]>r[3]&&(r[3]=e[3]);return t.length?r:[0,0,0,0]},e}(),dr=function(e,t,r){return{geometry:{coordinates:t,type:e},type:"Feature",properties:r||{}}},ur=function(e,t){for(var r=0;r<e.length;r++)null!=e[r].opacity&&(e[r]._opacity=e[r]._opacity||e[r].opacity),e[r].opacity=t;return e},pr=function(e){for(var t=0;t<e.length;t++)e[t].opacity=null==e[t]._opacity?1:e[t]._opacity,delete e[t]._opacity;return e},lr=function(e){return e=e?e instanceof Array?e:[e]:undefined},cr=function(e,t,r,i){return[[[e,t],[e,i],[r,i],[r,t],[e,t]]]},hr=function(){function e(e){this.layer=e}return e.prototype.getProvider=function(){return this.layer.getProvider()},e.prototype.hideFeature=function(){for(var e,t=this,r=t.layer,i=0;i<arguments.length;i++)(e=arguments[i])instanceof ar&&(e=e.toArray()),e instanceof Array?t.hideFeature.apply(t,e):r.setStyleGroup(e,ur(r.getStyleGroup(e),0))},e.prototype.showFeature=function(){for(var e,t=this,r=t.layer,i=0;i<arguments.length;i++)(e=arguments[i])instanceof ar&&(e=e.toArray()),e instanceof Array?t.showFeature.apply(t,e):r.setStyleGroup(e,pr(r.getStyleGroup(e)))},e.prototype.addFeature=function(e,t){var r=this.layer.addFeature(e,lr(t));return r.properties["@ns:com:here:editor"]=r.properties["@ns:com:here:editor"]||new gt,r},e.prototype.addCircle=function(e,t,r){return this.addFeature(dr("Point",e,r),t)},e.prototype.remove=function(e){var t=this.layer;if(e instanceof ar)for(var r=0;r<e.length;r++)t.removeFeature(e[r]);else e&&t.removeFeature(e)},e.prototype.setFeatureCoordinates=function(e,t){e._provider.setFeatureCoordinates(e,t)},e.prototype.getStyles=function(e){return this.layer.getStyleGroup(e)},e.prototype.modifyRect=function(e,t,r,i,n){this.setFeatureCoordinates(e,cr(t,r,i,n))},e.prototype.addRect=function(e,t,r,i,n){return this.addFeature(dr("Polygon",cr(e,t,r,i),n))},e.prototype.addPolygon=function(e,t,r){return this.addFeature(dr("Polygon",[e],r),t)},e.prototype.addSquare=function(e,r,i,n,o){var s=t.movePoint;return i^=0,this.addPolygon([s(e,r,-45+i),s(e,r,45+i),s(e,r,135+i),s(e,r,225+i),s(e,r,-45+i)],n,o)},e.prototype.addPath=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"LineString"},type:"Feature",properties:r||{}},lr(t))},e.prototype.addPoint=function(e,t,r){t instanceof Array||(r=t,t=undefined);var i={geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}};return this.addFeature(i,lr(t))},e.prototype.addImage=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}},lr(t))},e}(),fr="data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO8AAPACAvoCAvoMDPAODvASEvoXF/oZGfAdHfAkJPAqKv1BQf1KSv5QUP9dXf9paf9zc/95ef+Ghv+Njf+Skv+dnf+lpf+rq/vFxf3MzPzW1vfa2vvc3P3i4v7q6v/y8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACIALAAAAAAYABgAAAb/QJFwKAyBOpnMBhQiOp2hDSZSsVgqkYum+SR6LoJAoBMKecICCrkbbQQECwHZLFAkAoPtcxNeFARyZWcCBnECekMeboYGgXSEdYAdQyEXAYYCBWOCgI1wARRcGwOZgKVzg54BjRoiIRgBCqannJCACgEWZRMBCbMGm4+eAr4QHx8Pq78BHLXDjQgbHQzKpn/NwtaNHdPVgH+ondpyHsnDtNmdAQcbIby+1o6ppsUfr7Gz4M6muLoiGwRKfXPUQdzAVq4sYdIXgoPBBaC4iPDg4FImhh3eNMI1YBIRPpcKMEwF8ZDEIhvcRAqXABgBRE88WAgTzIMYARXWdEGJQUKVDStZYO6kdCRJByY7gwAAOw==",vr="#111111",gr=function(e){return e.properties["@ns:com:here:editor"].hovered},yr=function(e){return e.properties["@ns:com:here:editor"].selected},Ar=function(e,t,r){return"function"==typeof e?e(t,r):e},mr=function(e){return[{zLayer:function(e){return e.properties.zLayer},zIndex:999990,type:"Line",strokeWidth:2,stroke:"#FF0000",altitude:!!e}]},_r=function(e){var t=[{zIndex:4,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20,pointerEvents:!1,altitude:e}];return e&&t.push({zIndex:3,type:"VerticalLine",stroke:vr,altitude:function(e){var t=e.properties;return t[t.parentType].altitude}},{zIndex:1,type:"Circle",radius:4,fill:vr,opacity:.6,zLayer:function(e){var t=e.properties;return t[t.parentType].zLayer}}),t},Sr=function(e){return e?[{zLayer:function(e){return e.properties.zLayer},zIndex:999992,type:"Sphere",radius:8,fill:"#FF0000",stroke:"#FF0000",altitude:function(e){var t=e.properties;return t[t.parentType].altitude}},{zLayer:function(e){return e.properties.zLayer},zIndex:999991,type:"VerticalLine",stroke:"#000",altitude:!0},{zIndex:999990,type:"Circle",radius:4,fill:vr,opacity:.6,altitude:0,zLayer:function(e){return e.properties.zLayer}}]:[{zLayer:function(e){return e.properties.zLayer},zIndex:999991,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zLayer:function(e){return e.properties.zLayer},zIndex:999992,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}]},Lr=function(e){return[{zIndex:0,type:"Circle",radius:13,fill:"#ffffff",stroke:vr,strokeWidth:1.5},{zIndex:1,type:"Text",fill:vr,font:"normal 16px Arial",text:e}]},br=function(e){return[{zIndex:1,type:"Image",src:e,width:24,height:24,alignment:"map",rotation:function(e){return e.properties.rotation}}]},kr=function(){function e(){this.styleGroups={ADDRESS_LINE:mr(),ADDRESS_LINE_3D:mr(!0),ADDRESS_ROUTING_POINT:Sr(),ADDRESS_ROUTING_POINT_3D:Sr(!0),ADDRESS_SELECTOR:_r(),ADDRESS_SELECTOR_3D:_r(!0),PLACE_LINE:mr(),PLACE_LINE_3D:mr(!0),PLACE_ROUTING_POINT:Sr(),PLACE_ROUTING_POINT_3D:Sr(!0),AREA_SHAPE:[{zIndex:0,zLayer:function(e){return e.properties.AREA.zLayer},type:"Circle",strokeWidth:2,stroke:vr,radius:function(e){return gr(e)?8:6},fill:function(e,t){var r=e.properties.AREA.style[0],i=r.fill,n=r.stroke;return gr(e)?vr:Ar(i,e,t)||Ar(n,e,t)}}],AREA_VIRTUAL_SHAPE:[{zIndex:0,zLayer:function(e){return e.properties.AREA.zLayer},type:"Circle",strokeWidth:1,fill:vr,stroke:vr,radius:function(e){return gr(e)?6:4}}],AREA_HEIGHT_KNOB:[{zIndex:4,type:"Sphere",altitude:!0,fill:function(e,t){var r=e.properties.AREA.style[0],i=r.fill,n=r.stroke;return gr(e)?"#777":Ar(i,e,t)||Ar(n,e,t)},radius:10,offsetZ:50},{zIndex:3,type:"VerticalLine",stroke:"#000",offsetZ:50}],LINE_SHAPE_3D:[{zIndex:4,type:function(e){return yr(e)?"Sphere":null},radius:function(e,t){var r=e.properties.LINE.style;return 6+(v.getLineWidth(r,e.getLine(),t,0)[0]/2+4^0)},fill:"red",opacity:.5,strokeWidth:5,altitude:!0},{zIndex:3,type:"Sphere",alignment:"map",radius:function(e,t){var r=e.properties.LINE.style;return v.getLineWidth(r,e.getLine(),t,0)[0]/2+4^0},stroke:function(e,t){var r=e.properties.LINE.style.filter((function(e){return"Line"==e.type})),i=r.length-1;return Ar(r[i].stroke,e,t)||"BLACK"},fill:function(e,t){var r=e.properties.LINE.style;return r.length>1?Ar(r[0].stroke,e,t):"#e9e9e9"},strokeWidth:2,altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:vr,opacity:.6,zLayer:function(e){return e.properties.LINE.zLayer}}],LINE_SHAPE:[{zIndex:0,type:"Circle",radius:function(e,t){var r=e.properties.LINE.style;return v.getLineWidth(r,e.getLine(),t,0)[0]/2+4^0},stroke:function(e,t){var r=e.properties.LINE.style.filter((function(e){return"Line"==e.type})),i=r.length-1;return Ar(r[i].stroke,e,t)||"BLACK"},fill:function(e,t){var r=e.properties.LINE.style;return r.length>1?Ar(r[0].stroke,e,t):"#151515"},strokeWidth:2},{zIndex:4,type:function(e){return yr(e)?"Circle":null},radius:function(e,t){var r=e.properties.LINE.style;return 6+(v.getLineWidth(r,e.getLine(),t,0)[0]/2+4^0)},stroke:"red",strokeWidth:3}],LINE_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",radius:function(e,t){var r=e.properties.LINE.style;return v.getLineWidth(r,e.getLine(),t,0)[0]/2^0},fill:"#151515"}],LINE_VIRTUAL_SHAPE_3D:[{zIndex:3,type:"Sphere",radius:function(e,t){var r=e.properties.LINE.style;return v.getLineWidth(r,e.getLine(),t,0)[0]/2^0},fill:"red",altitude:function(e){var t;return null===(t=e.properties.LINE.style.find((function(e){return e.altitude})))||void 0===t?void 0:t.altitude}},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:vr,opacity:.6,zLayer:function(e){return e.properties.LINE.zLayer}}],MARKER_SELECTOR:_r(),MARKER_SELECTOR_3D:_r(!0),PLACE_SELECTOR:_r(),PLACE_SELECTOR_3D:_r(!0),NAVLINK_SHAPE:[{zIndex:0,type:function(e){return e.properties.isConnected?"Rect":"Circle"},width:function(e){return gr(e)?18:12},rotation:45,radius:function(e){return gr(e)?9:6},strokeWidth:2,fill:function(e,t){return e.isOverlapping()?"#FFFFFF":Ar(e.properties.NAVLINK.style[0].stroke,e,t)},stroke:function(e){return e.isOverlapping()?"#FF0000":"#FFFFFF"}},{zIndex:1,type:function(e){return yr(e)?"Circle":null},radius:function(e){return gr(e)?18:14},stroke:"red",strokeWidth:3}],NAVLINK_SHAPE_3D:[{zIndex:0,type:function(e){return e.properties.isConnected?"Box":"Sphere"},width:function(e){return gr(e)?18:12},rotation:45,radius:function(e){return gr(e)?9:6},strokeWidth:2,fill:function(e,t){return e.isOverlapping()?"#FFFFFF":Ar(e.properties.NAVLINK.style[0].stroke,e,t)},stroke:function(e){return e.isOverlapping()?"#FF0000":"#FFFFFF"},alignment:"map",altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:vr,opacity:.6,zLayer:function(e){return e.properties.NAVLINK.zLayer}}],NAVLINK_VIRTUAL_SHAPE:[{zIndex:1,type:"Circle",radius:function(e,t){var r=e.properties.NAVLINK.style;return v.getLineWidth(r,e.getLink(),t,0)[0]/5},opacity:.7,fill:vr,stroke:vr,strokeWidth:2}],NAVLINK_VIRTUAL_SHAPE_3D:[{zIndex:1,type:"Sphere",radius:function(e,t){var r=e.properties.NAVLINK.style;return v.getLineWidth(r,e.getLink(),t,0)[0]/5},opacity:.7,fill:vr,stroke:vr,strokeWidth:2,alignment:"map",altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:vr,opacity:.6,zLayer:function(e){return e.properties.NAVLINK.zLayer}}],NAVLINK_DIRECTION_HINT_1WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACUcHCMfICMgICklJSsnKS4qKzMvLzMvMTo3OD05OlpXWGVjY2pnZ25rbHFub5mXmJ6dncXExMjHx9bV1eXl5e7u7vHx8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABkALAAAAAAfAAwAAAVcYCaO5FgUZaquo7EQyMDOQ20PBGVFikHMKkHDQSQ+KpjkxEE4BIAjwSVJrVItkIQPKrV6qxJGU7bqfr/hMct8TmK1P6CwaEQqmU6o6GbL7XpxeiwuMGSCMwQohyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_2WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACMeISMfHyQhISklJisnKS0pKjIuLjMvMUNAQElFRVJPUG5rbHh1do2LjJORkrWztM/OztbW1uvr6////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABUALAAAAAAfAAwAAAV6YCWOpBgYoxGUbEsWhnKMh2IUbl4dBBNRicAgkKBEGISZTjQ4IB4TitTBqDqklMkDcRi4bgsIdkwmQxawkQBBaEjK8LikQUAIBDx3fD+eJwUpBWF8cGdpLU1PUVNVDFdSWlxeSzs9P0FDRUdJlCwwMjQ2OJ0uJykrSyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_BLOCKED:[{zIndex:1,type:"Image",src:fr,rotation:90,width:24,height:24,alignment:"map"}],NAVLINK_DIRECTION_HINT_A:Lr("A"),NAVLINK_DIRECTION_HINT_B:Lr("B"),NAVLINK_DIRECTION:[{zIndex:0,type:"Image",src:"data:image/gif;base64,R0lGODdhEAAcALMAAAAAACgbGxwcHCMfHyMfICMhISsrK////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAAAgALAAAAAAQABwAAAQ/EMlJq5WE3Jt3HdngTVk3FiVRjGApbmkKx2ZFy9Qd53pJ9jggjjfk7Dy0URJ5nBUtS6eP+bQ1jVXiVFrDbiURADs=",width:16,height:28,rotation:function(e){return-e.properties.bearing},opacity:.7,alignment:"map"}],NAVLINK_DIRECTION_NONE:[{zIndex:0,type:"Image",src:fr,width:24,height:24,rotation:90,alignment:"map"}],TURN_RESTRICTION_START:[{type:"Image",zIndex:1,src:"data:image/gif;base64,R0lGODdhJAAUAMQAAAAAAAAA/wBAvwBA/wBNzBRO2ABV/wtV2gxVzgdW0wpX1ApY1Qpa3BJbyABd0Qtd4wtf6Ath6wBmzABm/wBt2wCAgACA/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABgALAAAAAAkABQAAAW/ICZiC6Ocijmu43KaqMq+aMwwT6Tv0fPANZlIAQGmaidSjeRCniKK4aPWvNFYypeveZpijqjH4quYpm5oXGna5Lq+XCHZGUtKa2Z8dKXgBvcjZVRODGOBeUheKwuIdIaHdIIzjUhvfJRdgHeRfZpfmJKXnCePm06KkKOFi6CoIoyjoYF+dZODnVeBqnafeoJhY5lnaWo4t529KFUwqzMxW3pDRX9UTAvXcJERpS5GLzc5PDo+3kdYX0ZyWHUxpSEAOw==",width:36,height:20,rotation:function(e){return e.properties.rotation},alignment:"map"}],TURN_RESTRICTION_LINE:[{type:"Line",zIndex:0,strokeWidth:5,strokeLinecap:"round",stroke:function(e){return"TURN_RESTRICTION_ALLOWED"==e.properties.sign?"#0000ff":"#ff0000"}}],TURN_RESTRICTION_ONEWAY:br(fr),TURN_RESTRICTION_FORBIDDEN:br("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO0AAO4ACPAAAPYlK/YpL/YrMO4sMu9VV/tVV/xWWfxYWu9aW/BaXPBkZvBnafBpav9zdf93efOOj/+Oj/OPkP+PkP+RkvOSk/SenvSfoPSjo/WnqPWpqfe/v/XDxP/Dw/bHyPnOzvnR0fni4v309P749////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACgALAAAAAAYABgAAAb2QJRwKDyRRp/PiHQiOp2lz2VhGAwIi8un9CSeRpKAeEyOjJrPE2gQEAQYGA4HwxgPQOihOnAIOEQlJ4InJSIPfAF4RCMDfRmDkIMZfAMjQyURYo+RnJMBEVwoH2IOnKYnhwEeKCcXYiKnnCJiF0YLAQiBsZF1CkcFARW7nBgBBCIhbBvDkR1iScrMkM4BSgYBE9KDxcckCri60g0BCUyuAbDSI2IWTaN+2hBiqyiYYsvDGmKgQyKNAfhObaAkwgsIRA5GmIBUSF4fRQbZiGmAoUMHDOPGQHRyQkQmMiAjwOpyyQOFBATEEEhAwUMokl6OhFDChGQQADs="),TURN_RESTRICTION_ALLOWED:br("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAAA/qgBFqgBLrABTrgBWsQBZrwBdsQJlswBnuAtnsxFntBNoswBpuR5qtSNrtClstj10uEt+w0+AxFCBxG6Pwm6TzXWTxHKVznuXxnyYxoGax4OcyIym1Y+p15Cp1papz5ms0KGy06q41q672LG+2bTA2rzH3r7I3r/J4MLL37/M6MHO6cXO4MfQ4c7V5tDX59DY59Tb6d7j7uDl7uLm8OXp8uns9PHz9/P0+f///wAAAAAAAAAAAAAAAAAAACH5BAkKADsALAAAAAAYABgAAAb/wJ1wKNTVZK0WrKYjOp05VGfSOBwaFA8K9yTqXpgB4YBgMBAHwgDzaj51rALh4VgoEAjFwvEYs9xDcAIKD3iGCw90CA8KAn9ELwV6hngKBwNiDmUIBS9DOBZzlGUHFSUjHKJ9GFw7KAOFo3cRMzo6ILCLBCo7Oh0EEA7Cww4QaDK2IbAOBB5GElYE0tPSlwNttwMQBxM1MAkIFRoZ4xrm4xsXGje2IAIODTEuBQg2tvf4+bYiBgctLgTq6Rt4j98BFS/AXeCwgYPDhw3NsdOhDN4SaGmoTbOGTdm2br6AERtm7AAyigLoEPjQ5EQuWQhoJcv1YEAKIaAIaKLEoJQJThKpCjHDkGNIJAYLRi04ICDTpk5eWAyKdSiRJgcKAjzyskIOnTuU+BAosNXJFwtiyAhDo4YNoC44pEhIIC2BhA5bunTRQeNFkhc03hIJAgA7"),TURN_RESTRICTION_PEDESTRIAN:br("data:image/gif;base64,R0lGODdhGAAYAOYAAAAAAO0AAO4ACPAAAPYlK/YpLy0rK/YrMO4tMjMxMUVDRFRTU+9UVvtVV/xVWF9WVvxYWvBZW+9bXWNdXfBjZe9kZmhnZ/BnafBpa2xsbHJxcv9zdf93eX18fISEhIuLi/OOj/+Oj/OPkP+PkP+RkvOSk5iVlZ2dnfSenvSkpPWpqaysrLO0tLy8vPe/v8PDw//Dw/XExMjHyPbHyPnOzsbPz8/Pz8fQ0PnR0dPT09zc3Pri4uPj4+rq6vLy8v3z8////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKAEEALAAAAAAYABgAAAf/gEGCg4JAOzgxMzg7QISOjj8xJBAHAwMFECQxP4+EQDQbAaKjpBs4jY9AMAOjDCApKSIMowMwqIOqAQgBFDQ/QMBAPzQUugG2hDQDuynBzsEougM4gz+hASjP2kDRARycQS6iFdvbFAIBMUFAIaI4NT3OPNs0oiSGDQEMQCwAK8EvFuh49iNCAAiHCAQoAYxHBwUtgOnIwAJYDx9ARAQ4gGOGKBXOcmTw0GLFBwAedACYAERFgAExYnx85iPDAgAADAB48cFEy5cxcChkGIxFghM5ZNiwoMFZiQAEFuWTACyghoE9WKzIgBFYwYOM2gXAceNBjmA+WrCIF6xegHvhUERhKKftgih1QayJakYXWLcN4ILU25WNbjQE0zzBMIbh1DMadnchU8xKlIQSKlSUkEBrsqNP10iVOtWpmosRDRRCdUDCReDSuHbQiEmDUelAADs="),TRANSFORMER_TRANSLATE_KNOB:[{type:"Circle",zIndex:0,zLayer:1e4,stroke:"#FFFFFF",fill:"#010B1E",strokeWidth:3,opacity:.3,radius:9}],TRANSFORMER_ROTATE_KNOB:[{type:"Image",zIndex:4,zLayer:1e4,src:function(e){return e.properties.hovered?"data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAELHhAZKyApOTA4R0BHVlBXZGBmcnB1gICFjo+UnK+yuL/Cx8/R1d/g4+/w8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABEALAAAAAATABMAAAVpYCSOEWSaZDqeLKqWbQylck2aTgM5SqI4rZWJIUAEjkdEEAZhHAUHxkEQOLCYzacO8qBuYw+G+JsIJGq1hhktK5/ZrUGAcW0FCAtIwxAoXLEQB0hHBQ9/gA0JinSHgGw0cDMvaC+QJy8hADs=":"data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAAKIAELHhEaLCEqOjE5SEFIVlFYZXF2gYCFj5CVnaCkq7CzucDDx9DS1uDh5PDx8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABIALAAAAAATABMAAAVpoCSOkmCaZDqeLKqWbSykck2aRCEQSIIQrZXJAFFEjkdFECYwHCELwwISWbCYzadOMKBuYwOD+JuIJGq1ghktK5/ZrUfEcG1FHAdBgRFpXLECC0hHDQN/gAUJinSHgGw0cDMvaC+QJy8hADs="},width:18}],TRANSFORMER_SCALE_KNOB:[{type:"Circle",zIndex:4,zLayer:1e4,fill:function(e){return e.properties.hovered?"white":"black"},radius:9},{zIndex:5,zLayer:1e4,type:"Text",fill:function(e){return e.properties.hovered?"black":"white"},font:"20px Arial",text:""}],TRANSFORMER_SCALE_BOX:[{type:"Line",zIndex:0,zLayer:1e4,strokeDasharray:[4,4],strokeWidth:2,stroke:"#010B1E"}],UNKNOWN:[{zIndex:0,type:"Circle",strokeWidth:1,stroke:"#FF0000",fill:"#0000FF",radius:10}]}}return e.prototype.assign=function(e){var t,r,i=this.styleGroups,n=e.properties,o=e.class||n.type,s=!1;if("LINE_SHAPE"==o||"LINE_VIRTUAL_SHAPE"==o||"NAVLINK_SHAPE"==o||"NAVLINK_VIRTUAL_SHAPE"==o?s=null===(t=(n.LINE||n.NAVLINK).style.find((function(e){return e.altitude})))||void 0===t?void 0:t.altitude:"MARKER_SELECTOR"==o?null==(s=n.MARKER.altitude)&&(s=!!e.geometry.coordinates[2]):s=null===(r=n[n.parentType])||void 0===r?void 0:r.altitude,s){var a=o+"_3D";o=i[a]?a:o}return undefined!==i[o]?o:"UNKNOWN"},e}(),Cr=function(e){function t(t){void 0===t&&(t={});var r=this;return t.name="EOP",(r=e.call(this,t)||this).id="EOP-"+r.id,r}return y(t,e),t}(p),Er="pointerenter pointerleave pointerup pressmove pointerdown dbltap",xr=function(e){return e.class},Pr=function(){function r(e,t){this.listen=!1;var r=this;r.iEdit=e,r.display=t,r.history=new sr(e),r.selection=new er(e,t);var i,n,o=(i=e,(n=new Cr)._e=function(){return i},new l({name:"EditorOverlay",min:1,max:28,style:new kr,provider:n}));r.overlay=new hr(o);var a=new s([[o.id,o]]);this.layers=a,t.addLayer(o,function(e){for(var t,r=e.length;r--;)if((t=e[r].getProvider())&&"NAVLINK"==t.class)return r+1;return e.length}(t.getLayers())),r.arrangeOverlay=r.arrangeOverlay.bind(r),r.pointerListener=r.pointerListener.bind(r),e.listeners.add("_layerAdd",(function(e){var t=e.detail.layer;a.set(t.id,t)})),e.listeners.add("_layerRemove",(function(t){var r=t.detail.layer;a.delete(r.id);var i=e.objects.selection.getCurSelObj();i&&e.getLayer(i)==r&&e.objects.selection.clearSelected()})),r.onMVCStart=r.onMVCStart.bind(r)}return r.prototype.onMVCStart=function(){this.selection.unselectFeature()},r.prototype.splitLinkAt=function(e){return function(e,t){var r,n,o,s=t.link,a=t.index,d=t.preferSegment,u=t.avoidSnapping,p=s.coord(),l=p.length-1,c=dt._props(s),h=s.getProvider().readZLevels(s),f=e._config.snapTolerance,v=t.point,g=t.ignoreZ;if(v&&(r=v[0],n=v[1],o=v[2]||0),0===a||a===l||r==p[0][0]&&n==p[0][1]||r==p[l][0]&&n==p[l][1])return!1;if(e.objects.history.origin(s),void 0===a){var y=e.map.searchPointOnLine(p,v,f,d,void 0,g);if((0===(a=null==y?void 0:y.index)||a===l)&&y.existingShape)return!1;a=dt.addShp(s,[r,n,o],null,!0,null,d),p=s.coord()}dt.deHighlight(s);var A=s.getProvider(),m=function(t,r,n){var o=i.extend(!0,{},c),s={type:"Feature",geometry:{type:"LineString",coordinates:t},properties:o};return delete o["@ns:com:here:editor"],e.objects.create({feature:s,provider:A,zLevels:r,preferIndex:n})},_=m(p.slice(0,a+1),h.slice(0,a+1),u&&a),S=m(p.slice(a),h.slice(a),u&&0),L=Ee(p[a],p);L>.995&&(L=1);var b=xe(p,p[a]).offset,k=dt.getConnectedObjects(s);for(var C in k){var E=k[C],x=je.getRoutingPosition(E),P=b>xe(p,x).offset?_:S;je.connect(E,P,x),je.markAsModified(E,!1)}return e.hooks.trigger("Navlink.split",{link:s,index:a,children:[_,S],relativePosition:L},A),s.editState("split",Date.now()),e.objects.remove(s,{animation:!1,split:!0}),[_,S]}(this.iEdit,e)},r.prototype.destroy=function(){this.display.removeLayer(this.overlay.layer)},r.prototype.arrangeOverlay=function(e){var t=e&&e.detail.layer,r=this.display,i=this.overlay.layer;if(r.getLayers){var n=r.getLayers();if(!(t.getProvider()instanceof Cr)){var o=n.map((function(e){var t=e.getProvider();return t&&t.class})).indexOf("NAVLINK");r.removeLayer(i),o>=0?r.addLayer(i,o+1):r.addLayer(i)}}},r.prototype.pointerListener=function(e){var t=this.iEdit,r=e.target,i=e.type;if(r){var n=e.detail.layer;if(!this.layers.has(n.id))return;var o=ct.getEventListener(r,i);if(o)return e.stopPropagation(),o.apply(r,arguments)}"pointerup"!=i&&"dbltap"!=i||t.objects.selection.unselectFeature("viewportChange"==t._config.keepFeatureSelection),t.listeners.trigger(e,null)},r.prototype.listenDisplay=function(e){var t=this.display,r=this.listen,i=this.pointerListener,n=this.arrangeOverlay;e?r||(this.listen=!0,t.addEventListener("mapviewchangestart",this.onMVCStart),t.addEventListener(Er,i),t.addEventListener("addLayer removeLayer",n)):r&&(this.listen=!1,t.removeEventListener("mapviewchangestart",this.onMVCStart),t.removeEventListener(Er,i),t.removeEventListener("addLayer removeLayer",n))},r.prototype.get=function(e,t){var r=this.iEdit;return t?"object"!=typeof t&&(t=r.getLayer(t)):t=r.getLayer(e),"object"!=typeof e&&t&&(e=t.search(e)),e&&t?e:null},r.prototype.getInBBox=function(e,t,r){e||(e=[(e=this.display.getViewBounds()).minLon,e.minLat,e.maxLon,e.maxLat]);var i=1/Math.pow(10,this.iEdit._config.intersectionScale);e=[e[0]-i,e[1]-i,e[2]+i,e[3]+i];for(var n,o=[],s=0,a=(t=t||this.layers.values())instanceof Array?t:[t];s<a.length;s++){if(n=a[s].search(e))for(var d=0,u=n;d<u.length;d++){var p=u[d];r&&!r(p)||o.push(p)}}return o},r.prototype.remove=function(e,t){var r=this,i=!1;if((t=t||{}).split||!r.iEdit._config.editRestrictions(e,2)){var n=null==t.animation||t.animation;n&&ct.private(e,"isSelected")&&r.selection.clearSelected(),xr(e)&&(r.history.origin(e),ct.markAsRemoved(e,n),t.save&&r.history.saveChanges(),i=!0);var o=e.getProvider();return e.editState&&!e.editState("created")&&o.blockFeature(e,!0),o.removeFeature(e),i}},r.prototype.add=function(e,t,r){var i=this.iEdit;if(!e.getProvider()&&("string"==typeof t?t=this.layers.get(t):t||(t=i.getLayerForClass(xr(e))),t)){var n=e.id,o=null!=n&&t.search(n);return null!=n&&o?o:this.create({feature:e,provider:t.getProvider(),idMap:r})}},r.prototype.create=function(e){var t=this.iEdit,r=t.objects.history,i=[],n=e.feature;Array.isArray(n)||(n=[n]);for(var o=e.idMap||{},s=e.provider,a=e.preferIndex,d=e.history,u=e.zLevels,p=function(e){var p,l=n[e],c=l.id;if(d||s.enforceRandomFeatureId&&(l.id=undefined),l=s.prepareFeature(l),p=s.detectFeatureClass(l),null==c&&(c=l.id),o[c]=l.id,l=function(e){return d&&s.blockFeature(e,!1),e=s.addFeature(e),e=s.search(e.id),d||(e.editState("created",Date.now()),ct.markAsModified(e,!1),r.origin(e,!0),u&&r.ignore((function(){s.writeZLevels(e,u)}))),i.push(e),e}(l),"NAVLINK"===p)l.geometry.coordinates.forEach((function(e){return e[2]||(e[2]=0)})),d||!1===dt.fixGeo(l,undefined,undefined,a)&&(r.remove(l),s.removeFeature(i.pop()));else if("PLACE"===p||"ADDRESS"===p){var h=je.getRoutingData(l),f=h.link;if(o[f]){var v=je.getRoutingProvider(l),g=v&&v.search(o[f]);r.ignore((function(){l.getProvider().writeRoutingPoint(l,g,h.position)}))}"ADDRESS"!==p||d||(je.connect(l),l.getLink()||(r.remove(l),s.removeFeature(i.pop()),t.dump("No Link found within "+t._config.maxRoutingPointDistance+" meters","warn")))}},l=0;l<n.length;l++)p(l);return i.length>1?i:i[0]},r.prototype.getNearestLine=function(e,r,n){var o=this.iEdit,s={line:null,point:null,distance:1/0,shpIndex:null,segmentNumber:null},a=(n=i.extend({maxDistance:1/0,shapeThreshold:0,ignoreZ:!1},n||{})).maxDistance,d=a<1/0?t.getPointBBox(e,a):null;r instanceof c&&(r=this.getInBBox(d,r));for(var u=0,p=r;u<p.length;u++){var l=p[u];if(!n.ignore||!n.ignore(l)){var h=l.bbox;if(a==1/0||w(d[0],d[2],d[1],d[3],h[0],h[2],h[1],h[3])){var f=o.map.searchPointOnLine(l.geometry.coordinates,e,-1,undefined,undefined,n.ignoreZ);(null==f?void 0:f.distance)<Math.min(s.distance,n.maxDistance)&&(s.point=f.point,s.distance=f.distance,s.shpIndex=f.existingShape?f.index:null,s.segmentNumber=f.index-Number(!f.existingShape),s.line=l,a=t.distance(f.point,e),d=t.getPointBBox(e,a))}}}return s.line?s:null},r.prototype.searchLine=function(r,n,o,s){var a=this.iEdit,d={line:null,point:null,distance:1/0,shpIndex:null,segmentNumber:null},u=(o=i.extend({maxDistance:1/0,shapeThreshold:0,ignoreZ:!1},o||{})).maxDistance,p=o.ignoreZ,l=u<1/0?t.getPointBBox(r,u):null;n instanceof c&&(n=this.getInBBox(l,n,(function(e){return"NAVLINK"==e.class})));for(var h=a.display,f=h.geoToPixel(r[0],r[1]),v=f.x,g=f.y,y=h._unprj(v,g,-1),A=h._unprj(v,g,1),m=e.sub([],A,y),_=0,S=n;_<S.length;_++){var L=S[_];if(!o.ignore||!o.ignore(L)){var b=L.bbox;if(!l||w(l[0],l[2],l[1],l[3],b[0],b[2],b[1],b[3]))for(var k=L.geometry.coordinates,C=k[0],E=h._g2w(C[0],C[1],p?0:C[2]),x=void 0,P=1;P<k.length;P++){C=k[P],x=E,E=h._g2w(C[0],C[1],p?0:C[2]);var I=e.sub([],x,E),R=I[0],O=I[1];if(R||O){var N=x,F=e.add([],x,[-O,R,0]),T=E,M=e.normalize([],e.cross([],e.sub([],T,F),e.sub([],N,F))),j=B(m,y,M,N),G=h._w2g(j);j=D(N,T,j,!0);var z=h._w2g(j),K=t.distance(z,G);K<Math.min(d.distance,u)&&(d.point=z,d.distance=K,d.line=L)}}}}return d.line?d:null},r}(),Ir=function(){function e(e,t){var r=this;this.busy=null,this.display=t,this.iEdit=e,this.observers=e.observers,this.onStart=this.onStart.bind(this),this.onStop=this.onStop.bind(this),e.listeners.add("_layerAdd",(function(e){r.observers.change("ready",!1),r.display.setCenter(r.display.getCenter()),e.detail.layer.addEventListener("viewportReady",r.onStop)})),e.listeners.add("_layerRemove",(function(e){e.detail.layer.removeEventListener("viewportReady",r.onStop)}))}return e.prototype.onStart=function(){if(!this.busy){var e=this.iEdit.layers;this.busy=new a(e),e.length&&this.observers.change("ready",!1)}},e.prototype.onStop=function(e){var t=e.detail.layer,r=this.busy;r&&(r.delete(t),r.size||(this.observers.change("ready",!0),this.busy=null))},e.prototype.start=function(){this.display.addEventListener("mapviewchangestart",this.onStart)},e.prototype.stop=function(){this.display.removeEventListener("mapviewchangestart",this.onStart)},e}(),Rr=["Navlink.split","Navlink.disconnect","Feature.remove","Coordinates.update"],wr=function(e,t){var r=e.__=e.__||String(1e9*Math.random()^0);return t&&(r+=";"+t.id),r},Or=function(){function e(e){this.h=new o(Rr),this.h.sync(!0),this.history=e,this.w=new Map}return e.prototype.add=function(e,t,r){var i=wr(t,r),n=this.w.get(i);return n||this.w.set(i,n=function(e,t){var r=function(r,i){t&&i!=t||e(r)};return r.h=e,r}(t,r)),this.h.add(e,n)},e.prototype.remove=function(e,t,r){return this.h.remove(e,this.w.get(wr(t,r)))},e.prototype.get=function(e){return this.h.get(e).map((function(e){return e[0].h}))},e.prototype.trigger=function(e,t,r){var i=this.history,n=i.active();i.active(!1),this.h.trigger(e,[t,r]),i.active(n)},e}(),Nr=Math.PI/180,Fr=function(e,t,r,i){this.point=e,this.index=t,this.distance=r,this.existingShape=i};function Tr(e,t){if("number"==typeof e[0])return t(e);for(var r=[],i=e.length;i--;)r[i]=Tr(e[i],t);return r}var Mr=function(){function e(e){this.display=e}return e.prototype.distance=function(e,r){return t.distance(e,r)},e.prototype.rotatePoint=function(e,t,r){return this.clipGeoCoord(function(e,t,r){var i=e[0]-t[0],n=e[1]-t[1],o=r*Nr;return[t[0]+(Math.cos(o)*i-Math.sin(o)*n/Math.abs(Math.cos(t[1]*Nr))),t[1]+(Math.sin(o)*i*Math.abs(Math.cos(t[1]*Nr))+Math.cos(o)*n),0^e[2]]}(e,t,r))},e.prototype.movePoint=function(e,r,i,n){return this.clipGeoCoord(t.movePoint(e,r,i,n))},e.prototype.scaleGeometry=function(e,t,r){var i=this;return Tr(e.coordinates,(function(e){return i.clipGeoCoord([r[0]+(e[0]-r[0])*t[0],r[1]+(e[1]-r[1])*t[1],0^e[2]])}))},e.prototype.rotateGeometry=function(e,t,r){var i=this;return Tr(e.coordinates,(function(e){return i.rotatePoint(e,t,r)}))},e.prototype.getClosestPoint=function(e,t,r){var i=e[0]-t[0],n=e[1]-t[1],o=e[1]*t[0]-e[0]*t[1],s=i*r[0]+n*r[1],a=1/(i*i+n*n);return[(s*i+o*n)*a,(s*n-o*i)*a]},e.prototype.searchPointOnLine=function(e,t,r,i,n,o){var s,a,d=this,u=null,p=n||1/0,l=!1,c=null,h=null,f=null;if(null!=i){var v=d.searchPointOnLine(e.slice(i,i+2),t,r,undefined,n,o);return v&&(v.index+=i),v}o&&(t=[t[0],t[1]]);for(var g=0;g<e.length;g++){var y=e[g];o&&(y=[y[0],y[1]]),(s=d.distance(y,t))<=p&&(p=s,c=y[0],h=y[1],f=y[2],u=g,l=!0)}if(p>r||!l)
// const path = pathGeo.map((c) => map.getPixelCoord(c));
for(var A=e.map((function(e){return d.display._g2w(e[0],e[1],o?undefined:e[2])})),m=d.display._g2w(t),_=0;_<A.length;_++)if(_<A.length-1&&(a=D(A[_],A[_+1],m,!0))){var S=d.clipGeoCoord(d.display._w2g(a));(s=d.distance(S,t))<p&&(p=s,u=_+1,c=S[0],h=S[1],f=a[2],l=!1)}return null===u?u:new Fr([c,h,f||0],u,p,l)},e.prototype.translateGeo=function(e,t,r){var i=this,n=i.display;return Tr(e,(function(e){var o=n.geoToPixel(e[0],e[1]);return i.getGeoCoord(o.x+t,o.y+r,e[2])}))},e.prototype.translateZ=function(e,t){return this.display._translateGeoCoord(e,0,0,t)},e.prototype.pixelMove=function(e,t,r){var i=e.getProvider(),n=this.translateGeo(i.decCoord(e),t,r),o=ct.getTool(e,"_setCoords");o?o(e,n):i.setFeatureCoordinates(e,n)},e.prototype.clipGeoCoord=function(e,t){var r=e[0],i=e[1],n=e[2];return e[0]=Math.round(1e9*r)/1e9,e[1]=Math.round(1e9*i)/1e9,t&&"number"==typeof n&&(e[2]=Math.round(1e3*n)/1e3),e},e.prototype.getGeoCoord=function(e,t,r){var i,n=this,o=n.display;return arguments.length>1?i=o.pixelToGeo(e,t):null!=(i=e).x&&null!=i.y?(r=i.z,i=o.pixelToGeo(i.x,i.y)):null!=e[0]&&null!=e[1]&&(r=i[2],i=o.pixelToGeo(i[0],i[1])),n.clipGeoCoord([i.longitude,i.latitude,0|r])},e.prototype.getPixelCoord=function(e,t,r){var i=this.display;return 2==arguments.length?e=i.geoToPixel(e,t):null!=e.longitude&&null!=e.latitude?e=i.geoToPixel(e.longitude,e.latitude):null!=e[0]&&null!=e[1]&&(e=i.geoToPixel(e[0],e[1])),[e.x,e.y,0|e.z]},e.prototype.getEventsMapXY=function(e){var t,r,i=this.display;if(null!=e.mapX)t=e.mapX,r=e.mapY;else{var n=i.getContainer().getBoundingClientRect();t=e.pageX-n.left,r=e.pageY-n.top}return[t,r]},e}(),Dr=function(){function e(e,t){this.isCommitInProcess=!1,this._config=e;var r=this;r.layers=[],r.layerMap={},r.observers=new $t,r.listeners=new Kt,r.objects=new Pr(r,t),r.hooks=new Or(r.objects.history),this._dListener=new Ir(r,t),this._dListener.start();var n=r.objects.overlay.layer,o=this.prvIdLayerMap={};function s(e){r.listeners.trigger("error",e)}o[n.getProvider().id]=n,r.listeners.add("_layerAdd",(function(e){for(var t=e.detail.layer,r=t.getProvider(),i=0,n=["src","base","delta","id"];i<n.length;i++){var a=r[n[i]];a&&(o[a]=t)}t.removeEventListener("error",s),t.addEventListener("error",s)})),r.map=new Mr(t),r.transformer=new Xt(r),r.display=t,r.dump=i.dump}return e.prototype.getLayerForClass=function(e){for(var t,r,i,n,o=0,s=this.layers;o<s.length;o++){var a=s[o];a.getProvider&&(n=a.getProvider()),(r=n.class)?e==r&&(i=a):t||(t=a)}return i||t},e.prototype.getProviderById=function(e){var t=this.prvIdLayerMap[e];if(t)return t.getProvider()},e.prototype.getLayerById=function(e){for(var t=0,r=this.layers;t<r.length;t++){var i=r[t];if(i.id==e)return i}},e.prototype.getLayer=function(e){var t;if("object"==typeof e){var r=e.getProvider();e=r.src||r.delta||r.base||r.id}return e&&(t=this.prvIdLayerMap[e]),t},e.prototype.destroy=function(){this._dListener.stop(),this.objects.destroy(),this.listeners.destroy()},e.prototype.getStyle=function(e,t){var r=this.getLayer(e).getStyleGroup(e,0^this.display.getZoomlevel(),t);return i.extend(!0,[],r)},e.prototype.getStyleProperty=function(e,t){for(var r=0,i=this.getStyle(e);r<i.length;r++){var n=i[r];if(null!=n[t])return v.getValue(t,n,e,0^this.display.getZoomlevel())}},e.prototype.getZLayer=function(e){return 1+this.display.getLayers().indexOf(this.getLayer(e))},e.prototype.setStyle=function(e,t,r){var i=this.getLayer(e);null==t?t=i._getCustomStyleGroup(e):"default"==t&&(t=undefined),i.setStyleGroup(e,t,r)},e}(),Br={debug:!0,editRestrictions:function(){return!1},services:{reverseGeocoder:{}},geoFence:!1,snapTolerance:2,intersectionScale:5,routingPointPrecision:5,disconnectShapeDistance:3,keepFeatureSelection:"viewportChange",featureSelectionByDefault:!0,maxRoutingPointDistance:1e3,snapOnDrag:!0},jr=function(e,t,r,i){return e.getProvider().readTurnRestriction({link:e,index:t},{link:r,index:i})},Gr=function(e,t,r,i,n){t.getProvider().writeTurnRestriction(e,{link:t,index:r},{link:i,index:n})},zr={"Navlink.split":[function(e){for(var t=e.link,r=e.children,i=r[0],n=r[1],o=t.coord().length-1,s=i.coord().length-1,a=n.coord().length-1,d=0,u=t.getConnectedLinks(0,!0);d<u.length;d++){var p=u[d],l=p.link,c=p.index;jr(t,0,l,c)&&(Gr(!0,i,0,l,c),Gr(!1,n,0,l,c)),jr(l,c,t,0)&&(Gr(!0,l,c,i,0),Gr(!1,l,c,n,0))}for(var h=0,f=t.getConnectedLinks(o,!0);h<f.length;h++){var v=f[h];l=v.link,c=v.index;jr(t,o,l,c)&&(Gr(!0,n,a,l,c),Gr(!1,i,s,l,c)),jr(l,c,t,o)&&(Gr(!0,l,c,n,a),Gr(!1,l,c,i,s))}}],"Feature.remove":function(e){var t=e.feature;if("NAVLINK"==t.class){for(var r=t.coord().length-1,i=0,n=t.getConnectedLinks(0,!0);i<n.length;i++){var o=n[i],s=o.link,a=o.index;Gr(!1,t,0,s,a)}for(var d=0,u=t.getConnectedLinks(r,!0);d<u.length;d++){var p=u[d];s=p.link,a=p.index;Gr(!1,t,r,s,a)}}},"Navlink.disconnect":function(e){var t=e.link,r=e.index;t.getConnectedLinks(r,!0).forEach((function(e){var i=e.link,n=e.index;Gr(!1,t,r,i,n),Gr(!1,i,n,t,r)}))}},Kr=function(e){return e.properties["@ns:com:here:editor"]},Hr=function(e){return!!Kr(e).created},Vr=function(e){return!!Kr(e).removed},Yr=function(){function e(e){this.pIds={},this.iEdit=e}return e.prototype.reserveIds=function(e,t,r,i){var o=this.pIds,s=e.id,a=[];for(var d in t)Hr(t[d])&&(o[s][d]||a.push(t[d]));a.length>0?e.reserveId(a,(function(e){for(var i in t){var n=t[i];Hr(n)&&!o[s][i]&&(o[s][i]=e.shift())}r(o[s],s)}),i):n.setTimeout((function(){r(o[s],s)}),0)},e.prototype.replaceIds=function(e,t,r){var n,o,s,a=this.pIds,d=this.iEdit,u=0;for(var p in s=JSON.stringify(e),e){for(var l in u++,o=!1,e[p])if(Hr(e[p][l])){o=!0;break}a[p]||(a[p]={}),o?(d.dump("REQUESTING PERMANENT IDs..","info"),this.reserveIds(d.getProviderById(p),e[p],(function(r,o){var a,p,l="#"+i.String.random()+"#";for(var c in r)(n=e[o][c])&&(a="number"==typeof r[c]?r[c]:'"'+r[c]+'"',"string"==typeof(p=n.id)&&(p='"'.concat(n.id.replace(/(?=[.\\+*?[^\]$(){}\|])/g,"\\"),'"')),a!=p&&(s=s.replace(p+":{",l).replace(new RegExp('"link":'+p,"g"),'"link":"'+a+'"').replace(new RegExp(p,"g"),a).replace(l,a+":{")),d.dump(n.id+" -> "+a,"info"));--u||t(JSON.parse(s))}),r)):u--}!u&&t(e)},e.prototype.send=function(e,t,r,n){var o=this.pIds,s=this.iEdit,a=0;function d(){--a||t(i.clone(o))}for(var u in e){a++;var p=s.getProviderById(u),l=e[u],c=[],h=[],f=void 0;for(var v in l)f=l[v],(Vr(f)?h:c).push(f);var g=o[u],y={};for(var A in g)y[g[A]]=A;c.length|h.length?p.commit({put:c,remove:h},d,(function(e){r&&r(e)}),n):d()}},e.prototype.submit=function(e,t,r,n){var o=this;void 0===n&&(n=i.String.random());var s=this.iEdit,a=s._config.services.reverseGeocoder.getISOCC,d=0;s.dump("COMMIT",n,"info");var u=function(){o.replaceIds(e,(function(e){o.send(e,t,r,n)}),r)};function p(e){if(e)return"number"==typeof e[0]?e:p(e[0])}for(var l in e){var c=function(t){var r=e[l][t],i=s.getProviderById(l);Vr(r)?Hr(r)&&delete e[l][t]:a&&(i.isoCC(r)||(d++,s.dump(r.id,"["+i.detectFeatureClass(r)+"] MISSING ISOCC -> REVERSE GEOCODING..","info"),function(e,t){a(t[0],t[1],(function(t){t&&i.isoCC(e,t),--d||u()}))}(r,p(r.geometry.coordinates))))};for(var h in e[l])c(h)}d||u()},e}(),Ur=function(e){var t=e.class;return"NAVLINK"==t?"NAVLINK":String(t)+(e.src||e.base+e.delta||e.id)},Zr=function(e,t,r){var i=t.hooks;if(i)for(var n in i){var o=i[n];o instanceof Array||(o=[o]);for(var s=0,a=o;s<a.length;s++){var d=a[s];r.hooks[e](n,d,t)}}},Wr=function(e){!function(e){var t,r,i=e.objects.history.getChanges(),n=[];for(var o in i)for(var s in r=e.getProviderById(o),i[o])t=r.search(s),r._clearOnCommit?(t&&(t.properties["@ns:com:here:editor"].drop=!0),n.push(r,i[o][s].bbox)):t&&(t.properties["@ns:com:here:editor"]={});for(var a=0;a<n.length;a+=2)(r=n[a]).clear.apply(r,n[a+1])}(e),e.objects.history.clear(),e.display.refresh()},Qr=function(){function e(e,t){var r=this,n=this,o=(t=function(e){var t=i.extend(!0,{},Br);for(var r in e)switch(r){case"services":i.extend(!0,t[r],e[r]);break;case"editRestrictions":if("function"!=typeof e[r])break;default:t[r]=e[r]}return t}(t||{})).layers;delete t.layers,i.loglevel=t.debug&&"debug";var s,a=new Dr(t,e);n._i=function(){return a},s=a,function(e){var t;for(var r in e){"function"==typeof(t=e[r])&&(t=[t]);for(var i=0,n=t;i<n.length;i++){var o=n[i];s.hooks.add(r,o)}}}(zr),n.container=e.getContainer(),o instanceof Array&&o.forEach((function(e){return r.addLayer(e)})),n.active(!0),setTimeout((function(){var e=a.observers,t=e.get("active"),r=t;e.change("active",t,r),a.layers.length||e.change("ready",!0)}),0)}return e.prototype.active=function(e){var t=this._i(),r=t.observers.get("active");return null!=e&&(e=!!e)!=r&&(r=e,t.objects.listenDisplay(e),t.observers.change("active",e,!0)),r},e.prototype.addEventListener=function(e,t,r){var n=this._i().listeners,o=n.supported().filter((function(e){return"_"!=e[0]}));String(e).split(" ").forEach((function(e){o.indexOf(e)>-1?n.add.call(n,e,t,r):i.dump(e+" is not a valid event. Use: "+o.join(", "),"warn")}))},e.prototype.removeEventListener=function(e,t){var r=this._i().listeners;r.remove.apply(r,arguments)},e.prototype.addFeature=function(e,t,r){var i,n,o=this._i(),s=arguments,a=[],d={},u={},p=function(e){return null!=e.x&&null!=e.y||null!=e.longitude&&null!=e.latitude},l=function(e,t){if(p(e)&&(e=o.map.getGeoCoord(e)),"number"==typeof e[0])return e[0]+=t[0],e[1]+=t[1],o.map.clipGeoCoord(e);for(var r=[],i=0;i<e.length;i++)r[i]=l(e[i],t);return r},c=function(e,t){var r=t&&t.id;(u[r]=u[r]||[]).push(e)};if("Feature"==e.type)c(e,t);else if(e instanceof Array)e.forEach((function(e){return c(e,t)}));else for(var h in u=e)"Feature"==(e=u[h]).type&&(u[h]=[e]);if(r=s[s.length-1],p(r)){r=o.map.getGeoCoord(r);var f=o.display.getViewBounds();n=[r[0]-f.minLon,r[1]-f.maxLat]}else n=[0,0];var v=function(e){u[e].forEach((function(t){var r=t.geometry;r.coordinates=l(r.coordinates,n),"Feature"!=t.type||t instanceof _t||(t=new _t(t)),(t=o.objects.add(t,"undefined"==e?undefined:e,d))&&(i=!0,a.push(t))}))};for(var g in u)v(g);return i&&o.objects.history.saveChanges(),a.length>1?this.createFeatureContainer.apply(this,a):a[0]},e.prototype.addHook=function(e,t,r){return this._i().hooks.add(e,t,r)},e.prototype.removeHook=function(e,t,r){return this._i().hooks.remove(e,t,r)},e.prototype.getHooks=function(e){return this._i().hooks.get(e)},e.prototype.getFeature=function(e,t){return this._i().objects.get(e,t)||null},e.prototype.config=function(e,t){var r=this._i()._config;switch(arguments.length){case 2:r[e]=t;break;case 1:return r[e];case 0:return A({},r)}},e.prototype.createFeatureContainer=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=new ar(this._i());return r.push(e.flat()),r},e.prototype.clearFeatureSelection=function(){return this._i().objects.selection.clearSelected()||null},e.prototype.search=function(e){var t,r=this._i(),i=[];if("object"==typeof e)for(var n=e.filter,o=e.layers||r.layers,s=o.length;s--;){var a=o[s].search(e);a instanceof Array||(a=[a]);for(var d=a.length;t=a[--d];)n&&!n(t)||i.push(t)}return i},e.prototype.addLayer=function(e){if(e){var t=this._i(),r=t.layerMap,i=e.getProvider();if(i&&"FeatureProvider"==i.__type&&i.editable&&(!r[Ur(i)]||"NAVLINK"==i.class)){if(i._e instanceof Dr){if(i._e===t)return!1;throw new Error("Provider already in use by another editor")}return i._e=t,e.class=i.class,t.listeners.trigger("_layerAdd",{layer:e}),r[Ur(i)]=e,t.layers.push(e),Zr("add",i,t),!0}}return!1},e.prototype.getLayers=function(e){var t=this._i().layers;return e?t[e]:t.slice()},e.prototype.removeLayer=function(e){if(e){var t=this._i(),r=t.layerMap,i=t.layers,n=e.getProvider(),o=Ur(n);if("FeatureProvider"==n.__type&&n.editable&&r[o])return t.listeners.trigger("_layerRemove",{layer:e}),delete r[o],i.splice(i.indexOf(e),1),Zr("remove",n,t),delete n._e,!0}return!1},e.prototype.addObserver=function(e,t){this._i().observers.addObserver(e,t,arguments[2])},e.prototype.get=function(e){return this._i().observers.get(e)},e.prototype.removeObserver=function(e,t){this._i().observers.removeObserver(e,t,arguments[2])},e.prototype.destroy=function(){var e=this,t=e._i();for(var r in e.getLayers().forEach((function(t){return e.removeLayer(t)})),e.active(!1),t.destroy(),e)delete e[r];return e.__proto__={},null},e.prototype.setZoomLevel=function(e){this._i().display.setZoomlevel(e)},e.prototype.getZoomLevel=function(){return this._i().display.getZoomlevel()},e.prototype.pixelToGeo=function(e){var t=this._i().map.getGeoCoord(e);return t?new h(t[0],t[1]):null},e.prototype.geoToPixel=function(e){var t=this._i().map.getPixelCoord(e);return t?new f(t[0],t[1]):null},e.prototype.revert=function(){for(var e=this._i(),t=e.observers.get("history.current");t--;)e.objects.history.recoverViewport(-1,!0);Wr(e)},e.prototype.getDrawingBoard=function(){var e=this._i();return e._db=e._db||new wt(e)},e.prototype.getZoneSelector=function(){return this.getRangeSelector()},e.prototype.getRangeSelector=function(){var e=this._i();return e._rngSel=e._rngSel||new Vt(e)},e.prototype.getOverlay=function(){return this._i().objects.overlay.layer},e.prototype.undo=function(e){for(e=Math.min(this.get("history.current"),e||1);e--;)this._i().objects.history.recoverViewport(-1,!!e)},e.prototype.redo=function(e){for(e=Math.min(this.get("history.length"),e||1);e--;)this._i().objects.history.recoverViewport(1,!!e)},e.prototype.submit=function(e){var t,r=!1,i=[],n=(e=e||{}).ignoreEventBlock,o=e.layer,s=e.onError,a=e.onSuccess,d=e.transactionId,u=this._i();if("function"==typeof n)throw new Error("Invalid parameter!");if(n||!u.isCommitInProcess){for(var p in o=o instanceof Array?o:[o]){var c=o[p];c&&c instanceof l&&"MARKER"==c.type&&(c.base&&i.push(c.base),c.delta&&i.push(c.delta),c.src&&i.push(c.src))}for(var h in t=u.objects.history.getChanges())i.length>0&&i.indexOf(h)<0?delete t[h]:r=!0;if(r)return u.listeners.trigger("_beforeSubmit"),function(e,t,r,i,n){e.isCommitInProcess||(e.objects.selection.clearSelected(),e.observers.change("ready",e.isCommitInProcess),e.isCommitInProcess=!0,new Yr(e).submit(t,(function(t){e.isCommitInProcess=!1,r.call(null,t)}),(function(t){e.isCommitInProcess=!1,i.call(null,t)}),n))}(u,t,(function(e){Wr(u),u.listeners.trigger("_afterSubmit"),a&&a({permanentIDMap:e})}),(function(e){u.listeners.trigger("_afterSubmit"),s&&s(e)}),d),!0}return!1},e.prototype.info=function(){var e=[],t=this._i().objects.history.getChanges();for(var r in t)for(var n in t[r])e[e.length]=i.clone(t[r][n]);return e},e.prototype.export=function(){var e=this._i();return JSON.stringify(e.objects.history.getChanges())},e.prototype.import=function(e){var t=this._i();return"string"==typeof e&&(e=JSON.parse(e)),t.objects.history.import(e)},e.prototype.toGeoJSONCoordinates=function(e){if(Array.isArray(e)&&"number"!=typeof e[0]){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r];t.push(this.toGeoJSONCoordinates(n))}return t}return this._i().map.getGeoCoord(e)},e}();Qr.prototype.clearObjectSelection=Qr.prototype.clearFeatureSelection;var Xr={dragPlane:"XY"},Jr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return y(t,e),t.prototype.behavior=function(e,t){var r=he.private(this,"b")||A({},Xr);switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];break;case 2:var i={};i[e]=t,e=i}r=A(A({},r),e),e.dragPlane?delete r.dragAxis:e.dragAxis&&delete r.dragPlane,this.__.b=r},t}(_t);Jr.prototype.class="MARKER";var qr=function(e){function t(t,r){return e.call(this,t,r)||this}return y(t,e),t.prototype.coord=function(t){return e.prototype.coord.call(this,t)},t.prototype.getBBox=function(){var e=this.geometry.coordinates;return[e[0],e[1],e[0],e[1]]},t.prototype.getLink=function(){var e,t=je.getRoutingData(this);if(t.link){var r=je.getRoutingProvider(this);e=r&&r.search(t.link)}return e||null},t}(Jr),$r=function(e){function t(t,r){return e.call(this,t,r)||this}return y(t,e),t.prototype.createRoutingPoint=function(){var e=this;je.getRoutingData(e).link||(je.connect(e),je.getRoutingData(e).link&&je.markAsModified(e))},t.prototype.removeRoutingPoint=function(){var e=this;je.getRoutingData(e).link&&(je.disconnect(e),je.markAsModified(e))},t.prototype.prop=function(e,t){var r=this,n=arguments.length,o=r.getProvider().getFeatureProperties(r),s=!1;if(!n||1==n&&"string"==typeof e)return null!=(e=e?o[e]:o)&&"object"==typeof e?i.extend(!0,new e.constructor,e):e;if(2==n){var a={};a[e]=arguments[1],e=a}for(var d in e){var u=e[d],p="object"==typeof u,l=o[d];(p&&JSON.stringify(u)!=JSON.stringify(l)||!p&&l!==u)&&(s||(r._e().objects.history.origin(r),s=!0),o[d]=u)}je.getRoutingData(r).link?je.connect(r,null):je.disconnect(r),s&&(r._e().setStyle(r),je.markAsModified(r))},t}(qr);$r.prototype.class="PLACE";var ei,ti=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return y(t,e),t.prototype.prop=function(e,t){var r=this,n=!1,o=arguments.length,s=r.getProvider().getFeatureProperties(r);if(!o||1==o&&"string"==typeof e)return null!=(e=e?s[e]:s)&&"object"==typeof e?i.extend(!0,new e.constructor,e):e;if(2==o){var a={};a[e]=arguments[1],e=a}for(var d in e){var u=e[d],p="object"==typeof u,l=s[d];(p&&JSON.stringify(u)!=JSON.stringify(l)||!p&&l!==u)&&(n||(r._e().objects.history.origin(r),n=!0),s[d]=u)}je.connect(r,null),n&&(r._e().setStyle(r),je.markAsModified(r))},t}(qr);ti.prototype.class="ADDRESS",function(e){e.CROSSING="CROSSING",e.CROSSING_CANDIDATE="CROSSING_CANDIDATE"}(ei||(ei={}));var ri="#FFFFFF",ii="#FF0000",ni={zIndex:0,type:"Line",stroke:ii,strokeWidth:22,strokeLinecap:"round",opacity:.5},oi={zIndex:1,type:"Line",stroke:ri,strokeWidth:18,strokeLinecap:"round",opacity:.8},si={zIndex:2,type:"Line",stroke:"#000000",strokeWidth:14,strokeLinecap:"round",opacity:.8},ai={zIndex:3,type:"Circle",stroke:ii,strokeWidth:1,opacity:.5,radius:12,fill:ii},di={zIndex:4,type:"Circle",stroke:ri,strokeWidth:2,opacity:1,radius:10,fill:ri},ui={zIndex:5,type:"Circle",stroke:ri,radius:3,fill:ri};function pi(e,t){for(var r=e.coord(),i=0;i<r.length;i++)if(t[0]==r[i][0]&&t[1]==r[i][1])return i;return N(r,t)}var li=function(){function e(e,t,r,i,n){this.type="Feature";var o=e.iEditor,s=n||i,a=[(s[0]-i[0])/2+i[0],(s[1]-i[1])/2+i[1]],d=o.map.getPixelCoord(a);this._={iEditor:o,xTester:e,link:t,candidate:r,searchPnt:i,foundPnt:n},this.x=d[0],this.y=d[1];var u=!!n;n=n||i;var p=o.display.geoToPixel(i[0],i[1]),l=o.display.geoToPixel(n[0],n[1]);this.distance=K([p.x,p.y],[l.x,l.y]),this.class=u?ei.CROSSING_CANDIDATE:ei.CROSSING,this.type="Feature",this.geometry=u?{type:"LineString",coordinates:[i,n]}:{type:"Point",coordinates:a}}return e.prototype.getLinkIndex=function(){var e=this._;return pi(e.link,e.searchPnt)},e.prototype.getCandidateIndex=function(){var e=this._;return pi(e.candidate,e.foundPnt||e.searchPnt)},e.prototype.getRelatedLink=function(){return this._.candidate},e.prototype.connect=function(){var e=this.getRelatedLink(),t=this._,r=t.iEditor,i=t.xTester,n=this.getLink();if(!e.id||!n.id||e.editState("removed")||e.editState("modified")>i.createTS||n.editState("removed")||n.editState("modified")>i.createTS)return!1;var o,s,a=this.class==ei.CROSSING_CANDIDATE,d=this.getCandidateIndex(),u=(t.foundPnt||t.searchPnt).slice(),p=[];(a||(s=dt.addShp(n,r.map.clipGeoCoord(u),null,!0)),o=a?this.getLinkIndex():s,!1!==this.getLinkIndex())&&(a&&n.getConnectedLinks(o).forEach((function(e){dt.markAsModified(e,!1,!1)})),(dt.connectShpToLink(n,o,e,r.map.clipGeoCoord(u),"number"==typeof d?d:undefined).splittedInto||[]).forEach((function(e){null!=e&&p.push(e)})));for(var l in this.hide(),this)"type"!==l&&(this[l]=undefined);return i.getCrossings({links:p,croLink:n})},e.prototype.show=function(){var e=this,t=e._,r=t.iEditor,i=t.xTester,n=r.objects.overlay,o=t.foundPnt||t.searchPnt,s=t.set=t.set||function(t,o,s,a){var d=i.getStyle(),u=r.getStyle(s)[0].stroke,p=r.getStyle(a)[0].stroke,l=function(e){return n.addPath([t,o],e)},c=function(e,t){return n.addCircle(e,t)},h=function(t){return r.listeners.trigger(t,e)},f=r.getStyleProperty(s,"altitude");if(u&&p){var v=[l(A(A(A({},ni),d.connector1),{altitude:f})),l(A(A(A({},oi),d.connector2),{altitude:f})),l(A(A(A({},si),d.connector3),{altitude:f})),c(t,A(A(A({},ai),d.search1),{altitude:f})),c(t,A(A(A(A({},di),{fill:u}),d.search2),{altitude:f})),c(o,A(A(A(A({},ui),{fill:p,stroke:p}),d.found),{altitude:f}))];return v.forEach((function(e){return e.pointerup=h})),v}}(t.searchPnt,o,this.getLink(),this.getRelatedLink());r.objects.overlay.showFeature(s)},e.prototype.hide=function(){var e=this._,t=e.set;t&&t.forEach((function(e){e._provider.removeFeature(e)})),e.set=null},e.prototype.getLink=function(){return this._.link},e.prototype.getConnectedLinks=function(){return this.class==ei.CROSSING_CANDIDATE?this.getLink().getConnectedLinks(this.getLinkIndex()):[]},e}();var ci,hi=function(){function e(e,t){this.foundCrossings=[],this.simpleCrossings=[],this.iEditor=e,this.setRelatedLink(t)}return e.prototype.clear=function(){var e=this.foundCrossings,t=this.simpleCrossings;t.forEach((function(e){e.hide&&e.hide()})),e.length=0,t.length=0,this.createTS=0},e.prototype.checkRealCrossing=function(e,t){var r=this,i=[],n=e._e().getStyleProperty(e,"altitude")?void 0:0,o=function(e,t){for(var r=[],i="number"==typeof t,n=0,o=e;n<o.length;n++){var s=o[n],a=i?t:s[2]||0;r[r.length]=[s[0],s[1],a]}return r},s=o(e.geometry.coordinates,n),a=function(t,i){for(var a=!1,d=[],u=function(e,t){for(var r=[],i=0;i<e.length-1;i++)for(var n=0;n<t.length-1;n++){var o=F(e[i],e[i+1],t[n],t[n+1]);o.intersects&&o.onSegment&&r.push({point:o.p0,s1:i+1,s2:n+1})}return r}(s,o(t.geometry.coordinates,n)),p=0,l=0,c=u.length;p<c-1;l=++p)for(var h=u[p],f=h.point,v=void 0;++l<c;){var g=(v=u[l]).point;f[0]==g[0]&&f[1]==g[1]&&Math.abs(v.s1-h.s1)<=1&&Math.abs(v.s2-h.s2)<=1&&(u.splice(l--,1),c--)}for(p=0;p<u.length;p++){f=u[p].point;a=!1;for(var y=0,A=void 0;y<i.length;y++)if((A=i[y]).link.id==t.id&&dt.isIntersection(r.iEditor,f,A.link.coord()[A.index],!n)){a=!0;break}a||d.push(new li(r,e,t,f))}return d};if(!e.editState("removed")){var d=e.getConnectedLinks(0,!0).concat(e.getConnectedLinks(s.length-1,!0));t.forEach((function(e){i=i.concat(a(e,d))}))}return i},e.prototype.getNearestLineCandidate=function(e,t,r,i){if(undefined===i){i=[e.id];var n=e.getConnectedLinks(t,!0);for(var o in n)i.push(n[o].link.id)}var s=e.coord(),a=this.iEditor.objects.getNearestLine(s[t],r,{ignore:function(e){return-1!=i.indexOf(e.id)},maxDistance:this.maxDistance});if(null!=a&&function(e,t){for(var r in e)if(-1!=t.indexOf(e[r].link.id))return!0;return!1}(a.line.getConnectedLinks(a.shpIndex,!0),i))return i.push(a.line.id),this.getNearestLineCandidate(e,t,r,i);return a},e.prototype.calculateCrossings=function(e,r){var i,n=this,o=[];return this.createTS=+new Date,(Array.isArray(e)?e:[e]).forEach((function(e){if(!(e.editState("removed")||r&&"CROSSING"!=r&&"CROSSING_CANDIDATE"!=r)){var s=t.extendBBox(e.getBBox(),n.maxDistance),a=n.iEditor.objects.getInBBox(s,e.getProvider()),d=a.indexOf(e);-1!=d&&a.splice(d,1),"CROSSING_CANDIDATE"!=r&&(o=o.concat(n.checkRealCrossing(e,a))),"CROSSING"!=r&&e.coord().forEach((function(t,r){(i=n.getNearestLineCandidate(e,r,a))&&i.distance>.001&&o.push(new li(n,e,i.line,t,i.point))}))}})),o},e.prototype.getRelatedLink=function(){return this.linkOrig},e.prototype.getCrossings=function(e){var t=this;return e=e||{},t.setRelatedLink(undefined),e.links?e.croLink&&e.links.length&&(t.relatedLink=t.relatedLink.concat(e.links)):(t.searchType==e.class&&t.maxDistance==e.maxDistance||(t.createTS=0),t.cStyles=e.styles||{},t.searchType=e.class),t.maxDistance=e.maxDistance||t.iEditor._config.snapTolerance||3,(!t.createTS||t.linkOrig.editState("modified")>t.createTS||e.links)&&(t.clear(),t.foundCrossings=t.calculateCrossings(t.relatedLink,t.searchType)),t.getSimplifiedCrossings()},e.prototype.getSimplifiedCrossings=function(){this.simpleCrossings.length=0;for(var e=0,t=this.foundCrossings;e<t.length;e++){var r=t[e];this.simpleCrossings.push(r)}return this.simpleCrossings},e.prototype.setRelatedLink=function(e){e&&(this.linkOrig=e,this.relatedLink=[e])},e.prototype.getStyle=function(){return this.cStyles},e}(),fi=function(e){return e.getProvider().readPedestrianOnly(e)},vi=function(e){return e.getProvider().readDirection(e)},gi=function(e,t,r,i){var n=vi(r);return r.getZLevels()[i]===e.getZLevels()[t]&&("BOTH"==n||(0==i?"START_TO_END":"END_TO_START")==n)},yi=function(){function e(e,r,i,n,o,s){var a=e.objects.overlay,d=0==o?1:n.coord().length-2,u=n.coord(),p=u[o].slice(),l=u[d].slice();dt.ignoreZ(r)&&(p[2]=0,l[2]=0);var c=O(p,l,8e-5),h=function(e,t,r,i){var n=function(e,t,r,i){return e.getProvider().readTurnRestriction({link:e,index:t},{link:r,index:i})}(e,t,r,i);return gi(e,t,r,i)?n?"FORBIDDEN":fi(r)?"PEDESTRIAN":"ALLOWED":"ONEWAY"}(r,i,n,o),f=a.addPath([c,p,s],null,{type:"TURN_RESTRICTION_LINE",sign:"TURN_RESTRICTION_"+h}),v=a.addImage(c,null,{type:"TURN_RESTRICTION_"+h,rotation:-t.calcBearing(p,c)});this.sign=v,this.line=f,this.overlay=a,this.to=n,this.from=r,dt.showDirection(n),a.remove(f),v.pointerenter=function(){a.addFeature(f)},v.pointerleave=function(){a.remove(f)},v.pointerup=function(){gi(r,i,n,o)&&!fi(n)&&(e.objects.history.ignore((function(){!function(e,t,r,i,n){t.getProvider().writeTurnRestriction(e,{index:r,link:t},{index:n,link:i})}("ALLOWED"==h,r,i,n,o)})),h="ALLOWED"==h?"FORBIDDEN":"ALLOWED",e.objects.history.saveChanges()&&(v.properties.type="TURN_RESTRICTION_"+h,f.properties.sign=v.properties.type,e.setStyle(v),e.setStyle(f)))}}return e.prototype.hide=function(){dt.hideDirection(this.to),this.overlay.remove(this.sign),this.overlay.remove(this.line),this.sign=null,this.line=null},e}();!function(e){e.BOTH="BOTH",e.FROM_RN="START_TO_END",e.TO_RN="END_TO_START"}(ci||(ci={}));var Ai=function(){function e(e,t){var r=this,i=e._e();this._overlay=i.objects.overlay,this._trs=[];var n=function(){r.hide(),i.listeners.remove("_clearOverlay",n)};i.listeners.add("_clearOverlay",n),this._l=e,this._i=t,this.show()}return e.prototype._hideOrigin=function(){this._origin&&this._overlay.remove(this._origin),this._origin=null},e.prototype._showOrigin=function(e,r){var i=e.coord(),n=0==r?1:i.length-2,o=i[r],s=i[n];dt.ignoreZ(e)&&(o=[o[0],o[1],0],s=[s[0],s[1],0]);var a={geometry:{coordinates:O(o,s,1e-4),type:"Point"},type:"Feature",properties:{type:"TURN_RESTRICTION_START",rotation:-t.calcBearing(o,s)}};this._origin=this._overlay.addFeature(a)},e.prototype.show=function(){var e=this,t=this._l,r=this._i,i=vi(t),n=0==r?ci.FROM_RN:ci.TO_RN;if(!(i!=ci.BOTH&&n==i||fi(t))){var o=t.getConnectedLinks(r,!0);o.length&&this._showOrigin(t,r),this._trs=o.map((function(i){return new yi(t._e(),t,r,i.link,i.index,e._origin.geometry.coordinates)}))}},e.prototype.hide=function(){var e=this._trs;for(var t in e)e[t].hide(),e[t]=null;e.length=0,this._hideOrigin()},e.prototype.isActive=function(){return this._trs.length>0},e}(),mi=function(){function e(e,r,i,n){var o=r.coord(),s="END_TO_START"==i?180:0,a=[];n||a.push(e.addPoint(o[0].slice(),{type:"NAVLINK_DIRECTION_HINT_A"}),e.addPoint(o[o.length-1].slice(),{type:"NAVLINK_DIRECTION_HINT_B"}));for(var d=0;d<o.length-1;d++){var u=o[d],p=o[d+1],l={type:"BLOCKED"==i?"NAVLINK_DIRECTION_HINT_BLOCKED":"BOTH"==i?"NAVLINK_DIRECTION_HINT_2WAY":"NAVLINK_DIRECTION_HINT_1WAY"};"BLOCKED"!=i&&(l.bearing=s-t.calcBearing(u,p)),a.push(e.addPoint(j(u,p,.5),l))}this.overlay=e,this.points=a}return e.prototype.destroy=function(){this.overlay.remove(this.points),this.points=null},e}(),_i=function(e){throw new Error(e)},Si={snapCoordinates:!0},Li=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.setGeoFence=function(e){(isNaN(e)||e<0)&&_i("Geofence radius should be a positive Number"),t._e()._config.geoFence=+e},t}return y(t,e),t.prototype.coord=function(t){return e.prototype.coord.call(this,t)},t.prototype.checkCrossings=function(e){var t=this,r=dt.private(t),i=r.xt||new hi(t._e(),t);return r.xt=i,i.getCrossings(e)},t.prototype.showDirectionHint=function(e,t){e={B:"BOTH",F:"START_TO_END",T:"END_TO_START",N:"BLOCKED"}[e]||e;var r=dt.private(this),i=r.dh;i&&i.destroy(),r.dh=e&&new mi(this._e().objects.overlay,this,e,t)},t.prototype.addShape=function(e,t){var r=!1,i=this._e().map.getGeoCoord(e);return i?!1!==(r=dt.addShp(this,i,t,undefined,!0))&&dt.markAsModified(this):_i("Invalid coordinate"),r},t.prototype.behavior=function(e,t){var r=dt.private(this,"b")||A({},Si);switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];r=A(A({},r),e);break;case 2:r[e]=t}this.__.b=r},t.prototype.getConnectedLinks=function(e,t){void 0===t&&(t=!1);var r,i,n=this,o=n._e(),s=n.coord(),a=s[e],d=[],u=0==e||e==s.length-1,p=dt.ignoreZ(n);if(u)for(var l=0,c=o.objects.getInBBox(n.bbox,n.getProvider());l<c.length;l++){var h=c[l];h.id!=n.id&&"NAVLINK"==h.class&&(i=(r=h.coord()).length-1,null!=(e=dt.isIntersection(o,r[0],a,p)?0:dt.isIntersection(o,r[i],a,p)?i:null)&&d.push(t?{index:e,link:h}:h))}return d},t.prototype.getZLevels=function(e){var t=this.getProvider().readZLevels(this);return"number"==typeof e?t[e]:t.slice(0)},t.prototype.getSelectedShapes=function(){for(var e=dt.private(this,"selectedShapes"),t=this.geometry.coordinates,r=[],i=0;i<t.length;i++)r[i]=!!e[i];return r},t.prototype.setSelectedShapes=function(e){for(var t=this,r=dt.private(t,"selectedShapes"),i=t.geometry.coordinates,n=0;n<i.length;n++)r[n]=Boolean(e[n]);dt.refreshGeometry(t)},t.prototype.setZLevels=function(e){var t=this,r=t.getZLevels(),i=t._e().objects.history,n=t.geometry.coordinates.length;e instanceof Array||_i("Invalid 'zlevel' argument given, no array"),e.length!==n&&_i("Given 'zlevel' argument is of an invalid size, a length of "+n+" is required!"),i.origin(t);for(var o=!1,s=0,a=void 0;s<e.length;s++)(a=0^e[s])!=r[s]&&(e[s]=a,o=!0);o&&(i.ignore((function(){t.getProvider().writeZLevels(t,e)})),dt.refreshGeometry(this),dt.markAsModified(this))},t.prototype.editTurnRestrictions=function(e){var t=this,r=t.coord(),i=t._e(),n=0==e||e==r.length-1?[e]:undefined===e?[0,r.length-1]:[];i.listeners.trigger("_clearOverlay");var o=n.map((function(e){return new Ai(t,e)}));return undefined===e?o:o[0]},t.prototype.prop=function(e,t){var r=this,n=r._e(),o=!1,s=arguments.length,a=r.getProvider().getFeatureProperties(r);if(0==s||1==s&&"string"==typeof e){var d=e?a[e]:a;return"object"==typeof d?i.extend(!0,new d.constructor,d):d}var u=e;if(2==s){var p={};p[e]=arguments[1],u=p}for(var l in u){var c=u[l],h="object"==typeof c,f=a[l];(h&&JSON.stringify(c)!=JSON.stringify(f)||!h&&f!==c)&&(o||(n.objects.history.origin(r),o=!0),a[l]=c)}o&&(n.setStyle(r),r.editState("selected")&&dt.showDirection(r),dt.markAsModified(r))},t}(_t);Li.prototype.class="NAVLINK";var bi=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return y(t,e),t.prototype.addShape=function(e,t,r){var i=this,n=i._e().map.getGeoCoord(e),o=r;return n?((o=ke.addCoord(i,n,o,t||0))&&(ke.displayShapes(i),ke.markAsModified(i)),o):(function(e){throw new Error(e)}("Invalid coordinate"),!1)},t.prototype.coord=function(t){return e.prototype.coord.call(this,t)},t.prototype.getSelectedShapes=function(){for(var e,t=this,r=ke.private(t,"selectedShapes"),i=ke.getCoordinates(t),n=[],o=0;o<i.length;o++){n[o]=[];for(var s=0;s<i[o].length;s++)n[o][s]=!!(null===(e=r[o])||void 0===e?void 0:e[s])}return ke.isMultiLineString(t)?n:n[0]},t.prototype.setSelectedShapes=function(e){var t,r=this,i=ke.private(r,"selectedShapes"),n=ke.getCoordinates(r);Array.isArray(null==e?void 0:e[0])||(e=[e]);for(var o=0;o<n.length;o++){i[o]||(i[o]=[]);for(var s=0;s<n[o].length;s++)i[o][s]=Boolean(null===(t=null==e?void 0:e[o])||void 0===t?void 0:t[s])}ke.displayShapes(r)},t}(_t);bi.prototype.class="LINE";var ki=function(e){throw new Error(e)},Ci={snapCoordinates:!0},Ei=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return y(t,e),t.prototype.addShape=function(e,t,r){var i=!1,n=this._e().map.getGeoCoord(e);return e?(1==arguments.length&&(t=he.getPoly(this,n)),!1!==(i=he.addShp(this,n,0^t,0,r))&&he.markAsModified(this)):ki("Invalid coordinate"),i},t.prototype.addHole=function(e){var t=this;if(e){e=this._e().map.getPixelCoord(e);for(var r=this,i=he.getPoly(r,e),n=he.getCoords(r),o=n[i],s=1/0,a=0;a<o.length;a++){var d=he.getMaxSpace(r,e,o[a]);d<s&&(s=d)}if(s!=1/0&&(s=Math.floor(.5*s))>8){var u=e[0],p=e[1],l=[[u-s,p+s],[u+s,p+s],[u+s,p-s],[u-s,p-s],[u-s,p+s]].map((function(e){return t._e().map.getGeoCoord(e)}));return he.isClockwise(o[0])||l.reverse(),o.push(l),he._setCoords(r,n,!0),he.markAsModified(r),!0}return!1}},t.prototype.behavior=function(e,t){var r=he.private(this,"b")||A({},Ci);switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];r=A(A({},r),e);break;case 2:r[e]=t}this.__.b=r},t.prototype.coord=function(t){return e.prototype.coord.call(this,t)},t}(_t);Ei.prototype.class="AREA";var xi={};xi.NAVLINK="Navlink",xi.AREA="Area",xi.PLACE="Place",xi.ADDRESS="Address",xi.MARKER="Marker",xi.LINE="Line";for(var Pi=function(){function e(e){var t=function(e){if("number"==typeof(null!=e.x?e.x:null!=e.longitude?e.longitude:e[0]))return e;for(var r=[],i=0,n=e;i<n.length;i++){var o=n[i];r[r.length]=t(o)}return r};function r(r,n,o){var s=this;"number"!=typeof r&&"string"!=typeof r?(o=n,n=r):s.id=r,s.type="Feature",s.class=e,s.properties=i.extend({"@ns:com:here:editor":new gt},o||{}),s.geometry={type:"PLACE"==e||"ADDRESS"==e||"MARKER"==e?"Point":"AREA"==e?"MultiPolygon":"LineString",coordinates:t(n)}}return r.prototype=_t.prototype,r}var t={};for(var r in xi)t[xi[r]]=e(r);return t}(),Ii="here.xyz.maps.editor".split("."),Ri=n,wi=0;wi<Ii.length-1;wi++)Ri=Ri[Ii[wi]]=Ri[Ii[wi]]||{};var Oi=Ri[Ii.pop()]={Editor:Qr,features:Pi,PixelCoordinate:function(e,t,r){this.x=e,this.y=t,this.z=r||0},GeoCoordinate:function(e,t,r){this.longitude=e,this.latitude=t,this.z=r||0}};n.here.xyz.maps.providers.EditableFeatureProvider.prototype.getFeatureClass=function(e){switch(this.detectFeatureClass(e)){case"NAVLINK":return Li;case"PLACE":return $r;case"ADDRESS":return ti;case"AREA":return Ei;case"MARKER":return Jr;case"LINE":return bi;default:return this.Feature}};export{ti as Address,Ei as Area,q as AreaShape,li as Crossing,gt as DefaultEditorProperties,wt as DrawingBoard,bt as DrawingShape,Qr as Editor,St as EditorEvent,_t as Feature,bi as Line,ge as LineShape,Jr as Marker,Li as Navlink,Qe as NavlinkShape,$r as Place,Vt as RangeSelector,Oi as default,fe as defaultBehavior,Pi as features};
