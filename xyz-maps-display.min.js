/*
 * @here/xyz-maps-display
 * (c) 2019-2022 HERE
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@here/xyz-maps-common"),require("@here/xyz-maps-core")):"function"==typeof define&&define.amd?define(["exports","@here/xyz-maps-common","@here/xyz-maps-core"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).here=t.here||{},t.here.xyz=t.here.xyz||{},t.here.xyz.maps=t.here.xyz.maps||{}),t.here.xyz.maps.common,t.here.xyz.maps)}(this,(function(t,e,i){"use strict";const r=(t,e,i,r)=>{("string"==typeof e?[e]:e).forEach((e=>{t.addEventListener(e,i,r)}))},s=(t,e,i,r)=>{("string"==typeof e?[e]:e).forEach((e=>{t.removeEventListener(e,i,r)}))},n=(t,e)=>Math.round(parseFloat(((t,e)=>{let i,r;return(r=t.ownerDocument.defaultView.getComputedStyle(t,null))&&(i=r.getPropertyValue(e),""===i&&(i=t.style[e])),i})(t,e)))||0;class o{constructor(t,e,i,r){this.lrTs=!1,this.x=t,this.y=e,this.size=i,this.tile=r}}class a{constructor(t,e){this.ready=!1,this.cnt=0,this.z={},this.zLength=0,this.zd=!1,this._z3d=1/0,this.layer=t,this.tileSize=t.tileSize||null,this.layers=e,this.id=Math.floor(1e16*Math.random())}getZ(t){const e=this.z;if(this.zd){let t=0;for(let i in e)e[i]=t++;this.zLength=t,this.zd=!1,this.z3d=e[this._z3d]}return e[t]||0}getAbsoluteZ(t){const{index:e,layers:i}=this;let r=0,s=0;for(;r<e;)s+=i[r++].zLength;return null!=t&&(s+=this.getZ(t)),s}addZ(t,e){const i=this.z;null==i[t]&&(i[t]=0,this.zd=!0,e&&t<this._z3d&&(this._z3d=t))}getZ3d(){const{layers:t}=this;let e,i=0,r=0;for(;e=t[i++];){if(e._z3d>=0)return r+e.z3d;r+=e.zLength}return r}}class l extends Array{constructor(...t){super(...t),this._map={},Object.setPrototypeOf(this,l.prototype)}indexOf(t){let e=this._map[t.id];return super.indexOf(e)}fixZ(){for(let t=0;t<this.length;t++)this[t].index=t}add(t,e){const i=t.id;let r,s=this._map[i];return s?(this.splice(super.indexOf(s),1),this.splice(e,0,s),r=!1):(s=this._map[i]=new a(t,this),this.splice(e,0,s),r=!0),this.fixZ(),r}remove(t){let e=this.indexOf(t);return-1!==e&&(this.splice(e,1),delete this._map[t.id],this.fixZ()),e}get(t){return"string"!=typeof t&&(t=t.id),this._map[t]}reset(t){const e=new Set;let i;for(let r of this)if(i=r.layer,r.error=!1,r.cnt=0,r.tiles=[],r.visible=t>=i.min&&t<=i.max){if(r.ready=!1,i.custom)continue;e.add(i.tileSize)}else r.ready=!0;return Array.from(e)}}class h{constructor(t,e){this.display=t,this.render=e}forEachTile(t,e){t.getProvider().getCachedTilesOfBBox(t.getBBox()).forEach(e)}remove(t,e,i){for(let r of e)this.removeFromTile(t,r,i)}modifyInTile(t,e,i,r){let s=this.isVertexDataInitialized(e);return!!s&&(this.display.updateTile(e,s,r,t),!0)}isVertexDataInitialized(t){return this.display.getBucket(t.quadkey)}addToTile(t,e,i){const r=this.isVertexDataInitialized(e);r&&this.display.updateTile(e,r,i,t)}removeFromTile(t,e,i){let r=this.isVertexDataInitialized(e);r&&this.display.updateTile(e,r,i,t)}add(t,e,i){for(let r of e)this.addToTile(t,r,i)}updateGeometry(t,e,i,r){let s=r.getProvider(),n=s.getCachedTilesOfBBox(e),o=s.getCachedTilesOfBBox(t.getBBox());for(var a=0,l=o.length;a<l;a++){let e=n.indexOf(o[a]);-1===e?this.addToTile(t,o[a],r):(this.modifyInTile(t,o[a],i,r),n.splice(e,1))}for(a=0,l=n.length;a<l;a++)this.removeFromTile(t,n[a],r),this.removeFromTile(t,n[a],r)}repaint(t,e,i){let r=this;r.forEachTile(t,(function(e){let s=r.isVertexDataInitialized(e);s?r.display.updateTile(e,s,i,t):e.preview&&(e.preview=undefined)}))}clear(t,e){e=e||[];const i=this.display,r=i.layers.indexOf(t);i.buckets.forEach((function(i){e.length&&!((t,e)=>{let i=t.length;for(var r,s,n=0;n<e.length;n++)if(s=t,r=e[n],i>e[n].length&&(r=s,s=e[n]),0===r.search(s))return!0})(i.quadkey,e)||(i.clear(r),i.ready(r,!1),i.cancelTasks(t),i.luTs=null)})),i.update()}}const c=[];class u{constructor(t,e){this.display=t,"number"==typeof e?(this.down=e,this.up=e):(this.down=e[0],this.up=e[1])}lookUp(t,e,i,r,s,n){const o=t.quadkey;let a,l,h,c=i-r;if(a=Number(o[c]),n.x+=a%2*e/2,n.y+=Number(a>1)*e/2,h=o.substring(0,c),this.hasData(h,s)){let t=e/Math.pow(2,r);return l=[],this.add(l,h,n.x,n.y,t,0,0,e),l}n.x/=2,n.y/=2}add(t,e,i,r,s,n,o,a){t.push([e,i,r,s,s,0^n,0^o,a,a])}hasData(t,e){const i=this.display.buckets.get(t,!0);if(i)return i.ready(e)&&i.getData(e)}lookDown(t,e,r,s,n){let o,a,l,h,c,u,f=r+s;o=i.tileUtils.getTilesOfLevel(t.quadkey,f);for(let t=0;t<o.length;t++){a=l=0,h=e;for(let i=0;i<s;i++)h/=2,c=o[t][r+i],a+=c%2*h,l+=Number(c>1)*h,i==s-1&&this.hasData(o[t],n)&&(u=u||[],this.add(u,o[t],0,0,e,a,l,h))}return u}create(t,e,i,r){const s=t.quadkey.length,n=e.min,o=e.max,a=o-s,l=s-n,h={x:0,y:0};let u,f,d,p=0,g=e.tileSize;i=i||this.down,(r=r||this.up)>l&&(r=l),i>a&&(i=a);const m=r>i?r:i,v=t.index(e);for(;p++<m;){if(f=s-p,f>=n&&(u=this.lookUp(t,g,s,p,v,h)))return u;if(d=s+p,d<=o&&p<i&&(u=this.lookDown(t,g,s,p,v)))return u}return c}}let f=document.createElement("canvas").getContext("2d"),d="abcdefghijklmnopqrstuvwxyz";d=d+d.toUpperCase()+" 0123456789";let p=d.length,g={};const m="normal 12px Arial",v=(t,e,i,r)=>{t.font=e.font||m,"number"==typeof e.strokeWidth?t.lineWidth=e.strokeWidth:t.lineWidth=1,t.strokeStyle=r,t.fillStyle=i,t.textAlign=e.textAlign||"start",t.lineCap="round",t.lineJoin="round"},y=(t,e,i,r,s)=>{const{fill:n,stroke:o,strokeWidth:a}=s;o&&0!=a&&t.strokeText(e,i,r),n&&t.fillText(e,i,r)},x=(t,e,i,r,s)=>{r=r||128,s=s||128,t.fillStyle="#000",t.fillRect(0,0,r,s),v(t,e,"#fff","#fff"),y(t,i,0,0,e);const n=t.getImageData(0,0,r,s).data;let o=-1,a=-1;for(let t=0;t<s;t++)for(let e=0;e<r;e++){if(0!=n[4*(t*r+e)]){-1==o&&(o=t);break}if(e==r-1&&-1!==o){a=t,t=s;break}}return t.clearRect(0,0,r,s),{height:a-o,min:o,max:a}},_=(t={})=>{let{font:e,strokeWidth:i}=t;e=e||m,i=i||0;const r=e+i;return g[r]||(f.font=e,f.textBaseline="top",g[r]={width:f.measureText(d).width/p,height:x(f,t,"gM").height}),g[r]},b=(t,e)=>{if(!1===e)return[t];null!=e&&!0!==e||(e=14);const i=[];let r=0,s=-1;for(let n,o,a,l=0,h=t.length;l<h;l++)o=t.charAt(l),a=l-r," "==o?s=l:"\n"==o&&(a=1/0,s=l),a>=e&&r<=s&&(n=t.substring(r,s),r=s+1,i.push(n)),l==h-1&&r<=l&&(n=t.substring(r,l+1),i.push(n));return i},w={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgrey:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",grey:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"778899",lightslategrey:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"},M=t=>{const e=t.length;return e<5?[parseInt(t.charAt(0),16)/15,parseInt(t.charAt(1),16)/15,parseInt(t.charAt(2),16)/15,4==e?parseInt(t.charAt(3),16)/15:1]:A(parseInt(t,16),8==e)},A=(t,e)=>e?[(t>>24&255)/255,(t>>16&255)/255,(t>>8&255)/255,(255&t)/255]:[(t>>16&255)/255,(t>>8&255)/255,(255&t)/255,1];for(let t in w)w[t]=M(w[t]);const S=(t,e)=>{let i;return t&&(Array.isArray(t)?(i=t,3==i.length&&(i[3]=1)):"number"==typeof t?e||(i=A(t)):"#"==t[0]?i=M(t.slice(1)):/^([A-Fa-f\d]+)$/.test(t)?i=M(t):t.startsWith("rgb")?i=(t=>{const e=t.match(/^rgba?\s*\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*(?:\.\d+)?))?\)$/);return(null==e?void 0:e.length)>3&&[e[1]/255,e[2]/255,e[3]/255,null==e[4]?1:Number(e[4])]})(t):(i=w[t],i=i&&[i[0],i[1],i[2],i[3]])),i||null};let T;const L=(t,e)=>{for(let i of[t,e])for(let r=0;r<i.length;r++){let s,n=T,o=T,a=T,l=T,h=(r+1)%i.length,c=i[r],u=i[h],f=[u[1]-c[1],c[0]-u[0]];for(let e of t)s=f[0]*e[0]+f[1]*e[1],(n===T||s<n)&&(n=s),(o===T||s>o)&&(o=s);for(let t of e)s=f[0]*t[0]+f[1]*t[1],(a===T||s<a)&&(a=s),(l===T||s>l)&&(l=s);if(o<a||l<n)return!1}return!0},P=(t,e,i,r,s)=>{let n=Math.sin(s),o=Math.cos(s),a=t-i,l=e-r;return[o*a-n*l+i,n*a+o*l+r]},E=(t,e,i,r,s,n)=>t>i&&t<s&&e>r&&e<n,z=(t,e,i,r)=>{const s=t-i,n=e-r;return Math.sqrt(s*s+n*n)},I=(t,e,i,r,s)=>{const n=(r[1]-i[1])*(e[0]-t[0])-(r[0]-i[0])*(e[1]-t[1]);if(0!=n){const o=((r[0]-i[0])*(t[1]-i[1])-(r[1]-i[1])*(t[0]-i[0]))/n,a=((e[0]-t[0])*(t[1]-i[1])-(e[1]-t[1])*(t[0]-i[0]))/n;if(0<=o&&o<=1&&0<=a&&a<=1)return!s||[t[0]+o*(e[0]-t[0]),t[1]+o*(e[1]-t[1]),t[2]+o*(e[2]-t[2])]}return!1},C=t=>t>47&&t<58;class R{constructor(){this.fonts={}}static getInstance(){return this.instance=this.instance||new R}getFontId(t,e){return`${t.font||"normal 12px Arial"}${t.strokeWidth||1}${e}`}initFont(t,e=1){const{fonts:i}=this,r=this.getFontId(t,e);if(!i[r]){const s=96*e,n=((t,e)=>{const i=document.createElement("canvas");return i.width=t,i.height=e,i})(s,s),o=n.getContext("2d",{willReadFrequently:!0});o.textBaseline="bottom";const a=x(o,t,"gM").height;o.textBaseline="top";const l=x(o,t,"gM").height;v(o,t,"#fff","#000"),o.setTransform(e,0,0,e,0,0);const{lineWidth:h}=o,c=Math.floor(h),u=Math.floor(h),f=l+2*u;i[r]={name:r,size:0,glyphs:new Map,paddingX:c,paddingY:u,canvas:n,ctx:o,width:s,offsetX:2*h*e,scale:e,style:t,charWidthCache:new Map,rowHeight:f*e,letterHeightBottom:a,letterHeight:l,spaceWidth:o.measureText(" ").width*e,baselineOffset:e*((l-a)/2+u)}}return i[r]}hasGlyph(t,e){return e.glyphs.has(t)}getGlyph(t,e){let i=e.glyphs.get(t);if(!i){let s=e.canvas.width,{offsetX:n,scale:o}=e;e.ctx.clearRect(0,0,s,s),y(e.ctx,t,e.paddingX,e.paddingY,e.style);let a=e.charWidthCache.get(t);null==a?a=e.ctx.measureText(t).width:e.charWidthCache.delete(t);let l=Math.round((a||0)+2*e.paddingX)*o,h=e.ctx.getImageData(0,0,l,e.rowHeight);i={char:t,width:a,data:h,direction:(r=t.charCodeAt(0),(t=>t>=32&&t<=47||t>=58&&t<=64||t>=91&&t<=96||t>=123&&t<=126)(r)||C(r)?0:(t=>t>=1424&&t<=1791||t>=1872&&t<=1919||t>=2208&&t<=2303||t>=64336&&t<=65023||t>=65136&&t<=65279)(r)?-1:1),advanceX:a?h.width-n:0},e.glyphs.set(t,i),e.size++}var r;return i}getTextWidth(t,e){const{ctx:i}=e;let r=0;for(let s of t){let t=e.glyphs.get(s);if(t)r+=t.width;else{let t=e.charWidthCache.get(s);null==t&&(t=i.measureText(s).width,e.charWidthCache.set(s,t)),r+=t}}return r}}const k=R.getInstance(),{meterToPixel:O,pixelToMeter:D}=i.webMercator,F=t=>0^Math.min(t,20),N=1/0;let B;var U;!function(t){t[t.Number=0]="Number",t[t.String=1]="String",t[t.Color=2]="Color",t[t.Size=3]="Size",t[t.Boolean=4]="Boolean",t[t.Float=5]="Float"}(U||(U={}));const W={type:{value:U.Number},zIndex:{value:U.Number},fill:{value:U.Color},stroke:{value:U.Color},strokeWidth:{value:U.Size},radius:{value:U.Size},width:{value:U.Size},height:{value:U.Size},font:{value:U.String},text:{value:U.String},textRef:{value:U.String},offsetX:{value:U.Size},offsetY:{value:U.Size},alignment:{value:U.String},rotation:{value:U.Size},priority:{value:U.Size},repeat:{value:U.Number},collide:{value:U.Size},offset:{value:U.Size},from:{value:U.Size},to:{value:U.Size},checkLineSpace:{value:U.Boolean},extrude:{value:U.Size},extrudeBase:{value:U.Size},intensity:{value:U.Float},weight:{value:U.Float}},G={};for(let t in W)W[t].value==U.Float&&(G[t]=!0);const Z=new Map,Y=(t,e,i)=>{let r=H("text",t,e,i);if(!r&&t.textRef&&(r=Z.get(t.textRef),r==B&&(r=new Function("f","return f."+t.textRef),Z.set(t.textRef,r)),r=r(e,i)),""!=r)return r!==B&&"string"!=typeof r&&(r=String(r)),r},H=(t,e,i,r)=>{let s=e[t];return"function"==typeof s?s(i,r,e):s},X=(t,e=!1)=>{let i="px",r=t;return"string"==typeof t&&(r=parseFloat(t)||0,"m"==t.charAt(t.length-1))?(i="m",r=Math.round(1e3*r)/1e3,[r,i]):(e||(r=Math.round(r||0)),[r,i])},j=(t,e,i,r,s)=>{const n=H(t,e,i,r);let[o,a]=X(n,s);if("m"==a){const t=F(r);o=Math.pow(2,r%t)*O(o,t)}return o},q=(t,e,i,r)=>{let s=H("zIndex",t,e,i),n=H("zLayer",t,e,i);return"number"!=typeof n&&(n=r+1),1e6*n+s},V=(t,e,i,r)=>{let s=0;const n=F(i);for(let i of t){let t=q(i,e,n,r);t>s&&(s=t)}return s},K=(t,e,i,r,s)=>{let n,o=0,a=0;const l=F(i);for(let h=0;h<t.length;h++){n=t[h];if("Line"==H("type",n,e,l)&&(!s||!H("altitude",n,e,l))){let t=q(n,e,l,r);t>a&&(a=t);const s=j("strokeWidth",n,e,i,!0);s>o&&(o=s)}}return[o,a]},Q=(t,e,i,r,s,n)=>{const o=F(i),a=H("type",t,e,o);let l,h,c,u,f,d,p=0,g=0;s=s||[N,N,-1/0,-1/0];const m=H("fill",t,e,o),v=!n&&H("stroke",t,e,o);if("Image"!=a&&!m&&!v)return null;if("Text"==a){const i=Y(t,e,o);if(!i)return null;const s=H("strokeWidth",t,e,o);let n=H("font",t,e,o);const a=k.initFont({font:n,strokeWidth:s,fill:m,stroke:v},r);let l;if(f=0,"LineString"==e.geometry.type||"MultiLineString"==e.geometry.type)f=k.getTextWidth(i,a),d=a.letterHeight;else{const r=H("lineWrap",t,e,o);l=b(i,r);for(let t of l){let e=k.getTextWidth(t,a);e>f&&(f=e)}d=l.length*a.letterHeight}const h=H("textAnchor",t,e,o);if("string"==typeof h)switch(h){case"Top":g+=.5*d;break;case"TopLeft":p+=.5*f,g+=.5*d;break;case"TopRight":p-=.5*f,g+=.5*d;break;case"Bottom":g-=.5*d;break;case"BottomLeft":p+=.5*f,g-=.5*d;break;case"BottomRight":p-=.5*f,g-=.5*d}}else{let i=H("strokeWidth",t,e,o);isNaN(i)&&(i=1),"Circle"==a?(f=2*j("radius",t,e,o)^0,d=f):(f=0^j("width",t,e,o),d=j("height",t,e,o),d=0^(d||f)),d+=i,f+=i}p+=0^H("offsetX",t,e,o),g+=0^H("offsetY",t,e,o);let y="Circle"!=a&&0^H("rotation",t,e,o);if(y){const t=((t,e,i,r=0,s=0)=>{const n=r-(e*=.5),o=r+e,a=s-(i*=.5),l=s+i,h=P(n,a,r,s,t),c=P(o,l,r,s,t),u=P(n,l,r,s,t),f=P(o,a,r,s,t);return[Math.min(h[0],c[0],u[0],f[0]),Math.min(h[1],c[1],u[1],f[1]),Math.max(h[0],c[0],u[0],f[0]),Math.max(h[1],c[1],u[1],f[1])]})(y,f,d,p,g);l=t[0],c=t[1],h=t[2],u=t[3]}else l=p-.5*f,h=l+f,c=g-.5*d,u=c+d;return l<s[0]&&(s[0]=l),h>s[2]&&(s[2]=h),c<s[1]&&(s[1]=c),u>s[3]&&(s[3]=u),s},$=(t,e,i,r,s,n)=>{const o=F(i);let a,l,h=0;for(let c of t){if(n&&H("altitude",c,e,o))continue;l=Q(c,e,i,r,l,!0)||l,a=q(c,e,o,s),a>h&&(h=a)}if(l)return l[4]=h,l},J=t=>t.type&&t.zIndex!=B,tt=(t,e=0,i=1)=>Math.min(i,Math.max(e,t)),et=(t,e,i,r,s)=>((t,e,i)=>t*(1-i)+e*i)(i,r,((t,e,i)=>tt((i-t)/(e-t)))(t,e,s)),it=(t,e,i=!0)=>{let r,s,n,o,a=0;for(let l in t){const h=Number(l);r=t[h];const c=Array.isArray(r);let u,f;if(c?u=r:i?[u,f]=X(r):u=r,"px"==f&&(r=u),e<=h){if(0==a)return"m"==f?t[h]:u;if(c){let t=[];for(let i=0;i<u.length;i++)t[i]=et(o,h,s[i],u[i],e);return t}if(h-o>1){let t=s,i=u,r=f!=n,a="m"==f;r&&(a?t=D(t,o):i=D(i,h));return et(o,h,t,i,e)+(r||a?"m":0)}return r}o=h,s=u,n=f,a++}return r},rt=(t,e,i={})=>{let r={};for(let e in t)r[Math.round(Number(e))]=t[e];for(let t=1;t<=20;t++)i[t]=it(r,t,e);return i},st=t=>{for(let e in t)t[e]=S(t[e]);return t},nt=(t,e)=>{t=rt(t,e);const i=(e,i)=>t[null!=i?i:e];return i.map=t,i},ot=t=>{if(!t.__p){t.__p=!0;for(let e of t)for(let t in e)if(t in W){let i=e[t];if("object"==typeof i&&!Array.isArray(i)&&!i.type){"stroke"!=t&&"fill"!=t||st(i);const r=!G[t];e[t]=nt(i,r)}}}};var at=Object.freeze({__proto__:null,getTextString:Y,calcBBox:Q,is3d:(t,e,i)=>{const r=F(i);for(let i of t)if(H("altitude",i,e,r)||H("extrude",i,e,r))return!0;return!1},getExtrude:(t,e,i)=>{const r=F(i);for(let i of t){const t=H("extrude",i,e,r);if(t)return t}return null},fillMap:rt,parseColorMap:st,createZoomRangeFunction:nt,getValue:H,parseSizeValue:X,getLineWidth:K,getPixelSize:$,getSizeInPixel:j,merge:(t,e)=>{if(null===e||!1===e)return null;let i,r=[];for(let s=0,n=t.length;s<n;s++){i=t[s],r.push([i[0],{}]);for(let t in i[1])r[s][1][t]=i[1][t];if(e[s]){r[s][0]=e[s][0];for(let t in e[s][1])r[s][1][t]=e[s][1][t]}}return r},isStyle:J,getMaxZoom:V,parseStyleGroup:ot});const lt=()=>1,ht="*";let ct;class ut{constructor(t,e){this.tm=t,this.ms=e}exclusiveRuntime(t){this.ms=t}spawn(t,e,i,r,s,n,o,a){let l=this.createTask(t,e,i,r,s,n,o);return this.tm.start(l,a),l}createTask(t,e,i,r,s,n,o){const a=[],l=this.ms,h=this.tm.create({time:l,priority:t,init:function(){if(r){let t=r.length,e=Date.now();for(;t--;)r[t];h.time=l-(Date.now()-e)}return[i,r,s,0,a,300,e,{}]},name:"cluster",onDone:function(){const t=e.getStyle(),r=t&&(t.strokeWidthZoomScale||t.LineStringZoomScale)||lt;a.swzs=r(i.z),o(a,this)},exec:function(t){let e=t[0],i=t[1],r=t[2],s=t[6],o=i.length,a=t[4];const l=e.z;let h,c,u,f,d,p,g,m,v,y,x,_,b,w,M,A,S,T,L,P,E;if(i&&!(t[3]>=o)){for(;t[5]--&&(d=i[t[3]++]);)if(p=d.id,!r[p]&&(r[p]=!0,u=s.getStyleGroup(d,l),u)){u.length||(u=[u]);for(let t=0,e=u.length;t<e;t++)f=u[t],J(f)&&(h=H("zIndex",f,d,l),g=H("type",f,d,l),M=H("opacity",f,d,l),_=ct,x=ct,b=ct,w=ct,T=ct,A=ct,S=ct,L=ct,P=ct,E=ct,"Image"==g?c="I":(x=H("fill",f,d,l),b=H("stroke",f,d,l),w=H("strokeWidth",f,d,l),"Line"==g?(A=H("strokeLinecap",f,d,l),S=H("strokeLinejoin",f,d,l),T=H("strokeDasharray",f,d,l),c="L"+(A||ht)+(S||ht)+(T||ht)):"Text"==g?(_=H("font",f,d,l)||"normal 12px Arial",c="T"+(_||ht)):"Circle"==g?(L=H("radius",f,d,l),c="C"+L||ht):(P=H("width",f,d,l),E=H("height",f,d,l)||P,c="R"+P+E),c+=(b||ht)+(w||ht)+(x||ht)),M!=ct&&(c+=100*M^0),m=a[h]=a[h]||[],y=m[c],y==ct?(y=m[c]=m.length,v=m[y]={shared:{font:_,fill:x,opacity:M,stroke:b,strokeWidth:w,strokeLinecap:A,strokeLinejoin:S,strokeDasharray:T},data:new n}):v=m[y],v.data.add(d,f))}return t[5]=300,t[3]<o}}});return h}}const ft=1/0;class dt{constructor(t){this.tiles={},this.size=t}init(t,e,i,r,s){this.cwpx=t[0],this.cwpy=t[1],this.width=i,this.height=r,this.bounds=s;let n=ft,o=-n,a=ft,l=-a;for(let[t,e]of s)t<n&&(n=t),t>o&&(o=t),e<a&&(a=e),e>l&&(l=e);this.minX=n,this.maxX=o,this.minY=a,this.maxY=l}getTiles(t,e=this.size){const{width:r,height:s}=this,n=Math.pow(2,t)*e;let o=this.bounds,a=[],l=this.cwpx*n,h=this.cwpy*n,c=(l-r/2+this.minX)/e,u=(h-s/2+this.minY)/e,f=(l+r/2+this.maxX-r)/e,d=(h+s/2+this.maxY-s)/e,p=i.tileUtils.pixelToGrid(c,u,t),g=i.tileUtils.pixelToGrid(f,d,t),m=g[0]-p[0]+1,v=g[1]-p[1]+1,y=(p[0]-c)*e+this.minX,x=(p[1]-u)*e+this.minY;for(let r=0;r<v;r++)for(let s=0;s<m;s++){let n=y+s*e,l=x+r*e,h=n+e,f=l+e;if(L(o,[[n,l],[h,l],[h,f],[n,f]])){const e=i.tileUtils.tileXYToQuadKey(t,Math.floor(u+r),Math.floor(c+s));a.push({quadkey:e,x:n,y:l})}}return this.tiles[e]=a,a}}const pt=60/180*Math.PI;function gt(t,e,i){if(e[t+="EventListener"])for(var r in i)e[t](r,i[r])}class mt{constructor(t,i,r,s,o,a){this.updating=!1,this._gridClip={rz:0,rx:0,s:0,top:0},this.dirty=!1,this.globalBgc=!1;const c=this,f=n(t,"width"),d=n(t,"height"),p=((t,e,i,r,s)=>{let n,o,a=document.createElement("canvas"),l=a.style;return((t,e,i)=>{t.setAttribute("width",e),t.setAttribute("height",i)})(a,e,i),a.setAttribute("oncontextmenu","return false;"),((t,e)=>{["-webkit-user-select","-moz-user-select","-ms-user-select","user-select"].forEach((function(i){t.style[i]=e}))})(a,"none"),l.top=l.left="0px",l.position="absolute",1!=s&&(l.opacity=String(s)),t.querySelectorAll("canvas[type=layer]"),a.setAttribute("type","layer"),n=t.querySelectorAll("canvas"),o=n[r],o?t.insertBefore(a,o):t.appendChild(a),a})(t,f,d,0);c.previewer=new u(c,a),c.cluster=new ut(e.TaskManager.getInstance(),4),c.grid=new dt(i),c.tiles={256:[],512:[]},c.render=o,c.tileSize=i,c.buckets=s,c.layers=new l,c.w=f,c.h=d,c.canvas=p,p.className="tmc",c.dpr=mt.getPixelRatio(r),c.setSize(f,d),c.setBGColor();const g=new h(c,o);c.listeners={clear:t=>{const{tiles:e,layer:i}=t.detail;g.clear(i,e)},featureAdd:t=>{const{feature:e,tiles:i,layer:r}=t.detail;i&&g.add(e,i,r)},featureRemove:t=>{const{feature:e,tiles:i,layer:r}=t.detail;i&&g.remove(e,i,r)},featureCoordinatesChange:t=>{const{feature:e,prevBBox:i,prevCoordinates:r,layer:s}=t.detail;g.updateGeometry(e,i,r,s)},styleGroupChange:t=>{const{feature:e,styleGroup:i,layer:r}=t.detail;g.repaint(e,i,r)},styleChange:t=>{const{layer:e,style:i}=t.detail,r=c.layers.indexOf(e);c.setLayerBgColor(i,c.layers[r]),c.buckets.tiles.forEach((t=>t.clear(r)))}}}static getPixelRatio(t){return(t="auto"==t?Math.min(2,e.global.devicePixelRatio||1):t||1)<1?1:t}addLayer(t,e,i){const r=this,s=r.layers;let n=!1;if(s.add(t,i)){const e=s.get(t);if(n=!0,r.buckets.forEach((t=>{t.addLayer(i)})),gt("add",t,r.listeners),t.custom)return n;e.handleTile=i=>{r.isVisible(i,e)&&r.handleTile(i,t)},0==i&&r.setLayerBgColor(t.getStyle(),e)}return n}removeLayer(t){const e=this,i=this.layers,r=i.get(t),s=r.tiles,n=i.indexOf(t);if(-1!==n){e.buckets.forEach((e=>{e.cancelTasks(t),e.removeLayer(n)}));for(let i of s){const s=i.tile.quadkey;e.releaseTile(s,r),e.cancel(s,t)}i.remove(t),gt("remove",t,e.listeners)}return n}getBucket(t,e){const i=this;let r;return r=e?i.buckets.create(t,i.layers):i.buckets.get(t),r}handleTile(t,e,i,r){const s=this;let n,o=!1;if(i?o=!0:i=s.getBucket(t.quadkey,true),null==r&&(r=s.layers.indexOf(e)),t.error&&(s.layers[r].error=!0),!i.ready(r)&&!i.busy(e)&&(n=t.data)){const a=(e,i)=>{t.isLoaded()&&e.ready(e.index(i),!0),s.update(o)};i.ready(r,!1);let l=e.render;l?l(t,n,e,i,a):s.prepareTile(t,n,e,i,a)}}setLayerBgColor(t,e){let{backgroundColor:i}=t;i&&("object"!=typeof i||Array.isArray(i)||(i=nt(st(i))),e.bgColor="function"==typeof i?i:this.render.convertColor(i))}processLayerBackgroundColor(t){var e;const i=this;let r=null===(e=i.layers[0])||void 0===e?void 0:e.bgColor;"function"==typeof r&&(r=i.render.convertColor(r(t))),this.bgColor=r||i.globalBgc}isVisible(t,e){const i=t.quadkey;for(let t of e.tiles)if(t.tile.quadkey==i)return!0;return!1}getContext(){return this.render.getContext()}copyCanvas2d(t=0,e=0,i=this.w,r=this.h){const{canvas:s,dpr:n}=this;t*=n,e*=n,i*=n,r*=n;const o=document.createElement("Canvas");return o.width=i,o.height=r,this.viewport(),o.getContext("2d").drawImage(s,t,e,i,r,0,0,i,r),o}getScreenTile(t,e){return this.grid.tiles[e].find((e=>e.quadkey==t))}updateTile(t,e,i,r){if(e&&!e.busy(i)){const r=this,s=e.index(i);e.ready(s,!1),r.isVisible(t,r.layers[s])&&r.handleTile(t,i,e,s)}}setSize(t,e){var i=this,r=i.dpr,s=i.canvas;i.w=t,i.h=e,s.width=t*r,s.height=e*r,s.style.width=t+"px",s.style.height=e+"px"}cancel(t,e){const i=this.buckets.get(t,!0);i&&i.cancelTasks(e)}preview(t,e,i){const r=this.previewer.create(t,e);return t.preview(i,r),r}initVpTiles(t,e,i){const r=this,s=this.layers,n=r.tiles[i];let a=r.tiles[i]=[];const l=[];for(let n of t){const{x:t,y:h,quadkey:c}=n,u=r.getBucket(c,true),f=new o(t,h,i,u);u.i=++this.ti,l.push(f),a.push(f);for(let t of s){let s=t.layer;s.tiled&&((s.tileSize||256)==i&&(t.tiles!=l&&(t.tiles=l),e>=s.min&&e<=s.max&&(r.initTile(u,t),s.getTile(c,t.handleTile))))}}n.forEach((t=>{const e=t.tile.quadkey;for(let t of a)if(t.tile.quadkey==e)return;for(let t of s)t.layer.tileSize==i&&r.releaseTile(e,t);r.cancel(e)}))}getCamGroundPositionScreen(){return[this.w/2,this.h/2]}clipGridHeight(t){const{rz:e,rx:i,s:r,_gridClip:s,centerWorld:n}=this;if(s.rx!=i||s.rz!=e){s.rz=e,s.rx=i,this.setView(n,r,e,-t);const o=this.unproject(this.w/2,0);this.setView(n,r,e,i),s.top=this.project(o[0],o[1])[1]}return s.top}updateGrid(t,e,i){const r=this.centerWorld,s=0^t;this.processLayerBackgroundColor(t),this.viewChange=!0,this.sx=e,this.sy=i;const n=this,o=this.rz,a=this.w,l=this.h,h=a,c=Math.max(l,this.getCamGroundPositionScreen()[1]),u=this.grid;let f=0;-this.rx>pt&&(f=this.clipGridHeight(pt));let d=[n.unproject(0,f),n.unproject(h-1,f),n.unproject(h-1,c-1),n.unproject(0,c-1)];u.init(r,o,a,l,d);const p=this.layers.reset(s+Math.log(this.s)/Math.LN2);this.ti=0;for(let t of p){const e=n.grid.getTiles(s-Number(512==t),t);this.initVpTiles(e,s,t)}-1==p.indexOf(512)&&n.grid.getTiles(s-1,512),this.dirty=!0,n.update()}releaseTile(t,e){const i=e.layer,r=i.getCachedTile(t);r&&r.loadStartTs&&(r.isLoaded()||i.cancelTile(r,e.handleTile))}initTile(t,e){const i=e.index,r=this;e.visible?t.ready(i)||t.preview(i)||r.preview(t,e.layer,i):t.ready(i,!0)}update(t){const e=this;e.dirty||(e.dirty=t),e.updating||(e.updating=!0,requestAnimationFrame((()=>{e.viewport(),e.updating=!1})))}setBGColor(t="#ffffff"){const{render:e}=this;"transparent"==t&&(t="rgba(0, 0, 0, 0)"),t=e.convertColor(t),this.globalBgc=t,e.setBackgroundColor(t)}showGrid(t){this.render.grid(t)}setView(t,e,i,r,s,n){this.centerWorld=t,this.setTransform(e,i,r)}setTransform(t,e,i){this.render.setScale(this.s=t,0,0),this.render.setRotation(this.rz=e,this.rx=i),this.render.applyTransform()}getLayers(){return this.layers}destroy(){this.render.destroy();var t=this.canvas;t.parentElement.removeChild(t),t.width=t.height=1}clearLayer(t){const e=this.getLayers().indexOf(t);this.buckets.forEach((t=>{t.preview(e,!1),t.ready(e,!1)}))}viewChangeDone(){this.viewChange=!1}getRenderedFeatureAt(t,e,i){return null}scaleOffsetXYByAltitude(t){return 1}}const vt=window.console.error,yt=(t,e,i,r)=>{r=r||vt;const s=t.createShader(i);if(t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS)){return r("compileShader "+t.getShaderInfoLog(s)),t.deleteShader(s),null}return s},xt=(t,e,i)=>{const r=yt(t,e,t.VERTEX_SHADER),s=yt(t,i,t.FRAGMENT_SHADER),n=((t,e,i)=>{i=i||vt;const r=t.createProgram();for(let i of e)t.attachShader(r,i);if(t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))return i("linkProgram "+t.getProgramInfoLog(r)),t.deleteProgram(r),null;return r})(t,[r,s]);return t.detachShader(n,r),t.detachShader(n,s),t.deleteShader(r),t.deleteShader(s),n};class _t{constructor(t){for(var e in t)this[e]=t[e]}}var bt;!function(t){t[t.OPAQUE=1]="OPAQUE",t[t.ALPHA=2]="ALPHA",t[t.POST_ALPHA=4]="POST_ALPHA"}(bt||(bt={}));let wt;class Mt{constructor(t,e,i,r){this.attributeLocations={},this.attributeDivisors=[],this.uniforms={},this.uniformSetters={},this.textureUnits=0,this.macros={M_PI:3.1415927410125732},this.dpr=e,this.usage=t.STATIC_DRAW,i&&(this.macros=Object.assign(Object.assign({},this.macros),i)),this.mode=r||t.TRIANGLES,this.gl=t,this.framebuffer=null,this.glStates=new _t({scissor:!0,blend:!1,depth:!0})}static getMacros(t){return null}static getProgramId(t,e){return t.type}init(t,e){this.compile(this.vertexShaderSrc,this.fragmentShaderSrc,this.macros),this.setBufferCache(t),this.glExtAngleInstancedArrays=e}initBuffers(t){const e=this.gl;for(let i in t){let r=t[i];if(r.value)continue;let s=this.buffers.get(r);s||(s=e.createBuffer(),this.buffers.set(r,s)),r.dirty&&(r.dirty=!1,e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,r.data,e.STATIC_DRAW))}}createUniformSetter(t,e){const{gl:i}=this;switch(t.type){case i.FLOAT:return t=>i.uniform1f(e,t);case i.FLOAT_MAT4:return t=>i.uniformMatrix4fv(e,!1,t);case i.FLOAT_VEC2:return t=>i.uniform2fv(e,t);case i.FLOAT_VEC3:return t=>i.uniform3fv(e,t);case i.FLOAT_VEC4:return t=>i.uniform4fv(e,t);case i.BOOL:return t=>i.uniform1i(e,t);case i.SAMPLER_2D:const t=this.textureUnits++;return r=>{i.uniform1i(e,t),i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,null==r?void 0:r.texture)}}return()=>{}}buildSource(t,e,i){i=Object.assign(Object.assign(Object.assign({},this.macros),{DEVICE_PIXEL_RATIO:this.dpr.toFixed(1)}),i);let r="";for(let t in i)r+=`#define ${t} ${i[t]}\n`;return[r+"#define GLSLIFY 1\nvec2 round(vec2 point){vec2 fractPoint=fract(point);point+=step(0.5,fractPoint)-fractPoint;return point;}vec4 snapToScreenPixel(vec4 position,vec2 resolution){resolution*=DEVICE_PIXEL_RATIO;vec2 screenPixel=((position.xy/position.w+1.0)/2.0)*resolution;position.xy=(round(screenPixel)/resolution*2.0-1.0)*position.w;return position;}vec3 rotateY(vec3 v,float a){float s=sin(a);float c=cos(a);return mat3(c,0.0,-s,0.0,1.0,0.0,s,0.0,c)*v;}vec2 rotateZ(vec2 v,float a){float s=sin(a);float c=cos(a);return v*mat2(c,-s,s,c);}float toPixel(vec2 size,float zoom){float value=size.x;if(size.y>0.0){value*=zoom*size.y;}return value;}const float SCALE_UINT16_Z=9000.0/65535.0;"+t,r+e]}compile(t,e,i){const{gl:r}=this,[s,n]=this.buildSource(t,e,i||{}),o=xt(r,s,n);this.prog=o;let a=r.getProgramParameter(o,r.ACTIVE_ATTRIBUTES);for(let t=0;t<a;++t){const e=r.getActiveAttrib(o,t),{name:i,type:s}=e,n=r.getAttribLocation(o,i),a=s==r.FLOAT_MAT2?2:s==r.FLOAT_MAT3?3:s==r.FLOAT_MAT4?4:1;this.attributeLocations[i]={index:n,length:a}}let l=r.getProgramParameter(o,r.ACTIVE_UNIFORMS);for(let t=0;t<l;t++){const e=r.getActiveUniform(o,t),i=e.name,s=r.getUniformLocation(o,i);this.uniforms[i]=s,this.uniformSetters[e.name]=this.createUniformSetter(e,s)}}setBufferCache(t){this.buffers=t}getUniformLocation(t){return this.uniforms[t]}setUniform(t,e){let i;(i=this.uniformSetters[t])&&i(e)}initUniforms(t){for(let e in t){const i=this.uniformSetters[e];if(i){i(t[e])}}}setConstantAttributeValue(t,e){const{gl:i}=this;switch(i.disableVertexAttribArray(t),e.length){case 4:i.vertexAttrib4fv(t,e);break;case 3:i.vertexAttrib3fv(t,e);break;case 2:i.vertexAttrib2fv(t,e);break;case 1:i.vertexAttrib1fv(t,e)}}initAttributes(t){var e;const{gl:i,buffers:r,attributeLocations:s,attributeDivisors:n}=this;for(let o in t){let a=t[o];if(!s[o])continue;let{index:l,length:h}=s[o];const{value:c}=a;if(null!=c){for(let t=0;t<h;++t){const e=l+t;this.setConstantAttributeValue(e,c)}continue}let u=a,f=u.instanced;i.bindBuffer(i.ARRAY_BUFFER,r.get(u));const d=u.bytesPerElement,p=0|Number(f),g=u.stride^0+u.size*d,m=0^u.offset,v=u.size/h;for(let t=0;t<h;++t){const r=l+t;i.enableVertexAttribArray(r),i.vertexAttribPointer(r,v,u.type,u.normalized,g,m+t*v*d),n[r]=p,f&&(null===(e=this.glExtAngleInstancedArrays)||void 0===e||e.vertexAttribDivisorANGLE(r,1))}}}initIndex(t){const{buffers:e,gl:i}=this;let r=e.get(t),s=!0;r||(r=i.createBuffer(),e.set(t,r),s=!1),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,r),s||i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.data,i.STATIC_DRAW)}initPass(t,e){const i=Boolean(t&e.pass);return i&&this.bindFramebuffer(null),i}dbgGLState(t){const{gl:e}=this;this.__dbgGlEnums||(this.__dbgGlEnums=(t=>{for(let i of["NEVER","LESS","LEQUAL","GREATER","GEQUAL","EQUAL","NOTEQUAL","ALWAYS","KEEP","ZERO","REPLACE","INCR","INCR_WRAP","DECR","DECR_WRAP","INVERT"])t[e[i]]=i;return t})({}))}draw(t){var e,i;const{gl:r}=this,{groups:s,instances:n}=t;for(let t of s){let s=t.mode!=wt?t.mode:this.mode;if(t.uniforms&&this.initUniforms(t.uniforms),t.index){const i=t.index,o=i.length,a=i.type;this.initIndex(i),n?null===(e=this.glExtAngleInstancedArrays)||void 0===e||e.drawElementsInstancedANGLE(s,o,a,0,n):r.drawElements(s,o,a,0)}else{const e=t.arrays.first,o=t.arrays.count;n?null===(i=this.glExtAngleInstancedArrays)||void 0===i||i.drawArraysInstancedANGLE(s,e,o,n):r.drawArrays(s,e,o)}}}toggleCapability(t,e){e?this.gl.enable(t):this.gl.disable(t)}blendFunc(t=this.gl.ONE,e=this.gl.ONE_MINUS_SRC_ALPHA){this.gl.blendFunc(t,e)}initGeometryBuffer(t,e,i){var r,s,n;const o=this,{gl:a,glStates:l}=o;this._pass=e;const h=null!==(r=t.blend)&&void 0!==r?r:l.blend,c=null!==(s=t.depth)&&void 0!==s?s:l.depth,u=null!==(n=t.clip)&&void 0!==n?n:l.scissor,{scissorBox:f}=t,d=!!f;f&&a.scissor(f[0],f[1],f[2],f[3]),o.toggleCapability(a.SCISSOR_TEST,d),o.toggleCapability(a.BLEND,h),o.toggleCapability(a.DEPTH_TEST,c),o.toggleCapability(a.STENCIL_TEST,u),this.blendFunc();const p=t.cullFace();p?(a.cullFace(p),a.enable(a.CULL_FACE)):a.disable(a.CULL_FACE),null!=t.depthMask&&a.depthMask(t.depthMask);const g=t.colorMask||this.colorMask;null!=g&&a.colorMask(g.r,g.g,g.b,g.a),a.disable(a.POLYGON_OFFSET_FILL)}disableAttributes(){var t;const{attributeLocations:e,attributeDivisors:i,gl:r}=this;for(let s in e){let{index:n,length:o}=e[s];for(;o--;){let e=n+o;i[e]&&(null===(t=this.glExtAngleInstancedArrays)||void 0===t||t.vertexAttribDivisorANGLE(e,0),i[e]=0),r.disableVertexAttribArray(e)}}}delete(){this.gl.deleteProgram(this.prog)}bindFramebuffer(t=this.framebuffer,e=this.gl.canvas.width,i=this.gl.canvas.height){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.gl.viewport(0,0,e,i)}setResolution(t){}setColorMask(t){this.colorMask=t}}class At extends Mt{constructor(t,e){super(t,e),this.name="Rect",this.glStates=new _t({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute highp vec3 a_position;uniform float u_scale;uniform vec4 u_size;uniform mat4 u_matrix;uniform float u_strokeWidth;uniform vec2 u_topLeft;uniform float u_rotation;uniform vec4 u_offset;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform bool u_alignMap;uniform vec2 u_resolution;uniform bool u_scaleByAltitude;varying vec2 vSize;varying vec2 vDir;const float EXTENT_SCALE=1.0/32.0;void main(void){if(mod(a_position.x,2.0)==1.0){vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*EXTENT_SCALE;vec2 size=vec2(toPixel(u_size.xy,u_scale),toPixel(u_size.zw,u_scale));size=(size+u_strokeWidth)*.5;float rotation=u_rotation;if(!u_alignMap){rotation*=-1.0;}vec2 pixel_offset=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));float z=a_position.z*SCALE_UINT16_Z+toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;if(u_alignMap){vec2 posCenterWorld=u_topLeft+pos;vec2 shift=(pixel_offset+rotateZ(dir*vec2(size.x,-size.y),rotation))/u_scale;vec3 posWorld=vec3(posCenterWorld+shift,-z);if(!u_scaleByAltitude){float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);shift*=scaleDZ;}gl_Position=u_matrix*vec4(posCenterWorld+shift,-z,1.0);}else{vec4 cpos=u_matrix*vec4(u_topLeft+pos,-z,1.0);vec2 shift=rotateZ(dir*size,rotation);vec2 offset=pixel_offset*vec2(1.0,-1.0);gl_Position=vec4(cpos.xy/cpos.w+(offset+shift)/u_resolution*2.0,cpos.z/cpos.w,1.0);}vSize=size;vDir=dir;}}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform vec4 u_stroke;uniform float u_strokeWidth;varying vec2 vSize;varying vec2 vDir;\n#define COLOR_UNDEF -1.0\nvoid main(void){float dx=distance(vDir.x,0.0)*vSize.x;float dy=distance(vDir.y,0.0)*vSize.y;if(dx>vSize.x-u_strokeWidth||dy>vSize.y-u_strokeWidth){gl_FragColor=u_stroke;}else{gl_FragColor=u_fill;if(u_fill[0]==COLOR_UNDEF){gl_FragColor.a=0.0;};}}"}}class St extends Mt{constructor(t,e){super(t,e),this.name="Circle",this.glStates=new _t({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute highp vec3 a_position;uniform vec2 u_radius;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform vec4 u_offset;uniform float u_scale;uniform vec2 u_resolution;uniform bool u_alignMap;uniform float u_strokeWidth;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform bool u_scaleByAltitude;varying vec2 v_position;varying float v_radius;const float EXTENT_SCALE=1.0/32.0;void main(void){if(mod(a_position.x,2.0)==1.0){vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*EXTENT_SCALE;float radius=toPixel(u_radius,u_scale);radius=radius+u_strokeWidth/2.0;v_position=dir*radius;v_radius=radius;vec2 pixel_offset=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));float z=a_position.z*SCALE_UINT16_Z+toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;vec3 posWorld=vec3(u_topLeft+pos,-z);if(u_alignMap){vec2 shift=(pixel_offset+v_position*vec2(1.0,-1.0))/u_scale;if(!u_scaleByAltitude){float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);shift*=scaleDZ;}gl_Position=u_matrix*vec4(posWorld.xy+shift,posWorld.z,1.0);}else{vec4 cpos=u_matrix*vec4(posWorld,1.0);vec2 offset=pixel_offset*vec2(1.0,-1.0);gl_Position=vec4(cpos.xy/cpos.w+(offset+v_position)/u_resolution*2.0,cpos.z/cpos.w,1.0);}}}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform vec4 u_stroke;uniform float u_strokeWidth;varying float v_radius;varying vec2 v_position;\n#define COLOR_UNDEF -1.0\nvoid main(void){float r=length(v_position);if(r>v_radius)discard;if(r<v_radius-u_strokeWidth){if(u_fill[0]==COLOR_UNDEF)discard;gl_FragColor=u_fill;}else{gl_FragColor=u_stroke;}}"}}var Tt="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute highp vec4 a_normal;attribute float a_lengthSoFar;uniform mat4 u_matrix;uniform highp vec2 u_strokeWidth;uniform highp float u_scale;uniform vec2 u_topLeft;varying vec2 v_normal;\n#ifdef DASHARRAY\nvarying float v_lengthSoFar;varying vec2 v_dashSize;uniform vec2 u_dashSize;uniform vec2 u_dashUnit;\n#endif\nvarying vec2 v_width;varying vec2 v_dir;uniform vec2 u_offset;uniform float u_tileScale;uniform bool u_no_antialias;uniform bool u_scaleByAltitude;const float N_SCALE=1.0/8191.0;void main(void){float strokeWidth=toPixel(u_strokeWidth,u_scale);float alias=u_no_antialias? 0.0: strokeWidth<1. ? .65 : 1.;float width=(strokeWidth+alias)/u_scale;v_width=vec2(strokeWidth,alias);vec2 dir2=mod(a_normal.zw,2.0)*2.0-1.0;vec2 aliasNormal=floor(a_normal.zw*.5)*N_SCALE;v_normal=dir2*aliasNormal;v_dir=mod(a_normal.xy,2.0);vec2 dir=v_dir*2.0-1.0;vec2 normal=floor(a_normal.xy*.5)*N_SCALE;\n#ifdef DASHARRAY\nv_lengthSoFar=a_lengthSoFar;v_dashSize=vec2(toPixel(vec2(u_dashSize.x,u_dashUnit.x),u_scale),toPixel(vec2(u_dashSize.y,u_dashUnit.y),u_scale));\n#endif\nfloat lineOffset=toPixel(u_offset,u_scale);vec2 position=a_position.xy+normal*-lineOffset/u_scale;vec2 posCenterWorld=vec2(u_topLeft+position*u_tileScale);vec2 offset=dir*normal*width;if(!u_scaleByAltitude){vec3 posWorld=vec3(posCenterWorld+offset,-a_position.z);float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);offset*=scaleDZ;}gl_Position=u_matrix*vec4(posCenterWorld+offset,-a_position.z,1.0);}",Lt="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;varying vec2 v_normal;varying vec2 v_dir;uniform bool u_no_antialias;\n#ifdef DASHARRAY\nuniform highp float u_scale;\n#if (DASHARRAY & 2)\nuniform sampler2D u_dashPattern;\n#endif\nvarying float v_lengthSoFar;uniform sampler2D u_dashTexture;uniform bool u_hasDashTexture;varying vec2 v_dashSize;\n#endif\nvarying vec2 v_width;void main(void){highp float lineWidth=v_width.s+v_width.t;highp float width=length(v_normal)*lineWidth;if(width>lineWidth){discard;}\n#ifdef DASHARRAY\nfloat dashSize=v_dashSize.x;float gapSize=v_dashSize.y;float totalDashSize=dashSize+gapSize;\n#if DASHARRAY & 2\nfloat dash=texture2D(u_dashPattern,vec2(fract(v_lengthSoFar/totalDashSize*u_scale))).r;gl_FragColor=u_fill*step(0.1,dash);\n#else\nfloat patternPosition=fract(v_lengthSoFar/totalDashSize*u_scale);float dashPosition=dashSize/totalDashSize;\n#if DASHARRAY & 4\nfloat u=patternPosition/dashPosition;gl_FragColor=u_fill*texture2D(u_dashTexture,vec2(u,v_dir.y));\n#else\ngl_FragColor=u_fill*step(patternPosition,dashPosition);\n#endif\n#endif\n#else\ngl_FragColor=u_fill;\n#endif\nif(!u_no_antialias){float antialiasAlpha=1.0-clamp(.5*width-.5*v_width.s+.5,.0,1.);gl_FragColor*=antialiasAlpha;}}";class Pt extends Mt{constructor(t,e){super(t,e),this.name="Line",this.glStates=new _t({blend:!0,scissor:!0,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc=Tt,this.fragmentShaderSrc=Lt}}class Et extends Mt{constructor(t,e,i={}){super(t,e,i),this.name="DashedLine",this.glStates=new _t({blend:!0,scissor:!0,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc=Tt,this.fragmentShaderSrc=Lt}static getMacros(t){const{uniforms:e}=t;return{DASHARRAY:1|(e.u_dashPattern?2:0)|(e.u_dashTexture?4:0)}}static getProgramId(t,e){return t.type+e.DASHARRAY}}class zt extends Mt{constructor(t,e){super(t,e),this.name="Polygon",this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;uniform vec2 u_offsetZ;uniform float u_scale;uniform float u_zMeterToPixel;uniform mat4 u_matrix;uniform vec2 u_topLeft;void main(void){float z=a_position.z+u_offsetZ.x/u_zMeterToPixel/u_scale;gl_Position=u_matrix*vec4(u_topLeft+a_position.xy,-z,1.0);}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;void main(void){gl_FragColor=u_fill;}"}}class It extends Mt{constructor(t,e){super(t,e),this.name="Image",this.glStates=new _t({scissor:!0,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec2 a_position;attribute vec2 a_textureCoord;uniform highp mat4 u_matrix;uniform highp vec2 u_topLeft;uniform highp vec2 u_resolution;uniform float u_tileScale;varying vec2 v_textureCoord;uniform float u_scale;void main(void){v_textureCoord=a_textureCoord;highp vec4 position=u_matrix*vec4(u_topLeft+a_position*u_tileScale,0.0,1.0);gl_Position=position;}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nvarying vec2 v_textureCoord;uniform sampler2D u_sampler;void main(void){gl_FragColor=texture2D(u_sampler,v_textureCoord);}"}}class Ct extends Mt{constructor(t,e){super(t,e),this.name="Text",this.glStates=new _t({blend:!0,scissor:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision highp float;\n#define GLSLIFY 1\nattribute vec3 a_point;attribute vec3 a_position;attribute vec2 a_texcoord;uniform vec2 u_resolution;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform vec4 u_offset;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform float u_scale;uniform float u_rotate;uniform bool u_alignMap;uniform bool u_fixedView;uniform vec2 u_texSize;uniform bool u_scaleByAltitude;varying vec2 v_texcoord;varying vec4 vColor;const float EXTENT_SCALE=1.0/64.0;const float OFFSET_SCALE=1.0/32.0;const float PI_05=M_PI*0.5;const float PI_15=M_PI*1.5;const float PI_20=M_PI*2.0;void main(void){if(mod(a_position.x,2.0)==1.0){vec2 position=floor(a_position.xy/2.0)*EXTENT_SCALE;vec2 rotLowHi=mod(a_texcoord,32.0);float rotationZ=rotLowHi.y*32.0+rotLowHi.x;v_texcoord=floor(a_texcoord/32.0)/u_texSize;vec2 labelOffset=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));labelOffset*=DEVICE_PIXEL_RATIO;rotationZ=rotationZ/1024.0*PI_20;float z=a_position.z*SCALE_UINT16_Z+toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;if(u_alignMap){float absRotation=mod(u_rotate+rotationZ,PI_20);float rotationY=a_point.z/32767.0*PI_20;if(absRotation>PI_05&&absRotation<PI_15){rotationZ+=M_PI;labelOffset*=-1.0;rotationY*=-1.0;}vec3 offset=vec3(a_point.xy*OFFSET_SCALE+labelOffset,0.0)/u_scale/DEVICE_PIXEL_RATIO;offset=rotateY(offset,rotationY);offset.xy=rotateZ(offset.xy,rotationZ);vec3 posWorld=vec3(u_topLeft+position,-z);if(!u_scaleByAltitude){float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);offset.xy*=scaleDZ;}gl_Position=u_matrix*vec4(posWorld+offset,1.0);}else{vec4 cpos=u_matrix*vec4((u_topLeft+position),-z,1.0);vec2 offset=rotateZ(a_point.xy*OFFSET_SCALE+labelOffset,rotationZ);gl_Position=vec4(cpos.xy/cpos.w+vec2(1,-1)*offset/DEVICE_PIXEL_RATIO/u_resolution*2.0,cpos.z/cpos.w,1.0);}if(u_fixedView){gl_Position=snapToScreenPixel(gl_Position,u_resolution);}}}",this.fragmentShaderSrc="precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texcoord;uniform sampler2D u_texture;uniform bool u_strokeOnly;uniform vec4 u_fillColor;uniform vec4 u_strokeColor;void main(){vec4 glyph=texture2D(u_texture,v_texcoord);vec4 color;float glyphAlpha;if(u_strokeOnly){color=u_strokeColor;glyphAlpha=glyph.a;}else{color=u_fillColor;glyphAlpha=glyph.r;}gl_FragColor=glyphAlpha*color;}"}blendFunc(){const{gl:t}=this;t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA)}initGeometryBuffer(t,e,i){const{gl:r}=this;super.initGeometryBuffer(t,e),r.depthMask(!1),r.polygonOffset(0,2048*-i),r.enable(r.POLYGON_OFFSET_FILL)}draw(t){const{gl:e,uniforms:i}=this;e.uniform1f(i.u_strokeOnly,1),super.draw(t),e.uniform1f(i.u_strokeOnly,0),super.draw(t)}}class Rt extends Mt{constructor(t,e){super(t,e),this.name="icon",this.glStates=new _t({blend:!0,scissor:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec2 a_size;attribute highp vec3 a_position;attribute vec2 a_texcoord;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform float u_scale;uniform vec2 u_texSize;uniform vec4 u_offset;uniform vec2 u_offsetZ;uniform bool u_alignMap;uniform vec2 u_resolution;uniform bool u_fixedView;uniform float u_zMeterToPixel;uniform bool u_scaleByAltitude;varying float vOpacity;varying vec2 v_texcoord;const float EXTENT_SCALE=1.0/32.0;void main(void){if(mod(a_position.x,2.0)==1.0){vec2 rotLowHi=mod(a_texcoord,32.0);float rotation=rotLowHi.x+floor(rotLowHi.y*32.0);rotation=rotation/1024.0*2.0*M_PI;vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*EXTENT_SCALE;float z=a_position.z*SCALE_UINT16_Z+toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;vec2 offsetXY=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));if(u_alignMap){vec3 posWorld=vec3(u_topLeft+pos,-z);vec2 shift=rotateZ(offsetXY+dir*vec2(a_size.x,-a_size.y)*0.5,rotation)/u_scale;if(!u_scaleByAltitude){float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);shift*=scaleDZ;}gl_Position=u_matrix*vec4(posWorld.xy+shift,posWorld.z,1.0);}else{vec4 cpos=u_matrix*vec4(u_topLeft+pos,-z,1.0);vec2 shift=rotateZ(dir*a_size,-rotation)*0.5;vec2 offset=offsetXY*vec2(1.0,-1.0);gl_Position=vec4(cpos.xy/cpos.w+(offset+shift)/u_resolution*2.0,cpos.z/cpos.w,1.0);}if(u_fixedView){gl_Position=snapToScreenPixel(gl_Position,u_resolution);}v_texcoord=floor(a_texcoord/32.0)/u_texSize;}}",this.fragmentShaderSrc="precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texcoord;uniform float u_opacity;uniform sampler2D u_texture;void main(){gl_FragColor=texture2D(u_texture,v_texcoord);gl_FragColor.a*=u_opacity;if(gl_FragColor.a<.1)discard;}"}}class kt extends Mt{constructor(t,e){super(t,e),this.name="Extrude",this.glStates=new _t({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute vec3 a_normal;uniform mat4 u_matrix;uniform vec2 u_topLeft;varying vec3 v_normal;\n#define top vec2(0.0)\nvoid main(void){gl_Position=u_matrix*vec4(u_topLeft+a_position.xy,-a_position.z,1.0);v_normal=a_normal.xy==top ? vec3(0.0,0.0,-1.0): a_normal;}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform vec4 u_stroke;uniform bool u_strokePass;uniform vec3 u_lightDir;varying vec3 v_normal;\n#define top vec2(0.0)\nvoid main(void){if(u_strokePass){gl_FragColor=u_stroke;}else{vec3 normal=normalize(v_normal);float light=max(.3,dot(normal,u_lightDir));gl_FragColor.rgb=u_fill.rgb*light;gl_FragColor.a=u_fill.a;}}"}initGeometryBuffer(t,e){const{gl:i}=this;super.initGeometryBuffer(t,e),i.polygonOffset(1,1),i.enable(i.POLYGON_OFFSET_FILL)}draw(t){const{gl:e}=this;super.draw(t),e.disable(e.POLYGON_OFFSET_FILL)}}class Ot extends Mt{constructor(t,e,i){super(t,e,i),this.name="Box",this.glStates=new _t({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision mediump float;\n#define GLSLIFY 1\nvarying vec3 v_normal;attribute vec3 a_normal;attribute highp vec3 a_position;attribute highp vec3 a_point;uniform float u_scale;uniform vec4 u_size;uniform mat4 u_matrix;uniform mat4 u_inverseMatrix;uniform float u_strokeWidth;uniform vec2 u_topLeft;uniform float u_rotation;uniform vec4 u_offset;uniform bool u_alignMap;uniform vec2 u_resolution;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform bool u_scaleByAltitude;\n#ifdef SPHERE\nvarying vec3 v_rayOrigin;varying vec3 v_rayDirecton;varying vec3 v_worldPos;uniform vec2 u_radius;\n#else\nvarying vec3 vPosition;varying float v_strokeWidth;\n#endif\nvarying vec3 vSize;const float EXTENT_SCALE=1.0/32.0;void main(void){\n#ifdef SPHERE\nvec3 dir=a_point*2.0-1.0;vec3 size=vec3(toPixel(u_radius,u_scale))/u_scale;\n#else\nvec3 dir=mod(a_point,2.0)*2.0-1.0;vec3 size=floor(a_point*.5)/u_scale;\n#endif\nvec3 boxCenter=vec3(u_topLeft+a_position.xy*EXTENT_SCALE,-a_position.z*SCALE_UINT16_Z);boxCenter+=vec3(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale),-toPixel(u_offsetZ,u_scale)/u_zMeterToPixel)/u_scale;float scaleDZ=1.0+(u_scaleByAltitude ? 0.0 : boxCenter.z*u_matrix[2][3]/(u_matrix[0][3]*boxCenter.x+u_matrix[1][3]*boxCenter.y+u_matrix[3][3]));size*=scaleDZ;vec3 vertexOffset=vec3(size.xy,-size.z/u_zMeterToPixel)*dir;vec3 vertexPos=vec3(boxCenter.xy+rotateZ(vertexOffset.xy,u_rotation),boxCenter.z+vertexOffset.z);vertexPos.z=min(vertexPos.z,0.0);gl_Position=u_matrix*vec4(vertexPos,1.0);\n#ifdef SPHERE\nvec4 origin=u_inverseMatrix*vec4(gl_Position.xy,-1.0,gl_Position.w);v_rayOrigin=origin.xyz/origin.w;v_rayDirecton=vertexPos-v_rayOrigin;v_worldPos=boxCenter;v_rayOrigin.z*=u_zMeterToPixel;v_rayDirecton.z*=u_zMeterToPixel;v_worldPos.z*=u_zMeterToPixel;\n#else\nvPosition=vec3(vertexOffset.xy,vertexOffset.z*u_zMeterToPixel);v_strokeWidth=u_strokeWidth/u_scale;\n#endif\nvSize=size;v_normal=a_normal;}",this.fragmentShaderSrc="precision mediump float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform vec4 u_stroke;uniform vec3 u_lightDir;varying vec3 vSize;\n#ifdef SPHERE\nvarying vec3 v_worldPos;varying vec3 v_rayOrigin;varying vec3 v_rayDirecton;\n#else\nvarying float v_strokeWidth;varying vec3 vPosition;const float smoothness=.25;\n#endif\nuniform float u_zMeterToPixel;varying vec3 v_normal;\n#ifdef SPHERE\nfloat sphereIntersect(vec3 rayOrigin,vec3 rayDirection,vec3 spherePosition,float sphereRadius){vec3 oc=rayOrigin-spherePosition.xyz;float b=dot(oc,rayDirection);float c=dot(oc,oc)-sphereRadius*sphereRadius;float d=b*b-c;return(d<0.0)?-1.0 :-b-sqrt(d);}\n#endif\nvoid main(void){vec4 color=u_fill;vec3 normal;\n#ifdef SPHERE\nfloat radius=vSize.x;float distance=sphereIntersect(v_rayOrigin,normalize(v_rayDirecton),v_worldPos,radius);if(distance==-1.0)discard;vec3 surfacePos=normalize(v_rayDirecton)*distance+v_rayOrigin;normal=normalize(surfacePos-v_worldPos);\n#else\nvec3 size=vSize;vec3 pos=vPosition;float a=smoothstep(v_strokeWidth,v_strokeWidth+smoothness,length(abs(pos.xy)-size.xy));a*=smoothstep(v_strokeWidth,v_strokeWidth+smoothness,length(abs(pos.yz)-size.yz));a*=smoothstep(v_strokeWidth,v_strokeWidth+smoothness,length(abs(pos.xz)-size.xz));color=mix(u_stroke,u_fill,a);normal=normalize(v_normal);\n#endif\nfloat light=clamp(0.0,1.0,dot(normal,u_lightDir));color.rgb*=light;gl_FragColor=color;}"}}class Dt extends Ot{constructor(t,e){super(t,e,{SPHERE:!0}),this.name="Sphere"}}class Ft extends Mt{constructor(t,e,i){super(t,e,i),this.name="Model",this.glStates=new _t({scissor:!1,blend:!1,depth:!0}),this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute vec3 a_offset;attribute vec3 a_normal;attribute vec3 a_tangent;attribute vec4 a_color;attribute vec2 a_uv;attribute mat4 a_modelMatrix;uniform mat4 u_matrix;uniform mat4 u_world;uniform vec2 u_topLeft;uniform float u_groundResolution;uniform float pointSize;uniform vec3 u_camWorld;uniform vec3 u_lightDir;varying vec3 v_normal;varying vec2 v_texCoord;varying vec4 v_color;varying vec3 v_lightDir;\n#ifdef SPECULAR\nvarying vec3 v_surfaceToCam;\n#endif\n#ifdef NORMAL_MAP\nvarying vec3 v_tangent;\n#endif\nvoid main(void){vec4 position=a_modelMatrix*vec4(a_position,1.0);vec3 positionTileWorld=a_offset+vec3(position.xy/u_groundResolution,position.z);vec4 worldPos=vec4(u_topLeft+positionTileWorld.xy,-positionTileWorld.z,1.0);gl_PointSize=pointSize;gl_Position=u_matrix*worldPos;vec3 normal=a_normal*vec3(-1.0);if(u_groundResolution==1.0){v_texCoord=vec2(positionTileWorld.x/512.0,1.-positionTileWorld.y/512.0);v_normal=normal;}else{v_texCoord=a_uv;mat3 normalMat=mat3(a_modelMatrix);v_normal=normalize(normalMat*normal);\n#ifdef NORMAL_MAP\nv_tangent=normalize(normalMat*a_tangent);\n#endif\n}\n#ifdef SPECULAR\nv_surfaceToCam=u_camWorld-worldPos.xyz;\n#endif\nv_color=a_color;v_lightDir=u_lightDir*vec3(-1.0);}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec3 ambient;uniform vec3 diffuse;uniform vec3 emissive;uniform vec3 u_ambientLight;uniform float opacity;uniform float illumination;uniform sampler2D diffuseMap;uniform sampler2D normalMap;varying vec4 v_color;varying vec3 v_normal;varying vec2 v_texCoord;varying vec3 v_lightDir;\n#ifdef SPECULAR\nuniform float shininess;uniform vec3 specular;uniform sampler2D specularMap;varying vec3 v_surfaceToCam;\n#endif\n#ifdef NORMAL_MAP\nvarying vec3 v_tangent;\n#endif\n#ifdef DBG_GRID\nuniform highp float u_scale;\n#endif\nvoid main(){vec3 color=ambient*u_ambientLight+emissive;\n#ifdef DIFFUSE\nvec3 normal=normalize(v_normal);\n#ifdef NORMAL_MAP\nfloat flip=float(gl_FrontFacing)*2.0-1.0;normal=normal*flip;vec3 tangent=normalize(v_tangent)*flip;vec3 bitangent=normalize(cross(normal,tangent));mat3 matrixTbn=mat3(tangent,bitangent,normal);normal=texture2D(normalMap,v_texCoord).rgb*2.-1.;normal=normalize(matrixTbn*normal);\n#ifdef SPECULAR\nvec3 surfaceToCamDir=normalize(v_surfaceToCam);vec3 halfVector=normalize(v_lightDir+surfaceToCamDir);float specularLight=clamp(dot(normal,halfVector),0.0,1.0);color+=specular*texture2D(specularMap,v_texCoord).rgb*pow(specularLight,shininess);\n#endif\n#endif\nfloat diffuseLight=max(.3,dot(normal,v_lightDir));\n#else\nfloat diffuseLight=1.0;\n#endif\nvec4 diffuseMapColor=texture2D(diffuseMap,v_texCoord);vec3 diffuseColor=diffuse*diffuseMapColor.rgb*v_color.rgb;color+=diffuseLight*diffuseColor;gl_FragColor=vec4(emissive+color,opacity*v_color.a*diffuseMapColor.a);\n#ifdef DBG_GRID\nfloat tileSize=512.*u_scale;float dx=distance(v_texCoord.x,.5)*tileSize;float dy=distance(v_texCoord.y,.5)*tileSize;if(dx>(tileSize*.5-1.5)||dy>(tileSize*.5-1.5))gl_FragColor+=vec4(1.,.0,.0,.2);\n#endif\n}"}static getMacros(t){const{uniforms:e}=t;let i;return e.illumination>0&&(i={DIFFUSE:1,SPECULAR:2}),e.normalMap.width>1&&(i||(i={}),i.NORMAL_MAP=4),e.shininess>0&&(i||(i={}),i.SPECULAR=2),i}static getProgramId(t,e){return t.type+(e.DIFFUSE|e.SPECULAR|e.NORMAL_MAP)}}class Nt{constructor(t,e,i={}){var r;this.gl=t,this.format=i.format||t.RGBA,this.flipY=i.flipY||!1,this.halfFloat=i.halfFloat||!1,this.mipMaps=null===(r=i.mipMaps)||void 0===r||r,this.premultiplyAlpha=null==i.premultiplyAlpha||i.premultiplyAlpha,e&&this.set(e)}bind(){const{gl:t,texture:e}=this;e&&t.bindTexture(t.TEXTURE_2D,e)}set(t,e,i){var r;let{gl:s,texture:n,format:o,flipY:a}=this;const{width:l,height:h}=t;let c=o;const u="number"==typeof e;if(n||(this.texture=n=s.createTexture()),s.bindTexture(s.TEXTURE_2D,n),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,a),u||this.width==l&&!this.height&&!h)s.texSubImage2D(s.TEXTURE_2D,0,e||0,i||0,o,s.UNSIGNED_BYTE,t);else{if(t instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof ImageBitmap)s.texImage2D(s.TEXTURE_2D,0,c,o,s.UNSIGNED_BYTE,t);else{let e=s.UNSIGNED_BYTE;this.halfFloat&&(e=null===(r=s.getExtension("OES_texture_half_float"))||void 0===r?void 0:r.HALF_FLOAT_OES,s.getExtension("OES_texture_half_float_linear")),s.texImage2D(s.TEXTURE_2D,0,c,l,h,0,o,e,t.data)}this.width=l,this.height=h}this.mipMaps&&l==h&&(t=>0==(t&t-1))(h)?(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.generateMipmap(s.TEXTURE_2D)):(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR))}onDestroyed(t){}destroy(){const{gl:t,texture:e}=this;e&&t.deleteTexture(e),this.texture=null,this.onDestroyed(this)}getGLTexture(){return this.texture}}const Bt=(()=>{const t=Object.getPrototypeOf(Uint8Array);return e=>e instanceof t})();let Ut;const Wt=(t,e,i,r,s)=>{const n=t[e],o=t[e+1],a=t[e+2],l=t[i]-n,h=t[i+1]-o,c=t[i+2]-a,u=t[r]-n,f=t[r+1]-o,d=t[r+2]-a,p=c*f-h*d,g=l*d-c*u,m=h*u-l*f;s[e]+=p,s[e+1]+=g,s[e+2]+=m,s[i]+=p,s[i+1]+=g,s[i+2]+=m,s[r]+=p,s[r+1]+=g,s[r+2]+=m};class Gt{constructor(t,e,i){this.attributes={},this.uniforms={},this.pass=bt.OPAQUE,this.flat=!0,this.groups=[],this.instances=0,this.pixelPerfect=!1,this._cullFace=0,t&&(this.addGroup(t,i),this.type=e)}static fromTemplateBuffer(t,e){const{flexAttributes:i}=e;let r;if(e.hasIndex()){const i=e.index();if(!i.length)return null;r=new Gt(i,t,e.i32)}else r=new Gt({first:e.first,count:e.count()},t);for(let t in i){let s=i[t];s.value?r.attributes[t]={value:s.value}:s.data.length&&r.addAttribute(t,e.trimAttribute(s))}r.instances=e.instances,r.idOffsets=e.idOffsets,r.rayIntersects=e.rayIntersects,r.cullFace(e.cullFace);for(let t in e.uniforms)r.addUniform(t,e.uniforms[t]);return r}createIndex(t,e){return{index:e?{data:Bt(t)?t:new Uint32Array(t),type:5125,length:t.length}:{data:Bt(t)?t:new Uint16Array(t),type:5123,length:t.length}}}createArrays(t){return{arrays:t}}addGroup(t,e,i){if(t){let r;return r=t.first!=Ut?this.createArrays(t):this.createIndex(t,e),i&&(r.mode=i),this.groups[this.groups.length]=r}}addUniform(t,e){this.uniforms[t]=e}getUniform(t){return this.uniforms[t]}addAttribute(t,e,i=this.attributes){const{data:r}=e;e.type=(t=>t instanceof Int8Array?5120:t instanceof Uint8Array?5121:t instanceof Int16Array?5122:t instanceof Uint16Array?5123:t instanceof Int32Array?5124:t instanceof Uint32Array?5125:t instanceof Float32Array?5126:void 0)(r),e.bytesPerElement=r.BYTES_PER_ELEMENT,e.stride==Ut&&(e.stride=0),e.dirty==Ut&&(e.dirty=!0),i[t]=e}computeNormals(t,e){var i,r;void 0===t&&(t=null===(i=this.attributes.a_position)||void 0===i?void 0:i.data),void 0===e&&(e=null===(r=this.groups[0].index)||void 0===r?void 0:r.data);const s=t.length,n=new Float32Array(s);if(e)for(let i=0,{length:r}=e;i<r;i+=3)Wt(t,3*e[i],3*e[i+1],3*e[i+2],n);else for(let e=0;e<s;)Wt(t,e,e+3,e+=6,n);const o=new Int8Array(s);for(let t,e,i,r=0;r<s;r+=3){t=n[r],e=n[r+1],i=n[r+2];let s=t*t+e*e+i*i;s>0&&(s=1/Math.sqrt(s)),s*=127,o[r]=Math.round(t*s),o[r+1]=Math.round(e*s),o[r+2]=Math.round(i*s)}return o}getAttributes(){return this.attributes}destroy(t){}isPointBuffer(){const{type:t}=this;return"Line"!=t&&"Extrude"!=t}isFlat(){return this.flat}rayIntersects(t,e,i,r,s){return null}cullFace(t){return t!==Ut&&(this._cullFace=t),this._cullFace}}Gt.MODE_GL_POINTS=0,Gt.MODE_GL_LINES=1,Gt.MODE_GL_TRIANGLES=4;const Zt=bt.ALPHA;class Yt extends Mt{constructor(t,e){super(t,e),this.name="Heatmap",this.glStates=new _t({scissor:!1,blend:!0,depth:!1}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute float a_weight;uniform vec2 u_radius;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform float u_scale;uniform bool u_offscreen;varying vec2 v_texcoord;varying vec2 v_direction;varying float v_weight;const float EXTENT_SCALE=1.0/32.0;void main(void){if(u_offscreen){vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*EXTENT_SCALE;v_direction=3.0*dir;v_weight=a_weight;vec2 posCenter=vec2(u_topLeft+pos);vec2 offset=(dir*u_radius.x*vec2(1.0,-1.0));gl_Position=u_matrix*vec4(posCenter+offset/u_scale,0.0,1.0);}else{gl_Position=vec4(a_position.xy,0,1);v_texcoord=a_position.xy*0.5+0.5;}}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform bool u_offscreen;uniform sampler2D u_texture;uniform sampler2D u_gradient;varying float v_weight;uniform float u_intensity;uniform float u_opacity;varying vec2 v_texcoord;varying vec2 v_direction;const float INV_SQRT_2_PI=1.0/sqrt(2.0*M_PI);void main(void){if(u_offscreen){float sqDistance=dot(v_direction,v_direction);float density=INV_SQRT_2_PI*exp(-sqDistance/2.0);gl_FragColor.r=v_weight*u_intensity*density;}else{float r=texture2D(u_texture,v_texcoord).r;gl_FragColor=texture2D(u_gradient,vec2(r,0.5))*u_opacity;}}";let{width:i,height:r}=t.canvas;i*=.5,r*=.5;const s=new Nt(t,{width:i,height:r},{halfFloat:!0,premultiplyAlpha:!1}),n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s.getGLTexture(),0);const o=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,o),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,i,r),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,o),this.offscreen={framebuffer:n,depthStencilAttachment:o,texture:s,scale:.5};const a=new Gt({first:0,count:6},"Heatmap");a.addAttribute("a_position",{data:new Int8Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),size:2,stride:0}),a.addUniform("u_texture",s),a.addUniform("u_offscreen",!1),a.depth=!0,this.offscreenBuffer=a}initPass(t,e){switch(t){case bt.OPAQUE:return this.screenBufferRefreshed=!1;case Zt:const{width:t,height:e}=this.offscreen.texture;return this.bindFramebuffer(this.offscreen.framebuffer,t,e),!0;case bt.POST_ALPHA:this.bindFramebuffer(null);const i=!this.screenBufferRefreshed;return this.screenBufferRefreshed=!0,i}}draw(t){const{gl:e,uniforms:i,offscreen:r}=this;if(this._pass==Zt)this.initUniforms({u_texture:null}),e.uniform1i(i.u_offscreen,1),e.enable(e.BLEND),e.colorMask(!0,!1,!1,!1),e.blendFunc(e.ONE,e.ONE),super.draw(t),this.bindFramebuffer(null);else{const{offscreenBuffer:t}=this;this.initBuffers(t.attributes),this.initUniforms(t.uniforms),this.initAttributes(t.attributes),this.initGeometryBuffer(t,bt.ALPHA),e.depthFunc(e.LEQUAL),super.draw(t),this.clear()}}clear(){const{gl:t,offscreen:e}=this,{width:i,height:r}=e.texture;this.bindFramebuffer(e.framebuffer,i,r),t.colorMask(!0,!0,!0,!0),t.disable(t.SCISSOR_TEST),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),this.bindFramebuffer(null)}setResolution(t){const[e,i]=t,{gl:r,offscreen:s}=this,{scale:n}=s,{width:o,height:a}=s.texture,l=e*n,h=i*n;o==l&&a==h||(s.texture.set({width:l,height:h}),r.bindRenderbuffer(r.RENDERBUFFER,s.depthStencilAttachment),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,l,h))}}const Ht="round",Xt="butt",jt="miter",qt="bevel",Vt=8191;var Kt;!function(t){t[t.INSIDE=0]="INSIDE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTTOM=4]="BOTTOM",t[t.TOP=8]="TOP"}(Kt||(Kt={}));const Qt=(t,e,i,r,s,n)=>{let o=Kt.INSIDE;return t<i?o|=Kt.LEFT:t>r&&(o|=Kt.RIGHT),e<s?o|=Kt.BOTTOM:e>n&&(o|=Kt.TOP),o},$t=t=>{let e=t[0],i=t[1],r=e*e+i*i;return r>0&&(r=1/Math.sqrt(r),t[0]=e*r,t[1]=i*r),t},Jt=(t,e,i,r,s,n,o,a,l=1)=>{if(t==Ht)!1===r?o.push(e,i,e,i,e,i):o.push(e,i,r,e,i,r,e,i,r),s*=Math.SQRT2*l,n*=Math.SQRT2*l,a.push(s<<1|0,n<<1|1,s<<1|0,n<<1|1,s<<1|1,n<<1|0,s<<1|1,n<<1|0,n<<1|1,s<<1|1,n<<1|1,s<<1|1);else if("square"==t){!1===r?o.push(e,i,e,i,e,i,e,i,e,i,e,i):o.push(e,i,r,e,i,r,e,i,r,e,i,r,e,i,r,e,i,r);let t=n-s,l=s+n;a.push(s<<1|0,n<<1|1,0,0,l<<1|1,t<<1|0,0,0,s<<1|1,n<<1|0,0,0,t<<1|1,l<<1|1,s<<1|1,n<<1|1,l<<1|1,t<<1|0,s<<1|1,n<<1|1,s<<1|0,n<<1|1,0,0)}},te=(t,e,i,r,s,n,o,a,l,h,c,u,f,d,p,g=0,m=0)=>{u*=.5;const v=!!o;!0===o&&2==n&&(o=0);const y=a+16,x=-16,_=r[s/n-1];let b=g*_,w=m*_;if((g||m)&&(d=!1),b&&w&&m<g){const t=b;b=w,w=t}p&&(h=Xt,"none"!=c&&(c=jt)),o&&(h=Xt,c="none"),f&&(h="butt",c="miter");let M,A,S=Qt(i[0],i[1],x,y,x,y),T=null,L=null;for(let g=0,m=n;m<s;g=m,m+=n){let _=i[g],P=i[g+1];!0===o&&i[g+2];let E=i[m],z=i[m+1];for(!0===o&&i[m+2],M=A=Qt(E,z,x,y,x,y);;){if(!(S|M)){null==T&&(T=g),M!==A&&(L=m);break}if(S&M)break;{let t,e,i,r=S||M;r&Kt.TOP?(t=(y-P)/(z-P),e=_+(E-_)*t,i=y):r&Kt.BOTTOM?(t=(x-P)/(z-P),e=_+(E-_)*t,i=x):r&Kt.RIGHT?(t=(y-_)/(E-_),i=P+(z-P)*t,e=y):r&Kt.LEFT&&(t=(x-_)/(E-_),i=P+(z-P)*t,e=x),r=Qt(e,i,x,y,x,y),S?(S=r,_=e,P=i):(M=r,E=e,z=i)}}null==T||null==L&&m!=s-n||(L||(L=s-n),d&&(T-=n),ee(t,n,e,i,v,o,r,s,T,L+n,a,l,h,h,c,u,f,b,w,p,d),T=null,L=null),S=A}return t.length},ee=(t,e,i,r,s,n,o,a,l,h,c,u,f,d,p,g,m,v,y,x,_,b,w)=>{let M=l,A=0;l<0?M=a-e+l:A=o[M/e];let S=r[M],T=r[M+1],L=!0===n?r[M+2]:n;b&&([S,T,L]=b);let P,E,z,I,C,R,k,O,D,F,N,B,U,W,G,Z,Y,H,X,j,q,V,K,Q=h,$=null,J=null,tt=null,et=null,it=null,rt=null,st=null,nt=null;if(y&&y<A)return A;let ot=_;for(let h=l+e;h<Q;h+=e){let l,b,M=!_&&h==Q-e,at=null,lt=!1;M&&w?[I,C,R]=w:(I=r[h],C=r[h+1],R=!0===n?r[h+2]:n),z=p,k=S-I,O=T-C,K=$t([k,O]),D=K[1],F=K[0],it=null==it;const ht=A;A=o[h/e];const ct=A-ht;if(length=ct,u&&(T==C&&(T<=0||T>=c)||S==I&&(S<=0||S>=c))&&(ot=!0),y&&y<A&&y>=ht){const t=(y-ht)/ct;I=S-k*t,C=T-O*t,R=L,length*=t,M=!0,Q=0}if(v){if(!(v<A)){S=I,T=C,L=R;continue}if(v>=ht){const t=(v-ht)/ct;S-=k*t,T-=O*t,length*=1-t,it=!0}}if(it&&M&&(p="none"),!M){const t=h%(a-e)+e;$=I-r[t],J=C-r[t+1],at=$t([$,J]),tt=at[1],et=at[0],N=tt+D,B=-et-F,l=k*J-O*$<0;let i=[N,B];b=1/(i[0]*D-i[1]*F),b==1/0?(lt=!0,N=2,B=2):(lt=!!m||b>3,p==jt&&lt&&(z=qt),b>2?([N,B]=$t(i),N*=2,B*=2):(N=i[0]*b,B=i[1]*b)),N*=-8191,B*=-8191}if(D*=Vt,F*=Vt,G=[-D<<1|1,F<<1|1],H=[1^G[0],1^G[1]],X=H,j=H,Z=G,Y=G,!ot){if("none"!=p){if(!M&&z==jt&&Q>2*e&&(j=[N<<1|0,B<<1|0],Y=[N<<1|1,B<<1|1]),it||q||(V?(Z=[U<<1|1,W<<1|1],p==jt&&(X=[U<<1|0,W<<1|0])):(X=[U<<1|0,W<<1|0],p==jt&&(Z=[U<<1|1,W<<1|1]))),!lt&&!M&&p!=jt){let t=g*N/-8191,e=g*B/-8191;l&&(t*=-1,e*=-1);let i=K[0]*t+K[1]*e;length<i?lt=!0:l?Y=[N<<1|1,B<<1|1]:j=[N<<1|0,B<<1|0]}if((!it||M)&&A&&(p==Ht&&(V?i.push(E[0],E[1],E[0],E[1],X[0],X[1],X[0],X[1],U<<1|0,W<<1|0,U<<1|0,W<<1|0):i.push(U<<1|1,W<<1|1,U<<1|1,W<<1|1,Z[0],Z[1],Z[0],Z[1],P[0],P[1],P[0],P[1]),s?t.push(rt,st,nt,rt,st,nt,rt,st,nt):t.push(rt,st,rt,st,rt,st),null==m||m.push(ht,ht,ht)),!it))if(q){if(!x){let e=0,r=0;if(p!=Ht){let t=$t([N,B]);e=t[0]*Vt,r=t[1]*Vt}e=e<<1|1,r=r<<1|1,V?i.push(0,0,0,0,H[0],H[1],e,r,E[0],E[1],e,r):i.push(0,0,0,0,P[0],P[1],e,r,G[0],G[1],e,r),s?t.push(rt,st,nt,rt,st,nt,rt,st,nt):t.push(rt,st,rt,st,rt,st),null==m||m.push(ht,ht,ht)}}else if(p!=jt){let e=$t([U,W]);e[0]*=Vt,e[1]*=Vt,V?p==qt?i.push(U<<1|1,W<<1|1,e[0]<<1|1,e[1]<<1|1,X[0],X[1],e[0]<<1|0,e[1]<<1|0,E[0],E[1],e[0]<<1|0,e[1]<<1|0):i.push(U<<1|1,W<<1|1,e[0]<<1|1,e[1]<<1|1,X[0],X[1],X[0],X[1],E[0],E[1],E[0],E[1]):p==qt?i.push(Z[0],Z[1],e[0]<<1|1,e[1]<<1|1,U<<1|0,W<<1|0,e[0]<<1|0,e[1]<<1|0,P[0],P[1],e[0]<<1|1,e[1]<<1|1):i.push(Z[0],Z[1],Z[0],Z[1],U<<1|0,W<<1|0,e[0]<<1|0,e[1]<<1|0,P[0],P[1],P[0],P[1]),s?t.push(rt,st,nt,rt,st,nt,rt,st,nt):t.push(rt,st,rt,st,rt,st),null==m||m.push(ht,ht,ht)}}i.push(Z[0],Z[1],G[0],G[1],j[0],j[1],H[0],H[1],X[0],X[1],H[0],H[1],Z[0],Z[1],G[0],G[1],Y[0],Y[1],G[0],G[1],j[0],j[1],H[0],H[1]),s?t.push(S,T,L,I,C,R,S,T,L,S,T,L,I,C,R,I,C,R):t.push(S,T,I,C,S,T,S,T,I,C,I,C),it&&Jt(f,S,T,s&&L,D,F,t,i),M&&Jt(d,I,C,s&&R,-D,-F,t,i),null==m||m.push(ht,A,ht,ht,A,A)}ot=!1,P=G,E=H,U=N,W=B,rt=I,st=C,nt=R,S=I,T=C,L=R,V=l,q=lt}},ie=32,re=(t,e,i)=>{for(var r;++e<t.length;){let s=t.charAt(e),n=null===(r=i.glyphInfos[s])||void 0===r?void 0:r.glyph;if(n){let{direction:t}=n;if(t)return t}}},se=(t,e,i,r,s,n,o)=>{let{offset:a,x:l}=o,{spaceWidth:h}=e,c=e.glyphInfos[t],u=0;const f=s.data,d=null!=r;let p=s.length;const g=n.data;let m=n.length,v=i>>5,y=31&i;if(c){let{glyph:t}=c,e=c.u1<<5|y,i=c.u2<<5|y,s=c.v1<<5|v,n=c.v2<<5|v,{advanceX:o}=t,{width:h,height:x}=t.data,_=l*ie;x*=ie,u=_+ie*h,f[p++]=_,f[p++]=0,d&&(f[p++]=r),f[p++]=u,f[p++]=x,d&&(f[p++]=r),f[p++]=_,f[p++]=x,d&&(f[p++]=r),f[p++]=u,f[p++]=0,d&&(f[p++]=r),f[p++]=u,f[p++]=x,d&&(f[p++]=r),f[p++]=_,f[p++]=0,d&&(f[p++]=r),g[m++]=e,g[m++]=s,g[m++]=i,g[m++]=n,g[m++]=e,g[m++]=n,g[m++]=i,g[m++]=s,g[m++]=i,g[m++]=n,g[m++]=e,g[m++]=s,l+=o,a+=12}else" "==t&&(l+=h);s.length=p,n.length=m,o.x=l,o.offset=a,o.x2=u},ne=(t,e,i,r,s,n,o,a,l,h)=>{for(let c,u,f=e,d=i;f<d;f++){if(c=r?e+(d-1-f):f,u=t.charAt(c),r&&C(t.charCodeAt(c))){let e=c,i=0;for(;--e>=0;)if(!C(t.charCodeAt(e))){for(;++e<=c;)se(t.charAt(e),s,n,o,a,l,h),i++;break}if(i){f+=i-1;continue}}se(u,s,n,o,a,l,h)}},oe=(t,e,i,r,s=0,n)=>{var o;const a=t.length;i.reserve(18*a),r.reserve(12*a),n&&(n=32767*n/(2*Math.PI)^0);const l={x:0,x2:0,offset:0};let h,c,u,f=0;s=Math.round(s);for(let d=0;d<a;d++){let p=t.charAt(d),g=e.glyphInfos[p],m=d==a-1,v=(null===(o=null==g?void 0:g.glyph)||void 0===o?void 0:o.direction)||0;if(!h){if(" "==p)continue;v=v||1,h=v}if(void 0!==c){let o=!0;if(!v){let i=re(t,d,e);o=i&&i!=c}if(o&&v!=c){let o=d-1;" "==u&&1==v&&o--,o++,ne(t,f,o,-1==c,e,s,n,i,r,l),f=o}}if(m&&f<=d){let o,a=d+Number(" "!=p);o=v?-1==v:c!=h,ne(t,f,a,o,e,s,n,i,r,l)}v&&(c=v),u=p}const{offset:d,x2:p}=l;return{count:d/2,position:i.data,texcoord:r.data,width:p/ie/e.scale}};let ae=R.getInstance();class le{constructor(t,e,i,r){this.x=0,this.y=0,this.glyphInfos={},this.avgCharWidth=0,this.glyphs=0;const s=ae.initFont(t,e);if(this.style=t,this.letterHeight=s.letterHeight,this.lineHeight=s.letterHeight*e,this.baselineOffset=s.baselineOffset,this.rowHeight=s.rowHeight,this.spaceWidth=s.spaceWidth,this.fontScale=s.fontScale,!i)for(i=1;i<s.rowHeight;)i*=2;i*=e,this.width=i,this.height=i,this.maxWidth=i,this.maxHeight=i,this.style=t,this.scale=e,this.font=s,r&&this.addChars(r)}getTextWidth(t){return ae.getTextWidth(t,this.font)}placeGlyph(t){const{rowHeight:e}=this;if(this.x+t>this.width){let t=this.y+2*e;t>this.maxHeight?t>this.height?(this.height*=2,this.width*=2,0==this.x?this.maxWidth=this.maxWidth=this.width:(this.x=this.maxWidth,this.y=0)):(this.x=0,this.y+=e,this.maxHeight=this.height,this.maxWidth=this.width):(this.y+=e,this.maxHeight<this.height?this.x=this.maxWidth:this.x=0)}}addChars(t){const{glyphInfos:e,rowHeight:i}=this;let r=!1;for(let s of t)if(" "!=s&&!e[s]){let t=ae.getGlyph(s,this.font),n=s.charCodeAt(0),o=t.data.width,a=t.width;if(n){this.avgCharWidth=(this.avgCharWidth*this.glyphs+a)/++this.glyphs,r=!0,this.placeGlyph(o);const{x:n,y:l}=this;e[s]={u1:n,v1:l,u2:n+o,v2:l+i,glyph:t},this.x+=o}}return r}}class he extends Nt{constructor(t,e,i){super(t),this.dirty=!1;const{dpr:r}=t;this.atlas=new le(e,r,i),this.format=t.LUMINANCE_ALPHA}addChars(t){this.dirty=this.atlas.addChars(t)||this.dirty}bufferLength(t,e=2){let i=0;for(let e of t)" "!=e&&i++;return 6*i*e}getAtlas(){return this.atlas}sync(){if(this.dirty){const{atlas:t,gl:e}=this,i=t.glyphInfos;this.set({width:t.width,height:t.height});for(let t in i){let e=i[t];this.set(e.glyph.data,e.u1,e.v1)}}}destroy(){this.atlas=null,super.destroy()}}class ce{constructor(t,e=128){this.length=0,Bt(t)?(this.data=t,this.length=this.size=this.data.length):this.data=new t(this.size=e)}get(t){return this.data[t]}set(t,e=0){const{length:i}=t,r=e+i;r&&this.reserve(r),this.data.set(t,e),this.length=r}push(t){const e=arguments.length;this.reserve(e);for(let t=0;t<e;t++)this.data[this.length++]=arguments[t];return this.length}reserve(t){const{data:e}=this,i=t-(this.size-this.length);i>0&&(this.size+=Math.max(i,this.size),this.data=new e.constructor(this.size),this.length&&this.data.set(e))}trim(){let{size:t,length:e}=this;return t!=e&&(this.data=this.data.slice(0,e)),this.data}}class ue{constructor(t,e=!1){this.i32=!1,this._flat=!0,this.instances=0,this.uniforms={},this._flat=t,this.clip=e,t||(this.idOffsets=[]),this.cullFace=1028,this.first=0}addUniform(t,e){this.uniforms[t]=e}count(){if(null!=this._cnt)return this._cnt;const{data:t,size:e}=this.flexAttributes.a_position;return t.length/e-this.first}setArray(t,e){this.first=t,this._cnt=e}setIndex(t){this._index=t}index(){return this._index=this._index||[]}hasIndex(){return!!this._index}isEmpty(){return 0==this.count()}trimAttribute(t){const e=t;return e.data instanceof ce&&(e.data=e.data.trim()),e}isFlat(){return this._flat}finalize(t){var e;const i=this,{flexAttributes:r}=i;let s;if(i.hasIndex()){const e=i.index();if(!e.length)return null;s=new Gt(e,t,i.i32)}else s=new Gt({first:i.first,count:i.count()},t);for(let t in r){let n=r[t];(null===(e=n.data)||void 0===e?void 0:e.length)&&s.addAttribute(t,i.trimAttribute(n))}return s.idOffsets=i.idOffsets,s}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(t)}rayIntersects(t,e,i,r,s){return null}}var fe={},de={};Object.defineProperty(de,"__esModule",{value:!0}),de.setMatrixArrayType=function(t){de.ARRAY_TYPE=ge=t},de.toRadian=function(t){return t*ve},de.equals=function(t,e){return Math.abs(t-e)<=pe*Math.max(1,Math.abs(t),Math.abs(e))},de.RANDOM=de.ARRAY_TYPE=de.EPSILON=void 0;var pe=1e-6;de.EPSILON=pe;var ge="undefined"!=typeof Float32Array?Float32Array:Array;de.ARRAY_TYPE=ge;var me=Math.random;de.RANDOM=me;var ve=Math.PI/180;function ye(t){return ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ye(t)}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),Object.defineProperty(fe,"__esModule",{value:!0}),fe.create=Pe,fe.clone=function(t){var e=new Te.ARRAY_TYPE(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},fe.length=Ee,fe.fromValues=function(t,e,i){var r=new Te.ARRAY_TYPE(3);return r[0]=t,r[1]=e,r[2]=i,r},fe.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},fe.set=function(t,e,i,r){return t[0]=e,t[1]=i,t[2]=r,t};var xe=fe.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t},_e=fe.subtract=ze;fe.multiply=Ie,fe.divide=Ce,fe.ceil=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},fe.floor=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},fe.min=function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t},fe.max=function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t},fe.round=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t};var be=fe.scale=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t};fe.scaleAndAdd=function(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t},fe.distance=Re,fe.squaredDistance=ke,fe.squaredLength=Oe,fe.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},fe.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t};var we=fe.normalize=function(t,e){var i=e[0],r=e[1],s=e[2],n=i*i+r*r+s*s;n>0&&(n=1/Math.sqrt(n));return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t},Me=fe.dot=De,Ae=fe.cross=function(t,e,i){var r=e[0],s=e[1],n=e[2],o=i[0],a=i[1],l=i[2];return t[0]=s*l-n*a,t[1]=n*o-r*l,t[2]=r*a-s*o,t};fe.lerp=function(t,e,i,r){var s=e[0],n=e[1],o=e[2];return t[0]=s+r*(i[0]-s),t[1]=n+r*(i[1]-n),t[2]=o+r*(i[2]-o),t},fe.hermite=function(t,e,i,r,s,n){var o=n*n,a=o*(2*n-3)+1,l=o*(n-2)+n,h=o*(n-1),c=o*(3-2*n);return t[0]=e[0]*a+i[0]*l+r[0]*h+s[0]*c,t[1]=e[1]*a+i[1]*l+r[1]*h+s[1]*c,t[2]=e[2]*a+i[2]*l+r[2]*h+s[2]*c,t},fe.bezier=function(t,e,i,r,s,n){var o=1-n,a=o*o,l=n*n,h=a*o,c=3*n*a,u=3*l*o,f=l*n;return t[0]=e[0]*h+i[0]*c+r[0]*u+s[0]*f,t[1]=e[1]*h+i[1]*c+r[1]*u+s[1]*f,t[2]=e[2]*h+i[2]*c+r[2]*u+s[2]*f,t},fe.random=function(t,e){e=e||1;var i=2*Te.RANDOM()*Math.PI,r=2*Te.RANDOM()-1,s=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(i)*s,t[1]=Math.sin(i)*s,t[2]=r*e,t};var Se=fe.transformMat4=function(t,e,i){var r=e[0],s=e[1],n=e[2],o=i[3]*r+i[7]*s+i[11]*n+i[15];return o=o||1,t[0]=(i[0]*r+i[4]*s+i[8]*n+i[12])/o,t[1]=(i[1]*r+i[5]*s+i[9]*n+i[13])/o,t[2]=(i[2]*r+i[6]*s+i[10]*n+i[14])/o,t};fe.transformMat3=function(t,e,i){var r=e[0],s=e[1],n=e[2];return t[0]=r*i[0]+s*i[3]+n*i[6],t[1]=r*i[1]+s*i[4]+n*i[7],t[2]=r*i[2]+s*i[5]+n*i[8],t},fe.transformQuat=function(t,e,i){var r=i[0],s=i[1],n=i[2],o=i[3],a=e[0],l=e[1],h=e[2],c=s*h-n*l,u=n*a-r*h,f=r*l-s*a,d=s*f-n*u,p=n*c-r*f,g=r*u-s*c,m=2*o;return c*=m,u*=m,f*=m,d*=2,p*=2,g*=2,t[0]=a+c+d,t[1]=l+u+p,t[2]=h+f+g,t},fe.rotateX=function(t,e,i,r){var s=[],n=[];return s[0]=e[0]-i[0],s[1]=e[1]-i[1],s[2]=e[2]-i[2],n[0]=s[0],n[1]=s[1]*Math.cos(r)-s[2]*Math.sin(r),n[2]=s[1]*Math.sin(r)+s[2]*Math.cos(r),t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t},fe.rotateY=function(t,e,i,r){var s=[],n=[];return s[0]=e[0]-i[0],s[1]=e[1]-i[1],s[2]=e[2]-i[2],n[0]=s[2]*Math.sin(r)+s[0]*Math.cos(r),n[1]=s[1],n[2]=s[2]*Math.cos(r)-s[0]*Math.sin(r),t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t},fe.rotateZ=function(t,e,i,r){var s=[],n=[];return s[0]=e[0]-i[0],s[1]=e[1]-i[1],s[2]=e[2]-i[2],n[0]=s[0]*Math.cos(r)-s[1]*Math.sin(r),n[1]=s[0]*Math.sin(r)+s[1]*Math.cos(r),n[2]=s[2],t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t},fe.angle=function(t,e){var i=t[0],r=t[1],s=t[2],n=e[0],o=e[1],a=e[2],l=Math.sqrt(i*i+r*r+s*s),h=Math.sqrt(n*n+o*o+a*a),c=l*h,u=c&&De(t,e)/c;return Math.acos(Math.min(Math.max(u,-1),1))},fe.zero=function(t){return t[0]=0,t[1]=0,t[2]=0,t},fe.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},fe.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},fe.equals=function(t,e){var i=t[0],r=t[1],s=t[2],n=e[0],o=e[1],a=e[2];return Math.abs(i-n)<=Te.EPSILON*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(r-o)<=Te.EPSILON*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-a)<=Te.EPSILON*Math.max(1,Math.abs(s),Math.abs(a))},fe.forEach=fe.sqrLen=fe.len=fe.sqrDist=fe.dist=fe.div=fe.mul=fe.sub=void 0;var Te=function(t,e){if(!e&&t&&t.__esModule)return t;if(null===t||"object"!==ye(t)&&"function"!=typeof t)return{default:t};var i=Le(e);if(i&&i.has(t))return i.get(t);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in t)if("default"!==n&&Object.prototype.hasOwnProperty.call(t,n)){var o=s?Object.getOwnPropertyDescriptor(t,n):null;o&&(o.get||o.set)?Object.defineProperty(r,n,o):r[n]=t[n]}r.default=t,i&&i.set(t,r);return r}(de);function Le(t){if("function"!=typeof WeakMap)return null;var e=new WeakMap,i=new WeakMap;return(Le=function(t){return t?i:e})(t)}function Pe(){var t=new Te.ARRAY_TYPE(3);return Te.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Ee(t){var e=t[0],i=t[1],r=t[2];return Math.hypot(e,i,r)}function ze(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function Ie(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t}function Ce(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t}function Re(t,e){var i=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2];return Math.hypot(i,r,s)}function ke(t,e){var i=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2];return i*i+r*r+s*s}function Oe(t){var e=t[0],i=t[1],r=t[2];return e*e+i*i+r*r}function De(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}var Fe=ze;fe.sub=Fe;var Ne=Ie;fe.mul=Ne;var Be=Ce;fe.div=Be;var Ue=Re;fe.dist=Ue;var We=ke;fe.sqrDist=We;var Ge=Ee;fe.len=Ge;var Ze=Oe;fe.sqrLen=Ze;var Ye,He=(Ye=Pe(),function(t,e,i,r,s,n){var o,a;for(e||(e=3),i||(i=0),a=r?Math.min(r*e+i,t.length):t.length,o=i;o<a;o+=e)Ye[0]=t[o],Ye[1]=t[o+1],Ye[2]=t[o+2],s(Ye,Ye,n),t[o]=Ye[0],t[o+1]=Ye[1],t[o+2]=Ye[2];return t});fe.forEach=He;class Xe{constructor(t,e){this.sMat=t,this.iSMat=e,this.origin=[0,0,0],this.direction=[0,0,0],this.sOrigin=[0,0,0],this.sDirection=[0,0,0],this.pIntersection=[0,0,0],this.intersectRayLength=0}static rayIntersectsTriangle(t,e,i,r,s,n){const o=1e-7,a=_e([0,0,0],r,i),l=_e([0,0,0],s,i),h=Ae([0,0,0],e,l),c=Me(a,h);if(c>-1e-7&&c<o)return null;const u=1/c,f=_e([0,0,0],t,i),d=u*Me(f,h);if(d<0||d>1)return null;const p=Ae([0,0,0],f,a),g=u*Me(e,p);if(g<0||d+g>1)return null;const m=u*Me(l,p);return m>o?(n&&xe(n,t,be(n,e,m)),m):null}static getPointAtRayLength(t,e,i,r=[]){return xe(r,e,be(r,i,t))}getInverseScale(t){return t?this.invMapScale:this.invVpScale}intersectAABBox(t,e,i,r,s,n,o=this.origin,a=this.direction){const[l,h,c]=a,[u,f,d]=o,p=1/l,g=1/h,m=1/c,v=(t-u)*p,y=(r-u)*p,x=(e-f)*g,_=(s-f)*g,b=(i-d)*m,w=(n-d)*m,M=Math.min(Math.min(Math.max(v,y),Math.max(x,_)),Math.max(b,w));if(M<0)return null;const A=Math.max(Math.max(Math.min(v,y),Math.min(x,_)),Math.min(b,w));return A>M?null:A}intersectSphere(t,e){const i=_e([],t,this.origin),r=Me(i,this.direction),s=Me(i,i)-r*r,n=e*e;if(s>n)return null;const o=Math.sqrt(n-s),a=r-o,l=r+o;return a<0&&l<0?null:a<0?l:a}intersectEllipsoid(t,e){const i=_e([],this.origin,t),r=this.direction,s=e[0]*e[0],n=e[1]*e[1],o=e[2]*e[2],a=r[0]*r[0]/s+r[1]*r[1]/n+r[2]*r[2]/o,l=2*i[0]*r[0]/s+2*i[1]*r[1]/n+2*i[2]*r[2]/o;let h=l*l-4*a*(i[0]*i[0]/s+i[1]*i[1]/n+i[2]*i[2]/o-1);if(h<0)return null;h=Math.sqrt(h);const c=(-l+h)/(2*a),u=(-l-h)/(2*a);return c<u?c:u}init(t,e,i,r,s,n){const{sMat:o,iSMat:a,origin:l,direction:h,sOrigin:c,sDirection:u}=this;this.w=i,this.h=r,this.scale=s,this.invMapScale=[1/s,1/s,1/s/n],this.invVpScale=[2/i,2/r],this.scaleZ=n,c[0]=t,c[1]=e,c[2]=-1,h[0]=t,h[1]=e,h[2]=0,Se(l,c,a),Se(h,h,a),Se(u,h,o),_e(u,u,c),we(u,u),_e(h,h,l),we(h,h),this.result={id:null,z:1/0,layerIndex:null,pointWorld:null}}rayLengthScreenToWorld(t){const e=this.iSMat,i=this.origin[2],r=this.direction[2],s=t[0],n=t[1];let o=t[2];const a=e[3]*s+e[7]*n+e[11]*o+e[15];return o=(e[2]*s+e[6]*n+e[10]*o+e[14])/(a||1),(o-i)/r}getIntersectionTop(){const{result:t}=this;return t.z!=1/0&&(t.pointWorld=Xe.getPointAtRayLength(t.z,this.origin,this.direction)),t}intersect(t,e,i,r){if("Image"==i.type||!1===i.pointerEvents)return;const{result:s}=this;let n=i.rayIntersects(i,s,t,e,this);null!=n&&(s.id=n,s.layerIndex=r)}}class je extends ue{constructor(t=!0){super(t,!0),t||(this.cullFace=null),this.flexAttributes={a_position:{data:new ce(Float32Array),size:t?2:3},a_normal:{data:new ce(Int16Array),size:4},a_lengthSoFar:{data:new ce(Float32Array),size:1}},this.first=0}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(this.flexAttributes.a_position.data.length,t)}rayIntersects(t,e,i,r,s){const{attributes:n}=t;let o=n.a_position.data,a=n.a_normal.data,l=n.a_position.size;const h=[0,0,0],c=[0,0,0],u=[0,0,0];let f=s.origin,d=s.direction,p=t.getUniform("u_strokeWidth")[0]/s.scale;const g=t.getUniform("u_scaleByAltitude"),m=1/8192,v=3*l;let y;const x=s.sMat[3],_=s.sMat[7],b=s.sMat[11],w=s.sMat[15];for(let t=0,s=0;t<o.length;s+=12){let n=a[s],M=a[s+1];n=(2*(1&n)-1)*(n>>1)*m;M=(2*(1&M)-1)*(M>>1)*m;let A=o[t],S=o[t+1],T=3==l?-o[t+2]:0,L=a[s+4],P=a[s+5];L=(2*(1&L)-1)*(L>>1)*m;P=(2*(1&P)-1)*(P>>1)*m;let E=o[t+3],z=o[t+4],I=3==l?-o[t+5]:0,C=a[s+8],R=a[s+9];C=(2*(1&C)-1)*(C>>1)*m;R=(2*(1&R)-1)*(R>>1)*m;let k=o[t+6],O=o[t+7],D=3==l?-o[t+8]:0;const F=i+A,N=r+S,B=1+(g?0:T*b/(x*F+_*N+w));h[0]=F+n*p*B,h[1]=N+M*p*B,h[2]=T,c[0]=i+E+L*p*B,c[1]=r+z+P*p*B,c[2]=I,u[0]=i+k+C*p*B,u[1]=r+O+R*p*B,u[2]=D;let U=Xe.rayIntersectsTriangle(f,d,h,c,u);t+=v,null!=U&&U<=e.z&&(e.z=U,y=t-l)}if(null!=y)for(let i=0,{idOffsets:r}=t,{length:s}=r;i<s;i+=2)if(y<r[i])return e.id=r[i+1]}}const qe=[0,0,1,0,0,1,0,1,1,0,1,1],Ve=(t,e,i,r)=>{const s=new Gt({first:0,count:6},"Image");return s.addAttribute("a_position",{data:new Int16Array([0,0,i,0,0,i,0,i,i,0,i,i]),size:2,stride:0}),s.addAttribute("a_textureCoord",{data:new Int8Array(qe),size:2,stride:0}),s.addUniform("u_sampler",new Nt(e,t)),s.zIndex=0,s.clip=!0,s.blend=r,s.pass=r?bt.ALPHA:bt.OPAQUE,s.pixelPerfect=!0,s.cullFace(1028),s};let Ke;var Qe={};function $e(t){return $e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},$e(t)}Object.defineProperty(Qe,"__esModule",{value:!0});var Je=Qe.create=function(){var t=new ui.ARRAY_TYPE(16);ui.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0);return t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},ti=Qe.clone=function(t){var e=new ui.ARRAY_TYPE(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},ei=Qe.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t};Qe.fromValues=function(t,e,i,r,s,n,o,a,l,h,c,u,f,d,p,g){var m=new ui.ARRAY_TYPE(16);return m[0]=t,m[1]=e,m[2]=i,m[3]=r,m[4]=s,m[5]=n,m[6]=o,m[7]=a,m[8]=l,m[9]=h,m[10]=c,m[11]=u,m[12]=f,m[13]=d,m[14]=p,m[15]=g,m},Qe.set=function(t,e,i,r,s,n,o,a,l,h,c,u,f,d,p,g,m){return t[0]=e,t[1]=i,t[2]=r,t[3]=s,t[4]=n,t[5]=o,t[6]=a,t[7]=l,t[8]=h,t[9]=c,t[10]=u,t[11]=f,t[12]=d,t[13]=p,t[14]=g,t[15]=m,t};var ii=Qe.identity=di;Qe.transpose=function(t,e){if(t===e){var i=e[1],r=e[2],s=e[3],n=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=n,t[11]=e[14],t[12]=s,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t};var ri=Qe.invert=function(t,e){var i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],f=e[10],d=e[11],p=e[12],g=e[13],m=e[14],v=e[15],y=i*a-r*o,x=i*l-s*o,_=i*h-n*o,b=r*l-s*a,w=r*h-n*a,M=s*h-n*l,A=c*g-u*p,S=c*m-f*p,T=c*v-d*p,L=u*m-f*g,P=u*v-d*g,E=f*v-d*m,z=y*E-x*P+_*L+b*T-w*S+M*A;if(!z)return null;return z=1/z,t[0]=(a*E-l*P+h*L)*z,t[1]=(s*P-r*E-n*L)*z,t[2]=(g*M-m*w+v*b)*z,t[3]=(f*w-u*M-d*b)*z,t[4]=(l*T-o*E-h*S)*z,t[5]=(i*E-s*T+n*S)*z,t[6]=(m*_-p*M-v*x)*z,t[7]=(c*M-f*_+d*x)*z,t[8]=(o*P-a*T+h*A)*z,t[9]=(r*T-i*P-n*A)*z,t[10]=(p*w-g*_+v*y)*z,t[11]=(u*_-c*w-d*y)*z,t[12]=(a*S-o*L-l*A)*z,t[13]=(i*L-r*S+s*A)*z,t[14]=(g*x-p*b-m*y)*z,t[15]=(c*b-u*x+f*y)*z,t};Qe.adjoint=function(t,e){var i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],f=e[10],d=e[11],p=e[12],g=e[13],m=e[14],v=e[15];return t[0]=a*(f*v-d*m)-u*(l*v-h*m)+g*(l*d-h*f),t[1]=-(r*(f*v-d*m)-u*(s*v-n*m)+g*(s*d-n*f)),t[2]=r*(l*v-h*m)-a*(s*v-n*m)+g*(s*h-n*l),t[3]=-(r*(l*d-h*f)-a*(s*d-n*f)+u*(s*h-n*l)),t[4]=-(o*(f*v-d*m)-c*(l*v-h*m)+p*(l*d-h*f)),t[5]=i*(f*v-d*m)-c*(s*v-n*m)+p*(s*d-n*f),t[6]=-(i*(l*v-h*m)-o*(s*v-n*m)+p*(s*h-n*l)),t[7]=i*(l*d-h*f)-o*(s*d-n*f)+c*(s*h-n*l),t[8]=o*(u*v-d*g)-c*(a*v-h*g)+p*(a*d-h*u),t[9]=-(i*(u*v-d*g)-c*(r*v-n*g)+p*(r*d-n*u)),t[10]=i*(a*v-h*g)-o*(r*v-n*g)+p*(r*h-n*a),t[11]=-(i*(a*d-h*u)-o*(r*d-n*u)+c*(r*h-n*a)),t[12]=-(o*(u*m-f*g)-c*(a*m-l*g)+p*(a*f-l*u)),t[13]=i*(u*m-f*g)-c*(r*m-s*g)+p*(r*f-s*u),t[14]=-(i*(a*m-l*g)-o*(r*m-s*g)+p*(r*l-s*a)),t[15]=i*(a*f-l*u)-o*(r*f-s*u)+c*(r*l-s*a),t},Qe.determinant=function(t){var e=t[0],i=t[1],r=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],h=t[8],c=t[9],u=t[10],f=t[11],d=t[12],p=t[13],g=t[14],m=t[15];return(e*o-i*n)*(u*m-f*g)-(e*a-r*n)*(c*m-f*p)+(e*l-s*n)*(c*g-u*p)+(i*a-r*o)*(h*m-f*d)-(i*l-s*o)*(h*g-u*d)+(r*l-s*a)*(h*p-c*d)};var si=Qe.multiply=pi,ni=Qe.translate=function(t,e,i){var r,s,n,o,a,l,h,c,u,f,d,p,g=i[0],m=i[1],v=i[2];e===t?(t[12]=e[0]*g+e[4]*m+e[8]*v+e[12],t[13]=e[1]*g+e[5]*m+e[9]*v+e[13],t[14]=e[2]*g+e[6]*m+e[10]*v+e[14],t[15]=e[3]*g+e[7]*m+e[11]*v+e[15]):(r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],d=e[10],p=e[11],t[0]=r,t[1]=s,t[2]=n,t[3]=o,t[4]=a,t[5]=l,t[6]=h,t[7]=c,t[8]=u,t[9]=f,t[10]=d,t[11]=p,t[12]=r*g+a*m+u*v+e[12],t[13]=s*g+l*m+f*v+e[13],t[14]=n*g+h*m+d*v+e[14],t[15]=o*g+c*m+p*v+e[15]);return t},oi=Qe.scale=function(t,e,i){var r=i[0],s=i[1],n=i[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},ai=Qe.rotate=function(t,e,i,r){var s,n,o,a,l,h,c,u,f,d,p,g,m,v,y,x,_,b,w,M,A,S,T,L,P=r[0],E=r[1],z=r[2],I=Math.hypot(P,E,z);if(I<ui.EPSILON)return null;P*=I=1/I,E*=I,z*=I,s=Math.sin(i),n=Math.cos(i),o=1-n,a=e[0],l=e[1],h=e[2],c=e[3],u=e[4],f=e[5],d=e[6],p=e[7],g=e[8],m=e[9],v=e[10],y=e[11],x=P*P*o+n,_=E*P*o+z*s,b=z*P*o-E*s,w=P*E*o-z*s,M=E*E*o+n,A=z*E*o+P*s,S=P*z*o+E*s,T=E*z*o-P*s,L=z*z*o+n,t[0]=a*x+u*_+g*b,t[1]=l*x+f*_+m*b,t[2]=h*x+d*_+v*b,t[3]=c*x+p*_+y*b,t[4]=a*w+u*M+g*A,t[5]=l*w+f*M+m*A,t[6]=h*w+d*M+v*A,t[7]=c*w+p*M+y*A,t[8]=a*S+u*T+g*L,t[9]=l*S+f*T+m*L,t[10]=h*S+d*T+v*L,t[11]=c*S+p*T+y*L,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]);return t},li=Qe.rotateX=function(t,e,i){var r=Math.sin(i),s=Math.cos(i),n=e[4],o=e[5],a=e[6],l=e[7],h=e[8],c=e[9],u=e[10],f=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]);return t[4]=n*s+h*r,t[5]=o*s+c*r,t[6]=a*s+u*r,t[7]=l*s+f*r,t[8]=h*s-n*r,t[9]=c*s-o*r,t[10]=u*s-a*r,t[11]=f*s-l*r,t};Qe.rotateY=function(t,e,i){var r=Math.sin(i),s=Math.cos(i),n=e[0],o=e[1],a=e[2],l=e[3],h=e[8],c=e[9],u=e[10],f=e[11];e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]);return t[0]=n*s-h*r,t[1]=o*s-c*r,t[2]=a*s-u*r,t[3]=l*s-f*r,t[8]=n*r+h*s,t[9]=o*r+c*s,t[10]=a*r+u*s,t[11]=l*r+f*s,t};var hi=Qe.rotateZ=function(t,e,i){var r=Math.sin(i),s=Math.cos(i),n=e[0],o=e[1],a=e[2],l=e[3],h=e[4],c=e[5],u=e[6],f=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]);return t[0]=n*s+h*r,t[1]=o*s+c*r,t[2]=a*s+u*r,t[3]=l*s+f*r,t[4]=h*s-n*r,t[5]=c*s-o*r,t[6]=u*s-a*r,t[7]=f*s-l*r,t};Qe.fromTranslation=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},Qe.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Qe.fromRotation=function(t,e,i){var r,s,n,o=i[0],a=i[1],l=i[2],h=Math.hypot(o,a,l);if(h<ui.EPSILON)return null;return o*=h=1/h,a*=h,l*=h,r=Math.sin(e),s=Math.cos(e),n=1-s,t[0]=o*o*n+s,t[1]=a*o*n+l*r,t[2]=l*o*n-a*r,t[3]=0,t[4]=o*a*n-l*r,t[5]=a*a*n+s,t[6]=l*a*n+o*r,t[7]=0,t[8]=o*l*n+a*r,t[9]=a*l*n-o*r,t[10]=l*l*n+s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Qe.fromXRotation=function(t,e){var i=Math.sin(e),r=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=i,t[7]=0,t[8]=0,t[9]=-i,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Qe.fromYRotation=function(t,e){var i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=0,t[2]=-i,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=i,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Qe.fromZRotation=function(t,e){var i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=0,t[3]=0,t[4]=-i,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Qe.fromRotationTranslation=gi,Qe.fromQuat2=function(t,e){var i=new ui.ARRAY_TYPE(3),r=-e[0],s=-e[1],n=-e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=r*r+s*s+n*n+o*o;u>0?(i[0]=2*(a*o+c*r+l*n-h*s)/u,i[1]=2*(l*o+c*s+h*r-a*n)/u,i[2]=2*(h*o+c*n+a*s-l*r)/u):(i[0]=2*(a*o+c*r+l*n-h*s),i[1]=2*(l*o+c*s+h*r-a*n),i[2]=2*(h*o+c*n+a*s-l*r));return gi(t,e,i),t},Qe.getTranslation=function(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t},Qe.getScaling=mi,Qe.getRotation=function(t,e){var i=new ui.ARRAY_TYPE(3);mi(i,e);var r=1/i[0],s=1/i[1],n=1/i[2],o=e[0]*r,a=e[1]*s,l=e[2]*n,h=e[4]*r,c=e[5]*s,u=e[6]*n,f=e[8]*r,d=e[9]*s,p=e[10]*n,g=o+c+p,m=0;g>0?(m=2*Math.sqrt(g+1),t[3]=.25*m,t[0]=(u-d)/m,t[1]=(f-l)/m,t[2]=(a-h)/m):o>c&&o>p?(m=2*Math.sqrt(1+o-c-p),t[3]=(u-d)/m,t[0]=.25*m,t[1]=(a+h)/m,t[2]=(f+l)/m):c>p?(m=2*Math.sqrt(1+c-o-p),t[3]=(f-l)/m,t[0]=(a+h)/m,t[1]=.25*m,t[2]=(u+d)/m):(m=2*Math.sqrt(1+p-o-c),t[3]=(a-h)/m,t[0]=(f+l)/m,t[1]=(u+d)/m,t[2]=.25*m);return t},Qe.fromRotationTranslationScale=function(t,e,i,r){var s=e[0],n=e[1],o=e[2],a=e[3],l=s+s,h=n+n,c=o+o,u=s*l,f=s*h,d=s*c,p=n*h,g=n*c,m=o*c,v=a*l,y=a*h,x=a*c,_=r[0],b=r[1],w=r[2];return t[0]=(1-(p+m))*_,t[1]=(f+x)*_,t[2]=(d-y)*_,t[3]=0,t[4]=(f-x)*b,t[5]=(1-(u+m))*b,t[6]=(g+v)*b,t[7]=0,t[8]=(d+y)*w,t[9]=(g-v)*w,t[10]=(1-(u+p))*w,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t},Qe.fromRotationTranslationScaleOrigin=function(t,e,i,r,s){var n=e[0],o=e[1],a=e[2],l=e[3],h=n+n,c=o+o,u=a+a,f=n*h,d=n*c,p=n*u,g=o*c,m=o*u,v=a*u,y=l*h,x=l*c,_=l*u,b=r[0],w=r[1],M=r[2],A=s[0],S=s[1],T=s[2],L=(1-(g+v))*b,P=(d+_)*b,E=(p-x)*b,z=(d-_)*w,I=(1-(f+v))*w,C=(m+y)*w,R=(p+x)*M,k=(m-y)*M,O=(1-(f+g))*M;return t[0]=L,t[1]=P,t[2]=E,t[3]=0,t[4]=z,t[5]=I,t[6]=C,t[7]=0,t[8]=R,t[9]=k,t[10]=O,t[11]=0,t[12]=i[0]+A-(L*A+z*S+R*T),t[13]=i[1]+S-(P*A+I*S+k*T),t[14]=i[2]+T-(E*A+C*S+O*T),t[15]=1,t},Qe.fromQuat=function(t,e){var i=e[0],r=e[1],s=e[2],n=e[3],o=i+i,a=r+r,l=s+s,h=i*o,c=r*o,u=r*a,f=s*o,d=s*a,p=s*l,g=n*o,m=n*a,v=n*l;return t[0]=1-u-p,t[1]=c+v,t[2]=f-m,t[3]=0,t[4]=c-v,t[5]=1-h-p,t[6]=d+g,t[7]=0,t[8]=f+m,t[9]=d-g,t[10]=1-h-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Qe.frustum=function(t,e,i,r,s,n,o){var a=1/(i-e),l=1/(s-r),h=1/(n-o);return t[0]=2*n*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*l,t[6]=0,t[7]=0,t[8]=(i+e)*a,t[9]=(s+r)*l,t[10]=(o+n)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*n*2*h,t[15]=0,t},Qe.perspectiveNO=vi,Qe.perspectiveZO=function(t,e,i,r,s){var n,o=1/Math.tan(e/2);t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=s&&s!==1/0?(n=1/(r-s),t[10]=s*n,t[14]=s*r*n):(t[10]=-1,t[14]=-r);return t},Qe.perspectiveFromFieldOfView=function(t,e,i,r){var s=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),l=2/(o+a),h=2/(s+n);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=-(o-a)*l*.5,t[9]=(s-n)*h*.5,t[10]=r/(i-r),t[11]=-1,t[12]=0,t[13]=0,t[14]=r*i/(i-r),t[15]=0,t},Qe.orthoNO=_i,Qe.orthoZO=function(t,e,i,r,s,n,o){var a=1/(e-i),l=1/(r-s),h=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=h,t[11]=0,t[12]=(e+i)*a,t[13]=(s+r)*l,t[14]=n*h,t[15]=1,t};var ci=Qe.lookAt=function(t,e,i,r){var s,n,o,a,l,h,c,u,f,d,p=e[0],g=e[1],m=e[2],v=r[0],y=r[1],x=r[2],_=i[0],b=i[1],w=i[2];if(Math.abs(p-_)<ui.EPSILON&&Math.abs(g-b)<ui.EPSILON&&Math.abs(m-w)<ui.EPSILON)return di(t);c=p-_,u=g-b,f=m-w,d=1/Math.hypot(c,u,f),s=y*(f*=d)-x*(u*=d),n=x*(c*=d)-v*f,o=v*u-y*c,(d=Math.hypot(s,n,o))?(s*=d=1/d,n*=d,o*=d):(s=0,n=0,o=0);a=u*o-f*n,l=f*s-c*o,h=c*n-u*s,(d=Math.hypot(a,l,h))?(a*=d=1/d,l*=d,h*=d):(a=0,l=0,h=0);return t[0]=s,t[1]=a,t[2]=c,t[3]=0,t[4]=n,t[5]=l,t[6]=u,t[7]=0,t[8]=o,t[9]=h,t[10]=f,t[11]=0,t[12]=-(s*p+n*g+o*m),t[13]=-(a*p+l*g+h*m),t[14]=-(c*p+u*g+f*m),t[15]=1,t};Qe.targetTo=function(t,e,i,r){var s=e[0],n=e[1],o=e[2],a=r[0],l=r[1],h=r[2],c=s-i[0],u=n-i[1],f=o-i[2],d=c*c+u*u+f*f;d>0&&(d=1/Math.sqrt(d),c*=d,u*=d,f*=d);var p=l*f-h*u,g=h*c-a*f,m=a*u-l*c;(d=p*p+g*g+m*m)>0&&(d=1/Math.sqrt(d),p*=d,g*=d,m*=d);return t[0]=p,t[1]=g,t[2]=m,t[3]=0,t[4]=u*m-f*g,t[5]=f*p-c*m,t[6]=c*g-u*p,t[7]=0,t[8]=c,t[9]=u,t[10]=f,t[11]=0,t[12]=s,t[13]=n,t[14]=o,t[15]=1,t},Qe.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},Qe.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},Qe.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t[8]=e[8]+i[8],t[9]=e[9]+i[9],t[10]=e[10]+i[10],t[11]=e[11]+i[11],t[12]=e[12]+i[12],t[13]=e[13]+i[13],t[14]=e[14]+i[14],t[15]=e[15]+i[15],t},Qe.subtract=wi,Qe.multiplyScalar=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12]*i,t[13]=e[13]*i,t[14]=e[14]*i,t[15]=e[15]*i,t},Qe.multiplyScalarAndAdd=function(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t[4]=e[4]+i[4]*r,t[5]=e[5]+i[5]*r,t[6]=e[6]+i[6]*r,t[7]=e[7]+i[7]*r,t[8]=e[8]+i[8]*r,t[9]=e[9]+i[9]*r,t[10]=e[10]+i[10]*r,t[11]=e[11]+i[11]*r,t[12]=e[12]+i[12]*r,t[13]=e[13]+i[13]*r,t[14]=e[14]+i[14]*r,t[15]=e[15]+i[15]*r,t},Qe.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},Qe.equals=function(t,e){var i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],h=t[7],c=t[8],u=t[9],f=t[10],d=t[11],p=t[12],g=t[13],m=t[14],v=t[15],y=e[0],x=e[1],_=e[2],b=e[3],w=e[4],M=e[5],A=e[6],S=e[7],T=e[8],L=e[9],P=e[10],E=e[11],z=e[12],I=e[13],C=e[14],R=e[15];return Math.abs(i-y)<=ui.EPSILON*Math.max(1,Math.abs(i),Math.abs(y))&&Math.abs(r-x)<=ui.EPSILON*Math.max(1,Math.abs(r),Math.abs(x))&&Math.abs(s-_)<=ui.EPSILON*Math.max(1,Math.abs(s),Math.abs(_))&&Math.abs(n-b)<=ui.EPSILON*Math.max(1,Math.abs(n),Math.abs(b))&&Math.abs(o-w)<=ui.EPSILON*Math.max(1,Math.abs(o),Math.abs(w))&&Math.abs(a-M)<=ui.EPSILON*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(l-A)<=ui.EPSILON*Math.max(1,Math.abs(l),Math.abs(A))&&Math.abs(h-S)<=ui.EPSILON*Math.max(1,Math.abs(h),Math.abs(S))&&Math.abs(c-T)<=ui.EPSILON*Math.max(1,Math.abs(c),Math.abs(T))&&Math.abs(u-L)<=ui.EPSILON*Math.max(1,Math.abs(u),Math.abs(L))&&Math.abs(f-P)<=ui.EPSILON*Math.max(1,Math.abs(f),Math.abs(P))&&Math.abs(d-E)<=ui.EPSILON*Math.max(1,Math.abs(d),Math.abs(E))&&Math.abs(p-z)<=ui.EPSILON*Math.max(1,Math.abs(p),Math.abs(z))&&Math.abs(g-I)<=ui.EPSILON*Math.max(1,Math.abs(g),Math.abs(I))&&Math.abs(m-C)<=ui.EPSILON*Math.max(1,Math.abs(m),Math.abs(C))&&Math.abs(v-R)<=ui.EPSILON*Math.max(1,Math.abs(v),Math.abs(R))},Qe.sub=Qe.mul=Qe.ortho=Qe.perspective=void 0;var ui=function(t,e){if(!e&&t&&t.__esModule)return t;if(null===t||"object"!==$e(t)&&"function"!=typeof t)return{default:t};var i=fi(e);if(i&&i.has(t))return i.get(t);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in t)if("default"!==n&&Object.prototype.hasOwnProperty.call(t,n)){var o=s?Object.getOwnPropertyDescriptor(t,n):null;o&&(o.get||o.set)?Object.defineProperty(r,n,o):r[n]=t[n]}r.default=t,i&&i.set(t,r);return r}(de);function fi(t){if("function"!=typeof WeakMap)return null;var e=new WeakMap,i=new WeakMap;return(fi=function(t){return t?i:e})(t)}function di(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function pi(t,e,i){var r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],d=e[10],p=e[11],g=e[12],m=e[13],v=e[14],y=e[15],x=i[0],_=i[1],b=i[2],w=i[3];return t[0]=x*r+_*a+b*u+w*g,t[1]=x*s+_*l+b*f+w*m,t[2]=x*n+_*h+b*d+w*v,t[3]=x*o+_*c+b*p+w*y,x=i[4],_=i[5],b=i[6],w=i[7],t[4]=x*r+_*a+b*u+w*g,t[5]=x*s+_*l+b*f+w*m,t[6]=x*n+_*h+b*d+w*v,t[7]=x*o+_*c+b*p+w*y,x=i[8],_=i[9],b=i[10],w=i[11],t[8]=x*r+_*a+b*u+w*g,t[9]=x*s+_*l+b*f+w*m,t[10]=x*n+_*h+b*d+w*v,t[11]=x*o+_*c+b*p+w*y,x=i[12],_=i[13],b=i[14],w=i[15],t[12]=x*r+_*a+b*u+w*g,t[13]=x*s+_*l+b*f+w*m,t[14]=x*n+_*h+b*d+w*v,t[15]=x*o+_*c+b*p+w*y,t}function gi(t,e,i){var r=e[0],s=e[1],n=e[2],o=e[3],a=r+r,l=s+s,h=n+n,c=r*a,u=r*l,f=r*h,d=s*l,p=s*h,g=n*h,m=o*a,v=o*l,y=o*h;return t[0]=1-(d+g),t[1]=u+y,t[2]=f-v,t[3]=0,t[4]=u-y,t[5]=1-(c+g),t[6]=p+m,t[7]=0,t[8]=f+v,t[9]=p-m,t[10]=1-(c+d),t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}function mi(t,e){var i=e[0],r=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],h=e[9],c=e[10];return t[0]=Math.hypot(i,r,s),t[1]=Math.hypot(n,o,a),t[2]=Math.hypot(l,h,c),t}function vi(t,e,i,r,s){var n,o=1/Math.tan(e/2);return t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=s&&s!==1/0?(n=1/(r-s),t[10]=(s+r)*n,t[14]=2*s*r*n):(t[10]=-1,t[14]=-2*r),t}var yi=vi,xi=Qe.perspective=yi;function _i(t,e,i,r,s,n,o){var a=1/(e-i),l=1/(r-s),h=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+i)*a,t[13]=(s+r)*l,t[14]=(o+n)*h,t[15]=1,t}var bi=_i;function wi(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t[6]=e[6]-i[6],t[7]=e[7]-i[7],t[8]=e[8]-i[8],t[9]=e[9]-i[9],t[10]=e[10]-i[10],t[11]=e[11]-i[11],t[12]=e[12]-i[12],t[13]=e[13]-i[13],t[14]=e[14]-i[14],t[15]=e[15]-i[15],t}Qe.ortho=bi;var Mi=pi;Qe.mul=Mi;var Ai=wi;Qe.sub=Ai;class Si{constructor(t,e=[]){this.gl=t,this.ext={};for(let t of e)this.getExtension(t)}getExtension(t){const{ext:e,gl:i}=this;let r=e[t];return void 0===r&&(r=e[t]=i.getExtension(t)),r}}const Ti={create:Je,lookAt:ci,multiply:si,perspective:xi,rotateX:li,rotateZ:hi,translate:ni,scale:oi,clone:ti,copy:ei,invert:ri,identity:ii},Li=2*Math.PI,Pi=2*Math.atan(1/3),Ei="ANGLE_instanced_arrays",zi={font:"bold 14px Arial",stroke:"red",fill:"white",strokeWidth:3},Ii=.4*Math.PI,Ci=[[0,0]];class Ri{constructor(t){this.cameraWorld=new Float64Array(3),this.gridTextBuf=new WeakMap,this.tileGrid=!1,this.dbgTile=((t=[1,0,0,1],e=2)=>{const i=new je,{flexAttributes:r}=i;te(r.a_position.data,r.a_normal.data,new Float32Array([0,0,1,0,1,1,0,1,0,0]),new Float32Array([0,1,2,3,4]),10,2,0,1,!1,"butt","none",e);const s=i.finalize("Line");return s.addUniform("u_zIndex",0),s.addUniform("u_fill",t),s.addUniform("u_strokeWidth",[e,0]),s.addUniform("u_offset",[0,0]),s.clip=!1,s.depth=!1,s.pass=bt.ALPHA,s})(),this.buffers=new WeakMap,this._lightDir=[.5,0,-1],this.resolution=[],this.reservedStencils=new Map,this.ctxAttr=Object.assign({alpha:!0,antialias:!1,depth:!0,stencil:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1},t),this.vPMat=Ti.create(),this.vPRasterMat=Ti.create(),this.vMat=Ti.create(),this.invVPMat=Ti.create(),this.screenMat=Ti.create(),this.invScreenMat=Ti.create(),this.worldMatrix=new Float64Array(16),this.tilePreviewTransform={m:Ti.create(),tx:0,ty:0,s:0}}getContext(){return this.gl}setPass(t){const{gl:e}=this;switch(this.pass=t,t){case bt.OPAQUE:this.depthMask=!0,this.depthFnc=e.LESS;break;case bt.ALPHA:this.depthFnc=e.LEQUAL,this.depthMask=!1;break;case bt.POST_ALPHA:this.depthFnc=e.EQUAL,this.depthMask=!1,e.disable(e.SCISSOR_TEST),e.clear(e.STENCIL_BUFFER_BIT)}}convertColor(t){return S(t)}setBackgroundColor(t){var e,i;null===(e=this.gl)||void 0===e||e.clearColor(t[0],t[1],t[2],null!==(i=t[3])&&void 0!==i?i:1)}setScale(t,e,i){}setRotation(t,e){}clear(t){const{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null),t&&this.setBackgroundColor(t),e.colorMask(!0,!0,!0,!0),e.disable(e.SCISSOR_TEST),e.depthMask(!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),this.reservedStencils.clear()}init(t,e){this.dpr=e;const i=t.getContext("webgl",this.ctxAttr);i.dpr=e,this.gl=i,this.glExt=new Si(i,["OES_element_index_uint",Ei]),this.initContext();const r=((t,e)=>{const i=Ve({width:1,height:1,data:new Uint8ClampedArray([255,255,255,255])},e,1,!1);return i.id="StencilTile",i.clip=!0,i.depth=!1,i.pass=bt.OPAQUE,i})(0,i);r.pass=bt.OPAQUE|bt.ALPHA,r.blend=!0,r.colorMask={r:!1,g:!1,b:!1,a:!1},r.depthMask=!1,this.stencilTile=r,this.depthBufferSize=1<<i.getParameter(i.DEPTH_BITS);const s=this.programConfig={Rect:{program:At},Line:{program:Pt},DashedLine:{program:Et,default:!1},Text:{program:Ct},Image:{program:It},Circle:{program:St},Polygon:{program:zt},Extrude:{program:kt},Icon:{program:Rt},Box:{program:Ot},Sphere:{program:Dt},Model:{program:Ft,default:!1},Heatmap:{program:Yt,default:!1}};this.programs={};for(let t in s){const e=s[t];!1!==e.default&&this.createProgram(t,e.program)}}createProgram(t,e,i){const{gl:r,programs:s,dpr:n}=this;s[t]&&s[t].delete();const o=s[t]=new e(r,n,i);return o.init(this.buffers,this.glExt.getExtension(Ei)),o}initContext(){const{gl:t}=this;t.enable(t.CULL_FACE),t.cullFace(t.FRONT),t.enable(t.DEPTH_TEST),t.enable(t.SCISSOR_TEST),t.clearStencil(0),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)}grid(t){"object"==typeof t?null!=t.grid3d&&this.createProgram("Model",Ft,t.grid3d&&{DBG_GRID:1}):this.tileGrid=t}applyTransform(){}initView(t,e,i,r,s,n,o,a,l){const h=this.vPMat,c=this.vMat,u=.5*Pi,f=.5*t,d=.5*e,p=d/Math.tan(u),g=Math.cos(u),m=Math.sin(u)*p;let v=Math.max(.01,.5*Math.PI-u+r);const y=e/100;let x=g*(g*p+m/Math.tan(v));x*=1.005,this.tilePreviewTransform.tx=null,this.tilePreviewTransform.ty=null,this.tilePreviewTransform.s=null,this.rz=(s+Li)%Li,this.rx=r,this.scale=i,this.zMeterToPixel=1/n,this.gl.viewport(0,0,t*this.dpr,e*this.dpr),Ti.perspective(h,Pi,t/e,y,x);const _=Ti.copy(this.worldMatrix,h);Ti.scale(_,_,[1,-1,1]),Ti.translate(_,_,[0,0,-p]),Ti.rotateX(_,_,-r),Ti.rotateZ(_,_,s),Ti.scale(_,_,[l,l,l]),Ti.translate(_,_,[-o,-a,0]),Ti.lookAt(c,[f,d,-p],[f,d,0],[0,-1,0]),Ti.translate(c,c,[f,d,0]),Ti.rotateX(c,c,r),Ti.rotateZ(c,c,s),Ti.scale(c,c,[i,i,i/n]),Ti.translate(c,c,[-f,-d,0]),Ti.multiply(h,h,c),ri(this.invVPMat,h);let b=Ti.identity(this.screenMat);Ti.scale(b,b,[f,-d,1]),Ti.translate(b,b,[1,-1,0]),Ti.multiply(b,b,this.vPMat),ri(this.invScreenMat,b);const{cameraWorld:w}=this;w[0]=0,w[1]=0,w[2]=-1,Se(w,w,this.invVPMat);const M=Ti.copy(this.vPRasterMat,h),A=o*l,S=a*l,T=A-Math.round(A)+f%1,L=S-Math.round(S)+d%1;Ti.translate(M,M,[T-Math.round(T),L-Math.round(L),0]),this.setResolution(t,e),this.initSharedUniforms()}initSharedUniforms(){this.sharedUniforms={u_fixedView:this.fixedView,u_rotate:this.rz,u_resolution:this.resolution,u_scale:null,u_topLeft:[0,0],u_tileScale:1,u_matrix:this.vPMat,u_inverseMatrix:this.invVPMat,u_zMeterToPixel:null,u_groundResolution:1/this.zMeterToPixel,u_lightDir:this._lightDir,u_camWorld:this.cameraWorld}}useProgram(t){const e=this.prog;if(e!=t){const i=this.gl;return e&&e.disableAttributes(),i.useProgram(t.prog),this.prog=t,!0}return!1}drawGrid(t,e,i,r){this.dbgTile.uniforms.u_tileScale=r,this.drawBuffer(this.dbgTile,t,e,null,null);let s=this.gridTextBuf.get(i);s||(s=((t,e,i)=>{Ke||(Ke=new he(e,i),Ke.addChars("L0123456789"),Ke.sync());const r=t+" L"+t.length,{length:s}=r,n=new ce(Int16Array,18*s),o=new ce(Uint16Array,12*s),{position:a,count:l,texcoord:h}=oe(r,Ke.atlas,n,o);let c=new Gt({first:0,count:l},"Text");return c.addAttribute("a_position",{data:new Int8Array(a.length).fill(1),size:2,stride:0}),c.addAttribute("a_point",{data:a,size:2,stride:0}),c.addAttribute("a_texcoord",{data:h,size:2,stride:0}),c.pass=bt.ALPHA,c.depth=!1,c.clip=!1,c.addUniform("u_texture",Ke),c.addUniform("u_texSize",[Ke.width,Ke.height]),c.addUniform("u_opacity",1),c.addUniform("u_alignMap",!0),c.addUniform("u_fillColor",S(i.fill)),c.addUniform("u_strokeColor",S(i.stroke)),c})(i.quadkey,this.gl,zi),this.gridTextBuf.set(i,s)),this.drawBuffer(s,t+4,e+4)}deleteBuffer(t){const{buffers:e,gl:i}=this;let{attributes:r,uniforms:s}=t;for(let t in s){let e=s[t];if(e.format){0===(e.ref=(e.ref||1)-1)&&e.destroy()}}for(let t in r){let s=r[t];if(0===(s.ref=(s.ref||1)-1)){let t=e.get(s);i.deleteBuffer(t)}}for(let r of t.groups){const t=r.index;t&&i.deleteBuffer(e.get(t))}t.destroy(t)}initProgram(t,e,i){const r=e.getAttributes();this.useProgram(t),t.setResolution(this.resolution),t.initBuffers(r),t.initGeometryBuffer(e,i,this.zIndex),t.initAttributes(r),t.initUniforms(this.sharedUniforms),t.initUniforms(e.uniforms)}drawBuffer(t,e,i,r,s){const{gl:n,pass:o}=this,a=this.getProgram(t);if(a){s=s||1;const l=this.zIndex,h=t.flat&&l>this.min3dZIndex;let c=a.initPass(o,t);if(h&&t.pass==bt.OPAQUE&&(c=o==bt.ALPHA),c){const{sharedUniforms:c}=this;c.u_fixedView=this.fixedView,c.u_scale=this.scale*s,c.u_matrix=r||(t.pixelPerfect?this.vPRasterMat:this.vPMat),c.u_zMeterToPixel=this.zMeterToPixel/s;const u=t.pass&bt.POST_ALPHA;let f=null;t.clip&&t.isFlat()&&(f=this.drawStencil(e,i,s));let{depthFnc:d,depthMask:p}=this,g=Ri.DEFAULT_COLOR_MASK;u&&(o==bt.ALPHA?(g=Ri.NO_COLOR_MASK,p=!0):o==bt.POST_ALPHA&&(null!=f?(n.stencilFunc(n.EQUAL,f,255),n.stencilOp(n.KEEP,n.KEEP,n.KEEP)):(n.stencilFunc(n.EQUAL,0,255),n.stencilOp(n.KEEP,n.KEEP,n.INCR),n.enable(n.STENCIL_TEST)))),n.depthFunc(d),n.depthMask(p),a.setColorMask(g),c.u_topLeft[0]=e,c.u_topLeft[1]=i;const m=(65535-l)/65536;n.depthRange(t.flat?m:0,m),this.initProgram(a,t,o),u&&o==bt.POST_ALPHA&&n.enable(n.STENCIL_TEST),h&&n.disable(n.DEPTH_TEST),a.draw(t)}}}initStencil(t,e,i=Ci){this.stencilVal=t,this.stencilSize=e,this.tileStencils=i}reserveStencilValue(t){const{reservedStencils:e}=this;let i=e.get(t);return i||(i=e.size+1,i>255&&(i=1,e.clear(),this.gl.clear(this.gl.STENCIL_BUFFER_BIT)),e.set(t,i)),i}drawStencil(t,e,i){const{gl:r,stencilTile:s,sharedUniforms:n}=this,o=this.getProgram(s),a=this.stencilSize,l=Math.min(a,a/i),h=16777216*i+this.stencilVal,c=this.reserveStencilValue(h);r.stencilFunc(r.ALWAYS,c,255),r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),s.uniforms.u_tileScale=l;for(let i of this.tileStencils)n.u_topLeft[0]=t+i[0]*a,n.u_topLeft[1]=e+i[1]*a,this.initProgram(o,s,this.pass),r.enable(r.STENCIL_TEST),o.draw(s);return r.stencilFunc(r.EQUAL,c,255),r.stencilOp(r.KEEP,r.KEEP,r.KEEP),c}initScissor(t,e,i,r){const{gl:s}=this,n=s.canvas.width,o=s.canvas.height;if(this.scale>4||-this.rx>Ii)return[0,0,n,o];const a=t+i,l=e+i,h=[t,l,0],c=[a,l,0],u=[t,e,0],f=[a,e,0];let d=1/0,p=-d,g=d,m=p;for(let t of[h,c,u,f]){let[e,i]=Se(t,t,r);e<d&&(d=e),e>p&&(p=e),i<g&&(g=i),i>m&&(m=i)}d=Math.round(.5*(d+1)*n),p=Math.round(.5*(p+1)*n),g=Math.round(.5*(g+1)*o),m=Math.round(.5*(m+1)*o);return[d,g,p-d,m-g]}initBufferScissorBox(t,e,i){if(t.clip){let r=e.size,{x:s,y:n,tile:o}=e,a=this.vPMat;if(i){const[t,e,o,a,l,h,c,u,f]=i;s+=h,n+=c,r*=u/a}t.scissorBox=this.initScissor(s,n,r,a)}else t.scissorBox=null}draw(t,e){let i=t.data.tile,r=i.tile,s=i.size,n=i.x,o=i.y,a=t.b,{preview:l}=t.data;if(this.zIndex=t.z,this.min3dZIndex=e,this.stencilVal=null,l){const[e,i,h,c,u,f,d,p,g]=l,m=p/c,v=f/m-i,y=d/m-h,x=this.initPreviewMatrix(n,o,m,a.pixelPerfect);this.initStencil(r.i,s,t.data.stencils),this.drawBuffer(a,v,y,x,m)}else this.initStencil(r.i,s),this.drawBuffer(a,n,o)}initPreviewMatrix(t,e,i,r){const{tilePreviewTransform:s}=this,{m:n}=s;return s.tx==t&&s.ty==e&&s.s==i||(Ti.copy(n,r?this.vPRasterMat:this.vPMat),Ti.translate(n,n,[t,e,0]),Ti.scale(n,n,[i,i,1]),s.tx=t,s.ty=e,s.s=i),n}destroy(){}prepare(t,e,i,r,s,n){}drawCustom(t,e){var i;const r=this,{gl:s}=r;r.prog=null;const n=(65535-e)/65536,o="3d"==t.renderOptions.mode?0:n;s.depthRange(o,n),s.disable(s.SCISSOR_TEST),s.disable(s.STENCIL_TEST),t.render(s,r.worldMatrix),null===(i=this.glExt.getExtension("OES_vertex_array_object"))||void 0===i||i.bindVertexArrayOES(null),s.bindFramebuffer(s.FRAMEBUFFER,null),this.initContext()}getProgram(t){let e=t.progId;const i=t.type;if(!e){const r=this.programConfig[i].program;e=t.progId=r.getProgramId(t,r.getMacros(t))}let r=this.programs[e];if(void 0===r){const s=this.programConfig[i].program;s&&(r=this.createProgram(e,s,s.getMacros(t)))}return r}setResolution(t,e){const{resolution:i}=this;i[0]=t,i[1]=e}}let ki;Ri.DEFAULT_COLOR_MASK={r:!0,g:!0,b:!0,a:!0},Ri.NO_COLOR_MASK={r:!1,g:!1,b:!1,a:!1};class Oi{constructor(t){this.r=[],this.p=[],this.pool=t}init(t,e){this.luTs=null,this.quadkey=t,this.layers=e,this.tasks={},this.r.length=0,this.p.length=0}busy(t){const e=t.id;for(let t in this.tasks)if(e==this.tasks[t]._lid)return!0}addTask(t,e){t._lid=e.id,this.tasks[t.id]=t}cancelTasks(t){const e=this.tasks;let i;for(let r in e)i=e[r],t&&t.id!=i._lid||(i.cancel(),delete e[r])}removeTask(t,e){delete this.tasks[t.id]}index(t){return this.layers.indexOf(t)}ready(t,e){return 2==arguments.length&&(this.r[t]=e,e&&(this.luTs=Date.now())),this.r[t]}addLayer(t){this.r.splice(t,0,!1),this.p.splice(t,0,undefined)}removeLayer(t){this.r.splice(t,1),this.p.splice(t,1)}preview(t,e){return 2==arguments.length&&(this.p[t]=e),this.p[t]}getOverlayingTiles(){const t=[],{quadkey:e}=this,i=e.length;return this.pool.forEach((r=>{const s=r.quadkey;(s.length<i&&0==e.indexOf(s)||s.length>i&&0==s.indexOf(e))&&t.push(r)})),t}}class Di extends Oi{constructor(t,e,i,r){super(t),this.data=[],this.onDrop=r,this.init(e,i)}clear(t){this.setData(t,ki),this.ready(t,!1),this.preview(t,!1)}init(t,e){super.init(t,e),this.data.length=0}setData(t,e){const i="number"==typeof t?t:this.layers.indexOf(t),r=this.data[i];return r&&r.length&&this.onDrop&&this.onDrop(r,i),this.data[i]=e,i}getData(t){return this.data[t]}addLayer(t){super.addLayer(t),this.data.splice(t,0,ki)}removeLayer(t){super.removeLayer(t),this.setData(t,ki),this.preview(t,ki),this.data.splice(t,1)}}class Fi{constructor(t){this.tiles=new e.LRU(t)}setSize(t){this.tiles.setSize(t)}get(t,e){if(e){const e=this.tiles._[t];return e&&e.data}return this.tiles.get(t)}forEach(t){return this.tiles.forEach(t)}}class Ni extends Fi{constructor(t){super(t)}create(t,e){const{tiles:i,onDrop:r}=this;let s,n,o=i.get(t);if(!o&&(o=new Di(this,t,e,r),s=i.set(t,o),s&&(n=s.data))){for(let t=0;t<n.length;t++)s.setData(t,null),s.preview(t,null);s.data=null}return o}}class Bi{constructor(){this.length=0,this.buffers=[]}push(t){this.buffers.push(t),this.length++}pop(){if(this.length)return this.length--,this.buffers.pop()}get(t){return this.buffers[t]}set(t,e){this.buffers[t]=e,this.length=this.buffers.length}setIdOffset(t){for(let e of this.buffers)e.setIdOffset(t)}isEmpty(){for(let t of this.buffers)if(t.isEmpty())return!0;return!1}toArray(){return this.buffers}}const Ui=t=>9e3*t/65535,Wi=(t,e,i)=>e>0?t*e*i:t,Gi=(t,e,i)=>{const r=t.getUniform("u_offset"),s=Wi(r[0],r[1],e),n=Wi(r[2],r[3],e),o=t.getUniform("u_offsetZ");return[s,n,Wi(o[0],o[1],e)]};class Zi extends ue{constructor(t=!0,e){super(t,e),this.flexAttributes={a_position:{data:new ce(Uint16Array),size:t?2:3}},this.first=0}rayIntersects(t,i,r,s,n){var o;const{type:a,attributes:l}=t,h=t.getUniform("u_alignMap"),c=t.getUniform("u_scaleByAltitude"),{scale:u,scaleZ:f,sMat:d}=n,p=h?1/n.scale:1;let g,m,[v,y,x]=Gi(t,u);if(x=-x/f/u,"Rect"===a){const e=t.getUniform("u_size"),i=t.getUniform("u_strokeWidth")||0;g=.5*(e[0]+i),m=.5*(e[2]+i)}else"Circle"==a&&(g=m=t.getUniform("u_radius")[0]);g*=p,m*=p;const _=l.a_position,b=_.data,w=_.size,M=[0,0,0],A=[0,0,0];let S,T,L,P=null;h?(T=n.origin,L=n.direction,v/=u,y/=u):S=[0,0,0];const E=d[3],z=d[7],I=d[11],C=d[15];for(let t=0,u=0;t<b.length;t+=6*w,u+=6){let f=r+(b[t]>>2)/32,d=s+(b[t+1]>>2)/32,_=3==w?-Ui(b[t+2]):0,R=(2&b[t])-1,k=(2&b[t+1])-1,O=t+2*w,D=(2&b[O])-1,F=(2&b[O+1])-1;if("Icon"===a){let t=null===(o=l.a_size)||void 0===o?void 0:o.data;g=.5*t[u]*p,m=.5*t[u+1]*p}if(h){M[0]=A[0]=f+v,M[1]=A[1]=d+y,M[2]=A[2]=_+x;const t=1+(c?0:M[2]*I/(E*M[0]+z*M[1]+C)),e=g*t,i=m*t;M[0]+=R*e,M[1]-=k*i,A[0]+=D*e,A[1]-=F*i}else M[0]=f,M[1]=d,M[2]=_+x,Se(M,M,n.sMat),M[0]+=v,M[1]+=y,A[0]=M[0]+D*g,A[1]=M[1]-F*m,A[2]=M[2],M[0]+=R*g,M[1]-=k*m,T=n.sOrigin,L=n.sDirection;let N=n.intersectAABBox(M[0],M[1],M[2],A[0],A[1],A[2],T,L);N&&(h||(e.vec3.add(S,T,e.vec3.scale(S,L,N)),N=n.rayLengthScreenToWorld(S)),N<i.z&&(i.z=N,P=t))}if(null!=P)return t.idOffsets[Math.floor(P/18)]}}const Yi=(t,e,i,r)=>{let s=r.length;const n=t=32*t<<2|1,o=e=32*e<<2|1,a=2|t,l=o,h=n,c=2|e,u=a,f=c;return"number"==typeof i?(i=Math.round(i/9e3*65535),r.push(n,o,i,h,c,i,u,f,i,n,o,i,u,f,i,a,l,i),s+=18):(r.push(n,o,h,c,u,f,n,o,u,f,a,l),s+=12),s},Hi={type:"LinearGradient",stops:{1:"white",.9:"#FCFBAE",.8:"#FAD932",.7:"#F26C19",.5:"#C41D6F",.3:"#70009C",0:"#1E0073"}};class Xi extends Zi{constructor(t){super(!0),this.flexAttributes.a_weight={data:new ce(Float32Array),size:1}}static verifyAndFixGradient(t){let e=1/0;for(let i in t)i<e&&(e=i);const[i,r,s,n]=S(t[e]);if(n>0)return(t=Object.assign({},t))[e]=`rgba(${255*i},${255*r},${255*s},0)`,t}addPoint(t,e,i=1){const{flexAttributes:r}=this;Yi(t,e,void 0,r.a_position.data),r.a_weight.data.push(i,i,i,i,i,i)}}const{centroid:ji}=e.geometry,qi=e.TaskManager.getInstance(),Vi=Math.PI/180,Ki=new Float32Array([-1,-1,-1,-1]);let Qi;const $i=(t,e,i,r,s,n,o=0)=>{const a=t.z;for(let l of r){const r=l.type,h=H("type",l,e,a);if("Polygon"==h||"Line"==h){if(H("stroke",l,e,a)){l.type="Line";for(let r of i)t.create(e,"LineString",r,[l],s,n.clipped);l.type=r}}else if(0==o){const{bounds:i}=n,{bbox:r}=e;let o;if("Centroid"==H("anchor",l,e,a)){const{geometry:t}=e;o=t._c=t._c||ji("Polygon"==t.type?t.coordinates:t.coordinates[0])}else o=[r[0]+(r[2]-r[0])/2,r[1]+(r[3]-r[1])/2];const[h,c]=o;h>=i[0]&&c>=i[1]&&h<i[2]&&c<i[3]&&t.create(e,"Point",o,[l],s)}}},Ji={Center:{x:.5,y:0},Left:{x:0,y:0},Right:{x:1,y:0},Top:{x:.5,y:-1},TopLeft:{x:0,y:-1},TopRight:{x:1,y:-1},Bottom:{x:.5,y:1},BottomLeft:{x:0,y:1},BottomRight:{x:1,y:1}},tr=(t,e,i,r,s)=>{const n="number"==typeof s,o=t.length,a=[];let l=0;for(let o=0;o<e.length;o++){for(let a,l,h=0;h<e[o].length;h++)a=i.lon2x(e[o][h][0],r),l=i.lat2y(e[o][h][1],r),n?t.push(a,l,s):t.push(a,l);o>0&&(l+=e[o-1].length,a[a.length]=l)}return{dimensions:n?3:2,vertices:t,holes:a,start:o,stop:t.length}},er=(t,e,i,r,s)=>{let n;if("number"!=typeof e[0][0][0]){n=[];for(let o of e)n.push(tr(t,o,i,r,s))}else n=[tr(t,e,i,r,s)];return n},ir=(t,e,i)=>{let r=0;for(let s=e,n=i-1;s<n;s+=3){let e=t[s],i=t[s+1];r+=(t[s+3]-e)*(i+t[s+4])}return r},rr=(t,e,i,r,s,n,o,a)=>{const l=t.holes,h=t.vertices,c=t.stop-3;let u=t.start,f=0,d=u+3*l[f]-6,p=ir(e.data,u,d?d+3:c)>=0;for(o=o||0;u<c;){let g,m,v,y;if(p){let e=t.start+c-u;g=h.get(e),v=h.get(e+1),m=h.get(e-3),y=h.get(e-2)}else g=h.get(u),v=h.get(u+1),m=h.get(u+3),y=h.get(u+4);let x=Math.round(g)-Math.round(m),_=Math.round(v)-Math.round(y);if((x||_)&&(E(g,v,0,0,s,s)||E(m,y,0,0,s,s))){let t=e.length/3;r[r.length]=t+2,r[r.length]=t,r[r.length]=t+1,r[r.length]=t+3,r[r.length]=t+2,r[r.length]=t+1,null==a||a.push(t,t+1,t+2,t+3,t,t+2,t+1,t+3),e.push(g,v,n,g,v,o,m,y,n,m,y,o);let s=x*x+_*_,l=_,h=-x;s=127/Math.sqrt(s),l*=s,h*=s,i.push(l,h,l,h,l,h,l,h)}u==d?(u+=6,d=t.start+3*l[++f]-6,p=ir(e.data,u,d?d+3:c)<0):u+=3}},sr=(t,e,i,r,s,n,o,a,l)=>{let h=t.length;const c=er(t,r,s,n,o);for(;h<t.length;)e.push(0,0),h+=3;if(o)for(let r of c)rr(r,t,e,i,n,o,a,l);return c};var nr={exports:{}};function or(t,e,i){i=i||2;var r,s,n,o,a,l,h,c=e&&e.length,u=c?e[0]*i:t.length,f=ar(t,0,u,i,!0),d=[];if(!f||f.next===f.prev)return d;if(c&&(f=function(t,e,i,r){var s,n,o,a=[];for(s=0,n=e.length;s<n;s++)(o=ar(t,e[s]*r,s<n-1?e[s+1]*r:t.length,r,!1))===o.next&&(o.steiner=!0),a.push(yr(o));for(a.sort(pr),s=0;s<a.length;s++)i=gr(a[s],i);return i}(t,e,f,i)),t.length>80*i){r=n=t[0],s=o=t[1];for(var p=i;p<u;p+=i)(a=t[p])<r&&(r=a),(l=t[p+1])<s&&(s=l),a>n&&(n=a),l>o&&(o=l);h=0!==(h=Math.max(n-r,o-s))?32767/h:0}return hr(f,d,i,r,s,h,0),d}function ar(t,e,i,r,s){var n,o;if(s===Ir(t,e,i,r)>0)for(n=e;n<i;n+=r)o=Pr(n,t[n],t[n+1],o);else for(n=i-r;n>=e;n-=r)o=Pr(n,t[n],t[n+1],o);return o&&wr(o,o.next)&&(Er(o),o=o.next),o}function lr(t,e){if(!t)return t;e||(e=t);var i,r=t;do{if(i=!1,r.steiner||!wr(r,r.next)&&0!==br(r.prev,r,r.next))r=r.next;else{if(Er(r),(r=e=r.prev)===r.next)break;i=!0}}while(i||r!==e);return e}function hr(t,e,i,r,s,n,o){if(t){!o&&n&&function(t,e,i,r){var s=t;do{0===s.z&&(s.z=vr(s.x,s.y,e,i,r)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==t);s.prevZ.nextZ=null,s.prevZ=null,function(t){var e,i,r,s,n,o,a,l,h=1;do{for(i=t,t=null,n=null,o=0;i;){for(o++,r=i,a=0,e=0;e<h&&(a++,r=r.nextZ);e++);for(l=h;a>0||l>0&&r;)0!==a&&(0===l||!r||i.z<=r.z)?(s=i,i=i.nextZ,a--):(s=r,r=r.nextZ,l--),n?n.nextZ=s:t=s,s.prevZ=n,n=s;i=r}n.nextZ=null,h*=2}while(o>1)}(s)}(t,r,s,n);for(var a,l,h=t;t.prev!==t.next;)if(a=t.prev,l=t.next,n?ur(t,r,s,n):cr(t))e.push(a.i/i|0),e.push(t.i/i|0),e.push(l.i/i|0),Er(t),t=l.next,h=l.next;else if((t=l)===h){o?1===o?hr(t=fr(lr(t),e,i),e,i,r,s,n,2):2===o&&dr(t,e,i,r,s,n):hr(lr(t),e,i,r,s,n,1);break}}}function cr(t){var e=t.prev,i=t,r=t.next;if(br(e,i,r)>=0)return!1;for(var s=e.x,n=i.x,o=r.x,a=e.y,l=i.y,h=r.y,c=s<n?s<o?s:o:n<o?n:o,u=a<l?a<h?a:h:l<h?l:h,f=s>n?s>o?s:o:n>o?n:o,d=a>l?a>h?a:h:l>h?l:h,p=r.next;p!==e;){if(p.x>=c&&p.x<=f&&p.y>=u&&p.y<=d&&xr(s,a,n,l,o,h,p.x,p.y)&&br(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function ur(t,e,i,r){var s=t.prev,n=t,o=t.next;if(br(s,n,o)>=0)return!1;for(var a=s.x,l=n.x,h=o.x,c=s.y,u=n.y,f=o.y,d=a<l?a<h?a:h:l<h?l:h,p=c<u?c<f?c:f:u<f?u:f,g=a>l?a>h?a:h:l>h?l:h,m=c>u?c>f?c:f:u>f?u:f,v=vr(d,p,e,i,r),y=vr(g,m,e,i,r),x=t.prevZ,_=t.nextZ;x&&x.z>=v&&_&&_.z<=y;){if(x.x>=d&&x.x<=g&&x.y>=p&&x.y<=m&&x!==s&&x!==o&&xr(a,c,l,u,h,f,x.x,x.y)&&br(x.prev,x,x.next)>=0)return!1;if(x=x.prevZ,_.x>=d&&_.x<=g&&_.y>=p&&_.y<=m&&_!==s&&_!==o&&xr(a,c,l,u,h,f,_.x,_.y)&&br(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(;x&&x.z>=v;){if(x.x>=d&&x.x<=g&&x.y>=p&&x.y<=m&&x!==s&&x!==o&&xr(a,c,l,u,h,f,x.x,x.y)&&br(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;_&&_.z<=y;){if(_.x>=d&&_.x<=g&&_.y>=p&&_.y<=m&&_!==s&&_!==o&&xr(a,c,l,u,h,f,_.x,_.y)&&br(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function fr(t,e,i){var r=t;do{var s=r.prev,n=r.next.next;!wr(s,n)&&Mr(s,r,r.next,n)&&Tr(s,n)&&Tr(n,s)&&(e.push(s.i/i|0),e.push(r.i/i|0),e.push(n.i/i|0),Er(r),Er(r.next),r=t=n),r=r.next}while(r!==t);return lr(r)}function dr(t,e,i,r,s,n){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&_r(o,a)){var l=Lr(o,a);return o=lr(o,o.next),l=lr(l,l.next),hr(o,e,i,r,s,n,0),void hr(l,e,i,r,s,n,0)}a=a.next}o=o.next}while(o!==t)}function pr(t,e){return t.x-e.x}function gr(t,e){var i=function(t,e){var i,r=e,s=t.x,n=t.y,o=-1/0;do{if(n<=r.y&&n>=r.next.y&&r.next.y!==r.y){var a=r.x+(n-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=s&&a>o&&(o=a,i=r.x<r.next.x?r:r.next,a===s))return i}r=r.next}while(r!==e);if(!i)return null;var l,h=i,c=i.x,u=i.y,f=1/0;r=i;do{s>=r.x&&r.x>=c&&s!==r.x&&xr(n<u?s:o,n,c,u,n<u?o:s,n,r.x,r.y)&&(l=Math.abs(n-r.y)/(s-r.x),Tr(r,t)&&(l<f||l===f&&(r.x>i.x||r.x===i.x&&mr(i,r)))&&(i=r,f=l)),r=r.next}while(r!==h);return i}(t,e);if(!i)return e;var r=Lr(i,t);return lr(r,r.next),lr(i,i.next)}function mr(t,e){return br(t.prev,t,e.prev)<0&&br(e.next,t,t.next)<0}function vr(t,e,i,r,s){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*s|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*s|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function yr(t){var e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function xr(t,e,i,r,s,n,o,a){return(s-o)*(e-a)>=(t-o)*(n-a)&&(t-o)*(r-a)>=(i-o)*(e-a)&&(i-o)*(n-a)>=(s-o)*(r-a)}function _r(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Mr(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(Tr(t,e)&&Tr(e,t)&&function(t,e){var i=t,r=!1,s=(t.x+e.x)/2,n=(t.y+e.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&s<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==t);return r}(t,e)&&(br(t.prev,t,e.prev)||br(t,e.prev,e))||wr(t,e)&&br(t.prev,t,t.next)>0&&br(e.prev,e,e.next)>0)}function br(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function wr(t,e){return t.x===e.x&&t.y===e.y}function Mr(t,e,i,r){var s=Sr(br(t,e,i)),n=Sr(br(t,e,r)),o=Sr(br(i,r,t)),a=Sr(br(i,r,e));return s!==n&&o!==a||(!(0!==s||!Ar(t,i,e))||(!(0!==n||!Ar(t,r,e))||(!(0!==o||!Ar(i,t,r))||!(0!==a||!Ar(i,e,r)))))}function Ar(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function Sr(t){return t>0?1:t<0?-1:0}function Tr(t,e){return br(t.prev,t,t.next)<0?br(t,e,t.next)>=0&&br(t,t.prev,e)>=0:br(t,e,t.prev)<0||br(t,t.next,e)<0}function Lr(t,e){var i=new zr(t.i,t.x,t.y),r=new zr(e.i,e.x,e.y),s=t.next,n=e.prev;return t.next=e,e.prev=t,i.next=s,s.prev=i,r.next=i,i.prev=r,n.next=r,r.prev=n,r}function Pr(t,e,i,r){var s=new zr(t,e,i);return r?(s.next=r.next,s.prev=r,r.next.prev=s,r.next=s):(s.prev=s,s.next=s),s}function Er(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function zr(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Ir(t,e,i,r){for(var s=0,n=e,o=i-r;n<i;n+=r)s+=(t[o]-t[n])*(t[n+1]+t[o+1]),o=n;return s}nr.exports=or,nr.exports.default=or,or.deviation=function(t,e,i,r){var s=e&&e.length,n=s?e[0]*i:t.length,o=Math.abs(Ir(t,0,n,i));if(s)for(var a=0,l=e.length;a<l;a++){var h=e[a]*i,c=a<l-1?e[a+1]*i:t.length;o-=Math.abs(Ir(t,h,c,i))}var u=0;for(a=0;a<r.length;a+=3){var f=r[a]*i,d=r[a+1]*i,p=r[a+2]*i;u+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},or.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},r=0,s=0;s<t.length;s++){for(var n=0;n<t[s].length;n++)for(var o=0;o<e;o++)i.vertices.push(t[s][n][o]);s>0&&(r+=t[s-1].length,i.holes.push(r))}return i};class Cr extends Nt{destroy(t){t&&super.destroy()}}class Rr{constructor(t,e,i,r,s){this.i=t,this.u1=e,this.v1=r,this.u2=i,this.v2=s}}class kr{constructor(t){const i=t.gl,r=t.maxImgSize||256,s=Math.pow(1024/r,2),n=Math.sqrt(s);this.c=new e.LRU(s),this.max=s,this.maxSize=r,this.gl=i,this.d=n}get(t){return this.c.get(t)}init(){let{texture:t,gl:e,maxSize:i,d:r}=this;if(!this.texture){const t=r*i;this.texture=new Cr(this.gl,{width:t,height:t})}}set(t,e){const i=this.c,{d:r,maxSize:s}=this;let n,o=i.get(t),a=!1;o?n=o.i:(n=i.length,n>=i.max&&(o=i.tail.data,n=o.i),a=!0);const l=n%r^0,h=n/r^0,c=l*s,u=h*s,f=c+e.width,d=u+e.height;return o?(o.u1=c,o.u2=f,o.v1=u,o.v2=d):o=new Rr(n,c,f,u,d),(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(this.init(),this.texture.set(e,l*s,h*s)),a&&i.set(t,o),o}destroy(){const{texture:t}=this;t&&t.destroy(!0)}}class Or{constructor(t){this.data={},this.scale=10,this.gl=t}create(t){let e=t.reduce(((t,e)=>t+e));const i=512/e;e*=i;const r=new Uint8Array(e),{gl:s}=this;let n=!0,o=0;for(;o<e;)for(let e of t)e*=i,n&&r.fill(255,o,o+e),o+=e,n=!n;return{scale:i,texture:new Cr(s,{width:r.length,height:1,data:r},{format:s.LUMINANCE})}}get(t){const e=String(t);let i=this.data[e];return i||(i=this.data[e]=this.create(t)),i}}class Dr{constructor(t=256){this.length=0,this.points=[],this.sqDistance=this.setMinDistance(t)}setMinDistance(t){return this.sqDistance=t*t}add(t,e){const{points:i}=this;i[this.length++]=t,i[this.length++]=e}clear(){this.length=0,this.points.length=0}hasSpace(t,e){const{length:i,points:r,sqDistance:s}=this;let n=0;if(s)for(;n<i;){const i=t-r[n++],o=e-r[n++];if(i*i+o*o<s)return!1}return!0}}const Fr=180/Math.PI;var Nr;!function(t){t[t.MID_TO_END=1]="MID_TO_END",t[t.MID_TO_START=-1]="MID_TO_START"}(Nr||(Nr={}));class Br{constructor(t){this.length=0,this.dashes=new Or(t),this.gl=t,this.pixels=new Float32Array(262144),this.alpha=new Float32Array(131072),this.lineLength=new Float32Array(131072),this.repeat={}}getDistanceGrp(){return this.repeat[this.dId]}projectLine(t,e,i){const{pixels:r,decimals:s}=this;if(!this.length){let n=0;const o="number"==typeof t[0][2]?3:2,a=3===o;for(let l,h,c,u,f,d,p=0,g=t.length;p<g;p++){let g=t[p];if(l=e.lon2x(g[0],i),h=e.lat2y(g[1],i),c=g[2]||0,(!p||Math.round(u*s)-Math.round(l*s)||Math.round(f*s)-Math.round(h*s)||a&&c!=d)&&(r[n++]=l,r[n++]=h,a&&(r[n++]=c),n>o)){const t=u-l,e=f-h;this.lineLength[p]=this.lineLength[p-1]+Math.sqrt(t*t+e*e)}u=l,f=h,d=c}this.length=n,this.dimensions=o}return this.length}placeCached(t,e,i,r){const{collisions:s}=this;for(let n,o=0;o<s.length;o++){n=s[o];let{cx:a,cy:l,cz:h}=n;256==i&&(a-=e.x%2*i,l-=e.y%2*i),t(a,l,h,r?this.alpha[o]:0,0,n)}}initTile(){const{repeat:t}=this;for(let e in t)t[e].clear()}initFeature(t,e,i){this.decimals=t>=20-Number(512==e)?100:1,this.length=0,this.collisions=null;const{repeat:r}=this;this.dId=i,i&&!r[i]&&(r[i]=new Dr)}createLine(t,e,i,r,s,n,o,a,l,h,c,u,f){e.buffer||(e.buffer=new je(!h));const d=e.buffer;if(n){const{units:t}=n,e=t.some((e=>e!=t[0]));if(n.pattern.length>2&&!e){const t=this.dashes.get(n.pattern);d.addUniform("u_dashPattern",t.texture),d.addUniform("u_dashSize",[t.texture.width/t.scale,0])}else d.addUniform("u_dashSize",[n.pattern[0],n.pattern[1]])}this.projectLine(t,i,r);const{pixels:p,length:g,dimensions:m}=this,v=g-m,y=p[0]==p[v]&&p[1]==p[v+1];return te(d.flexAttributes.a_position.data,d.flexAttributes.a_normal.data,p,this.lineLength,g,m,h,r,s,o,a,l,n&&d.flexAttributes.a_lengthSoFar.data,y,c,u,f)}placeAtSegments(t,e,i,r,s,n,o,a,l,h,c,u,f,d,p,g){var m;if(this.projectLine(t,i,r),null===(m=this.getDistanceGrp())||void 0===m||m.setMinDistance(null==o?256:o),p<d){const t=p;p=d,d=t}this.placeAlongLine(i,r,s,n,a,l,h,c,u,f,e,d,p,g)}getAbsOffset(t){if("string"==typeof t&&t.endsWith("px"))return parseFloat(t);const{length:e,dimensions:i,lineLength:r}=this;return t*r[e/i-1]}placeAtPoints(t,e,i,r,s,n,o,a,l,h,c=0,u=1,f){this.projectLine(t,i,r);let{length:d,dimensions:p,lineLength:g}=this;const m=g[d/p-1];let v=c*m,y=u*m;if(this.collisions)return this.placeCached(f,i,r);const x=s&&[];let _=!0===e;const b="number"==typeof e?e:null;_&&2==p&&(_=null);let w,M=0;for(let t=0,e=this.pixels;t<d;t+=p){let c,u=e[t],m=e[t+1],A=_?e[t+2]:b,S=t/p;if(w=M,M=g[S+1],v){if(!(v<M))continue;{const i=(v-w)/(M-w),r=t+p,s=e[r],n=e[r+1],o=_?e[r+2]:b;u+=(s-u)*i,m+=(n-m)*i,null!=A&&(A+=(o-A)*i),v==y&&(d=null,y=null),v=null}}if(y&&y&&w>y){const i=(y-w)/(w-g[S-1]),r=t-p,s=e[r],n=e[r+1],o=_?e[r+2]:b;u-=(s-u)*i,m-=(n-m)*i,null!=A&&(A-=(o-A)*i),d=null}if(u>=0&&m>=0&&u<r&&m<r){let t;x&&(t=this.getDistanceGrp(),t&&!t.hasSpace(u,m)||(c=s.insert(u,m,A,l,h,o,a,i,r,n),c&&x.push(c))),x&&!c||(f(u,m,A,0,0,c),null==t||t.add(u,m))}}(null==x?void 0:x.length)&&(this.collisions=x)}placeAlongLine(t,e,i,r,s,n,o,a,l,h,c,u,f,d){if(this.collisions)return this.placeCached(d,t,e,l);let{length:p,dimensions:g,lineLength:m}=this;const v=m[p/g-1];let y=u*v,x=f*v;const _=this.dimensions,b=i&&[],w=this.length/_;let M=this.pixels,A=0,S=Math.pow(2*s+o,2),T=Math.floor(w/2)-1,L=Nr.MID_TO_END,P=!1,E=!0===c;const z="number"==typeof c?c:null;let I="number"==typeof c?c:null;E&&2==g&&(E=null);for(let c=1;c<w;c++){let u=T+L*c;if(u>=w&&(L=Nr.MID_TO_START,u=T,T=w-1,P))break;const f=u-1,p=m[f],g=m[u],v=f*_;let C=M[v],R=M[v+1],k=E?M[v+2]:z;const O=u*_;let D=M[O],F=M[O+1],N=E?M[O+2]:z;if(y){if(!(y<g))continue;if(y>=p){const t=(y-p)/(g-p);C+=(D-C)*t,R+=(F-R)*t,k+=(N-k)*t,L==Nr.MID_TO_END?P=!0:c=1/0}}if(x){if(!(x>p)){L==Nr.MID_TO_END&&(c=w-T-1);continue}if(x<=g){const t=1-(x-p)/(g-p);D-=(D-C)*t,F-=(F-R)*t,N-=(N-k)*t,L==Nr.MID_TO_END&&(c=w-T-1)}}const B=D-C,U=F-R,W=C+.5*B,G=R+.5*U;if(W>=0&&G>=0&&W<e&&G<e){let c=h?B*B+U*U:1/0;if(c>S){if(E){const t=N-k;I=k+.5*t,A=Math.asin(t/Math.sqrt(B*B+U*U+t*t))}let h,u,f=Math.atan2(U,B);if(-1==L&&(f+=Math.PI),b&&(u=this.getDistanceGrp(),!u||u.hasSpace(W,G))){let u=s,d=n;if(l&&f&&(u||d)){const t=Math.sin(f),e=Math.cos(f);u=e*s-t*n,d=t*s+e*n}const p=Math.sqrt(S/c),g=[B*p,U*p];h=i.insert(W,G,I,u,d,o/2,a/2,t,e,r,g),h&&(this.alpha[b.length]=f*Fr,b.push(h))}b&&!h||(d(W,G,I,l?f*Fr:0,A,h),null==u||u.add(W,G))}}}(null==b?void 0:b.length)&&(this.collisions=b)}}class Ur extends ue{constructor(t=!0,e){super(t),this.flexAttributes={a_position:{data:new ce(Uint16Array),size:t?2:3},a_point:{data:new ce(Int16Array),size:e?3:2},a_texcoord:{data:new ce(Uint16Array),size:2}},this.first=0}}class Wr extends Zi{constructor(t=!0){super(t),this.flexAttributes={a_position:{data:new ce(Uint16Array),size:t?2:3},a_size:{data:new ce(Uint8Array),size:2},a_texcoord:{data:new ce(Uint16Array),size:2}},this.first=0}}class Gr extends ue{constructor(t=!0,e=!0){super(t,e),this.flexAttributes={a_position:{data:new ce(Float32Array),size:t?2:3}},this.first=0}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(this.flexAttributes.a_position.data.length,t)}rayIntersects(t,e,i,r,s){var n;const{attributes:o}=t,a=o.a_position.data,l=o.a_position.size,h=s.origin,c=s.direction,u=[0,0,0],f=[0,0,0],d=[0,0,0];let p=null;for(let s of t.groups){const o=null===(n=s.index)||void 0===n?void 0:n.data;let g=null;if(s.mode!=Gt.MODE_GL_LINES){for(let t=0;t<o.length;t+=3){const s=o[t]*l,n=o[t+1]*l,p=o[t+2]*l;u[0]=i+a[s],u[1]=r+a[s+1],f[0]=i+a[n],f[1]=r+a[n+1],d[0]=i+a[p],d[1]=r+a[p+1],3==l&&(u[2]=-a[s+2],f[2]=-a[n+2],d[2]=-a[p+2]);const m=Xe.rayIntersectsTriangle(h,c,u,f,d);m&&m<e.z&&(g=s,e.z=m)}if(null!=g)for(let e=0,{idOffsets:i}=t,{length:r}=i;e<r;e+=2)if(g<i[e]){p=i[e+1];break}}}return p}}class Zr extends Gr{constructor(){super(!1,!1),this.flexAttributes.a_normal={data:new ce(Int8Array),size:2,normalized:!0}}}const Yr=new Map;let Hr;[[Hr,Hr,Hr],[Hr,Hr,65154],[Hr,Hr,65156],[Hr,Hr,65158],[Hr,Hr,65160],[65163,65164,65162],[Hr,Hr,65166],[65169,65170,65168],[Hr,Hr,65172],[65175,65176,65174],[65179,65180,65178],[65183,65184,65182],[65187,65188,65186],[65191,65192,65190],[Hr,Hr,65194],[Hr,Hr,65196],[Hr,Hr,65198],[Hr,Hr,65200],[65203,65204,65202],[65207,65208,65206],[65211,65212,65210],[65215,65216,65214],[65219,65220,65218],[65223,65224,65222],[65227,65228,65226],[65231,65232,65230],Hr,Hr,Hr,Hr,Hr,[1600,1600,1600],[65235,65236,65234],[65239,65240,65238],[65243,65244,65242],[65247,65248,65246],[65251,65252,65250],[65255,65256,65254],[65259,65260,65258],[Hr,Hr,65262],[Hr,Hr,65264],[65267,65268,65266]].forEach(((t,e)=>{Yr.set(1569+e,t&&{initial:t[0],medial:t[1],final:t[2]})})),Yr.set(1662,{initial:64344,medial:64345,final:64343}),Yr.set(1740,{initial:64510,medial:64511,final:64509}),Yr.set(1670,{initial:64380,medial:64381,final:64379}),Yr.set(1705,{initial:64400,medial:64401,final:64399}),Yr.set(1711,{initial:64404,medial:64405,final:64403}),Yr.set(1688,{final:64395});const Xr=new Set([1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773]),jr={1570:{isolated:65269,final:65270},1571:{isolated:65271,final:65272},1573:{isolated:65273,final:65274},1575:{isolated:65275,final:65276}},qr=(t,e,i)=>{const r=i>0?t.length-e:e+1;for(let s,n=1;n<r;n++)if(s=t.charCodeAt(e+i*n),!Xr.has(s))return{cp:s,map:Yr.get(s)}},Vr=t=>{var e;if(!(t=>/[\u0600-\u06FF]/.test(t))(t))return t;let i="";for(let r=0;r<t.length;++r){let s=t.charCodeAt(r);if(Yr.has(s)){let i=null===(e=qr(t,r,-1))||void 0===e?void 0:e.map;!i||i.initial||i.medial||(i=Hr);let n,o=qr(t,r,1),a=null==o?void 0:o.map;if(!a||a.medial||a.final||(a=Hr),n=1604==s&&jr[null==o?void 0:o.cp])s=i?n.final:n.isolated,r++;else{const t=Yr.get(s);i&&a&&t.medial?s=t.medial:i&&t.final?s=t.final:a&&t.initial&&(s=t.initial)}}i+=String.fromCharCode(s)}return i},Kr=(t,e,i,r)=>{if(r){t.buffer||(t.buffer=new Gr(!1),t.isVerticalLine=!0);const s=t.buffer.flexAttributes.a_position.data;return s.push(e,i,0,e,i,r),s.length}},Qr=32,$r=.03125;class Jr extends Zi{constructor(t=!0){super(!1),this.flexAttributes.a_point={data:new ce(Uint16Array),size:3},this.flexAttributes.a_normal={data:new ce(Int8Array),normalized:!0,size:3}}rayIntersects(t,e,i,r,s){const{attributes:n}=t,o=n.a_position.data,a=n.a_position.size,l=n.a_point.data,[h,c,u]=s.getInverseScale(!0),f=t.getUniform("u_scaleByAltitude");let d=null;const p=6*a*6;let[g,m,v]=Gi(t,s.scale);const{sMat:y}=s,x=y[3],_=y[7],b=y[11],w=y[15];g*=h,m*=c,v*=u;for(let t=0,{length:n}=o;t<n;t+=p){const n=i+o[t]*$r+g,p=r+o[t+1]*$r+m,y=(3==a?-Ui(o[t+2]):0)-v,M=1+(f?0:y*b/(x*n+_*p+w)),A=(l[t]>>1)*h*M,S=(l[t+1]>>1)*c*M,T=(l[t+2]>>1)*u*M,L=s.intersectAABBox(n-A,p-S,y-T,n+A,p+S,y+T);null!=L&&L<e.z&&(e.z=L,d=t)}if(null!=d)return t.idOffsets[Math.floor(d/p)]}}const ts=(t,e,i)=>{const r=e[0]-t[0],s=e[1]-t[1],n=e[2]-t[2],o=i[0]-t[0],a=i[1]-t[1],l=i[2]-t[2];return[Math.floor(127*(s*l-n*a)),Math.floor(127*(n*o-r*l)),Math.floor(127*(r*a-s*o))]};let es;const is=(t,e,i,r,s,n,o)=>{es=es||((t=8,e=6,i=0,r=2*Math.PI,s=0,n=Math.PI,o=1)=>{const a=Math.min(s+n,Math.PI),l=[],h=[],c=[];let u=0;for(let a=0;a<=e;a++){const h=[],f=a/e;for(let e=0;e<=t;e++){const a=e/t,l=Math.sin(s+f*n);c.push(-Math.cos(i+a*r)*l*o,Math.cos(s+f*n)*o,-Math.sin(i+a*r)*l*o),h.push(u++)}l.push(h)}const f=[];for(let i=0;i<e;i++)for(let r=0;r<t;r++){const t=l[i][r+1],n=l[i][r],o=l[i+1][r],u=l[i+1][r+1];if(0!==i||s>0){h.push(t,n,u);const e=c.slice(3*t,3*t+3),i=c.slice(3*n,3*n+3),r=c.slice(3*u,3*u+3),s=ts(e,i,r);f.push.apply(f,s),f.push.apply(f,s),f.push.apply(f,s)}if(i!==e-1||a<Math.PI){h.push(n,o,u);const t=c.slice(3*n,3*n+3),e=c.slice(3*o,3*o+3),i=c.slice(3*u,3*u+3),r=ts(t,e,i);f.push.apply(f,r),f.push.apply(f,r),f.push.apply(f,r)}}let d=[];for(let t of h)d.push(127+Math.floor(127*c[3*t]),127+Math.floor(127*c[3*t+1]),127+Math.floor(127*c[3*t+2]));return{normals:d,surfaceNormals:f}})(16,12),t*=Qr,e*=Qr,i=Math.round(i/9e3*65535);const{normals:a,surfaceNormals:l}=es;for(let r=0;r<a.length;r+=3)s.push(t,e,i),n.push(a[r],a[r+1],a[r+2]),null==o||o.push(l[r],l[r+1],l[r+2])},rs=.03125;class ss extends Jr{constructor(t=!0){super(!1),this.cullFace=1029,this.flexAttributes.a_point={normalized:!0,data:new ce(Uint8Array),size:3}}rayIntersects(t,e,i,r,s){const{attributes:n}=t,o=n.a_position.data,a=n.a_position.size,l=t.getUniform("u_scaleByAltitude"),[h,c,u]=s.getInverseScale(!0),[f]=t.uniforms.u_radius,d=f*h,p=f*c,g=f*u,{sMat:m}=s,v=m[3],y=m[7],x=m[11],_=m[15],b=1056*a,w=[0,0,0],M=[0,0,0];let A=null,[S,T,L]=Gi(t,s.scale);S*=h,T*=c,L*=u;for(let t=0,{length:n}=o;t<n;t+=b){const n=i+o[t]*rs+S,h=r+o[t+1]*rs+T,c=(3==a?-Ui(o[t+2]):0)-L,u=1+(l?0:c*x/(v*n+y*h+_));w[0]=n,w[1]=h,w[2]=c,M[0]=d*u,M[1]=p*u,M[2]=g*u;const f=s.intersectEllipsoid(w,M);null!=f&&f<e.z&&(e.z=f,A=t)}if(null!=A)return t.idOffsets[Math.floor(A/b)]}}var ns;!function(t){t[t.bbox=0]="bbox",t[t.geometry=1]="geometry"}(ns||(ns={}));const os=[1,1,1,1];const as=(t,e,i,r,s)=>{const n=t[e],o=t[e+1],a=t[e+2],l=t[i]-n,h=t[i+1]-o,c=t[i+2]-a,u=t[r]-n,f=t[r+1]-o,d=t[r+2]-a,p=c*f-h*d,g=l*d-c*u,m=h*u-l*f;s[e]+=p,s[e+1]+=g,s[e+2]+=m,s[i]+=p,s[i+1]+=g,s[i+2]+=m,s[r]+=p,s[r+1]+=g,s[r+2]+=m},ls=(t,e)=>{const i=t.length,r=new Float32Array(i);if(e)for(let i=0;i<e.length;i+=3)as(t,3*e[i],3*e[i+1],3*e[i+2],r);else for(let e=0;e<i;)as(t,e,e+3,e+=6,r);const s=new Int8Array(i);for(let t,e,n,o=0;o<i;o+=3){t=r[o],e=r[o+1],n=r[o+2];let i=t*t+e*e+n*n;i>0&&(i=1/Math.sqrt(i)),i*=127,s[o]=Math.round(t*i),s[o+1]=Math.round(e*i),s[o+2]=Math.round(n*i)}return s};class hs extends ue{constructor(t,e,i,r){super(!1),this.hitTest=ns.bbox,this.flexAttributes={};const{flexAttributes:s}=this;hs.init(t,s),(null==t?void 0:t.index)&&(this._index=t.index),s.a_modelMatrix=i||{data:new ce(Float32Array),size:16,instanced:!0},s.a_offset=r||{data:new ce(Float32Array),size:3,instanced:!0},this.uniforms=Object.assign({},e)}static calcBBox(t){const{position:e}=t,i=1/0;let r=i,s=-1/0,n=i,o=-1/0,a=i,l=-1/0;for(let t,i,h,c=0,{length:u}=e;c<u;c+=3)t=e[c],i=e[c+1],h=e[c+2],t<r&&(r=t),t>s&&(s=t),i<n&&(n=i),i>o&&(o=i),h<a&&(a=h),h>l&&(l=h);return[r,n,a,s,o,l]}static init(t,e={}){if(t){const{position:i,normal:r,color:s,uv:n}=t;let o,a=os;if(e.a_position={data:hs.createFlexArray(i),size:3},e.a_normal=r?{data:hs.createFlexArray(r),size:3}:{data:hs.createFlexArray(ls(i)),normalized:!0,size:3},n&&(e.a_uv={data:hs.createFlexArray(n),size:2}),n&&r){const r=function(t,e,i){const r=new Float32Array(t.length),s=new Float32Array(3),n=new Float32Array(3),o=new Float32Array(3),a=new Float32Array(3),l=new Float32Array(3),h=new Float32Array(3),c=(null==i?void 0:i.length)||t.length/3;for(let u=0;u<c;u+=3){let c=u,f=u+1,d=u+2;i&&(c=i[c],f=i[f],d=i[d]);const p=3*c,g=3*f,m=3*d,v=2*c,y=2*f,x=2*d;s[0]=t[p],s[1]=t[p+1],s[2]=t[p+2],n[0]=t[g],n[1]=t[g+1],n[2]=t[g+2],o[0]=t[m],o[1]=t[m+1],o[2]=t[m+2],a[0]=e[v],a[1]=e[v+1],a[2]=e[v+2],l[0]=e[y],l[1]=e[y+1],l[2]=e[y+2],h[0]=e[x],h[1]=e[x+1],h[2]=e[x+2];const _=_e(n,n,s),b=_e(o,o,s),w=_e(l,l,a),M=_e(h,h,a),A=1/(w[0]*M[1]-M[0]*w[1]),S=s;Number.isFinite(A)?we(S,be(S,_e(S,be(_,_,M[1]),be(b,b,w[1])),A)):(S[0]=1,S[1]=0,S[2]=0),r[p]=r[g]=r[m]=S[0],r[p+1]=r[g+1]=r[m+1]=S[1],r[p+2]=r[g+2]=r[m+2]=S[2]}return r}(i,n,t.index);e.a_tangent={data:hs.createFlexArray(r),size:3}}else e.a_tangent={value:[1,0,0]};if(s)if(Bt(s)||Array.isArray(s)){const t=i.length/3;if(s.length==4*t)a=s,o=4;else if(s.length==3*t){o=4,a=new Uint8Array(4*t);const e=s;for(let t=0;t<e.length;t+=3){let i=t/3*4;a[i]=255*e[t],a[i+1]=255*e[t+1],a[i+2]=255*e[t+2],a[i+3]=255}}}else a=S(s);e.a_color=o?{data:new ce(a),size:o,normalized:!0}:{value:a}}return e}static createFlexArray(t){return new ce(Bt(t)?t:new Float32Array(t))}addInstance(t,e,i,r,s,n,o){this.instances++;const a=ii(Je());o?si(a,a,o):(s&&ni(a,a,s),r&&oi(a,a,r),n&&(n[0]&&ai(a,a,n[0],[1,0,0]),n[1]&&ai(a,a,n[1],[0,1,0]),n[2]&&ai(a,a,n[2],[0,0,1])));const l=this.flexAttributes.a_modelMatrix.data;return l.set(a,l.length),this.flexAttributes.a_offset.data.push(t,e,i),a}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(this.flexAttributes.a_modelMatrix.data.length,t)}rayIntersects(t,e,i,r,s){var n;const{attributes:o}=t,a=o.a_position,l=o.a_modelMatrix.data,h=o.a_offset.data,c=a.data,u=a.size,f=s.origin,d=s.direction,p=[0,0,0],g=[0,0,0],m=[0,0,0];let v=null;for(let o=0,a=0,{length:y}=l;o<y;o+=16,a+=3){const y=l.subarray(o,o+16);if(t.bbox){const[n,l,c,u,f,d]=t.bbox,p=[[n,l,c],[u,f,d]];let g=1/0,m=1/0,x=1/0,_=-1/0,b=-1/0,w=-1/0;const M=t.uniforms.u_groundResolution||1/s.scaleZ;for(let t of p){Se(t,t,y),t[0]=t[0]/M+i+h[a],t[1]=t[1]/M+r+h[a+1],t[2]=-t[2]-h[a+2];let[e,s,n]=t;e<g&&(g=e),e>_&&(_=e),s<m&&(m=s),s>b&&(b=s),n<x&&(x=n),n>w&&(w=n)}const A=s.intersectAABBox(g,m,x,_,b,w),S=(t.hitTest||0)==ns.bbox;if(null==A)continue;if(S){A<e.z&&(v=o,e.z=A);continue}}const x=y[o],_=y[o+5],b=y[o+10];for(let s of t.groups){const t=null===(n=s.index)||void 0===n?void 0:n.data;if(s.mode!=Gt.MODE_GL_LINES)for(let s=0;s<t.length;s+=3){const n=t[s]*u,a=t[s+1]*u,l=t[s+2]*u;p[0]=i+c[n]*x,p[1]=r+c[n+1]*_,g[0]=i+c[a]*x,g[1]=r+c[a+1]*_,m[0]=i+c[l]*x,m[1]=r+c[l+1]*_,3==u&&(p[2]=-c[n+2]*b,g[2]=-c[a+2]*b,m[2]=-c[l+2]*b);const h=Xe.rayIntersectsTriangle(f,d,p,g,m);h&&h<e.z&&(v=o,e.z=h)}}}if(null!=v)for(let e=0,{idOffsets:i}=t,{length:r}=i;e<r;e+=2)if(v<i[e])return i[e+1]}}const cs=function(){};class us extends class{constructor(t,e){this.cnt=0,this.callbacks={},this.fncStr=t.toString().match(/^\s*function\s*\(\s*\)\s*\{(([\s\S](?!\}$))*[\s\S])/)[1];let i=this;for(let t of e)this[t]=async e=>i.call(t,e)}destroy(){var t;null===(t=this.worker)||void 0===t||t.terminate(),this.worker=null,this.callbacks=null}init(){if(!this.worker){const t=URL.createObjectURL(new Blob([this.fncStr,"\nself.onmessage = async ({data}) => {try{\n        const {message,transfer} = await self[data.method](data.args);\n        self.postMessage({result: message, id: data.id}, transfer);\n    }catch(error){self.postMessage({error, id: data.id})}\n};"],{type:"text/javascript"}));this.worker=new Worker(t),URL.revokeObjectURL(t),delete this.fncStr,this.worker.onmessage=({data:t})=>{const{result:e,error:i,id:r}=t;let[s,n]=this.callbacks[r];delete this.callbacks[r],i?n(i):s(e)}}return this.worker}async call(t,e){this.init();const i=this.cnt++;return this.worker.postMessage({args:e,id:i,method:t}),new Promise(((t,e)=>{this.callbacks[i]=[t,e]}))}}{constructor(){super(cs,["main"]),this.inProgress={}}async load(t){var e;return(e=this.inProgress)[t]||(e[t]=(async()=>{const e=new URL(t,window.location.href),i=await this.main({url:e.href});return delete this.inProgress[t],i})())}}class fs extends Nt{constructor(){super(...arguments),this.ref=0}}class ds{constructor(t){this.models={};const e=new fs(t,{width:1,height:1,data:new Uint8Array([255,255,255,255])});e.ref=1/0,this.unusedTexture=e;const i=new fs(t,{width:1,height:1,data:new Uint8Array([127,127,255,255])});i.ref=1/0,this.unusedNormalTexture=i,this.gl=t,this.onBufferDestroyed=t=>{0===t.attributes.a_position.ref&&delete this.models[t.id]},this.objParser=new us}destroy(){this.objParser.destroy()}isValid(t){var e,i;return!(!(null===(e=null==t?void 0:t.faces)||void 0===e?void 0:e.length)||!(null===(i=t.geometries)||void 0===i?void 0:i[t.faces[0].geometryIndex]))}async loadObj(t){const e=await this.objParser.load(t);return this.initModel(t,e)}initTexture(t,e,i){let r=i[t];return r||(r=new fs(this.gl,e,{flipY:!0}),i[t]=r),r}getModel(t){return this.models[t]}initModel(t,e){if(null!=this.models[t])return this.models[t];if(this.isValid(e)){const{geometries:i,materials:r,faces:s}=e,n=new WeakMap,o=e.textures||{},a=[],l={unusedTexture:this.unusedTexture,unusedNormalTexture:this.unusedNormalTexture};for(let t of s){const e=i[t.geometryIndex];if(!e)continue;const s=Object.assign({diffuse:[1,1,1],diffuseMap:"unusedTexture",opacity:1,illumination:1,ambient:[1,1,1],specular:[1,1,1],specularMap:"unusedTexture",shininess:32,normalMap:"unusedNormalTexture"},null==r?void 0:r[t.material]);let h,c=n.get(e);"Points"==s.mode?s.pointSize=null==s.pointSize?1:s.pointSize:s.pointSize=0,delete s.mode,c||(c=hs.init(e)),e.index&&(h=e.index);const u=e.bbox||(e.bbox=hs.calcBBox(e));for(let t in s)if(t.endsWith("Map")){const e=s[t],i=o[e];s[t]=this.initTexture(e,i,l)}a.push({attributes:c,bbox:u,uniforms:s,index:h,first:t.start,count:t.count})}this.models[t]={textures:l,parts:a}}else this.models[t]=!1;return this.models[t]}createModelBuffer(t,e){const i=this.models[t];let r;if(i){r=new Bi;let s,n,o,{parts:a}=i;for(let i=0;i<a.length;i++){let{attributes:l,bbox:h,uniforms:c,index:u,first:f,count:d}=a[i],p=new hs(o,o,n,s);n=p.flexAttributes.a_modelMatrix,s=p.flexAttributes.a_offset;for(let t in l){let e=l[t];e.ref=(e.ref||0)+1,p.flexAttributes[t]=e}for(let t in c){let e=c[t];e instanceof fs&&e.ref++,p.uniforms[t]=e}u?p.setIndex(u):p.setArray(f||0,d),p.bbox=h,p.cullFace=e,p.id=t,r.set(i,p)}r.get(0).destroy=this.onBufferDestroyed}return r}addPosition(t,e,i,r,s,n,o,a){const{buffers:l}=t;l[0].addInstance(e,i,r,s,n,o,a);for(let t=1;t<l.length;t++)l[t].instances=l[0].instances}}class ps extends Nt{constructor(){super(...arguments),this.ref=0}destroy(){this.factory.dropTexture(this),super.destroy()}}class gs{constructor(t,e=256,i=1){this.cache=new Map,this.gl=t,this.width=e,this.height=i}getTexture(t,e){let i=this.cache.get(t);if(!i){const s=gs.canvas,n=gs.ctx,{width:o,height:a}=this;s.width=o,s.height=a;const l=n.createLinearGradient(0,0,o,a),h=(null==e?void 0:e(t))||t;for(var r in h)l.addColorStop(Number(r),h[r]);n.fillStyle=l,n.fillRect(0,0,o,a);const c=n.getImageData(0,0,o,a).data;i=new ps(this.gl,{width:o,height:a,data:c},{premultiplyAlpha:!1}),i.gradient=t,i.factory=this,this.cache.set(t,i)}return i.ref++,i}dropTexture(t){this.cache.delete(t.gradient)}}gs.canvas=document.createElement("canvas"),gs.ctx=gs.canvas.getContext("2d");const ms=document.createElement("canvas"),vs=ms.getContext("2d");ms.width=1,ms.height=1;function ys(){let t=this;const e=t._cbs,i=Math.max(t.width,t.height);if(t._cbs=null,!t.skipAutoScale&&i>64){const e=64/i;t=t._r[t.src]=((t,e)=>{const i=document.createElement("canvas"),r=i.getContext("2d");return i.width=t.width*e,i.height=t.height*e,r.drawImage(t,0,0,i.width,i.height),i})(t,e)}else vs.drawImage(t,0,0);t.ready=!0,t._r=null;for(let i in e)e[i][0](t,e[i][1])}class xs{constructor(){this.imgData={},this.promises={}}isRequested(t){return!!this.imgData[t]}isReady(t){var e;return null===(e=this.imgData[t])||void 0===e?void 0:e.ready}get(t,e,i,r,s){let n=this.imgData;if(null==n[t]){let o=n[t]=new Image;o.ready=!1,o._cbs={},e&&(o._cbs[i]=[e,r]),o._r=n,o.crossOrigin="Anonymous",o.skipAutoScale=s,o.onload=ys,o.src=t}else e&&(n[t].ready?e(n[t],r):n[t]._cbs[i]=[e,r]);return n[t]}}class _s{constructor(t){this.loader=new xs,this.textures=new Map,this.promises=new Map,this.gl=t,this.atlas=new kr({gl:t,maxImgSize:64})}getTexture(t){const e=this.textures.get(t);return e.ref++,e}load(t,e){var i;const{loader:r,promises:s}=this;return null!==(i=this.textures.get(t))&&void 0!==i?i:s[t]||(s[t]=new Promise(((i,n)=>{r.get(t,(r=>{delete s[t];const n=new Nt(this.gl,r,e);n.ref=1/0,this.textures.set(t,n),i(n)}),"*",void 0,!0)})))}loadAtlas(t,e){const{atlas:i,loader:r,promises:s}=this;return e?this.textures.has(t)?new Rr(0,e.x,e.x+e.width,e.y,e.y+e.height):this.load(t):i.get(t)||s[t]||(s[t]=new Promise(((e,n)=>{r.get(t,(r=>{delete s[t];let n=i.set(t,r);this.textures.set(t,i.texture),e(n)}))})))}destroy(){this.atlas.destroy()}}const bs="*";let ws;class Ms{constructor(t,e,i){this.pendingCollisions=[],this.gl=t,this.atlasManager=new _s(t),this.dpr=i,this.collisions=e,this.lineFactory=new Br(t),this.modelFactory=new ds(t),this.gradients=new gs(t,256,1);var r=new Uint8Array(1048576);for(let t=0;t<262144;t++)r[4*t]=255,r[4*t+1]=0,r[4*t+2]=0,r[4*t+3]=255}toRGBA(t,e=1,i=!0){const r=S(t);return r&&(e=r[3]*=e,i&&(r[0]*=e,r[1]*=e,r[2]*=e)),r||null}init(t,e,i,r,s){this.tile=t,this.groups=e,this.tileSize=i,this.z=r,this.lineFactory.initTile(),this.pendingCollisions.length=0,this.waitAndRefresh=s}createPoint(t,e,i,r,s,n,o,a,l=0,h,c,u,f){var d;const p=null===s,g=this.z;let m,v,y;if(l=(l+360)%360,"Text"==t){e.buffer||(e.buffer=new Ur(p,h!=ws),e.buffer.addUniform("u_texture",new he(this.gl,e.shared)));const t=e.buffer.uniforms.u_texture,{flexAttributes:a}=e.buffer;t.addChars(c);const x=t.getAtlas();let _=null!==(d=H("lineWrap",n,o,g))&&void 0!==d?d:u;const w=b(c,_);m=a.a_position,v=m.data.length,y=v+t.bufferLength(c,p?2:3),((t,e,i,r,s,n,o,a,l=0,h,c="Center")=>{const u=r.length-1,f=a.lineHeight,d=Ji[c]||Ji.Center;let p=a.baselineOffset+.5*f*(u+r.length*d.y);p*=ie,t=64*t<<1|1,e=64*e<<1|1,l=Math.round(1024*l/360);const g=null!==i;let m=2,v=null==h?2:3;g&&(i=Math.round(i/9e3*65535),m=3);let y=n.length/m;for(let c of r){const r=oe(c,a,s,o,l,h),u=r.width*d.x*a.scale*ie,x=r.count*m;n.reserve(x);for(let r=s.data,o=n.data,a=y+x/m;y<a;y++)r[y*v]-=u,r[y*v+1]-=p,o[y*m]=t,o[y*m+1]=e,g&&(o[y*m+2]=i);n.length+=x,p-=f*ie}})(i,r,s,w,a.a_point.data,a.a_position.data,a.a_texcoord.data,x,l,h,f)}else{if("Model"==t){let t,a=H("model",n,o,g);if(!a)return;if("string"==typeof a){if(t=a,a=this.modelFactory.getModel(t),a===ws)return void(t.endsWith(".obj")&&this.waitAndRefresh(this.modelFactory.loadObj(t)))}else t=a.id||(a.id=Math.random()),a=this.modelFactory.initModel(t,a);if(!1===a)return;let l=e.buffer,{scale:h,translate:c,rotate:u,transform:f,cullFace:d}=n;if(!e.buffer){let i;d&&(i="Front"==d?this.gl.BACK:this.gl.FRONT),l=e.buffer=this.modelFactory.createModelBuffer(t,i)}this.modelFactory.addPosition(l,i,r,s,h,c,u,f)}else if("Icon"==t){e.buffer||(e.buffer=new Wr(p));const t=e.buffer,{flexAttributes:a}=t,h=H("src",n,o,g),c=H("width",n,o,g),u=H("height",n,o,g)||c,f=n.atlas,d=this.atlasManager.loadAtlas(h,f);if(d.then)return this.waitAndRefresh(d);m=a.a_position,((t,e,i,r,s,n,o,a,l,h=0)=>{let{u1:c,u2:u,v1:f,v2:d}=r;Yi(t,e,i,a);const p=(h=Math.round(1024*h/360))>>5,g=31&h;c=c<<5|g,u=u<<5|g,f=f<<5|p,d=d<<5|p,o.push(s,n,s,n,s,n,s,n,s,n,s,n),l.push(c,d,c,f,u,f,c,d,u,f,u,d)})(i,r,s,d,c,u,a.a_size.data,m.data,a.a_texcoord.data,l),t.addUniform("u_texture",this.atlasManager.getTexture(h))}else if("Circle"==t||"Rect"==t){m=(e.buffer||(e.buffer=new Zi(p))).flexAttributes.a_position,Yi(i,r,s,m.data)}else if("Heatmap"==t){const t=e.buffer||(e.buffer=new Xi(p)),s=H("weight",n,o,g);t.addPoint(i,r,s)}else if("Sphere"==t){H("radius",n,o,g);const t=e.buffer||(e.buffer=new ss(p)),{flexAttributes:a}=t;m=a.a_position,is(i,r,s,0,m.data,a.a_point.data,a.a_normal.data)}else{if("Box"!=t)return void(s>0&&"VerticalLine"==t&&Kr(e,i,r,s));{let t=H("width",n,o,g),a=H("height",n,o,g)||t,l=H("depth",n,o,g)||t;const h=e.buffer||(e.buffer=new Jr(p)),{flexAttributes:c}=h;m=c.a_position,((t,e,i,r,s,n,o,a,l)=>{t*=Qr,e*=Qr,"number"==typeof i?(i=Math.round(i/9e3*65535),o.push(t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i,t,e,i)):o.push(t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e,t,e),a.push(0|r,1|s,1|n,1|r,1|s,1|n,0|r,1|s,0|n,0|r,1|s,0|n,1|r,1|s,1|n,1|r,1|s,0|n,0|r,0|s,0|n,1|r,0|s,1|n,0|r,0|s,1|n,1|r,0|s,0|n,1|r,0|s,1|n,0|r,0|s,0|n,0|r,1|s,0|n,0|r,0|s,0|n,0|r,1|s,1|n,0|r,0|s,0|n,0|r,0|s,1|n,0|r,1|s,1|n,1|r,1|s,0|n,1|r,1|s,1|n,1|r,0|s,0|n,1|r,0|s,0|n,1|r,1|s,1|n,1|r,0|s,1|n,0|r,0|s,1|n,1|r,1|s,1|n,0|r,1|s,1|n,0|r,0|s,1|n,1|r,0|s,1|n,1|r,1|s,1|n,0|r,0|s,0|n,1|r,1|s,0|n,0|r,1|s,0|n,0|r,0|s,0|n,1|r,0|s,0|n,1|r,1|s,0|n),l&&l.push(0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1)})(i,r,s,t,a,l,m.data,c.a_point.data,c.a_normal.data)}}y=null==m?void 0:m.data.length,v=y-12}e.buffer.setIdOffset(o.id),a&&m&&a.attrs.push({buffer:m,start:v,stop:y})}create(t,e,i,r,s,n,o,a){var l;const{tile:h,groups:c,tileSize:u}=this,f=this.z;let d,p,g,v,y,x,_,b,w,M,A,S,T,L,P,E,z,I,C,R,k,O,D,F,N,B,U,W,G,Z,j,q,V,K,$,J={};if(this.lineFactory.initFeature(f,u,null==a?void 0:a.id),o!==ws||"Point"!==e||h.isInside(i)){for(let tt=0,et=r.length;tt<et;tt++){if(v=r[tt],x=H("type",v,t,f),!x)continue;if(_=H("opacity",v,t,f),0===_)continue;let et,it="Polygon"==e||H("collide",v,t,f);if(o==ws&&("Text"==x&&!it||!1===it)){let e=H("collisionGroup",v,t,f)||"0",i=J[e];const r=Q(v,t,f,this.dpr,null==i?void 0:i.bbox);if(r){i||(i=J[e]={id:e,bbox:null,priority:Number.MAX_SAFE_INTEGER,repeat:-Number.MAX_SAFE_INTEGER,styleGrp:[]}),i.bbox=r,i.styleGrp.push(v);const s=H("priority",v,t,f);s<i.priority&&(i.priority=s);const n=H("repeat",v,t,f);n<i.repeat&&(i.repeat=n),i.id+=`${x}${s||"?"}${n||"?"}`}continue}(_==ws||_>=.98)&&(_=1),"Image"==x&&(x="Icon"),b=ws,w=ws,S=ws,M=ws,T=ws,L=ws,P=ws,E=ws,z=ws,I=ws,k=ws,O=ws,U=0,W=0,Z=ws,q=ws,j=s,V="px",K=ws;let rt=!0,st=!1,nt=0;A=0^H("rotation",v,t,f);let ot=H("altitude",v,t,f);if("Model"==x)(l=v).modelId||(l.modelId=Math.random()),nt=Number(v.terrain||0),F="M"+v.modelId,st=!0;else if("Icon"==x)q=H("alignment",v,t,f)||"viewport",F=(ot?"AI":"I")+(q||""),st=!0;else{if(S=H("stroke",v,t,f),L=H("strokeWidth",v,t,f),"VerticalLine"==x)G=H("offsetZ",v,t,f)||0,F="VL"+S+G,ot==ws&&(ot=!0);else if("Line"==x){if(!S||!L)continue;const[e,i]=X(L,!1);L=e,V=i,z=H("strokeLinecap",v,t,f)||"round",I=H("strokeLinejoin",v,t,f)||"round";const r=H("offset",v,t,f);if([U,K]=X(r),F=(ot?"AL":"L")+V+U+K+z+I,P=H("strokeDasharray",v,t,f),Array.isArray(P)&&P[0]){let e=[],i=[];for(let t=0;t<P.length;t++){const[r,s]=X(P[t]);e[t]=r,i[t]=s,F+=r+s}P={pattern:e,units:i},E=H("strokeDashimage",v,t,f),E&&(F+=E.slice(-8))}else P=ws}else if(w=H("fill",v,t,f),"Polygon"==x){if(!w||"Polygon"!=e)continue;C=H("extrude",v,t,f),R=H("extrudeBase",v,t,f),"number"==typeof C||R?(F="E",x="Extrude"):F="P"}else{if("Polygon"==e)continue;if(q=H("alignment",v,t,f),"Text"==x){if(Z=Y(v,t,f),!Z)continue;Z=Vr(Z),b=H("font",v,t,f)||m,q==ws&&(q="Point"==e?"viewport":"map"),F="T"+(b||bs)}else if("Circle"==x)k=O=H("radius",v,t,f),[k,V]=X(k),F=(ot?"AC":"C")+V+k||bs;else if("Heatmap"==x){k=H("radius",v,t,f),[k,V]=X(k),M=w;const e=H("intensity",v,t,f);O=e,F="H"+(k||bs)+JSON.stringify(w)+e}else if("Rect"==x)k=H("width",v,t,f),[k,V]=X(k),O=H("height",v,t,f),O=O?X(O)[0]:k,F=(ot?"AR":"R")+A+V+k+O;else if("Box"==x)rt=H("pointerEvents",v,t,f),F="B"+A+rt;else{if("Sphere"!=x)continue;k=O=H("radius",v,t,f),[k,V]=X(k),rt=H("pointerEvents",v,t,f),F="S"+k+rt}st=!0,F+=q||""}!M&&w&&(M=this.toRGBA(w,_)),S&&(T=this.toRGBA(S,_),"Text"==x&&(j=1),"number"!=typeof L?L=1:(L*=j,L<0&&(L=1))),F+=(S||bs)+(L||bs)+(w||bs)}st&&(U=H("offsetX",v,t,f),W=H("offsetY",v,t,f),G=H("offsetZ",v,t,f),K=new Array(3),[U,K[0]]=X(U),[W,K[1]]=X(W),[G,K[2]]=X(G),F+=U+(W<<8)+(G<<16)+K[0]+K[1]+K[2]),F+=100*_^0,y=H("zIndex",v,t,f);const at=H("zLayer",v,t,f);let lt;at!=ws&&(F=at+":"+F),ot&&(lt=H("depthTest",v,t,f),lt||(F="ND"+F));let ht=H("scaleByAltitude",v,t,f);if(ht=ht==ws?"m"==V:!!ht,ht&&(F+="SA"),D=c[y]=c[y]||{index:{},groups:[]},B=D.index[F],B==ws?(B=D.index[F]=D.groups.length,N=D.groups[B]={type:x,zLayer:at,depthTest:lt,pointerEvents:rt,shared:{unit:V,font:b,fill:M,opacity:_,stroke:T,strokeWidth:L,strokeLinecap:z,strokeLinejoin:I,strokeDasharray:P,strokeDashimage:E,width:k,height:O,depth:et,rotation:A,offsetX:U,offsetY:W,offsetZ:G,offsetUnit:K,alignment:q,modelMode:nt,scaleByAltitude:ht}}):N=D.groups[B],"Point"==e)if("VerticalLine"==x){if("number"==typeof ot||i[2]>0){const t="number"==typeof ot?ot:i[2];if(t>0){const e=h.lon2x(i[0],u),r=h.lat2y(i[1],u);Kr(N,e,r,t)}}}else{const e=h.lon2x(i[0],u),r=h.lat2y(i[1],u),s="number"==typeof ot?ot:ot?i[2]||0:null;if(a){if($=this.collisions.insert(e,r,s,a.offsetX,a.offsetY,a.width,a.height,h,u,a.priority),!$)return;a=null}this.createPoint(x,N,e,r,s,v,t,$,A,ws,Z,ws,"Text"==x&&H("textAnchor",v,t,f))}else if("LineString"==e)if("Line"==x){if(E){const t=this.atlasManager.load(E,{mipMaps:!1});if(t.then)return void this.waitAndRefresh(t)}this.lineFactory.createLine(i,N,h,u,n,P,z,I,L,ot,U,H("from",v,t,f),H("to",v,t,f)),E&&N.buffer.addUniform("u_dashTexture",this.atlasManager.getTexture(E)),N.buffer.setIdOffset(t.id)}else{let e="Text"==x,r=H("anchor",v,t,f);null!=r||(r=e?"Line":"Coordinate");const s=e&&H("textAnchor",v,t,f),n=e?!it:!1===it;let l,c;const d=H("from",v,t,f),p=H("to",v,t,f);if("Line"==r){const e="map"==q;if(a)l=2*a.width,c=2*a.height;else if("Icon"==x)l=H("width",v,t,f),c=H("height",v,t,f)||k;else if("Text"==x){N.buffer||(N.buffer=new Ur(!0,!0),N.buffer.addUniform("u_texture",new he(this.gl,v)));const t=N.buffer.uniforms.u_texture.getAtlas();l=t.getTextWidth(Z),c=t.letterHeight}else l=k,c=O,"Circle"==x&&(l*=2,c*=2);let r=H("checkLineSpace",v,t,f);r==ws&&(r=!0),this.lineFactory.placeAtSegments(i,ot,h,u,n&&this.collisions,o,H("repeat",v,t,f),U,W,l,c,e,r,d,p,((e,i,r,n,o,a)=>{this.createPoint(x,N,e,i,r,v,t,a,n+A,o,Z,!1,s)}))}else a?(l=a.width,c=a.height):(l=k/2,c=O/2),this.lineFactory.placeAtPoints(i,ot,h,u,n&&this.collisions,o,l,c,U,W,d,p,((e,i,r,n,o,a)=>{this.createPoint(x,N,e,i,r,v,t,a,n+A,ws,Z,ws,s)}))}else if("Polygon"==x||"Extrude"==x){N.buffer||(N.buffer="Polygon"==x?new Gr:new Zr);const e=N.buffer,r=e.index(),{flexAttributes:s}=e,n=s.a_position.data;if(d=n.length,"Extrude"==x){let t;S&&(t=N.extrudeStrokeIndex=N.extrudeStrokeIndex||[]),p=sr(n,N.buffer.flexAttributes.a_normal.data,r,i,h,u,C,R,t)}else"Polygon"==x&&(p=er(n,i,h,u));if(N.buffer.setIdOffset(t.id),!g){const e=t.geometry;if(e._xyz)g=e._xyz;else{g=[];for(let t of p){let e=t.dimensions,i=n.data.subarray(t.start,t.stop),r=nr.exports(i,t.holes,e),s=(t.start-d)/e;for(let t of r)g.push(s+t)}h.clipped||(e._xyz=g)}}for(let t,i=0,s=d/p[0].dimensions;i<g.length;i++)t=s+g[i],e.i32=e.i32||t>65535,r.push(t)}}for(let r in J){const s=J[r],[n,o,a,l]=s.bbox,h=.5*(a-n),c=.5*(l-o);s.feature=t,s.geomType=e,s.coordinates=i,s.offsetX=n+h,s.offsetY=o+c,s.width=h,s.height=c,this.pendingCollisions.push(s)}}}destroy(){this.modelFactory.destroy()}}class As{constructor(t){this.timer=null,this.tiles=new Map,this.display=t,this.debug(false)}debug(t){t?this.dbgLayers||(this.dbgLayers=[new i.TileLayer({pointerEvents:!1,min:2,max:28,provider:new i.LocalProvider({})}),new i.TileLayer({pointerEvents:!1,min:2,max:28,provider:new i.LocalProvider({})})],setTimeout((()=>this.dbgLayers.forEach((t=>Lo.getInstances().pop().addLayer(t)))),0)):this.dbgLayers&&this.dbgLayers.forEach((t=>t.getProvider().clear())),this.dbg=t}dbgBBoxes(t,e,r){const s=Lo.getInstances().pop();let n=2,o=1;for(let a of t.boxes){let t,l,h=.5*(a.maxX-a.minX),c=.5*(a.maxY-a.minY);if("number"==typeof e){const r=i.webMercator.mapSizePixel(512,e);t=i.webMercator.x2lon(a.maxX-h,r),l=i.webMercator.y2lat(a.maxY-c,r),n=3,o=0}else{const i=s.pixelToGeo(a.minX+h,a.minY+c);t=i.longitude,l=i.latitude,r=e?"orange":"green"}this.dbgLayers[Number("number"!=typeof e)].addFeature({type:"Feature",geometry:{type:"Point",coordinates:[t,l]}},[{zLayer:1e5,zIndex:o,type:"Rect",stroke:r,strokeWidth:n,width:2*h,height:2*c,collide:!0}])}}getTileCacheKey(t,e){return 256==e.tileSize?t.slice(0,-1):t}getDataKey(t,e){return`${e.id}-${t}`}intersects(t,e){const i=t.boxes;for(let{boxes:t}of e)for(let e of t)for(let t of i)if(t.minX<=e.maxX&&e.minX<=t.maxX&&t.minY<=e.maxY&&e.minY<=t.maxY)return!0}updateBBoxes(t,e,i,r,s,n,o){for(let a=0;a<=n;a++){let l=.75*(a/n-.5),h=i[0]*l+t,c=i[1]*l+e;o[a]={minX:h-r,maxX:h+r,minY:c-s,maxY:c+s}}}initTile(t,e){const r=[];let{quadkey:s,x:n,y:o,z:a}=t;this.clearTile(s,e),256==e.tileSize&&(a--,o=.5*o^0,n=.5*n^0);for(let t=-1;t<2;t++)for(let e=-1;e<2;e++)if(0!=e||0!=t){let s=i.tileUtils.tileXYToQuadKey(a,o+t,n+e),l=this.tiles.get(s);if(l)for(let t in l){let e=l[t];for(let t of e)r[r.length]=t}}const l=this.getTileCacheKey(s,e);this.curLayerTileCollision={tileKey:l,data:[],dataKey:this.getDataKey(s,e),existing:Object.assign({neighbours:r},this.tiles.get(l)||{})},this.updated=!1}insert(t,e,i,r,s,n,o,a,l,h=Number.MAX_SAFE_INTEGER,c){let u,f=a.x,d=a.y,p=a.z;256==l&&(t+=f%2*l,e+=d%2*l,l*=2,f=.5*f^0,d=.5*d^0,p--),f=f*l+r,d=d*l+s;n+=4,o+=4;const g=Math.min(n,o),m=Math.max(n,o);let v=Math.floor(m/g);c&&v>1.5?(n=g,o=g,v=Math.floor(.7*v),u=new Array(v),this.updateBBoxes(t+f,e+d,c,g,g,v,u)):u=[{minX:f+t-n,maxX:f+t+n,minY:d+e-o,maxY:d+e+o}];const y={cx:t,cy:e,cz:i,halfWidth:n,halfHeight:o,offsetX:r,offsetY:s,boxes:u,slope:c,priority:h,attrs:[]},{data:x,existing:_}=this.curLayerTileCollision,{dbg:b}=this;if(this.intersects(y,x))return!1;for(let t in _)if(this.intersects(y,_[t]))return b&&this.dbgBBoxes(y,p,"darkred"),!1;return this.updated=!0,x.push(y),y}completeTile(t){const{tileKey:e,dataKey:i,data:r}=this.curLayerTileCollision,s=this.tiles.get(e)||{};return s[i]=r,this.tiles.set(e,s),this.curLayerTileCollision=null,this.updated&&t&&this.updateTileSync(this.display.getScreenTile(e,512)),this.updated}clearTile(t,e){var i;const r=this.getTileCacheKey(t,e),s=this.getDataKey(t,e);if((null===(i=this.curLayerTileCollision)||void 0===i?void 0:i.dataKey)==s)return;const n=this.tiles.get(r);if(n){delete n[s];for(let t in n)return;this.tiles.delete(r)}}updateTileSync(t){return t&&this.updateTiles([t],this.display.s)}update(t,e){null==this.timer&&(this.timer=setTimeout((()=>{const t=this.display.grid.tiles[512],i=this.display.s,r=this.updateTiles(t,i);this.timer=null,r&&(null==e||e())}),150))}updateTiles(t,e){const{display:i,dbg:r}=this,s=[];r&&this.dbgLayers[1].getProvider().clear();for(let r of t){let t=r.quadkey,n=this.tiles.get(t);if(n)for(let t in n){const o=n[t];for(let t of o){const{attrs:n}=t,o=t.offsetX/e,a=t.offsetY/e,l=t.boxes.length;let h,{slope:c,halfWidth:u,halfHeight:f}=t,d=r.x+t.cx,p=r.y+t.cy;if(l>1){h=new Array(l),d+=o,p+=a;let[t,r]=i.project(d,p,0,0,0),s=i.project(d+c[0],p+c[1],0,0,0);c=[(s[0]-t)/e,(s[1]-r)/e],this.updateBBoxes(t,r,c,u,f,h.length-1,h)}else{const[t,e]=i.project(d,p,0,0,0);h=[{minX:t-u+o,maxX:t+u+o,minY:e-f+a,maxY:e+f+a}]}s.push({boxes:h,attrs:n,slope:c,priority:t.priority})}}}s.sort(((t,e)=>t.priority-e.priority));const n=[],o=[];let a=!1;for(let t of s){let e,i=this.intersects(t,o);t.slope?e=n:(i||(i=this.intersects(t,n)),e=o),i||(e[e.length]=t);for(let{buffer:e,start:r,stop:s}of t.attrs){const{data:t,size:n}=e,o=1==(1&t[r]);if(i&&o||!i&&!o){for(;r<s;)t[r]^=1,r+=n;e.dirty=!0,a=!0}}r&&this.dbgBBoxes(t,i)}return a}removeTiles(t){const{id:e}=t;this.tiles.forEach((t=>{for(let i in t)Number(i.split("-")[0])==e&&delete t[i]}))}}const Ss=[3,9],Ts=(t,e)=>{let i=t.length,r=e.length-i,s=0,n=0;for(let t=0,o=.5;t<r;t++,o*=.5){const r=Number(e.charAt(i+t));s+=r%2*o,n+=Number(r>1)*o}return[s,n]};class Ls extends mt{constructor(t,e,i,r){super(t,e,i||"auto",new Ni(512),new Ri(r),Ss),this.name="gl-test",this.worldCenter=[0,0],this.dpr<2&&this.buckets.setSize(1024);const s=this;this.collision=new As(s),this.buckets.onDrop=function(t,e){const{quadkey:i,layers:r}=this;s.collision.clearTile(i,r[e]),s.releaseBuffers(t)};const{render:n}=s;n.init(this.canvas,this.dpr),this.rayCaster=new Xe(n.screenMat,n.invScreenMat),this.factory=new Ms(n.gl,this.collision,this.dpr)}refreshTile(t,e){const i=this.layers.get(e);if(i){const e=this.buckets.get(t,!0);if(e){const r=i.layer,{index:s}=i;e.preview(s,!1),e.ready(s,!1),e.cancelTasks(r);const n=r.getCachedTile(e.quadkey);n&&this.getScreenTile(t,i.tileSize)&&this.handleTile(n,r,e,s)}}}releaseBuffers(t){const e=this.render;if(t)for(let i of t)e.deleteBuffer(i)}removeLayer(t){return this.collision.removeTiles(this.layers.get(t)),super.removeLayer(t)}unproject(t,e,i){const r=this.render.invScreenMat;if("number"==typeof i){const s=[t,e,i];return Se(s,s,r),s[2]*=-1,s}const s=[t,e,0],n=[t,e,1];Se(s,s,r),Se(n,n,r);const o=s[2],a=n[2],l=o===a?0:(0-o)/(a-o);return[s[0]*(1-l)+n[0]*l,s[1]*(1-l)+n[1]*l]}project(t,e,i=0,r=this.sx,s=this.sy){const n=[t-r,e-s,-i];return Se(n,n,this.render.screenMat)}setSize(t,e){super.setSize(t,e),this.initRenderer()}setTransform(t,e,i){const r=2*Math.PI;e=(e+r)%r,this.s=t,this.rz=e,this.rx=i}setView(t,e,i,r,s=this.groundResolution,n=this.worldSize){super.setView(t,e,i,r,s,n),this.groundResolution=s,this.worldCenter[0]=t[0],this.worldCenter[1]=t[1],this.worldSize=n,this.initRenderer()}initRenderer(){this.render.gl&&this.render.initView(this.w,this.h,this.s,this.rx,this.rz,this.groundResolution,this.worldCenter[0],this.worldCenter[1],this.worldSize)}prepareTile(t,e,r,s,n){const o=this,a=o.render.gl,l=r.tileSize,{quadkey:h}=s,c=r.id,u=this.layers.get(c);if("image"==t.type&&e instanceof Image){const t=Ve(e,a,l,u.index>0);u.addZ(t.zIndex),s.preview(s.setData(r,[t]),null),n(s,r)}else if(e.length){const a=((t,e,r,s,n,o,a)=>{const l=e.layer,h={},c=[],u=t=>{c.push(t)},f=qi.create({time:4,priority:4,init:function(){const e=s.z+l.levelOffset,i=l.getStyle();let a=1;if(i){const t=i.strokeWidthZoomScale||i.LineStringZoomScale;t&&(a=t(e))}return o&&o(),n.init(s,h,r,e,u),[s,t,a,0,16,l,e,!1]},name:"createBuffer",onDone:function(t){var r,o,u;const f=t[6],d=1/i.webMercator.getGroundResolution(f);let p,g=[];for(p in h){const t=h[p];if(t)for(let i of t.groups){let t=i.type,a=i.shared,h=a.stroke,c=a.strokeWidth,f=t;if(!i.buffer||i.buffer.isEmpty())continue;const m=i.buffer instanceof Bi?i.buffer.toArray():[i.buffer];for(let v of m){const m=Gt.fromTemplateBuffer(t,v);if(null==m)continue;const y=null===(r=a.fill)||void 0===r?void 0:r[3],x=null===(o=a.stroke)||void 0===o?void 0:o[3],_=y<1||x<1;if(m.flat=v.isFlat(),m.addUniform("u_scaleByAltitude",a.scaleByAltitude),m.pointerEvents=i.pointerEvents,"VerticalLine"==f&&(m.groups[0].mode=Gt.MODE_GL_LINES,m.type="Polygon",m.addUniform("u_fill",a.stroke),m.addUniform("u_offsetZ",[a.offsetZ,0])),g.push(m),"Line"==t)a.strokeDasharray&&(m.type="DashedLine",m.addUniform("u_dashUnit",["m"==a.strokeDasharray.units[0]?d:0,"m"==a.strokeDasharray.units[1]?d:0])),m.clip=!s.clipped,m.addUniform("u_fill",h),m.addUniform("u_strokeWidth",[.5*c,"m"==a.unit?d:0]),m.addUniform("u_offset",[a.offsetX,"m"==a.offsetUnit?d:0]),m.addUniform("u_no_antialias",!1),m.pass=bt.ALPHA,(!m.isFlat()||a.strokeDasharray||_)&&(m.pass|=bt.POST_ALPHA),m.depth=m.blend=!0;else{if("Polygon"==t||"Extrude"==t)m.addUniform("u_fill",a.fill),"Extrude"==t&&(m.addUniform("u_strokePass",0),a.stroke)&&(m.addGroup(i.extrudeStrokeIndex,v.i32,1).uniforms={u_strokePass:1,u_stroke:a.stroke}),_&&(m.pass=bt.ALPHA,"Extrude"==t&&(m.pass|=bt.POST_ALPHA),m.depth=m.blend=!0);else{if("Text"==t||"Icon"==t){"Text"==t?(m.uniforms.u_texture.sync(),m.addUniform("u_fillColor",a.fill||Ki),m.addUniform("u_strokeColor",a.stroke||Ki)):m.addUniform("u_opacity",a.opacity);const e=m.uniforms.u_texture;m.addUniform("u_texSize",[e.width,e.height]),m.addUniform("u_alignMap","map"==a.alignment),m.pass=bt.ALPHA,m.depth=m.blend=!0}else if("Rect"==t||"Circle"==t||"Box"==t||"Sphere"==t){const e=a.fill||Ki;m.addUniform("u_fill",e),h&&(m.addUniform("u_stroke",h),c==Qi&&(c=1)),m.addUniform("u_strokeWidth",0^c);const i="m"==a.unit?d:0;"Circle"==t||"Sphere"==t?m.addUniform("u_radius",[a.width,i]):(e==Ki&&(m.pass=bt.ALPHA,m.blend=!0),m.addUniform("u_size",[a.width,i,a.height,i]),m.addUniform("u_rotation",a.rotation*Vi)),_&&(m.pass=bt.ALPHA,m.depth=m.blend=!0),m.addUniform("u_alignMap","map"==a.alignment)}else if("Heatmap"==t){m.addUniform("u_radius",[a.width,0]),m.addUniform("u_weight",1),m.addUniform("u_intensity","number"==typeof a.height?a.height:1),m.addUniform("u_opacity",a.opacity),m.pass=bt.ALPHA|bt.POST_ALPHA,m.flat=!0,m.depth=!1,m.blend=!1;const t=(null===(u=a.fill)||void 0===u?void 0:u.stops)||Hi.stops,e=n.gradients.getTexture(t,Xi.verifyAndFixGradient);m.addUniform("u_gradient",e)}if(a.offsetUnit&&(m.addUniform("u_offset",[a.offsetX,"m"==a.offsetUnit[0]?d:0,a.offsetY,"m"==a.offsetUnit[1]?d:0]),m.addUniform("u_offsetZ",[a.offsetZ,"m"==a.offsetUnit[2]?d:0])),"Model"==t){if(m.addUniform("u_meterToPixel",d),a.modelMode&&m.addUniform("u_groundResolution",1),!m.attributes.a_normal){const t=m.computeNormals();m.addAttribute("a_normal",{data:t,size:3,normalized:!0})}m.bbox=v.bbox,m.id=v.id,m.hitTest=a.modelMode||0,m.destroy=v.destroy||m.destroy,m.depth=!0,m.uniforms.pointSize&&(m.groups[0].mode=Gt.MODE_GL_POINTS),m.uniforms.opacity<1&&(m.pass=bt.ALPHA,m.blend=!0)}}m.clip=v.clip}let{zLayer:b}=i;"top"==p&&(b=1/0,p=0),p=Number(p),m.flat||(m.clip=!1,i.depthTest!=Qi&&(m.depth=i.depthTest,m.pass||(m.pass=bt.ALPHA))),e.addZ(p,!m.flat),m.zIndex=p,m.zLayer="number"==typeof b?Math.ceil(b):null,m.clip==Qi&&(m.clip=!s.clipped||l.getMargin()>0||_)}}}a(g.reverse(),c)},exec:function(t){let e=t[0],i=t[1];const r=t[2];let s=t[5],o=i.length;const a=t[6];let l,h,c,u,f;if(!t[7]){for(f||(f=!1);t[4]--&&(h=i[t[3]++]);)if(l=s.getStyleGroup(h,a),l){c=h.geometry,u=c.type,l.length||(l=[l]),ot(l);const t=h.getProvider().decCoord(h);if("MultiLineString"==u||"MultiPoint"==u){const e="MultiPoint"==u?"Point":"LineString";for(let i of t)n.create(h,e,i,l,r)}else if("MultiPolygon"==u){n.create(h,"Polygon",t,l,r);for(let i=0;i<t.length;i++){let s=t[i];$i(n,h,s,l,r,e,i)}}else n.create(h,u,t,l,r),"Polygon"==u&&$i(n,h,t,l,r,e)}f=t[3]<o}if(!f&&n.pendingCollisions.length){t[7]||(t[7]=n.pendingCollisions.sort(((t,e)=>t.priority-e.priority)),t[3]=0);let e,i=t[7];if(t[4]>=0)for(;t[4]--&&(e=i[t[3]++]);){const{coordinates:t,priority:i,geomType:s}=e;"Point"!=s&&"LineString"!=s||n.create(e.feature,s,t,e.styleGrp,r,!1,i,e)}f=t[3]<i.length}return t[4]=16,f}});return qi.start(f),f})(e,u,l,t,this.factory,(()=>{o.collision.initTile(t,u)}),((t,e)=>{s.removeTask(a,r),s.preview(s.setData(r,t),null),e.length&&e.forEach((t=>{t.then((()=>this.refreshTile(h,c)))}));o.collision.completeTile(!0)&&(this.dirty=!0);let i=s.getOverlayingTiles();for(let t of i)t.preview(u.index,null);n(s,r)}));s.addTask(a,r)}else s.preview(s.setData(r,[]),null),n(s,r)}orderBuffers(t,e,i,r,s,n){for(let o of e){let{zLayer:e,zIndex:a}=o;null==e&&(e=i.index+1);let l=1e8*e+10*a;o.flat||(l+=1),r[l]=0,t[t.length]={b:o,z:l,data:s,tiled:n}}}initLayerBuffers(t){var e;const{buckets:i}=this;let r,s=[],n={};for(let o of t){let t=o.tiles;if(o.cnt=0,r={},o.layer.tiled){if(t){let a=o.index,l=t.length;for(let h of t){let t=h.tile,c=null===(e=t.data)||void 0===e?void 0:e[o.index];if(!o.ready&&t.ready(a)&&++o.cnt==l&&(o.ready=!0),c)c.length&&this.orderBuffers(s,c,o,n,{tile:h},!0);else{let e;if((e=t.preview(a))&&e.length)for(let l of e){const[e]=l,c=Ts(e,t.quadkey);if(r[e]){r[e].push(c);continue}r[e]=[c];let u,f=i.get(e,!0);u=null==f?void 0:f.getData(a),(null==u?void 0:u.length)&&this.orderBuffers(s,u,o,n,{tile:h,preview:l,stencils:r[e]},!0)}}}}}else{o.ready=!0;const t=o.layer,{renderOptions:e}=t;this.orderBuffers(s,[{zLayer:e.zLayer,zIndex:e.zIndex,pass:e.alpha||1,flat:t.flat}],o,n,o.layer,!1)}}let o=0;for(let t of Object.keys(n).sort(((t,e)=>Number(t)-Number(e))))n[t]=o++;let a=1/0;for(let t,e,i=0;i<s.length;i++)e=s[i],t=e.z=n[e.z],!e.b.flat&&t<a&&(a=t);return{tileBuffers:s,min3dZIndex:a,maxZIndex:o}}getCamGroundPositionScreen(){const{cameraWorld:t}=this.render;return this.project(t[0],t[1])}viewport(t){const e=this,{buckets:i,layers:r,render:s}=e;let n;r.length,e.dirty&&(e.dirty=!1,e.collision.update(e.grid.tiles[512],(()=>e.update()))),s.clear(e.bgColor),s.fixedView=Number(!this.viewChange);let{tileBuffers:o,min3dZIndex:a,maxZIndex:l}=this.initLayerBuffers(r);s.zIndexLength=l,s.setPass(bt.OPAQUE);let h=o.length;for(;h--;){let t=o[h];(null==t?void 0:t.tiled)&&s.draw(t,a)}s.setPass(bt.ALPHA),o=o.sort(((t,e)=>10*(t.z-e.z)+t.b.pass-e.b.pass));let c=0;do{let t=!1;for(h=0,n=o.length;h<n;h++){let e=o[h];e.b.pass&bt.POST_ALPHA&&(t=!0),(null==e?void 0:e.z)==c&&(e.tiled?s.draw(e,a):s.drawCustom(e.data,e.z))}s.pass==bt.POST_ALPHA?s.setPass(bt.ALPHA):t&&(s.setPass(bt.POST_ALPHA),c--)}while(++c<l);if(s.tileGrid)for(let t in e.tiles){const i=e.tiles[t];if(i.length){for(let e of i)s.drawGrid(e.x,e.y,e.tile,Number(t));break}}}destroy(){super.destroy(),this.factory.destroy()}getRenderedFeatureAt(t,e,i){const{tiles:r}=this;this.rayCaster.init(t,e,this.w,this.h,this.s,1/this.groundResolution);const s=this.rayCaster.origin[2]-.001;let n;for(n in r){n=Number(n);for(let t of r[n]){const e=t.x,r=t.y,o=t.tile;if(this.rayCaster.intersectAABBox(e,r,0,e+n,r+n,s))for(let t=0,{data:s}=o;t<s.length;t++){const{layer:n}=o.layers[t],a=s[t],l=i.indexOf(n);if(a&&-1!=l)for(let t of a)t.isFlat()||this.rayCaster.intersect(e,r,t,l)}}}const o=this.rayCaster.getIntersectionTop();return this.viewport(!0),o}viewChangeDone(){this.viewChange=!1,this.update()}scaleOffsetXYByAltitude(t){const e=this.render.vPMat;return 1-t[2]*e[11]/(e[3]*t[0]+e[7]*t[1]+e[15])}}Ls.zoomBehavior="float";const Ps=new xs,Es=2*Math.PI,zs=Math.PI/180,Is=Math.log(2048)/Math.log(2),Cs=Is+9,Rs=(t,e,i,r,s,n,o,a,l,h,c,u)=>{const f=o.z;e+=0^H("offsetX",r,s,f),i+=0^H("offsetY",r,s,f);let d,p,g,m,v,y,x=H("rotation",r,s,f),_=e+512<<Is|i+512^0|(x+360)%360<<Cs;c[_]||(c[_]=1,x&&(x*=zs,l.translate(e,i),l.rotate(x),v=e,y=i,e=0,i=0),"Text"==t?(r.stroke&&0!=r.strokeWidth&&l.strokeText(n,e,i),r.fill&&l.fillText(n,e,i)):"Circle"==t?(p=H("radius",r,s,f),l.moveTo(e+p,i),l.arc(e,i,p,0,Es,!1)):(g=H("width",r,s,f),m=H("height",r,s,f)||g,e-=g/2,i-=m/2,"Image"==t?(d=H("src",r,s,f),Ps.isReady(d)?l.drawImage(Ps.get(d),e,i,g,m):Ps.get(d,(()=>u.updateTile(o,a,h)),o.quadkey)):"Rect"==t&&l.rect(e,i,g,m)),x&&(l.rotate(-x),l.translate(-v,-y)))},ks=Math;class Os{constructor(){this.o=.5}init(t){return this.o=t,!0}createSymbol(t,e){let i;return i="Circle"==e.type?e.radius:e.width,t-i>0}drawSymbol(t,e,i,r,s,n,o,a,l,h,c){Rs(s.type,e,i,s,o,!1,n,a,r,l,h,c)}angle(t,e){return Math.atan2(t,e)}place(t,e,i,r,s,n,o,a,l,h){let c,u,f,d,p,g,m,v,y,x;const _=this.o;for(let b=0;b<t.length;b++)f=Math.round(e.lon2x(t[b][0])),d=Math.round(e.lat2y(t[b][1])),b&&(y=f-c,x=d-u,p=ks.sqrt(ks.pow(y,2)+ks.pow(x,2))-16,g=this.createSymbol(p,s),g&&(m=(y*_+c)*h,v=(x*_+u)*h,i.setTransform(h,0,0,h,m,v),i.rotate(this.angle(x,y)),i.translate(-m,-v),this.drawSymbol(g,m,v,i,s,e,r,n,o,a,l),i.setTransform(h,0,0,h,0,0))),c=f,u=d}}const Ds=(t,e,i)=>{let r,s,n,o,a=t.length-1;for(e.moveTo(n=Math.round(i.lon2x(t[a][0])),o=Math.round(i.lat2y(t[a][1])));a--;)r=Math.round(i.lon2x(t[a][0])),s=Math.round(i.lat2y(t[a][1])),(n-r||o-s)&&e.lineTo(n=r,o=s)},Fs="round",Ns=[];let Bs,Us=new class extends Os{constructor(t){super(),super.init(.5),this.setCharWidth(t)}setCharWidth(t){this.cw=t}init(t){return"string"!=typeof t&&(t=String(t)),this.lw=t.length*this.cw,this.label=t,!0}angle(t,e){return Math.atan(t/e)}createSymbol(t){const e=this.label,i=this.cw,r=this.lw;let s,n,o=Math.floor(t/r);return o>0&&(s=e,o>1&&(o=1+Math.floor((o-1)/8),n=new Array(Math.floor(1.5*(t-r)/i/o)).join(" "),s=e+new Array(o).join(n+e))),s}drawSymbol(t,e,i,r,s){s.stroke&&r.strokeText(t,e,i),s.fill&&r.fillText(t,e,i)}}(_({font:m}).width),Ws=new Os;var Gs=(t,e,i)=>{t.globalAlpha=e.opacity==Bs?1:e.opacity;const r=e.font,s=e.stroke;let n,o;if(s&&(t.strokeStyle=s,n=e.strokeWidth,r&&(i=1),n&&"number"==typeof n||(n=1),t.lineWidth=n*i),e.fill&&(t.fillStyle=e.fill),r){let i=e.font||m;Us.setCharWidth(_(e).width),t.font=i,t.textAlign=e.textAlign||"center",t.textBaseline=e.textBaseline||"middle"}else t.lineCap=e.strokeLinecap||Fs,t.lineJoin=e.strokeLinejoin||Fs,o=e.strokeDasharray,o instanceof Array?t.setLineDash(o):t.setLineDash(Ns),(e.fill||e.stroke)&&t.beginPath();return!0},Zs=(t,e,i,r,s,n,o,a,l,h)=>{let c=i.getProvider().decCoord(i),u=i.geometry.type;const f=t.z;let d=H("type",s,i,f);if("LineString"==u){if("Circle"==d||"Rect"==d||"Image"==d){const r=H("offset",s,i,f);if(r!=Bs)return Ws.init(r),void Ws.place(c,t,e,i,s,n,o,a,l,h);u="MultiPoint"}}else if(("Polygon"==u||"MultiPolygon"==u)&&"Polygon"!=d&&"Line"!=d){const h=i.bbox;return Rs(d,Math.round(t.lon2x(h[0]+(h[2]-h[0])/2)),Math.round(t.lat2y(h[1]+(h[3]-h[1])/2)),s,i,r,t,n,e,o,a,l)}if("Point"==u)Rs(d,Math.round(t.lon2x(c[0])),Math.round(t.lat2y(c[1])),s,i,r,t,n,e,o,a,l);else if("Text"==d){if(!Us.init(r))return;if("MultiLineString"==u)for(var p=0;p<c.length;p++)Us.place(c[p],t,e,i,s,n,o,a,l,h);else"LineString"==u&&Us.place(c,t,e,i,s,n,o,a,l,h)}else if("LineString"==u)Ds(c,e,t);else if("Polygon"==u||"MultiLineString"==u)for(var g=0;g<c.length;g++)Ds(c[g],e,t);else if("MultiPolygon"==u)for(p=0;p<c.length;p++)for(g=0;g<c[p].length;g++)Ds(c[p][g],e,t);else if("MultiPoint"==u){let h=c.length;for(;h--;)Rs(d,Math.round(t.lon2x(c[h][0])),Math.round(t.lat2y(c[h][1])),s,i,r,t,n,e,o,a,l)}};let Ys;class Hs{constructor(t,e,i){this.tm=t,this.exclusiveTimeMS=i,this.dpr=e}spawn(t,e,i,r,s,n,o,a,l){let h=this.createTask(t,e,i,r,s,i.bounds,n,o,a,l);return this.tm.start(h),h}createTask(t,e,i,r,s,n,o,a,l,h){const c=this.dpr;let u=s.index(r),f=s.getContext(u),d=this.tm.create({priority:t,delay:h,time:this.exclusiveTimeMS,init:function(){if(!l){f.setTransform(c,0,0,c,0,0);let t=r.getStyle().backgroundColor;t?(f.fillStyle=t,f.globalAlpha=1,f.fillRect(0,0,256,256)):f.clearRect(0,0,256,256)}return{tile:i,ctx:f,data:o,lI:0,gI:0,fI:0,style:Ys,dTile:s,layer:r,bI:100}},onDone:function(){s.dirty(u),a(f,this)},exec:function(t){let i,r=t.tile,s=t.data,n=s.length;if(n){for(;!(i=s[t.lI])&&t.lI<n;)++t.lI;if(i){let n=i[t.gI];if(n){let i=t.ctx,o=n.shared,a=o.font!=Ys;for(t.style!=o&&(t.style=o,Gs(i,o,s.swzs),t.pmap={});t.bI--;){let s=t.fI++;const l=n.data;let h=l.features[s];if(!h){a?i.setTransform(c,0,0,c,0,0):(o.fill&&i.fill(),o.stroke&&(o.strokeWidth||o.strokeWidth==Ys)&&i.stroke()),t.fI=0,t.gI++;break}{let n,o=l.styles[s];if(a&&(n=Y(o,h,r.z),!n))continue;Zs(r,i,h,n,o,t.dTile,t.layer,t.pmap,e,c)}}}else t.fI=0,t.gI=0,t.lI++;return t.bI=100,this.CONTINUE}}}});return d}}const Xs=256;class js{constructor(t,i){this.dpr=1,this.debug=!1,this.rz=0,this.sx=0,this.sy=0,this.s=1;let r=e.TaskManager.getInstance(),s=this;s.ts=t,s.dpr=i,s.painter=new Hs(r,i,4)}drawGrid(t,e,i){let r=i+"  L"+i.length;const s=this.ctx;s.strokeRect(t,e,Xs,Xs),s.strokeText(r,t+8,e+16),s.fillText(r,t+8,e+16)}applyTransform(){const t=this,e=t.s,i=t.rz;if(t._s!=e||t._rz!=i){t._s=e,t._rz=i;const r=t.ctx,s=t.canvas,n=s.width,o=s.height,a=n/2-t.sx,l=o/2-t.sy,h=t.dpr;r.setTransform(1,0,0,1,n/2,o/2),r.rotate(i),r.translate(-n/2+a,-o/2+l),r.scale(e,e),r.translate(-a,-l),r.scale(h,h)}}init(t){let e=t.getContext("2d",{alpha:!1});e.font="bold 14px Arial",e.lineWidth=3,e.strokeStyle="red",e.fillStyle="white",e.textAlign="start",e.textBaseline="alphabetic",this.ctx=e,this.canvas=t}setBuckets(t){this.buckets=t}clear(){}convertColor(t){return t}setBackgroundColor(t){this.buckets.bgColor(t)}grid(t){this.debug=t}setScale(t,e,i){let r=this;r.s=t,r.sx=e,r.sy=i}setRotation(t,e){this.rz=t}prepare(t,e,i,r,s,n){return this.painter.spawn(3,r,e,i,s,t,n)}tile(t,e,i){const r=this;e=Math.round(e),i=Math.round(i),r.ctx.drawImage(t.combine(),e,i,Xs,Xs),r.debug&&r.drawGrid(e,i,t.quadkey)}preview(t,e,i,r){let s=t.getContext(r);s.clearRect(0,0,t.size,t.size);for(let i=0,n=e.length;i<n;i++){let n,o=e[i],a=this.buckets.get(o[0],!0);a&&(n=a.getData(r))&&(s.setTransform(1,0,0,1,0,0),s.drawImage(n,o[1],o[2],o[3],o[4],0+o[5],0+o[6],o[7],o[8]),t.dirty(r))}}destroy(){}getContext(){return this.ctx}}let qs;class Vs extends Oi{constructor(t,e,i,r,s){super(t);let n=i.length;this.c=new Array(n),this.init(e,i),this.size=r,this.ctx=t.claimCtx(r),this.canvas=this.ctx.canvas,this.ctx.fillStyle=s}destroy(t){if(t!=qs)(e=this.c[t])&&(e.canvas&&this.pool.releaseCtx(e),this.c[t]=qs);else{let t=this.c.length;for(var e;t--;)(e=this.c[t])&&e.canvas&&(this.pool.releaseCtx(e),this.c[t]=qs)}}init(t,e){super.init(t,e);let i=e.length;for(this.c.length=i;i--;)this.c[i]=qs;this._c=!1,this._ready=!1}dirty(t,e){let i=this.c[t],r=e!=i;e&&i&&r&&this.destroy(t),e||(r=!0,e=this.c[t]),r&&(this.c[t]=e,this._c=!1)}clear(t){let e;(e=this.c[t])&&(e.setTransform&&this.pool.releaseCtx(e),this.c[t]=qs,this.preview(t,qs),this.ready(t,!1),this._c=!1,this.combine())}getContext(t){return this.c[t]||(this.c[t]=this.pool.claimCtx(this.size)),this.c[t]}getData(t){return this.c[t]&&(this.c[t].canvas||this.c[t])}combine(){let t,e=this,i=e.size;if(!e._c){e._c=!0,e.ctx.fillRect(0,0,i,i);for(let r=0;r<e.c.length;r++)(t=this.getData(r))&&e.ctx.drawImage(t,0,0,i,i)}return e.canvas}addLayer(t){super.addLayer(t);let e=this;e.c.splice(t,0,qs),e._c=!1,e._ready=!1}removeLayer(t){super.removeLayer(t);this.destroy(t),this.c.splice(t,1),this._c=!1}}let Ks=[];const Qs={length:0,max:128,clear:function(){this.length=0},create:function(t){let e=document.createElement("canvas");return e.width=e.height=t,this.length++,e.getContext("2d")},get:function(t){return Ks.length?(this.length++,Ks.shift()):this.create(t)},release:function(t){t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.lineWidth=1,t.globalAlpha=1,Ks.push(t),this.length--}};class $s extends Fi{constructor(t,e){super(t||256),this.ctxCache=Qs,this._bgc=null,this.tSize=e}bgColor(t){this._bgc=t,this.forEach((e=>{e.ctx.fillStyle=t}))}clear(){this.tiles.clear(),Qs.clear()}setSize(t){this.tiles.setSize(t)}releaseCtx(t){return Qs.release(t)}claimCtx(t){if(Qs.length<Qs.max)return Qs.get(t);{let e=this.tiles.tail.data;return e.destroy(),Qs.release(e.ctx),e.ctx=null,e.canvas=null,this.tiles.remove(e.quadkey),e.cancelTasks(),this.claimCtx(t)}}create(t,e){let i=this.tiles.get(t);return i||(this.tiles.length>=this.tiles.max?(i=this.tiles.tail.data,i.destroy(),i.init(t,e),i.size=this.tSize):i=new Vs(this,t,e,this.tSize,this._bgc),this.tiles.set(t,i)),i}}let Js={1:[512,3,512],2:[128,2,128],3:[64,1,128]};let tn;const en=(t,e,i,r,s)=>{const n=Math.sin(s),o=Math.cos(s),a=t-i,l=e-r;return[o*a-n*l+i,n*a+o*l+r]};class rn{constructor(){this.features=[],this.styles=[]}add(t,e){this.features.push(t),this.styles.push(e)}}class sn extends mt{constructor(t,e,i,r){e=e||256,i=0^mt.getPixelRatio(i);const s=Js[i][1],n=new js(e*i,i),o=Js[i][0],a=new $s(o,e*i);n.setBuckets(a),super(t,e,i,a,n,s),n.init(this.canvas)}preview(t,e,i){const r=super.preview(t,e,i);return r&&this.render.preview(t,r,e,i),r}prepareTile(t,e,i,r,s){let n=this,o=n.render;if("image"==t.type){const t=r.index(i);r.dirty(t,e),s(r,i)}else if(e.length)r.addTask(n.cluster.spawn(4,i,t,e,{},rn,((e,a)=>{r.removeTask(a,i),null==r&&(r=tn),r.addTask(o.prepare(e,t,i,n,r,((t,e)=>{r.removeTask(e,i),s(r,i)})),i)})),i);else{const t=r.index(i);r.destroy(t),r.dirty(t),s(r,i)}}viewport(t){const e=this,i=e.tiles,r=e.render,s=e.layers,n=s.length;let o,a;this.buckets,(this.dirty||t)&&(this.render.clear(),this.dirty=!1);for(let e in i){if("512"==e)continue;const c=i[e],u=c.length;for(let e of c)if(o=e.tile,a=o.luTs,e.lrTs!=a||t){e.lrTs=a,r.tile(o,e.x,e.y);for(var l,h=0;h<n;h++)!(l=s[h]).ready&&o.ready(h)&&++l.cnt==u&&(l.ready=!0)}}}addLayer(t,e,i){t.tileSize=256;const r=super.addLayer(t,e,i);return r&&this.setupTilePool(),r}removeLayer(t){const e=super.removeLayer(t);return-1!==e&&this.setupTilePool(),e}setSize(t,e){const i=this;super.setSize(t,e),i.setupTilePool(),i.render._s=tn,i.setTransform(i.s,i.rz,i.rx)}destroy(){super.destroy(),this.buckets.clear()}setupTilePool(){let t=this;const e=(Math.ceil(t.w/256)+1)*(Math.ceil(t.h/256)+1);let i=e;const r=Js[t.dpr];let s=e*t.getLayers().length;i<r[0]&&(i=r[0]),t.buckets.setSize(i),s<r[2]&&(s=r[2]),t.buckets.ctxCache.max=s}update(t){super.update()}project(t,e){const i=this,r=i.s;return en(t*=r,e*=r,i.w/2,i.h/2,i.rz)}unproject(t,e){let i=this,r=i.s;const s=i.w/2,n=i.h/2;let o=en(t,e,s,n,-i.rz);return o[0]=(o[0]-s)/r+s,o[1]=(o[1]-n)/r+n,o}}sn.zoomBehavior="fixed";const nn=0===navigator.platform.indexOf("Win")?.0025:.0015;class on{constructor(t,e,i,r){this.passive=!1;try{let t=Object.defineProperty({},"passive",{get:()=>{this.passive=!0}});window.addEventListener("testPassive",null,t),window.removeEventListener("testPassive",null,t)}catch(t){}this.el=t,this.settings=i,this.map=e,this.ams=0^r,this.onSpin=this.onSpin.bind(this)}onSpin(t){const{settings:i,el:r,map:s}=this,n=i.zoom;if(n){let i=-(t=t||e.global.event).deltaY;if(t.deltaMode===t.DOM_DELTA_LINE&&(i*=32.001953125),i){const e=s.getZoomlevel();let o,a;"fixed"==n?t.shiftKey?o=e+(i>0?.1:-.1):(o=Math.round(e+(i<0?-1:1)),a=!0):o=e+i*nn;let l=r.getBoundingClientRect();this.zoom(o,t.pageX-l.left,t.pageY-l.top,a)}}t.preventDefault&&t.preventDefault(),t.returnValue=!1}enable(){r(this.el,["wheel","DOMMouseScroll"],this.onSpin)}disable(){s(this.el,["wheel","DOMMouseScroll"],this.onSpin)}zoom(t,e,i,r){const{map:s,ams:n}=this;s.setZoomlevel(t,e,i,r&&n)}}const an=t=>t,ln=t=>Math.sin(Math.PI*t*.5);var hn=Object.freeze({__proto__:null,linear:an,easeOut:t=>1-Math.pow(1-t,1.5),easeOutSine:ln,easeOutCubic:t=>1-(t=1-t)*t*t});class cn{constructor(t,e,i,r,s){this.ts=0,this.af=null,this.from="number"==typeof t?[t]:t,this.to="number"==typeof e?[e]:e,this.duration=i,"function"==typeof r&&(s=r,r="linear"),this.easing=hn[r]||an,this.animator=s,this.animate=this.animate.bind(this)}animate(){const{duration:t}=this,e=Math.min(Date.now()-this.ts,t);let i=this.from.map(((i,r)=>{const s=this.to[r];return i+this.easing(e/t)*(s-i)}));this.animator(1==i.length?i[0]:i),e<t?this.af=requestAnimationFrame(this.animate):(this.af=null,this.done())}async start(){return new Promise((t=>{this.done=t,this.ts?t():(this.ts=Date.now(),this.animate())}))}stop(){null!=this.af&&(cancelAnimationFrame(this.af),this.af=null)}}const un=(t,e)=>{let i,r,s=t.targetTouches;if(s){let t,n=s.length,o=s[n-1];if(n){let a=e.getBoundingClientRect(),l=o.pageX-a.left,h=o.pageY-a.top;n>1?(t=s[n-2],i=(l+t.pageX-a.left)/2,r=(h+t.pageY-a.top)/2):(i=l,r=h)}}else i=t.clientX,r=t.clientY;return[0^i,0^r]},fn=t=>{const e=t.targetTouches,i=e.length,r=e[i-2];if(r){const t=e[i-1],s=r.clientX-t.clientX,n=r.clientY-t.clientY;return 180*Math.atan2(n,s)/Math.PI}};class dn{constructor(t,i,n,o,a){this.scrollHandler=new on(t,i,o,a.zoomAnimationMs);let l,h,c,u,f,d,p,g=this,m=null,v=Date.now();const y=[],x=[],_=(t,e,i)=>{const r=a[t];return Math.abs(e-l)>r||Math.abs(i-h)>r},b=()=>{p=0,y.length=0,x.length=0};function w(t){let e=1;if(null!=t.scale)return t.scale;let i=t.targetTouches,r=i.length,s=i[r-1],n=i[r-2];if(n){let t=z(s.clientX,s.clientY,n.clientX,n.clientY);null==m&&(m=t),e=t/m}return e}function M(t,e){if(!f){if(!_("minPanMapThreshold",t,e))return!0;n.cancel()}if(d=Date.now(),o.drag&&!i.lockViewport().pan){let r=t-c,s=e-u;p<8?(y[p]=r,x[p]=s,p++):p=0,i.pan(r,s),f=!0}c=t,u=e}function A(t){if(f){let t=Date.now();t-d<25&&n.pan(t,3*y.reduce(((t,e)=>t+e),0),3*x.reduce(((t,e)=>t+e),0))}}let S,T,L,P,E,I,C,R,k,O=null;function D(e){b();let r=e.targetTouches,s=r.length,n=un(e,t);if(c=n[0],u=n[1],l=c,h=u,w(e),f=!1,2==s){k=0;let t=r[s-1],n=r[s-2];E=t.clientX,I=t.clientY,C=n.clientX,R=n.clientY,m=z(E,I,C,R),P=i.getZoomlevel(),S=i.rotate(),T=i.pitch(),L=fn(e)}}function F(e){let r=e.targetTouches,s=r.length,n=un(e,t),a=w(e);if(s>1){if(o.pitch){if(++k<5)return void e.preventDefault();const t=r[s-1],n=r[s-2],o=I-t.clientY,a=R-n.clientY;if(O||0!=O&&Math.abs(n.clientY-t.clientY)<110&&Math.sign(o)==Math.sign(a))return O=!0,i.pitch(T+.2*o),void e.preventDefault();O=!1}o.zoom&&g.scrollHandler.zoom(P+Math.log2(a),n[0],n[1],!1),o.rotate&&i.rotate(S+fn(e)-L)}M(n[0],n[1]),c=n[0],u=n[1],e.preventDefault()}function N(e){let i=un(e,t),r=e.targetTouches.length;O=null,i&&(c=i[0],u=i[1],l=c,h=u),r<2&&(m=null);let s=Date.now(),n=s-v;r&&(v=s),w(e),0==r&&1==e.changedTouches.length&&n>350&&A()}let B=null;function U(e){B=e.button,b(),f=!1,r(t,"mousemove",W),S=i.rotate(),T=i.pitch(),c=e.clientX,u=e.clientY,l=c,h=u}function W(t){var e;null===(e=g.resetAnimation)||void 0===e||e.stop();const r=t.clientX,s=t.clientY;0==B?M(r,s):2==B&&(o.rotate&&_("minRotateMapThreshold",r,s)&&i.rotate(S+.25*(c-r)),o.pitch&&_("minPanMapThreshold",r,s)&&i.pitch(T+.1*(u-s)))}function G(e){if(B=null,s(t,"mousemove",W),f)A();else if(o.rotate){const t=i.rotate();S!=t&&Math.abs(t)<=5&&(g.resetAnimation=new cn(t,0,500,"easeOutSine",(t=>i.rotate(t))),g.resetAnimation.start())}}g.scroll=t=>{let{scrollHandler:e}=this;t?e.enable():e.disable()},g.drag=i=>{const n=i?r:s;setTimeout((()=>{n(t,"touchstart",D),n(e.global,"touchend",N),n(t,"touchmove",F),n(t,"mousedown",U),n(e.global,"mouseup",G)}),0)},g.getOptions=()=>o}}class pn{constructor(t,e,i,r,s){this.type=t,this.timeStamp=Date.now(),null!=e&&(this.data=this.detail=e),i&&(this.mapX=r,this.mapY=s,this.nativeEvent=i,this.button=i.button)}stopPropagation(){const t=this.nativeEvent;if("mousemove"==t.type||"touchmove"==t.type)return t.stopImmediatePropagation(),t.preventDefault()}toString(){return"MapEvent "+this.type}}const gn="pointerup",mn="pointerenter",vn="pointerleave",yn="pointerdown",xn="pointermove",_n="pressmove",bn="dbltap",wn=[gn,mn,vn,yn,xn,_n,"tap",bn];function Mn(t){return-1!==wn.indexOf(t)}function An(t,e){let i=e.type;"touchstart"!=i&&"touchmove"!=i&&"touchend"!=i||(e=e.changedTouches[e.changedTouches.length-1]);let r=t.getBoundingClientRect();return[e.pageX-r.left,e.pageY-r.top]}class Sn{constructor(t,i,r,s){this.disabled={},this.hActive=!1,this.cnt=0,this.el=t,this.cbs=new e.Listener(["click"]);const{disabled:n}=this;let o,a,l,h,c,u,f=!1,d=!1,p=0,g=!1,m=this.cbs;m.sync(!0),wn.forEach((t=>{m.addEvent(t),n[t]=!1}));let v=e.TaskManager.getInstance().create({delay:40,priority:5,exec:function(){!function(e){let i=An(t,e),r=_(i);x(xn,e,i,r),r?c?c.feature.id!==r.feature.id&&(x(vn,e,i,c),x(mn,e,i,r)):x(mn,e,i,r):c&&x(vn,e,i,c);c=r}(u),g=!1}});function y(t,e,r,s,n){let o=new pn(t,n,e,r,s);return n&&(o.target=n.feature,o.detail.display=i),o}function x(t,e,i,r){m.trigger(t,[y(t,e,i[0],i[1],r)],!1)}function _(t){return i.getFeatureAt({x:t[0],y:t[1]},{layers:i._layers.filter((t=>t.pointerEvents()))})}let b=!1;this.onPointerDown=function(e){const r="touchstart"==e.type;r||!b?(l=i.getCenter(),d=!0,f=!1,o=An(t,e),a=_(o),x(yn,e,o,a),r&&e.target.parentNode==t&&(b=!0)):b=!1},this.onPointerMove=function(e){const i="mousemove"==e.type;if(i&&b)return;let r,l,h;if(d){let i=s.minPanMapThreshold;if(!f&&(r=An(t,e),l=r[0]-o[0],h=r[1]-o[1],Math.abs(l)<i&&Math.abs(h)<i))return}f=!0,d?a&&m.isListened(_n)&&(r=An(t,e),l=r[0]-o[0],h=r[1]-o[1],m.trigger(_n,[y(_n,e,r[0],r[1],a),l,h],!1)):i&&(m.isListened(mn)||m.isListened(vn)||m.isListened(xn))&&(u=e,n.pointerenter||n.pointerleave||g||(g=!0,v.start()))},this.onPointerUp=function(e){if(d){let r=i.getCenter();if(!(l.longitude!=r.longitude||l.latitude!=r.latitude)&&e.target.parentNode==t&&(a||!f)){let i=An(t,e);x("tap",e,i,a),x(gn,e,i,a),function(t){let e=Date.now(),i=a&&a.feature;e-p<250&&!f&&h==i&&x(bn,t,o,a),h=i,p=e}(e)}d=f=!1}}}getGlobalHandlers(){const{onPointerDown:t,onPointerMove:e,onPointerUp:i}=this;return{touchstart:t,touchmove:e,touchend:i,mousedown:t,mouseup:i,mousemove:e}}enable(t){Mn(t)&&delete this.disabled[t]}disable(t){Mn(t)&&(this.disabled[t]=!0)}destroy(){let t=this.getGlobalHandlers();if(this.hActive){for(let e in t)s(this.el,e,t[e]);this.hActive=!1}}addEventListener(t,e,i){if(Mn(t)&&this.cbs.add(t,e,i)){this.cnt++;let t,e=this.getGlobalHandlers();if(!this.hActive)for(let i in e){t=e[i];let{el:s}=this;if("mouseup"==i)for(;s.parentNode;)s=s.parentNode;r(s,i,t),this.hActive=!0}}}removeEventListener(t,e,i){const{cbs:r,el:n}=this;if(Mn(t)&&r.remove(t,e,i)&&!--this.cnt&&this.hActive){let t=this.getGlobalHandlers();for(let e in t)r.isListened(e)||s(n,e,t[e]);this.hActive=!1}}}const Tn=(t,e,i)=>{let r=!1;for(let s=0,n=i.length-1;s<i.length;n=s++){const o=i[s][0],a=i[s][1],l=i[n][0],h=i[n][1];a>e!=h>e&&t<(l-o)*(e-a)/(h-a)+o&&(r=!r)}return r};class Ln{constructor(t,e){this.map=t,this.dpr=e}pointToLineDistanceSq(t,e,i,r,s,n){const o=s-i,a=n-r,l=o*o+a*a;let h,c,u,f,d=-1;if(0!=l){h=t-i,c=e-r;d=(h*o+c*a)/l}d<0?(u=i,f=r):d>1?(u=s,f=n):(u=i+d*o,f=r+d*a);const p=t-u,g=e-f;return this.sideOfLine=o*c-h*a<0?-1:1,p*p+g*g}pointInPolygon(t,e,i){for(let r=0;r<i.length;r++)if(Tn(t,e,i[r])!=!r)return!1;return!0}pointInBox(t,e,i,r,s){for(let[n,o]of t){if(n>=e&&n<=i&&o>=r&&o<=s)return!0}}linesIntersectBox(t,e,i,r,s){const n=[[e,s],[i,s],[i,r],[e,r],[e,s]];for(let e=0,i=t.length-1;e<i;e++)for(let i=0;i<n.length-1;i++)if(I(t[e],t[e+1],n[i],n[i+1],!1))return!0}getOffsetLineData(t,e,i){let r=[];for(let s of e){const e=H("offset",s,t,i)||0;e&&r.find((t=>t.offset==e))||r.push({offset:e,width:.5*j("strokeWidth",s,t,i,!0)})}return r.length,r}geometry(t,e,i,r,s,n,o,a,l,h){let c=!1;const{dpr:u,map:f}=this,d=!t&&!e;let p=this.screenX,g=this.screenY,m=1;if("Point"==r){if(l=l||$(s,o,a,u,n,h)){let r=i[0],n=i[1];const h=H("alignment",s[0],o,a);if(h&&"viewport"!=h)[r,n]=f._g2w(r,n),p=this.worldX,g=this.worldY,m=1/f._s;else{const t=f.geoToPixel(r,n);r=t.x,n=t.y}const u=r+l[0]*m,d=n+l[1]*m,M=r+l[2]*m,A=n+l[3]*m;v=p+t,y=g,x=g+e,_=u,b=d,w=A,c=p<=M&&_<=v&&y<=w&&b<=x}}else if("LineString"==r){l=l||K(s,o,a,n,h);let t=i.length,[e]=l;if(e)if(d){let e,r,n,h=f.geoToPixel(i[0][0],i[0][1]),u=this.getOffsetLineData(o,s,a);u.length||(e=Math.pow(.5*l[0],2));for(let s=1;s<t;s++){if(r=f.geoToPixel(i[s][0],i[s][1]),n=this.pointToLineDistanceSq(p,g,h.x,h.y,r.x,r.y),u.length){for(let t of u){const{offset:e,width:i}=t,r=Math.pow(e-this.sideOfLine*i,2);if(e){if(n>r){if(c=n-Math.pow(e+this.sideOfLine*i,2)<=i*i)break}}else if(c=n<=i*i)break}if(c)break}else if(c=n<=e)break;h=r}}else{const t=.5*l[0],e=f.pixelToGeo(p-t,g-t),r=f.pixelToGeo(p+t,g+t),s=e.longitude,n=r.longitude,o=r.latitude,a=e.latitude;if(c=this.pointInBox(i,s,n,o,a)||this.linesIntersectBox(i,s,n,o,a),!c)return!1}}else if("Polygon"==r){let r=!1;if(!s.find((t=>{const e=H("type",t,o,a);return r=r||"Line"==e,"Polygon"==e})))return r&&this.geometry(t,e,i,"MultiLineString",s,n,o,a,null,h);if(d){const{longitude:t,latitude:e}=f.pixelToGeo(p,g);if(c=this.pointInPolygon(t,e,i),!c)return!1}else{const e=f.pixelToGeo(p-t,g-t),r=f.pixelToGeo(p+t,g+t),s=e.longitude,n=r.longitude,o=r.latitude,a=e.latitude;for(let t=0;t<i.length&&(c=this.pointInBox(i[t],s,n,o,a),!c);t++);if(!c){const{longitude:t,latitude:e}=f.pixelToGeo(p,g);if(c=this.pointInPolygon(t,e,i)||this.linesIntersectBox(i[0],s,n,o,a),!c)return!1}}l=l||[V(s,o,a,n)]}else{let f,d;if("MultiPolygon"==r?(f="Polygon",l=l||[V(s,o,a,n)]):"MultiPoint"==r?(f="Point",l=l||$(s,o,a,u,n)):"MultiLineString"==r&&(f="LineString",l=l||K(s,o,a,n)),f)for(let r=0,u=i.length;r<u;r++)if(d=this.geometry(t,e,i[r],f,s,n,o,a,l,h),d){c=!0;break}}var v,y,x,_,b,w;return c&&l}init(t,e){this.screenX=t,this.screenY=e,[this.worldX,this.worldY]=this.map._unprj(t,e)}feature(t,e,i,r,s,n,o){return this.geometry(t,e,i.geometry.coordinates,i.geometry.type,r,s,i,n,null,o)}}const Pn=Array.from({length:33},((t,e)=>32*Math.pow(2,Math.max(0,e-20+3)))),En=t=>"number"==typeof t;class zn{constructor(t,e){this.map=t,this.hit=new Ln(t,e)}getFeaturesInRect(t,e,i,r,s,n){var o;const{map:a,hit:l}=this,h=a.getZoomlevel(),c=Pn[Math.ceil(h)],u=0^Math.min(20,h),f={},d=(i-t)/2,p=(r-e)/2;let g=t+d,m=e+p,v=180,y=-180,x=180,_=-180;[t,e]=a._unprj(t,e),[i,r]=a._unprj(i,r);let b,w,M,A,S,T,L,P,E=[a._w2g(t-c,e-c),a._w2g(i+c,e-c),a._w2g(i+c,r+c),a._w2g(t-c,r+c)],z=4,I=[];for(;z--;){let t=E[z][0],e=E[z][1];t<v&&(v=t),t>y&&(y=t),e<x&&(x=e),e>_&&(_=e)}b=[v,x,y,_],s&&!Array.isArray(s)&&(s=[]),l.init(g,m);let C=s.length;for(;C--;)if(M=s[C],w=null===(o=M.getProvider)||void 0===o?void 0:o.call(M,h),h<=M.max&&h>=M.min&&(null==w?void 0:w.search))for(S=w.search(b),T=S.length;T--;)if(A=S[T],(L=M.getStyleGroup(A,u))&&(P=l.feature(d,p,A,L,C,h,n))){let t=P[P.length-1],e=f[t]=f[t]||[];(e[C]=e[C]||[]).push(A)}const R={layer:null,features:null};for(let t of Object.keys(f).sort(((t,e)=>Number(t)-Number(e)))){let e=f[t];for(let t,i=0;i<e.length;i++)if(t=e[i]){const e=s[i];R.layer==e?R.features=R.features.concat(t):I.push({layer:e,features:t})}}return I}search(t,e,i,r,s,n){const{map:o}=this,a=o._layers;if(s=s?s.slice().sort(((t,e)=>Number(a.indexOf(t)>a.indexOf(e)))):a,En(t)&&En(e)&&En(i)&&En(r))return this.getFeaturesInRect(t,e,i,r,s,n)}}const In=e.global.setTimeout,Cn=e.global.setInterval,Rn="mapviewchange";let kn=100;const On=(t,e,i)=>{let r;return"function"==typeof Event?r=new Event(t):(r=document.createEvent("Event"),r.initEvent(t,!0,!0)),r.detail=r.data={map:e,layer:i},r};class Dn{constructor(t,i,r){this.watchTimer=null,this.map=t,this.trigger=i,this.renderInfo=r,kn=e.global.__XYZTST_MVCEDelayMs||kn,this.changeWatcher=this.changeWatcher.bind(this),this.readyWatcher=this.readyWatcher.bind(this)}centerChanged(t){return this.center.longitude!=t.longitude||this.center.latitude!=t.latitude}vpChanged(t,e,i){const{viewport:r,rz:s,rx:n}=this;return!(r.minLon!=t.minLon||r.maxLon!=t.maxLon||r.minLat!=t.minLat||r.maxLat!=t.maxLat||s!=e||n!=i)}changeWatcher(){const{map:t,readyTimer:e,watchTimer:i,viewport:r,center:s}=this;let n=t.getViewBounds(),o=t.getCenter(),a=t.rotate(),l=t.pitch(),h=Rn,c={changed:{center:!0}};if(r){if(c.changed.center=this.centerChanged(o),this.vpChanged(n,a,l))return clearInterval(i),this.watchTimer=this.viewport=this.rz=this.rx=null,e&&clearTimeout(e),this.readyTimer=In(this.readyWatcher,kn);this.viewport=n,this.rz=a,this.rx=l,this.center=o}else this.triggeredLayers={},h="mapviewchangestart",this.viewport=n,this.rz=a,this.center=o,this.endTriggered=!0;this.trigger(h,c,true)}readyWatcher(){const{map:t,triggeredLayers:e}=this;let i,r,s,n=this.renderInfo.getLayers(),o=!0;if(this.endTriggered){this.endTriggered=!1;const e=t.getCenter();this.trigger("mapviewchangeend",{changed:{center:this.centerChanged(e)}},true)}for(let a=0;a<n.length;a++)if(r=n[a],i=r.layer,s=i.id,r.ready){if(!e[s]&&(e[s]=!0,!r.error)){let e=On("viewportReady",t,i);i._l.trigger("viewportReady",e,!0)}}else o=!1;o||(this.readyTimer=In(this.readyWatcher,kn))}watch(t){const{readyTimer:e,watchTimer:i}=this;e&&(clearTimeout(e),this.readyTimer=null),t?i||(this.watchTimer=Cn(this.changeWatcher,33.333333333333336)):i&&(clearInterval(i),this.watchTimer=null)}}let Fn;class Nn{constructor(t,e,i,r){this._v=!0;let s=this;s.map=i,s.cPrefix=t.className+"-ui-",s.parent=t,s.opt=e,e.visible&&(s.create(t,e),s.enable())}show(){const t=this;t.html||t.create(t.parent,t.opt),t.html.style.display="inline"}hide(){const t=this.html;t&&(t.style.display="none")}enable(){this.active=!0,this.toggleListeners(!0)}disable(){this.active=!1,this.toggleListeners(!1)}destroy(){const t=this;t.disable(),t.parent.removeChild(t.html)}toggleListeners(t){const e=this,{listeners:i}=e;for(let r in i){const s=e.querySelectorAll(r);for(let n in i[r])s.forEach((s=>{const o=i[r][n];t?s.addEventListener(n,i[r][n]._=o.bind(e)):s.removeEventListener(n,o._)}))}}insertRule(t,e){Fn=Fn||function(){let t=document.createElement("style");return document.head.appendChild(t),t}();let i=Fn.sheet;i.insertRule?i.insertRule(t+" {"+e+"}",i.cssRules.length):i.addRule&&i.addRule(t,e)}create(t,e){let i=this.templ.replace(/class\=\"/g,'class="'+this.cPrefix);i=i.replace(/\>[\s]+\</g,"><");let r=(s=i,(new DOMParser).parseFromString(s,"text/html").body.childNodes[0]);var s;let n=r.style,o=e.position,a="."+t.className+" ";for(let t in o)n[t]=o[t];if(this.style)for(let t in this.style)this.insertRule(a+this.prefixClass(t),this.style[t]);this.html=t.appendChild(r)}prefixClass(t){return t=t.replace(/\./g,"."+this.cPrefix)}querySelector(t){return this.html.querySelector(this.prefixClass(t))}querySelectorAll(t){return this.html.querySelectorAll(this.prefixClass(t))}}class Bn extends Nn{constructor(t,e,i,r){super(t,e,i),this.maxPitch=r.maxPitch}enable(){super.enable();const t=this.querySelector(".needle"),e=this.map;e.addEventListener("mapviewchange",this._rl=i=>{t.style.transform=`rotate(${e.rotate()}deg) rotateX(${Math.min(60,e.pitch())}deg) scale(0.7,1.1)`}),this._rl()}disable(){super.disable(),this.map.removeEventListener("mapviewchange",this._rl),this.a&&(this.a.stop(),this.a=null)}}Bn.prototype.listeners={".btn":{click:async function(t){if(!this.aip){const{map:t}=this,e=t.rotate(),i=t.pitch();let r=[0,0];e||i||(r=[0,this.maxPitch]),this.a=new cn([e,i],r,500,"easeOutCubic",(e=>{t.rotate(e[0]),t.pitch(e[1])})),await this.a.start(),this.a=null}}}},Bn.prototype.style={".compass":"        position: absolute;        right:  10px;        bottom: 96px;        text-align: center;        font-family: sans-serif;        color: white;        height: 28px;        background-color: #0f1621;        user-select: none;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;        overflow: hidden;",".compass .needle":"        padding: 4px 0px;        line-height: 10px;",".compass .btn":"        width: 100%;        height: 100%;",".compass:hover":"        background-color: #383c45;        cursor: pointer;"},Bn.prototype.templ='<div class="compass">        <div class="btn">            <div class="needle">&#9650;<br>&#9661;</div>        </div>    </div>';class Un extends Nn{constructor(t,e,i,r){super(t,e,i),this.ams=250;let s=this;r&&r.zoomAnimationMs&&(s.ams=r.zoomAnimationMs)}enable(){super.enable();let t=this.querySelector(".info"),e=this.map;t.innerText=e.getZoomlevel(),e.addEventListener("mapviewchangeend",this._zll=function(i){t.innerText=Math.round(10*e.getZoomlevel())/10})}disable(){super.disable(),this.map.removeEventListener("mapviewchangeend",this._zll)}}Un.prototype.listeners={".zoomBtn":{click:function(t){let e=0^t.srcElement.getAttribute("dir");this.map.setZoomlevel(this.map.getZoomlevel()+e,this.ams)}}},Un.prototype.style={".zoomctrl":"        position: absolute;        right:  10px;        bottom: 20px;        text-align: center;        font-family: sans-serif;        color: white;        user-select: none;",".zoomctrl div":"        background-color: #0f1621;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;",".zoomctrl .zoomBtn":"        height: 28px;        font-size: 32px;        /* border: 1px solid white; */        line-height: 22px;        font-weight: 200;",".zoomctrl .zoomBtn:hover":"        background-color: #383c45;        cursor: pointer;"},Un.prototype.templ='<div class="zoomctrl">         <div class="zoomBtn" dir="1">+</div>         <div class="info">L</div>        <div class="zoomBtn" dir="-1">-</div>     </div>';class Wn extends Nn{constructor(t,e,i){super(t,e,i)}add(t){((t,e,i,r)=>{const s=document.createElement(t);e&&(s.className=e),i&&(s.innerText=i),r&&r.appendChild(s)})("div",this.prefixClass(".src").substr(1)," "+t.label,this.html)}setData(t){const e=this;if(e.data=t,e.html){e.html.innerText="";for(let i of t)e.add(i)}}}Wn.prototype.style={".copyright-popup":"        user-select: none;        background-color: rgba(0,0,0,0.1);        position: absolute;        bottom: 15px;        padding: 2px;        right: 120px;        z-index: 1;        width:  auto;        color: #fff;        font-family: arial;        font-size: 11px;        opacity: 0.8;        height: auto;",".src":"        opacity: 0.8;        margin: 4px;    "},Wn.prototype.templ='<div class="copyright-popup"></div>';const Gn=e.global.document,Zn=!0,Yn=!1,Hn="addLayer removeLayer",Xn="zoomlevel",jn=(t,e)=>{let i,r,s,n=t.scopes,o=n.length;if(!o)return Zn;for(;i=n[--o];){const t=i.layer.getProvider(e),n=t&&t.level||e;if(r=i.minLevel||-1/0,s=i.maxLevel||1/0,n>=r&&n<=s)return Zn}return Yn},qn=(t,e)=>{t.style.display=e?"inline":"none"};const Vn={defaultOwner:"XYZ",termsAndConditions:{label:"Terms and Conditions",url:!1}};class Kn extends Nn{constructor(t,i,r){super(t,e.JSUtils.extend(!0,e.JSUtils.clone(Vn),i),r),this.sources=new e.Map,this.sLen=0,this.srcWidth=0;const s=this,{termsAndConditions:n,defaultOwner:o}=s.opt;s.$src=s.querySelector(".sources"),s.$cDefault=s.querySelector(".cDefault"),s.$btn=s.querySelector(".btn"),this.details=new Wn(t,{visible:!1},r),this.setDefaultOwner(o),this.setTermsAndConditions(n)}setTermsAndConditions(t){const{url:e,label:i}=t,r=this.querySelector(".terms");e?(r.lastChild.href=e,i&&(r.lastChild.innerText=i)):qn(r,Yn)}setDefaultOwner(t){"string"==typeof t&&this.setOwnerLabel(this.$cDefault,t)}enable(){let t=this;super.enable(),t.map.addObserver(Xn,t.onZoomChange=(e,i,r)=>{if(Math.abs((0^i)-(0^r))){t.sources.forEach((t=>{qn(t.el,jn(t,i))})),t.showDetails(!1),t.handleOverflow()}}),t.map.addEventListener(Hn,t.onLayerChange=e=>{let i=e.detail.layer;i.getCopyright((r=>{t.active&&("addLayer"==e.type?r.forEach((e=>t.addSource(e,i))):r.forEach((e=>t.removeSource(e,i))))}))}),t.map.addEventListener("resize",t.onResize=()=>t.handleOverflow())}disable(){let t=this;super.disable(),t.map.removeObserver(Xn,t.onZoomChange),t.map.removeEventListener(Hn,t.onLayerChange),t.map.removeEventListener("resize",t.onResize)}getSourceLabelsString(){const t=0^this.map.getZoomlevel();let e="";for(let i of this.sources.values())jn(i,t)&&(e+=` ${i.label} `);return e}getColors(){return{color:window.getComputedStyle(this.$cDefault).getPropertyValue("color"),backgroundColor:window.getComputedStyle(this.html).getPropertyValue("background-color")}}calcWidth(){const t=0^this.map.getZoomlevel(),e=this.sources;let i=0;return e.forEach((e=>{i+=jn(e,t)&&e.width})),i}handleOverflow(){const t=this,e=t.$btn,i=t.map.getWidth(),r=t.calcWidth(),s=i-132^0;t.$src.style.width=(s<r?s-10:r)+"px",r>Math.min(s,384)?qn(e,Zn):(qn(e,Yn),t.showDetails(!1))}showDetails(t){const e=this,i=e.details,r=e.map.getZoomlevel();e.$btn.innerText=t?"-":"+",t?(i.show(),i.setData(e.sources.values().filter((t=>jn(t,r))))):i.hide()}setOwnerLabel(t,e){t.innerText=" "+e}addSource(t,e){const i=this,r=i.sources,s=t.label,n=t.scopes,o=0^i.map.getZoomlevel();let a,l=r.get(s);l?(a=l.el,l.cnt++):(a=Gn.createElement("span"),a.className=this.prefixClass(".source").substr(1),i.setOwnerLabel(a,s),i.$src.appendChild(a),l={label:s,scopes:[],el:a,cnt:1,width:a.getBoundingClientRect().width},r.set(s,l),i.sLen++,i.srcWidth+=l.width),null!=n&&n.forEach((t=>l.scopes.push({minLevel:t.minLevel,maxLevel:t.maxLevel,layer:e}))),qn(i.$cDefault,Yn),qn(a,jn(l,o)),i.handleOverflow()}removeSource(t,e){const i=this,r=t.label,s=i.sources.get(r);let n,o;if(s){if(o=s.scopes,n=t.scopes)for(let t,i=0;i<n.length;i++){t=n[i];for(let r,s=0;i<o.length;s++)if(r=o[s],r.layer==e&&r.minLevel==t.minLevel&&r.maxLevel==t.maxLevel){o.splice(s,1);break}}--s.cnt||(i.$src.removeChild(s.el),i.sources.delete(r),i.handleOverflow(),--i.sLen||qn(i.$cDefault,Zn))}}}Kn.prototype.listeners={".btn":{click:function(t){const e="+"==this.$btn.innerText;this.showDetails(e)}}},Kn.prototype.style={".copyright *":"        color: rgba(255,255,255,.8);        font-family: arial;        text-decoration: none;",".copyright":"        right: 0px;        bottom: 0px;        padding: 1px 4px;        margin: 0px;        background-color: rgba(0,0,0,.1);        position: absolute;        font-size: 11px;        line-height: 13px;        overflow: hidden;        white-space: nowrap;        user-select: none;",".sources":"        width:auto;        max-width: 384px;        float: left;        white-space: nowrap;        overflow: hidden;        text-overflow: ellipsis;        border-right: 2px;",".copyright .btn":"        display: none;        font-family: sans-serif;        font-weight: bold;        text-align: center;        height: 12px;        width: 12px;        float: left;        padding: 0px;        line-height: 9px;        margin: 1px 2px 0px;        background-color: inherit;        box-sizing: border-box;        border-radius: 3px;        border: 1px solid;",".terms, .cDefault, .source":"        white-space: nowrap;        padding-right: 4px;"},Kn.prototype.templ='<div class="copyright">        <span style="float: left; white-space: nowrap;">            <span class="sources"></span>            <span class="cDefault"></span>         </span>        <span class="tac" style="float: right; white-space: nowrap;">            <span class="btn">+</span>            <span class="terms" style="white-space: nowrap;">|            <a target="_blank" style="white-space: nowrap;" href="">Terms and Conditions</a></span>        </span>    </div>';class Qn extends Nn{constructor(t,e,i){super(t,e,i);const{url:r}=e;r&&this.setSrc(r)}setSrc(t){this.html.style.backgroundImage=`url(${t})`}getImage(){const t=window.getComputedStyle(this.html),e=Math.round(parseFloat(t.getPropertyValue("width"))),i=Math.round(parseFloat(t.getPropertyValue("height")));return new Promise((r=>{const s=new Image;s.onload=()=>r({img:s,width:e,height:i}),s.src=t.getPropertyValue("background-image").slice(5,-2)}))}}Qn.prototype.style={".logo":"        position: absolute;        bottom: 6px;        left: 6px;        z-index: 1;        margin:  0px;        background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjdweCIgaGVpZ2h0PSIzMnB4IiB2aWV3Qm94PSIwIDAgMjcgMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDUyLjYgKDY3NDkxKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5Hcm91cCAzPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9Ikdyb3VwLTMiPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzA0QjZDOCIgcG9pbnRzPSItNy44NjQyMTYxOWUtMTQgOSAxMyAxNS45Njg4NjgxIDEzIDMyIDAgMjQuNDc4MDIyNiI+PC9wb2x5Z29uPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzBBNTdENCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAuNTAwMDAwLCAyMC41MDAwMDApIHNjYWxlKC0xLCAxKSB0cmFuc2xhdGUoLTIwLjUwMDAwMCwgLTIwLjUwMDAwMCkgIiBwb2ludHM9IjE0IDkgMjcgMTUuOTY4ODY4MSAyNyAzMiAxNCAyNC40NzgwMjI2Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTIiIGZpbGw9IiMwQTk0REUiIHBvaW50cz0iMCA3Ljc5MTIyNDMxIDEzLjU1MDIxNTEgMCAyNyA3Ljc5MTIyNDMxIDEzLjU1MDIxNTEgMTUiPjwvcG9seWdvbj4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==);        background-repeat: no-repeat;        background-size: contain;        width: 32px;        height: 32px;        cursor: pointer;"},Qn.prototype.templ='<div class="logo"></div>';const $n={Compass:Bn,ZoomControl:Un,Copyright:Kn,Logo:Qn};let Jn;class to{constructor(t,e,i){const r=Object.assign({},e.UI||e.ui||{}),s=this.components={};this.el=t,r.HERE!=Jn&&(r.Logo=r.HERE);for(let n in $n){let o=r[n];!1!==o&&("object"!=typeof o&&(o={}),o.visible==Jn&&(o.visible=!0),o.visible&&(s[n]=new $n[n](t,o,i,e)))}}static initComponentOptions(){}get(t){return this.components[t]}destroy(){const{components:t}=this;for(let e in t)t[e].destroy(),delete t[e]}}const{isFunction:eo}=e.JSUtils;class io{constructor(t={}){this.animation=null;let e=this;this.easing=t.easing,eo(t.onStart)&&(e.onStart=t.onStart),eo(t.onStop)&&(e.onStop=t.onStop)}onStart(){}onStop(){}async animate(t,e,i,r){const s=this;s.active||(s.active=!0,s.onStart(),s.animation=new cn(t,e,i,this.easing,r),await s.animation.start(),s.onStop(),s.active=!1,s.animation=null)}stop(){var t;null===(t=this.animation)||void 0===t||t.stop()}}class ro extends io{constructor(t,e={}){e.easing=e.easing||"easeOutCubic",super(e),this.map=t}start(t,e,i,r){const{map:s}=this;this.animate(s.getZoomlevel(),t,r,(t=>{s.setZoomlevel(t,e,i)}))}}const so=e.JSUtils.isFunction;class no{constructor(t,e){e=e||{};const i=this;i.map=t,i.duration=e.duration||500,so(e.onStart)&&(i.onStart=e.onStart),so(e.onStop)&&(i.onStop=e.onStop),i.raf=()=>{i._pan()&&(i.rafId=requestAnimationFrame(i.raf))}}_pan(){const t=this,e=t.deltaX,i=t.deltaY,r=t.duration,s=t.startTs,n=Math.min(Date.now()-s,r)/r,o=ln(n)*e,a=ln(n)*i;if(t.map.pan(o-t.lastDx||0,a-t.lastDy||0),o!=e||a!=i)return t.lastDx=o,t.lastDy=a,!0;t.onStop()}pan(t,e,i){this.startTs=t,this.deltaX=e,this.deltaY=i,this.onStart(),this.raf()}cancel(){const t=this.rafId;t&&(cancelAnimationFrame(t),this.rafId=null),this.onStop(),this.startTs=0,this.lastDx=0,this.lastDy=0}onStart(){}onStop(){}}const oo={ui:{},behavior:{drag:!0,pitch:!1,rotate:!1},rotate:0,pitch:0,zoomlevel:18,center:{longitude:8.534,latitude:50.162},layers:null,maxLevel:20,minLevel:2,debug:!1,minPanMapThreshold:4,minRotateMapThreshold:4,minPitchMapThreshold:4,zoomAnimationMs:100,maxPitch:50};class ao extends io{constructor(t,e={}){e.easing=e.easing||"easeOut",super(e),this.map=t}start(t,e,r){const{map:s}=this,n=s.getZoomlevel(),o=s._worldSizeFixed,a=s.getCenter(),l=i.webMercator.lon2x(a.longitude,o),h=i.webMercator.lat2y(a.latitude,o),c=i.webMercator.lon2x(t.longitude,o),u=i.webMercator.lat2y(t.latitude,o),f=Math.max(s.getWidth(),s.getHeight()),d=f/Math.pow(2,e-n),p=z(c,u,l,h)||1,g=1.42,m=2.0164,v=t=>(Math.exp(t)-Math.exp(-t))/2,y=t=>(Math.exp(t)+Math.exp(-t))/2,x=t=>{const e=(d*d-f*f+(t?-1:1)*m*m*p*p)/(2*(t?d:f)*m*p);return Math.log(Math.sqrt(e*e+1)-e)},_=x(0),b=t=>{return f*(y(_)*(v(e=_+g*t)/y(e))-v(_))/m;var e},w=(x(1)-_)/g,M=f*Math.pow(2,n);r=r||1e3*w*.77,this.animate(0,w,r,(r=>{const a=b(r)/p,d=l+(c-l)*a,m=h+(u-h)*a;let v,x;r>=w?(v=t,x=e):(v=new i.GeoPoint(i.webMercator.x2lon(d,o),i.webMercator.y2lat(m,o)),x=Math.log(M/(t=>f*(y(_)/y(_+g*t)))(r))/Math.LN2,x=isNaN(x)?n:x),s.setZoomlevel(x),s.setCenter(v)}))}}const lo=i.webMercator,ho=i.webMercator.earthCircumference;let co="fixed";const uo=180,fo=-180,po=85.05112878,go=-85.05112878,mo=256,vo="longitude",yo="latitude",xo="width",_o="height",bo="pitch",wo="rotate",Mo="addLayer",Ao="removeLayer";let So,To=[];class Lo{constructor(t,r){this._s=1,this._rz=0,this._rx=0,this._cWorldFixed=new i.PixelPoint(0,0),this._cWorld=new i.PixelPoint(0,0),this._c=new i.GeoPoint(0,0),this._pc=new i.GeoPoint(0,0),this._ox=0,this._oy=0,this._cfg=r=e.JSUtils.extend(!0,e.JSUtils.extend(!0,{},oo),r||{});let s=this;this._w=n(t,xo),this._h=n(t,_o),this._cx=this._w/2,this._cy=this._h/2;const o=r.zoomLevel||r.zoomlevel;r.maxLevel=Math.min(28,r.maxLevel),r.maxPitch=Math.min(85,r.maxPitch),this._z=0^Math.min(20,o),this._worldSizeFixed=Math.pow(2,this._z)*mo,this._worldSize=Math.pow(2,o)*mo,this._l=new e.Listener(["center","rotation","zoomlevel","pitch","mapviewchangestart","mapviewchange","mapviewchangeend","resize",Mo,Ao]);let a=this._l,l=[],h=t;s._layers=l,s.id=1e6*Math.random()^0,(t=document.createElement("div")).className="_"+e.JSUtils.String.random(11),t.style["-webkit-tap-highlight-color"]="rgba(0,0,0,0)",t.style.position="relative",t.style.width=this._w+"px",t.style.height=this._h+"px",h.appendChild(t),this._el=t;const c="canvas"==r.renderer?sn:Ls;"string"==typeof c.zoomBehavior&&(co=c.zoomBehavior);const u=new c(t,256,r.devicePixelRatio,r.renderOptions||{});s._mvcRecognizer=new Dn(s,(function(t,e,i){a.trigger(t,[new pn(t,e)],i)}),u),s._display=u,this.setBackgroundColor(r.backgroundColor),this._search=new zn(s,u.dpr);const f=this._evDispatcher=new Sn(t,s,l,r);a.add("mapviewchangestart",(t=>f.disable("pointerenter"))),a.add("mapviewchangeend",(t=>f.enable("pointerenter"))),a.add("mapviewchangeend",(t=>u.viewChangeDone())),this._zoomAnimator=new ro(s),this._flightAnimator=new ao(s);const d=Object.assign(Object.assign({},r.behavior),r.behaviour);d.zoom==So&&(d.zoom=co);let p=this._b=new dn(t,s,new no(s),d,r);p.drag(!0),p.scroll(!0),this._vplock={pan:!1,minLevel:r.minLevel,maxLevel:r.maxLevel};const g=r.UI||r.ui||{};g.Compass==So&&(g.Compass=d.rotate||d.pitch),this.ui=new to(t,r,s),s.setCenter(r.center),s.pitch(r.pitch),s.rotate(r.rotate),s.setZoomlevel(o),s._layerClearListener=s._layerClearListener.bind(s);for(let t of r.layers||[])s.addLayer(t);To.push(this),r.debug&&this.debug(r.debug)}static getInstances(){return To.slice()}_layerClearListener(t){this.refresh(t.detail.layer)}initViewPort(){const t=this._s,e=this._worldSizeFixed,r=this._cWorldFixed.x,s=this._cWorldFixed.y,n=this._w/2,o=this._h/2,a=r-n/t,l=s-o/t;this._tlwx=r-n,this._tlwy=s-o,this._ox=r-n/t-a,this._oy=s-o/t-l;let h=lo.x2lon(a,e),c=lo.y2lat(l,e),u=r+n/t,f=s+o/t,d=lo.x2lon(u,e),p=lo.y2lat(f,e);return this._vp=new i.GeoRect(h,p,d,c),[r/e,s/e]}updateGrid(){const t=this._display,e=this._c,i=this._pc;this._mvcRecognizer.watch(!0),this._groundResolution=ho(e.latitude)/this._worldSizeFixed,t.setView(this.initViewPort(),this._s,this._rz,this._rx,this._groundResolution,this._worldSize),t.updateGrid(this._z,this._ox,this._oy),i[vo]==e[vo]&&i[yo]==e[yo]||(this._l.trigger("center",["center",e,i],!0),this._pc=e)}_clipLatitude(t){return Math.min(po,Math.max(go,t))}_setCenter(t,e){const r=this._worldSizeFixed;return 2!=arguments.length&&(t instanceof Array?(e=t[1],t=t[0]):(e=(t=t||this._c)[yo],t=t[vo])),!isNaN(t)&&!isNaN(e)&&"number"==typeof t&&"number"==typeof e&&(t>uo?t-=360:t<fo&&(t+=360),e=this._clipLatitude(e),this._c=new i.GeoPoint(t,e),this._cWorldFixed=new i.PixelPoint(lo.lon2x(t,r),lo.lat2y(e,r)),this._cWorld=new i.PixelPoint(lo.lon2x(t,this._worldSize),lo.lat2y(e,this._worldSize)),!0)}repaint(){this.updateGrid()}debug(t){this._display.showGrid(t),this.updateGrid()}pitch(t){if(t!==So){const e=this._cfg.maxPitch,i=-(t=Math.max(0,Math.min(e,Math.round(t%360*10)/10)))*Math.PI/180,r=this._rx;r!=i&&(this._rx=i,this.updateGrid(),this._l.trigger("pitch",["pitch",t,180*-r/Math.PI],!0))}return 180*-this._rx/Math.PI}rotate(t){if(t!==So){const e=Math.round(10*t||0)/10,i=e*Math.PI/180,r=this._rz;if(i!==r){const t=this._cx,s=this._cy,n=this._display.unproject(t,s),o=this._cWorldFixed;o.x+=n[0]-t,o.y+=n[1]-s,this._rz=i,this.updateGrid(),this._l.trigger("rotation",["rotation",e,r/Math.PI*180],!0)}}return this._rz/Math.PI*180}setBackgroundColor(t){this._display.setBGColor(t),this.refresh()}addEventListener(t,e){const i=this._l;t.split(" ").forEach((t=>{if(i.isDefined(t))return i.add(t,e);this._evDispatcher.addEventListener(t,e)}))}removeEventListener(t,e){const i=this._l;t.split(" ").forEach((t=>{if(i.isDefined(t))return i.remove(t,e);this._evDispatcher.removeEventListener(t,e)}))}getViewBounds(){let t=this._vp,e=t.minLon,r=t.maxLon,s=t.minLat,n=t.maxLat;return s<=go&&(s=-90),n>=po&&(n=90),e<fo&&(e=fo),r>uo&&(r=uo),new i.GeoRect(e,s,r,n)}setViewBounds(t,e){const r=arguments;let s,n,o,a;if("number"==typeof t?t=[r[0],r[1],r[2],r[3]]:"FeatureCollection"==t.type?t=t.features:"Feature"==t.type&&(t=[t]),Array.isArray(t)){if("object"==typeof t[0]){const e=[1/0,1/0,-1/0,-1/0];for(let r of t)i.utils.calcBBox(r,e);t=e}s=t[0],n=t[1],o=t[2],a=t[3]}else{const e=t;s=e.minLon,n=e.minLat,o=e.maxLon,a=e.maxLat}const l=function(t,e,i,r,s,n){let o,a,l,h=Math.pow(2,20)*mo;for(let c=20;c>=0;--c)if(l=20-c,o=(lo.lon2x(i,h)>>l)-(lo.lon2x(t,h)>>l),a=(lo.lat2y(e,h)>>l)-(lo.lat2y(r,h)>>l),o<=s&&a<=n)return c;return 0}(s,n,o,a,this.getWidth(),this.getHeight()),h=new i.GeoPoint(s+(o-s)/2,n+(a-n)/2);e?this.flyTo(h,l,!0===e?{}:e):(this.setZoomlevel(l),this.setCenter(h))}getFeatureAt(t,e){e=e||{};const i=this.getFeaturesAt(t,e);if(i.length){const t=i[i.length-1];return t.feature=t.features[0],t}}getFeaturesAt(t,e){let i,r,s,n,o=!1;e=e||{};let{layers:a}=e;if(a&&!Array.isArray(a)&&(a=[a]),t.x!=So&&t.y!=So){let l=t.x,h=t.y,c=0^e.width,u=e.height||c;if(!c&&!u){o=!0,a=a||this._layers;const t=this._display.getRenderedFeatureAt(l,h,a);if(null!=t.id){const e=a[t.layerIndex],i=e.getProvider(0^this.getZoomlevel()),r=(null==i?void 0:i.search)&&i.search(t.id);if(r){const{pointWorld:i}=t;return[{layer:e,features:[r],intersectionPoint:i&&this._w2g(i[0],i[1],-i[2])}]}}}i=l-c/2,r=l+c/2,s=h-u/2,n=h+u/2}else t.minX!=So&&t.maxX!=So&&(i=t.minX,s=t.minY,r=t.maxX,n=t.maxY);return i!=So&&this._search.search(i,s,r,n,a,o)}snapshot(t,e,i,r,s){if(!t)return;e||(e=0),i||(i=0),r||(r=this._w),s||(s=this._h),r+e>this._w&&(r=this._w-e),s+i>this._h&&(s=this._h-i);const n=this._display,{dpr:o}=n,a=n.copyCanvas2d(e,i,r,s),l=Math.ceil(11/3),h=this.ui.get("Copyright"),c=h.getSourceLabelsString(),u=h.getColors(),f=h.calcWidth();(async()=>{const e=await this.ui.get("Logo").getImage(),i=a.getContext("2d");i.scale(o,o),i.font="11px sans-serif",i.textBaseline="hanging",i.fillStyle=u.backgroundColor,i.fillRect(r-f-2*l,s-11-l,r+2*l,11+l),i.fillStyle=u.color,i.fillText(c,r-f-l,s-11),i.drawImage(e.img,2*l,s-e.height-2*l),a.style.width=`${r}px`,a.style.height=`${s}px`,t(a)})()}getBehavior(){const t={},e=this._b.getOptions();for(let i in e)t[i]=!!e[i];return t}setBehavior(t,e){let i=typeof t,r="object"==i?t:{};const s=this._b.getOptions();"string"==i&&(r[t]=e);let n=r.zoom;n!=So&&(s.zoom="fixed"==n||"float"==n?n:!!n&&co);for(let t of["drag",bo,wo]){let e=r[t];e!=So&&(s[t]=!!e)}}getZoomlevel(){return this._z+Math.log(this._s)/Math.LN2}setZoomlevel(t,e,i,r){const s=this._vplock,n=this._z,o=this._s;if(t=Math.round(1e3*t)/1e3,t=Math.max(Math.min(t,s.maxLevel),s.minLevel),2==arguments.length&&(r=e,e=So),e!=So&&i!=So||(e=this._cx,i=this._cy),n!=t||1!=o)if(this._worldSize=Math.pow(2,t)*mo,r)this._zoomAnimator.start(t,e,i,"number"==typeof r?r:250);else{const r=this.getZoomlevel(),s=this._display.unproject(e,i),o=0^Math.min(20,t),a=n-o,l=this._worldSizeFixed,h=Math.pow(2,t-o);a&&(this._z=0^Math.min(20,t),this._worldSizeFixed=Math.pow(2,this._z)*mo),this._display.setView(this.initViewPort(),h*Math.pow(.5,a),this._rz,this._rx,this._groundResolution,this._worldSize);const c=this._display.unproject(e,i);this._setCenter(lo.x2lon(this._cWorldFixed.x+s[0]-c[0],l),lo.y2lat(this._cWorldFixed.y+s[1]-c[1],l)),this._s=h,this.updateGrid(),this._l.trigger("zoomlevel",["zoomlevel",this.getZoomlevel(),r],!0)}}setCenter(t,e){this._setCenter.apply(this,arguments)&&this.updateGrid()}getCenter(){return new i.GeoPoint(this._c.longitude,this._c.latitude)}flyTo(t,e,i){e&&"object"!=typeof e||(i=e,e=this.getZoomlevel()),this._flightAnimator.stop(),this._flightAnimator.start(t,e,null==i?void 0:i.duration)}lockViewport(t){const e=this._vplock;if(t){let i=t.pan,r=t.minLevel,s=t.maxLevel;r=!1===r?this._cfg.minLevel:r,s=!1===s?this._cfg.maxLevel:s,i!=So&&(e.pan=i),"number"==typeof r&&(e.minLevel=r),"number"==typeof s&&(e.maxLevel=s)}return e}pan(t,e){if(0!=t||0!=e){const i=this._worldSizeFixed,r=this._cx,s=this._cy,n=this._cWorldFixed,o=this._display.unproject(r+t,s+e),a=n.x-o[0]+r,l=n.y-o[1]+s;this.setCenter(lo.x2lon(a,i),lo.y2lat(l,i))}}getLayers(t){const e=this._layers;return t!=So?e[t]:e.slice()}addLayer(t,e){const i=this._layers;if(-1==i.indexOf(t)){e==So&&(e=i.length),this._display.addLayer(t,t.getStyle(),e),t.addEventListener("clear",this._layerClearListener);const r={index:e,layer:t,map:this,context:this._display.getContext(),canvas:this._display.canvas};t.dispatchEvent("layerAdd",r),this._l.trigger(Mo,[new pn(Mo,r)]),i.splice(e,0,t),this.updateGrid()}}removeLayer(t){const e=this._layers,i=e.indexOf(t);i>=0&&(this._display.removeLayer(t),t.removeEventListener("clear",this._layerClearListener),e.splice(i,1),this.updateGrid(),this._l.trigger(Ao,[new pn(Ao,{index:i,layer:t})]))}refresh(t){t instanceof Array||(t=[t]);for(let e of t)e instanceof i.TileLayer&&this._display.clearLayer(e);this.updateGrid()}pixelToGeo(t,e){1==arguments.length&&(e=t.y,t=t.x);const r=this._unprj(t,e),[s,n]=this._w2g(r);return new i.GeoPoint(s,n)}_unprj(t,e,i){Array.isArray(t)&&([t,e,i]=t);const r=this._ox,s=this._oy,n=this._display.unproject(t,e,i);return n[0]+=r,n[1]+=s,n}_w2g(t,e,i){Array.isArray(t)&&([t,e,i]=t);const r=this._worldSizeFixed;let s=t+this._tlwx,n=e+this._tlwy;return s%=r,n%=r,n<0&&(n+=r),[lo.x2lon(s,r),lo.y2lat(n,r),i]}geoToPixel(t,e,r){e==So&&(r=t.altitude,e=t.latitude,t=t.longitude);let[s,n]=this._g2w(t,e);return[s,n]=this._prj([s,n,r||0]),new i.PixelPoint(s,n)}_g2w(t,e,i){Array.isArray(t)&&([t,e,i]=t),e=this._clipLatitude(e);const r=this._worldSizeFixed,s=this._tlwx,n=this._tlwy;return[lo.lon2x(t,r)-s,lo.lat2y(e,r)-n,i||0]}_prj(t){return this._display.project(t[0],t[1],t[2])}getCamera(){const t=this,[e,i,r]=t._w2g(t._unprj(t._cx,t._cy,-1));return{position:{longitude:e,latitude:i,altitude:r}}}_translateGeoCoord(t,e,i,r){const s=this,n=s._groundResolution/s._s;let[o,a,l]=t;if(l+=r*n,e||i){const[t,r,n]=s._g2w(o,a,l);[o,a,l]=s._w2g([t+e,r+i,n])}return[o,a,l]}_scaleOffsetXYByAltitude(t,e){return(e?1:this._display.scaleOffsetXYByAltitude(t))/this._s}destroy(){const t=this._el;this.ui.destroy(),this._layers.forEach((t=>this.removeLayer(t))),this._display.destroy(),t.parentNode.removeChild(t),this._mvcRecognizer.watch(!1),this._evDispatcher.destroy(),this._b.drag(!1),this._b.scroll(!1);const e=this;e.__proto__=null,Object.keys(e).forEach((t=>delete e[t])),To.splice(To.indexOf(e),1)}resize(t,e){const i=this._el;t!=So&&e!=So||(t=n(i.parentNode,xo),e=n(i.parentNode,_o));const{_w:r,_h:s}=this;r===t&&s===e||(i.style.width=t+"px",i.style.height=e+"px",this._display.setSize(t,e),this._w=t,this._h=e,this._cx=t/2,this._cy=e/2,this.updateGrid(),this._l.trigger("resize",[new pn("resize",{width:t,height:e})]))}getWidth(){return this._w}getHeight(){return this._h}addObserver(t,e){return"zoomLevel"==t&&(t="zoomlevel"),this._l.add(t,e)}removeObserver(t,e){return"zoomLevel"==t&&(t="zoomlevel"),this._l.remove(t,e)}getContainer(){return this._el.parentNode}}Lo.fillZoomMap=rt,Lo.toRGB=S;const Po={scale:oi,rotate:ai,translate:ni,create:Je,identity:ii},Eo={transformMat4:Se},zo=e.global.here.xyz.maps;zo.Map=Lo,zo.styleTools=at,t.Map=Lo,t.MapEvent=pn,t.default=Lo,t.mat4=Po,t.styleTools=at,t.vec3=Eo,Object.defineProperty(t,"__esModule",{value:!0})}));
