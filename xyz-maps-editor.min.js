/*
 * @here/xyz-maps-editor
 * (c) 2019-2022 HERE
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@here/xyz-maps-common"),require("@here/xyz-maps-core"),require("@here/xyz-maps-display")):"function"==typeof define&&define.amd?define(["exports","@here/xyz-maps-common","@here/xyz-maps-core","@here/xyz-maps-display"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).here=e.here||{},e.here.xyz=e.here.xyz||{},e.here.xyz.maps=e.here.xyz.maps||{},e.here.xyz.maps.editor={}),e.here.xyz.maps.common,e.here.xyz.maps,e.here.xyz.maps)}(this,(function(e,t,r,i){"use strict";
/******************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},o(e,t)};function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var s=function(){return s=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},s.apply(this,arguments)};function a(e,t,r){if(r||2===arguments.length)for(var i,o=0,n=t.length;o<n;o++)!i&&o in t||(i||(i=Array.prototype.slice.call(t,0,o)),i[o]=t[o]);return e.concat(i||Array.prototype.slice.call(t))}var p,l=function(e,t,r){e.editState("modified",Date.now());var i=e._e(),o=i.objects.history;if(t.isGeoMod&&!t.isMarking){t.isMarking=!0;var n=o.getHistoryFeature(e).geometry.coordinates;i.hooks.trigger("Coordinates.update",{feature:e,previousCoordinates:n},e.getProvider()),t.isGeoMod=!1,t.isMarking=!1}return(null==r||r)&&o.saveChanges(),e};function d(e,t,r){e._e().listeners.trigger(t,e,r)}function u(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,isGeoMod:!1}),t?r[t]:r}function c(e){this.editState("hovered","pointerenter"==e.type),this._e().listeners.trigger(e,this)}var h,f={private:u,_evl:{pointerdown:function(e){var t=u(this);t.moved=!1;var r=this.geometry.coordinates,i=e.detail.display.geoToPixel(r[0],r[1]);t.x=i.x,t.y=i.y,t.button=e.button,t.z=r[2]||0,d(this,e,"pointerdown")},pointerup:function(e){var t=u(this),r=t.moved;!t.isSelected&&this._e()._config.featureSelectionByDefault?f._select(this):r&&f.markAsModified(this),d(this,e,r?"dragStop":"pointerup")},pointerenter:c,pointerleave:c},deHighlight:function(e){var t=u(e);t.selector&&(e.editState("selected",!1),e._e().objects.overlay.remove(t.selector),t.selector=null,t.pointerdown=p,t.pressmove=p)},_editable:function(e,t){var r=u(e);return t!=p&&(r.isEditable=!!t),f.deHighlight(e),r.isEditable},_select:function(e){var t=e._e();if(t.objects.selection.select(e)){var r=u(e),i=t.getStyleProperty(e,"altitude");if(e.editState("selected",!0),r.pressmove=function(o,n,s){if(r.isEditable&&r.isSelected&&!t._config.editRestrictions(e,1)){var p=a([],e.geometry.coordinates,!0);"number"==typeof i&&(p[2]=i),p=ct(o.mapX,o.mapY,e,p,t),f._setCoords(e,p),d(e,o,r.moved?"dragMove":"dragStart"),r.moved=!0}},!r.selector){var o=t.getZLayer(e);r.selector=t.objects.overlay.addCircle(e.coord(),p,{type:"MARKER_SELECTOR",parentType:"MARKER",MARKER:{properties:e.prop(),altitude:i,zLayer:o}})}}},_setCoords:function(e,t){e._e().objects.history.origin(e);var r=u(e,"selector");r&&r._provider.setFeatureCoordinates(r,t),e.getProvider().setFeatureCoordinates(e,t.slice()),u(e).isGeoMod=!0},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),f.deHighlight(e)},markAsModified:function(e,t){return l(e,u(e),t)}},v=Math,g=v.PI,y=v.pow,A=v.sqrt,m=function(e,r,i,o,n){void 0===i&&(i=0),void 0===o&&(o=e.length),void 0===n&&(n=[]);var s=0,a=0;o--;for(var p=i+1;p<o;p++){var l=I(e[p],e[i],e[o],t.geotools.distance);l>s&&(a=p,s=l)}return s>r?(m(e,r,i,a,n),m(e,r,a,o+1,n)):(n.push(e[i]),o-i>0&&n.push(e[o])),n},S=function(e,t,r,i,o,n,s,a){return e<=n&&o<=t&&r<=a&&s<=i},_=function(e,r,i){null==e[2]&&(e=[e[0],e[1],0]);var o=[r[0]-e[0],r[1]-e[1],(r[2]||0)-e[2]];return t.vec3.scale(o,t.vec3.normalize(o,o),i),t.vec3.add(o,o,e)},L=function(e,t){for(var r=999999,i=!1,o=0;o<e.length-1;o++){var n=o+1,s=x(e[o],e[n],t);if(s){var a=w(s,t);a<r&&(r=a,i=o)}}return i},b=function(e,r,i,o){var n=t.vec3.sub([],r,e),s=t.vec3.sub([],o,i),a=t.vec3.sub([],e,i),p=t.vec3.dot(a,n),l=t.vec3.dot(a,s),d=t.vec3.dot(n,s),u=t.vec3.dot(n,n),c=t.vec3.dot(s,s),h=(l*d-p*c)/(u*c-d*d),f=(l+h*d)/c,v=t.vec3.add([],e,t.vec3.scale([],n,h)),g=t.vec3.add([],i,t.vec3.scale([],s,f)),y=0<=h&&h<=1&&0<=f&&f<=1,A=t.vec3.length(t.vec3.sub([],v,g));return{p0:v,p1:g,onSegment:y,intersects:A<=1e-7,distance:A}},k=function(e,t,r,i,o){var n=(i[1]-r[1])*(t[0]-e[0])-(i[0]-r[0])*(t[1]-e[1]);if(0!=n){var s=((i[0]-r[0])*(e[1]-r[1])-(i[1]-r[1])*(e[0]-r[0]))/n,a=((t[0]-e[0])*(e[1]-r[1])-(t[1]-e[1])*(e[0]-r[0]))/n,p=e[2]||0,l=t[2]||0;if(0<=s&&s<=1&&0<=a&&a<=1)return!o||[e[0]+s*(t[0]-e[0]),e[1]+s*(t[1]-e[1]),p+s*(l-p)]}return!1},x=function(e,t,r){if(e[0]==t[0]){var i=[e[0],r[1]];return!!O(e,t,i)&&i}if(e[1]==t[1]){var o=[r[0],e[1]];return!!O(e,t,o)&&o}var n=(t[1]-e[1])/(t[0]-e[0]),s=e[1]-n*e[0],a=-1/n,p=(r[1]-a*r[0]-s)/(n-a),l=[p,n*p+s];return!!O(e,t,l)&&l},E=function(e,r,i,o){var n=t.vec3.sub([],i,e),s=t.vec3.sub([],r,e),a=t.vec3.sub([],r,e),p=t.vec3.dot(s,n)/t.vec3.dot(s,s);return o&&(p=Math.max(0,Math.min(1,p))),t.vec3.scale(a,a,p),t.vec3.add(a,a,e)},C=function(e,r,i,o,n){var s=t.vec3.sub([],r,o),a=t.vec3.dot(s,i)/t.vec3.dot(e,i);return a==1/0?null:t.vec3.sub([],r,t.vec3.scale([],e,a))},P=function(e,t,r){var i=e[2]||0,o=t[2]||0;return[(t[0]-e[0])*r+e[0],(t[1]-e[1])*r+e[1],i+(o-i)*r]},I=function(e,t,r,i){void 0===i&&(i=w);var o=e[0],n=e[1],s=t[0],a=t[1],p=r[0],l=r[1],d=p-s,u=l-a,c=((o-s)*d+(n-a)*u)/(d*d+u*u);return i([o,n],c<0?[s,a]:c>1?[p,l]:[s+c*d,a+c*u])},R=function(e,t){for(var r=1/0,i=t.length-1,o=0;o<i;o++){var n=I(e,t[o],t[o+1]);n<r&&(r=n)}return r},w=function(e,t){return A(y(e[0]-t[0],2)+y(e[1]-t[1],2))},O=function(e,t,r,i){i=i||1e-7;var o=r[0]-e[0],n=r[1]-e[1],s=t[0]-e[0],a=t[1]-e[1],p=(o*s+n*a)/(s*s+a*a);return(p=(s=o-(p=p<0?0:p>1?1:p)*s)*s+(a=n-p*a)*a)<i*i},N=function(e){for(var t=0,r=0;r<e.length-1;r++)t+=w(e[r],e[r+1]);return t},F=function(e,t,r){var i;void 0===r&&(r=!0);for(var o,n,s,a=0,p=0;p<e.length-1;p++)if(o=e[p],n=e[p+1],a+=i=w(o,n),!r||a>=t)return s=(t-(a-i))/i,[(n[0]-o[0])*s+o[0],(n[1]-o[1])*s+o[1]];return n},T=function(e,t,r){var i,o,n,s,a=w(r,e),p=(i=e,n=(o=r)[0]-i[0],s=o[1]-i[1],n||s?(180+180*v.atan2(s,n)/g)%360:0);return[r[0]+a*v.cos((t+p)/180*g),r[1]+a*v.sin((t+p)/180*g)]};function M(e,t,r){for(var i=0,o=r.length-1;i<o;i++)if(k(e,t,r[i],r[i+1]))return 1}function D(e,t){for(var r=0,i=e.length-1;r<i;r++)if(M(e[r],e[r+1],t))return 1}function B(e,t){for(var r=e[0],i=e[1],o=!1,n=0,s=t.length-1;n<t.length;s=n++){var a=t[n][0],p=t[n][1],l=t[s][0],d=t[s][1];p>i!=d>i&&r<(l-a)*(i-p)/(d-p)+a&&(o=!o)}return o}function j(e,t,r){for(var i=0^r,o=e.length;i<o;i++)for(var n=0;n<e[i].length;n++)if(!B(e[i][n],t))return 0;return 1}var G,z=function(e,t,r,i,o,n){void 0===i&&(i=0),void 0===o&&(o=0);var s=h.getCoords(e),a=s[o],p=a[i],l=p[r];if(!h.willSelfIntersect(p,t,r)){if(p[r]=t,r||(p[p.length-1]=t),!function(e,t,r){for(var i=0,o=t.length;i<o;i++)if(i!=r&&D(e,t[i]))return 1}(p,a,i)&&j(a,a[0],1)){var d=h.private(e,"shapePnts");if(n=n||h.getConnectedAreas(e,l),e.behavior("snapCoordinates"))for(var u=0;u<n.length;u++){var c=n[u],f=c.coordinates,v=c.polyIndex,g=c.lineIndex,y=c.coordIndex,A=f[v],m=A[g];if(c.area.behavior("snapCoordinates")){if(m[y][0]=t[0],m[y][1]=t[1],y||(m[m.length-1]=t),!(!h.willSelfIntersect(m,t,y)&&j(A,A[0],1)))return!1}else f.splice(u,1)}for(var S=0,_=n;S<_.length;S++){var L=_[S],b=L.area,k=L.coordinates;h._setCoords(b,k,!1)}h._setCoords(e,s,!1);for(var x=0,E=d;x<E.length;x++){var C=E[x],P=C.geometry.coordinates;P[0]==l[0]&&P[1]==l[1]&&C.getProvider().setFeatureCoordinates(C,t.slice())}}return!0}},K=function(e){function t(t,r,i,o,n){var s=this;h=n;var a=t._e(),p=a.display.getLayers().indexOf(a.getLayer(t))+1,l={type:"Feature",geometry:{type:"Point",coordinates:[r,i]},properties:{type:"AREA_SHAPE",poly:o[0],index:o[1],hole:o[2],AREA:{style:a.getStyle(t),zLayer:p?p+1:G}}},d=s=e.call(this,l,a.objects.overlay.layer.getProvider())||this,u=a.objects.overlay;function c(e){var t,r=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete r.hovered,t="default"):(r.hovered=!0,t="move"),document.body.style.cursor=t,a.setStyle(this)}function f(e,t){a.listeners.trigger(e,d,t)}var v=!1;return s.__={area:t,pointerdown:function(){v=!1,d.__.cAreas=h.getConnectedAreas(t,d.geometry.coordinates)},pressmove:function(e,r,i,o,n){var s;v||(v=!0,h.hideShape(h.private(t,"midShapePnts"),u),null===(s=t.__.hk)||void 0===s||s.hide(),f(e,"dragStart"));var p=a._config,l=d.getIndex(),c=d.properties.poly,g=d.properties.hole,y=a.map.getGeoCoord(e.mapX,e.mapY);t.behavior("snapCoordinates")&&(y=h.snapShape(d,y,p.snapTolerance)||y),z(t,y,l,g,c,d.__.cAreas)},pointerup:function(e){var r;if(v){if(t.behavior("snapCoordinates"))for(var i=0,o=d.__.cAreas;i<o.length;i++){var n=o[i].area;h.markAsModified(n,!1)}h.markAsModified(t)}null===(r=t.__.hk)||void 0===r||r.show(),h.addVShapes(t),f(e,v?"dragStop":G)},pointerenter:c,pointerleave:c},d}return n(t,e),t.prototype.getArea=function(){return this.__.area},t.prototype.remove=function(){return h.deleteShape(this.getArea(),this)},t.prototype.getIndex=function(){return this.properties.index},t.prototype.removeGeometry=function(){var e=this.getArea(),t=this.properties.poly,r=this.properties.hole,i=e.coord();i[t].splice(r,1),h._setCoords(e,i,!1),h.deHighlight(e),h._select(e),h.markAsModified(e)},t}(r.Feature);K.prototype.class="AREA_SHAPE";var H,V=function(e){function t(t,r,i,o,n){var s,a,p=t._e(),l=p.display.getLayers().indexOf(p.getLayer(t))+1,d=p.objects.overlay,u={type:"Feature",geometry:{type:"Point",coordinates:[r,i]},properties:{type:"AREA_VIRTUAL_SHAPE",poly:o[0],index:o[1],hole:o[2],AREA:{style:p.getStyle(t),zLayer:l?l+1:undefined}}},c=s=e.call(this,u,d.layer.getProvider())||this;function h(e){var t,r=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete r.hovered,t="default"):(r.hovered=!0,t="move"),document.body.style.cursor=t,p.setStyle(this)}return c.__={pointerdown:function(){a=null},pressmove:function(e,r,i,o,s){var p=c.properties,l=p.index+1,d=p.poly,u=c.geometry.coordinates;if(!a){for(var h=n.private(t,"midShapePnts"),f=0,v=void 0,g=void 0,y=void 0;f<h.length;f++)(g=(v=h[f]).geometry.coordinates)[0]==u[0]&&g[1]==u[1]&&(y=v.properties,n.addShp(t,u.slice(),y.poly,y.hole,y.index+1));(a=n.getShp(t,d,p.hole,l)).__.pointerdown.apply(a)}a.__.pressmove.apply(a,arguments)},pointerup:function(e){if(a){var r=c.properties,i=r.poly,o=r.hole,s=r.index,p=n.getShp(t,i,o,s+1);p.__.pointerup.call(p,e)}},pointerenter:h,pointerleave:h},s}return n(t,e),t}(r.Feature),U=t.geometry.centroid,Y=function(e){var t=e.geometry;return U("Polygon"==t.type?t.coordinates:t.coordinates[0])},Z=function(e){function t(t,r,i){var o=this;H=i;var n=t._e(),s=n.display.getLayers().indexOf(n.getLayer(t))+1,a=Y(t),p={type:"Feature",geometry:{type:"Point",coordinates:[a[0],a[1],r]},properties:{type:"AREA_HEIGHT_KNOB",offsetZ:0,AREA:{style:n.getStyle(t),zLayer:s?s+1:undefined}}};function l(e){var t,r=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete r.hovered,t="default"):(r.hovered=!0,t="move"),document.body.style.cursor=t,n.setStyle(this)}return(o=e.call(this,p,n.objects.overlay.layer.getProvider())||this).__={area:t,iEditor:n,overlay:n.objects.overlay,pointerdown:function(){this.properties.isMoved=!1,this.properties.offsetZ=this.__.iEditor.getStyleProperty(this,"offsetZ")||0},pressmove:function(e,t,r,i,o){var n=this.__,s=n.area,a=n.iEditor,p=this.properties.offsetZ,l=a.map.translateZ(this.geometry.coordinates,p);l=ct(e.mapX,e.mapY,this,l,a,{axis:[0,0,1]});var d=a.map.translateZ(l,-p)[2];d=Math.max(0,d),this.update(d),s.getProvider().writeFeatureHeight(s,d),H._setCoords(s,s.geometry.coordinates),this.properties.isMoved=!0},pointerup:function(e){this.properties.isMoved&&H.markAsModified(this.__.area)},pointerenter:l,pointerleave:l},o}return n(t,e),t.prototype.update=function(e){var t=Y(this.__.area);t[2]=e,this.__.overlay.setFeatureCoordinates(this,t)},t.prototype.remove=function(){this.__.overlay.remove(this)},t.prototype.hide=function(){this.__.overlay.hideFeature(this)},t.prototype.show=function(){this.update(this.geometry.coordinates[2]),this.__.overlay.showFeature(this)},t}(r.Feature);function J(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,allowEdit:!0,shapePnts:[],midShapePnts:[]}),t?r[t]:r}function W(e){var t=J(e),r=e._e().objects.overlay;ie.hideShape(t.shapePnts,r),ie.hideShape(t.midShapePnts,r)}function Q(e,t,r,i){for(var o=e._e().objects.overlay,n=0;n<r.length;n++)for(var s=r[n],a=0;a<s.length-1;a++){var p=i(s[a],s[a+1],a,n);o.addFeature(p),t.push(p)}}function X(e){for(var t=J(e,"midShapePnts"),r=ie.getCoords(e),i=function(i){Q(e,t,r[i],(function(t,r,o,n){return new V(e,(t[0]+r[0])/2,(t[1]+r[1])/2,[i,o,n],ie)}))},o=0;o<r.length;o++)i(o)}function q(e){if(J(e,"isSelected")){W(e),function(e){for(var t=J(e,"shapePnts"),r=ie.getCoords(e),i=function(i){Q(e,t,r[i],(function(t,r,o,n){return new K(e,t[0],t[1],[i,o,n],ie)}))},o=0;o<r.length;o++)i(o)}(e),X(e);var t=e.getProvider().readFeatureHeight(e);if(ie.isExtruded(e)&&"number"==typeof t){var r=e.__.hk;if(r)r.show();else r=e.__.hk=new Z(e,t,ie),e._e().objects.overlay.addFeature(r);r.update(t)}}}function $(e){var t=this,r=J(t);r.allowEdit&&!r.isSelected&&(t._e().listeners.trigger(e,t),t.editState("hovered","pointerenter"==e.type),t._e().setStyle(this))}function ee(e){var t=this,r=J(t);r.isSelected||this._e()._config.featureSelectionByDefault&&r.allowEdit&&ie._select(t),t._e().listeners.trigger(e,t)}var te,re,ie={private:J,_evl:{pointerenter:$,pointerleave:$,dbltap:ee,pointerup:ee},deHighlight:function(e){var t,r=J(e);r.isSelected&&(W(e),null===(t=e.__.hk)||void 0===t||t.remove(),e.__.hk=null,e.editState("hovered",!1),e.editState("selected",!1),e._e().setStyle(e),r.isSelected=!1)},_editable:function(e,t){var r=J(e);t&&t!=r.allowEdit?document.body.style.cursor="pointer":t||t==r.allowEdit||(ie.deHighlight(e),document.body.style.cursor="default"),r.allowEdit=t},isExtruded:function(e){if("number"==typeof e._e().getStyleProperty(e,"extrude"))return!0},_select:function(e){var t=J(e),r=e._e();t.isSelected||(r.objects.selection.select(e),r.dump(e,"info"),t.isSelected=!0,e.editState("selected",!0),r.setStyle(e),q(e))},_setCoords:function(e,t,r){"number"==typeof t[0][0][0]&&(t=[t]);for(var i=t.length;i--;)for(var o=t[i],n=o.length;n--;){var s=o[n];s[s.length-1]=s[0]}e._e().objects.history.origin(e),"Polygon"==e.geometry.type&&(1==t.length?t=t[0]:e.geometry.type="MultiPolygon"),J(e).isGeoMod=!0,e.getProvider().setFeatureCoordinates(e,t),r&&q(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),ie.deHighlight(e)},markAsModified:function(e,t){return l(e,J(e),t)},deleteShape:function(e,t){var r=t.properties,i=ie.getCoords(e),o=i[r.poly][r.hole];return!(o.length<=4)&&(o.splice(t.getIndex(),1),ie._setCoords(e,i),ie.deHighlight(e),ie._select(e),ie.markAsModified(e),!0)},getCoords:function(e){var t=e.coord();return"Polygon"==e.geometry.type?[t]:t},isClockwise:function(e){for(var t=0,r=0,i=void 0,o=e.length-1;r<o;r++)i=(r+1)%o,t+=e[r][0]*e[i][1],t-=e[i][0]*e[r][1];return t<0},getMaxSpace:function(e,t,r){var i=e._e(),o=t[0],n=t[1],s=1e5,a=[[o+s,n-s],[o-s,n+s],[o+s,n+s],[o-s,n-s]];s=1/0;for(var p=0,l=r.length-1;p<l;p++)for(var d=(p+1)%l,u=i.map.getPixelCoord(r[p]),c=i.map.getPixelCoord(r[d]),h=0;h<4;){var f=k(a[h++],a[h++],u,c,!0);if(f){var v=w(t,f);v<s&&(s=0^v)}}return s},getPoly:function(e,t){for(var r=ie.getCoords(e),i=1/0,o=null,n=0,s=void 0;n<r.length;n++)(s=R(t,r[n][0]))<i&&(i=s,o=n);return o},addVShapes:X,getShp:function(e,t,r,i){for(var o=J(e,"shapePnts"),n=0,s=void 0;n<o.length;n++)if((s=o[n].properties).poly==t&&s.index==i&&s.hole==r)return o[n]},addShp:function(e,t,r,i,o){for(var n=ie.getCoords(e),s=n[r][i],a="number"==typeof o?o:L(s,t)+1,p=0;p<s.length;p++)if(s[p][0]==t[0]&&s[p][1]==t[1])return!1;return s.splice(a,0,t),ie._setCoords(e,n),q(e),a},hideShape:function(e,t){Array.isArray(e)||(e=[e]);for(var r=0;r<e.length;r++)t.remove(e[r]);e.length=0},snapShape:function(e,t,r){for(var i=e.getArea(),o=e.__.cAreas,n=i._e(),s=r,a=function(e){if(e.id!=i.id&&"AREA"==e.class)for(var r=0,a=ie.getCoords(e);r<a.length;r++){var p=a[r][0],l=n.map.searchPointOnLine(p,t,s,undefined,s);if(l&&!o.find((function(t){return t.area==e})))return{value:l.point}}},p=0,l=i.getProvider().search({point:t,radius:s});p<l.length;p++){var d=a(l[p]);if("object"==typeof d)return d.value}},willSelfIntersect:function(e,t,r){for(var i=0==r?e.length-2:r-1,o=r+1,n=0,s=void 0,a=e.length-1;n<a;n++){if(s=n+1,o==a){if(n&&n<i&&k(t,e[o],e[n],e[n+1]))return!0}else if(n!=o&&r!=(s%=a)&&n!=r&&k(t,e[o],e[n],e[s]))return!0;if(n>r){if((s%=a)!=i&&n!=i&&k(e[i],t,e[n],e[s]))return!0}else if(s<i&&n!=r&&k(e[i],t,e[n],e[s]))return!0}return!1},validateGeometry:function(e){for(var t=1;t<e.length-1;t+=1)if(ie.willSelfIntersect(e,e[t],t))return!1;return!0},getConnectedAreas:function(e,t){for(var r=[],i=e._e(),o=i.getLayer(e),n=function(e){return Math.round(1e9*e)},s=n(t[0]),a=n(t[1]),p=i.objects.getInBBox([t[0],t[1],t[0],t[1]],o),l=p.length;l--;)for(var d=p[l],u=ie.getCoords(d),c=u.length;c--;)for(var h=u[c].length;h--;)for(var f=u[c][h],v=f.length-1;v--;)n(f[v][0])==s&&n(f[v][1])==a&&d!=e&&r.push({area:d,polyIndex:c,lineIndex:h,coordIndex:v,coordinates:u});return r}},oe={dragPlane:"XY"},ne="@ns:com:here:editor",se=function(e,t){var r=e.__||(e.__={b:s({},oe)});return t?r[t]:r},ae=function(e){function r(t,r,i,o,n,s){var a=this;te=s;var p=t._e().getStyle(t);return(a=e.call(this,{type:"Feature",properties:{lineStringIndex:i,index:o,LINE:{properties:t.prop(),style:p,zLayer:n}},geometry:{type:"Point",coordinates:r}})||this)._l=t,a.properties[ne]={selected:a.isSelected()},a}return n(r,e),r.prototype.behavior=function(e,t){var r=se(this,"b");switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];break;case 2:var i={};i[e]=t,e=i}r=s(s({},r),e),e.dragPlane?delete r.dragAxis:e.dragAxis&&delete r.dragPlane,this.__.b=r},r.prototype.getLine=function(){return this._l},r.prototype.getLength=function(){return this._l.geometry.coordinates.length},r.prototype.getIndex=function(){return this.properties.index},r.prototype.getLineStringIndex=function(){return this.properties.lineStringIndex},r.prototype.remove=function(){var e=this.getLine();te.removeCoord(e,this.properties.index,this.properties.lineStringIndex),te.markAsModified(e)},r.prototype.select=function(){var e=this,t=e.getLine(),r=te.private(t,"selectedShapes"),i=e.properties,o=i.lineStringIndex,n=i.index;r[o]||(r[o]=[]),r[o][n]=!0,e.properties[ne].selected=!0,te.displayShapes(t)},r.prototype.unselect=function(){var e=this,t=e.getLine();t._e(),e.properties[ne].selected=!1;var r=te.private(t,"selectedShapes"),i=e.properties,o=i.lineStringIndex,n=i.index;r[o]&&(r[o][n]=!1),te.displayShapes(t)},r.prototype.isSelected=function(){var e,t=te.private(this.getLine(),"selectedShapes"),r=this.properties,i=r.lineStringIndex,o=r.index;return!!(null===(e=t[i])||void 0===e?void 0:e[o])},r.prototype.pointerdown=function(e){var t=this,r=t.properties,i=t.geometry.coordinates,o=e.detail.display,n=t.getLine();r.moved=!1;var s=o.geoToPixel.apply(o,i);r.x=s.x,r.y=s.y,r.button=e.button,r.z=i[2]||0,te.removeShapes(n,"vShps","LINE_VIRTUAL_SHAPE"==t.class&&this),n._e().listeners.trigger(e,this,"pointerdown")},r.prototype.getSelectedShapes=function(e,t){for(var r,i=this.getLine(),o=te.private(i,"selectedShapes"),n=te.private(i,"shps"),s=[],a=0;a<o.length;a++)for(var p=0;p<(null===(r=o[a])||void 0===r?void 0:r.length);p++)o[a][p]&&(arguments.length&&t==a&&e==p||s.push(n[a][p]));return s},r.prototype.pressmove=function(e,r,i){var o=this,n=this.properties,s=n.lineStringIndex,a=n.index,p=o.getLine(),l=p._e(),d=te.getCoordinates(p),u=d[s],c=!l.getStyleProperty(p,"altitude"),h=u[a][2],f=o.geometry.coordinates;n.moved||(n.moved=!0,l.listeners.trigger(e,this,"dragStart"));var v=u[a]=ct(e.mapX,e.mapY,o,f,l);if(c&&"number"==typeof h&&(v[2]=h),this.isSelected())for(var g=l.display,y=g._g2w(f),A=g._g2w(v),m=t.vec3.sub(A,A,y),S=0,_=this.getSelectedShapes(n.index,s);S<_.length;S++){var L=_[S],b=L.properties,k=g._g2w(L.geometry.coordinates);t.vec3.add(k,k,m);var x=g._w2g(k);d[b.lineStringIndex][b.index]=x,L.getProvider().setFeatureCoordinates(L,x)}o.getProvider().setFeatureCoordinates(o,v.slice()),te._setCoords(p,d)},r.prototype.pointerup=function(e){var t=this.getLine(),r=this.properties.moved;r&&te.markAsModified(t),te.displayShapes(t),t._e().listeners.trigger(e,this,r?"dragStop":undefined)},r}(r.Feature);ae.prototype.class="LINE_SHAPE";var pe,le=function(e){function t(t,r,i,o,n,s){return re=s,e.call(this,t,r,i,o,n,s)||this}return n(t,e),t.prototype.pointerdown=function(t){e.prototype.pointerdown.call(this,t)},t.prototype.pressmove=function(t,r,i){var o=this.properties,n=this,s=n.getLine();o.moved||(o.index++,re.addCoord(s,n.geometry.coordinates.slice(),o.index,o.lineStringIndex),re.removeShapes(s,"vShps",n)),e.prototype.pressmove.call(this,t,r,i)},t.prototype.pointerup=function(t){this.getProvider().removeFeature(this),e.prototype.pointerup.call(this,t)},t}(ae);function de(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,highlight:!0,moved:!1,shps:[],vShps:[],selectedShapes:[],isGeoMod:!1}),t?r[t]:r}le.prototype.class="LINE_VIRTUAL_SHAPE";var ue=function(e,t,r){void 0===r&&(r=!1),t&&e.editState(t,r),e._e().setStyle(e,pe)};function ce(e){de(this,"isEditable")&&this._e().listeners.trigger(e,this)}var he,fe,ve,ge,ye,Ae={private:de,_evl:{pointerenter:ce,pointerleave:ce,pointerup:function(e){var t=this,r=de(t);r.isEditable&&(!r.isSelected&&t._e()._config.featureSelectionByDefault&&Ae._select(t),t._e().listeners.trigger(e,t))}},addCoord:function(e,t,r,i){var o,n=Ae.getCoordinates(e,i);if(r==pe){var s=L(n,t);if(!1===s)return s;r=s+1}return n.splice(r,0,t),Ae._setCoords(e,n,i),null===(o=de(e,"selectedShapes")[i])||void 0===o||o.splice(r,0,pe),r},removeCoord:function(e,t,r){var i,o,n=Ae.getCoordinates(e,r),s=n.length;return s>2&&t>=0&&t<s&&(o=n.splice(t,1),null===(i=de(e,"selectedShapes")[r])||void 0===i||i.splice(t,1),Ae._setCoords(e,n,r),Ae.displayShapes(e)),o},createShapes:function(e,t,r,i,o){for(var n=de(e,i),s=n[t]=n[t]||[],a=e._e(),p=a.getZLayer(e)-1,l=a.getStyleProperty(e,"altitude"),d=0;d<r.length;d++){var u=r[d].slice();"number"==typeof l&&(u[2]=l),s[d]=new o(e,u,t,d,p,Ae),a.objects.overlay.addFeature(s[d])}},createVShapes:function(e,t,r){void 0===t&&(t=0);for(var i=[],o=1;o<r.length;o++)i.push(P(r[o-1],r[o],.5));Ae.createShapes(e,t,i,"vShps",le)},displayShapes:function(e){if(de(e,"isSelected")){var t=e.geometry,r=void 0;r="LineString"==t.type?[t.coordinates]:t.coordinates,Ae.removeShapes(e,"shps"),Ae.removeShapes(e,"vShps");for(var i=0;i<r.length;i++)Ae.createShapes(e,i,r[i],"shps",ae),Ae.createVShapes(e,i,r[i])}},removeShapes:function(e,t,r){var i=de(e,t);i.forEach((function(t){t!=r&&e._e().objects.overlay.remove(t)})),i.length=0},deHighlight:function(e){de(e,"isSelected")&&(ue(e,"selected",!1),Ae.removeShapes(e,"shps"),Ae.removeShapes(e,"vShps"))},_editable:function(e,t){var r=de(e);return t!=pe&&(r.isEditable=!!t),Ae.deHighlight(e),r.isEditable},_select:function(e){e._e().objects.selection.select(e)&&(de(e,"selectedShapes").length=0,ue(e,"selected",!0),Ae.displayShapes(e))},isMultiLineString:function(e){return"MultiLineString"==e.geometry.type},getCoordinates:function(e,t){var r=e.coord();return Ae.isMultiLineString(e)||(r=[r]),t>=0?r[t]:r},_setCoords:function(e,t,r){e._e().objects.history.origin(e),de(e).isGeoMod=!0;var i=t;Ae.isMultiLineString(e)?r>=0&&((i=e.coord())[r]=t):"number"!=typeof i[0][0]&&(i=i[0]),e.getProvider().setFeatureCoordinates(e,i)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),Ae.deHighlight(e),e.getProvider().removeFeature(e)},markAsModified:function(e,t){return l(e,de(e),t)}},me=function(e,t){this.offset=e,this.distance=t},Se=function(e,t){for(var r=0,i=0,o=0;o<t.length-1;o++){var n=t[o],s=t[o+1];0!=O(t[o],t[o+1],e)&&(i=r+w(n,e)),r+=w(n,s)}return i/r},_e=function(e,t){for(var r=0,i={lenPntToLine:1/0,lenTotal:0,shp:0},o=0;o<e.length-1;o++){var n=e[o],s=e[o+1],a=x(e[o],e[o+1],t);if(0!=a){var p=w(a,t);p<i.lenPntToLine&&(i.shp=o,i.lenPntToLine=p,i.lenTotal=r+w(n,a))}r+=w(n,s)}var l=0,d={shp:-1,distancePoi:1/0,length:-1};for(o=0;o<e.length;o++){var u=w(e[o],t);o>0&&(l+=w(e[o],e[o-1])),u<d.distancePoi&&(d.shp=o,d.distancePoi=u,d.length=l)}return i.lenPntToLine<d.distancePoi?new me(i.lenTotal/r,i.lenPntToLine):new me(d.length/r,d.distancePoi)},Le=function(e,t,r,i){e.target=r||"display",e._e().listeners.trigger(t,e,i)},be=function(){function e(e,t,r){fe=r,he=t,this.location=e,this.iEditor=e._e()}return e.prototype.updateDisplayedRoutingPoint=function(){var e=this.getLink(),t=this.coord();if(e){var r=e.coord(),i=N(r),o=0^_e(r,t).offset,n=F(r,i*o),s=F(r,i*o+(o<1?1:-1));if(n[0]!=s[0]||s[1]!=n[1]){var a=this.rpFeature;a&&(this.updateStreetLine(),this.iEditor.objects.overlay.setFeatureCoordinates(a,t.slice()))}}},e.prototype.createDisplayedRoutingPoint=function(e,t,r){var i=this,o=this.iEditor;i.rpFeature=i.iEditor.objects.overlay.addPoint(i.routingPoint.slice(),s({type:e,zLayer:t},r));var n=i.rpFeature;return n.pointerdown=function(){i.dragged=!1},n.pressmove=function(e,t,r){var n=i.cLink,s=i.location,a=i.ignoreZ;if(n&&!o._config.editRestrictions(s,1)){i.dragged||(i.dragged=!0,Le(s,e,"routing","dragStart"));var p=o.display.pixelToGeo(e.mapX,e.mapY),l=p.longitude,d=p.latitude,u=o.objects.searchLine([l,d],n.getProvider(),{ignoreZ:a},s.geometry.coordinates);if(u||(u=o.objects.searchLine([l,d],[n],{ignoreZ:a},s.geometry.coordinates)),u){var c=u.line,h=u.point;c!=n&&(fe.defaults(n),fe.displayAsSelected(c,s.id,!0)),i.setRoutingPoint(c,h),i.updateDisplayedRoutingPoint()}}},n.pointerup=function(e){i.dragged&&(he.setRoutingData(i.location),i.updateDisplayedRoutingPoint(),he.markAsModified(i.location)),Le(i.location,e,"routing",i.dragged?"dragStop":ve)},i.rpFeature},e.prototype.updateStreetLine=function(){var e=this.iEditor,t=this.location,r=e.display;if(this.streetLine){var i=t.coord(),o=he.private(t),n=this.coord();if(o.isSelected){var s=e.getStyle(o.selector)[0]||{},a=s.radius||s.width/2,p=s.scaleByAltitude,l=r._g2w(i),d=r._scaleOffsetXYByAltitude(l,p);i=r._w2g(_(l,r._g2w(n),a*d))}e.objects.overlay.setFeatureCoordinates(this.streetLine,[n].concat([i]))}},e.prototype.getLink=function(){return this.cLink},e.prototype.coord=function(){return this.routingPoint},e.prototype.show=function(){var e=this,t=e.cLink,r=e.location,i=e.iEditor;if(t){var o=i.getStyleProperty(r,"altitude"),n=r.class;if(e.ignoreZ=!o,!e.rpFeature){var a=i.display.getLayers().indexOf(i.getLayer(e.getLink()))+1;a=a?a+1:ve;var p={parentType:n};p[n]={altitude:o},e.streetLine=i.objects.overlay.addPath([r.coord().slice(),this.routingPoint.slice()],ve,s(s({},p),{type:n+"_LINE",zLayer:a})),e.rpFeature=this.createDisplayedRoutingPoint(n+"_ROUTING_POINT",a,p)}e.updateDisplayedRoutingPoint(),fe.displayAsSelected(t,r.id)}return e.cLink},e.prototype.hide=function(){var e=this,t=e.rpFeature,r=e.iEditor;t&&(t.pointerdown=t.pressmove=t.pointerup=ve,r.objects.overlay.remove(t),r.objects.overlay.remove(e.streetLine),e.rpFeature=e.streetLine=null)},e.prototype.updateRoutingPoint=function(){var e,t,r=he.getRoutingData(this.location),i=r.link,o=he.getRoutingProvider(this.location),n=r.position;if(this.cLink=this.routingPoint=null,i&&o&&(this.cLink=o.search(i)),this.cLink){if(n){t=this.cLink.coord();for(var s=0;s<t.length-1;s++)if(O(t[s],t[s+1],n,1e-6))return this.routingPoint=n,this.cLink;e=n}else e=this.location.coord();var a=this.iEditor.objects.getNearestLine(e,[this.cLink]);a&&(this.cLink=a.line,this.routingPoint=a.point)}return this.cLink},e.prototype.searchLink=function(){var e=this.iEditor,t=this.location,r=he.getRoutingProvider(t);return r&&e.objects.getNearestLine(t.coord(),r,{maxDistance:e._config.maxRoutingPointDistance})},e.prototype.setRoutingPoint=function(e,t){if(this.routingPoint=this.cLink=null,e)this.cLink=e,this.routingPoint=t;else{var r=this.searchLink();r&&(this.cLink=r.line,this.routingPoint=r.point)}return this.cLink},e.prototype.clearRoutingPoint=function(){this.cLink=this.routingPoint=null,this.hide()},e}(),ke=function(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,allowEdit:!0,isGeoMod:!1,isHovered:!1,cLink:null,moved:!1}),t?r[t]:r};var xe=function(e){return"PLACE"==e.class},Ee=function(e){var t=ke(e);return null==t._rp&&(t._rp=new be(e,Ne,ge)),t._rp};function Ce(e,t){var r=!xe(e),i=Ne.getRoutingData(e).link,o=ke(e);o.isHovered=t;var n=i||r;if(i||r){var s=Ee(e);(s.updateRoutingPoint()||s.setRoutingPoint())&&(o.cLink=s.show(),n&&Ne.setRoutingData(e))}t&&Le(e,t)}function Pe(e,t){var r=ke(e,"cLink");ke(e).isHovered=!t,r&&ge.defaults(r,e.id)&&ge.private(r,"isSelected")&&ge.displayAsSelected(r),t&&Le(e,t),Ee(e).hide()}function Ie(e){var t=this,r=ke(t),i="pointerenter"==e.type;r.allowEdit&&(t.editState("hovered",i),r.isSelected||(i?Ce(t,e):Pe(t,e)))}function Re(e,t,r,i,o){var n=this,s=ke(n),p=n._e();if(s.isSelected&&!p._config.editRestrictions(n,1)){s.moved||Ne.getRoutingData(n).link!=ye&&Ne.connect(n,null),Le(n,e,"display",s.moved?"dragMove":"dragStart");var l=a([],n.geometry.coordinates,!0);p.getStyleProperty(n,"altitude")||(l[2]=0),l=ct(e.mapX,e.mapY,n,l,p),Ne._setCoords(n,l),s.moved=!0,Ee(n).updateStreetLine()}}var we,Oe,Ne={private:ke,setLinkTools:function(e){ge=e},_evl:{pointerenter:Ie,pointerleave:Ie,dbltap:function(e){Le(this,e)},pointerup:function(e){var t=ke(this),r=t.moved,i=this._e();t.allowEdit&&(t.isSelected||(i.dump(this),i._config.featureSelectionByDefault&&Ne._select(this)),r&&(Ee(this).show(),Ne.markAsModified(this)),Le(this,e,"display",r?"dragStop":"pointerup"),t.moved=!1)},pointerdown:function(e){var t=ke(this);t.allowEdit&&(t.isSelected&&(t.moved=!1),Le(this,e,"display","pointerdown"))}},deHighlight:function(e){var t=ke(e);return t.selector&&e._e().objects.overlay.remove(t.selector),t.selector=null,t.isSelected&&(Pe(e),t.pressmove=null,t.isSelected=!1,e.editState("selected",!1),t.cLink&&ge.defaults(t.cLink,e.id)),e},_editable:function(e,t){var r=ke(e);t!=r.allowEdit&&(t||(Ne.deHighlight(e),r.isHovered&&(r.isHovered.type="mouseout",Pe(e,r.isHovered))),r.allowEdit=t)},_select:function(e){e._e().objects.selection.select(e)&&(e.editState("selected",!0),ke(e).pressmove=Re,Ne.highlight(e),Ce(e))},_setCoords:function(e,t){return f._setCoords(e,t)},markAsRemoved:f.markAsRemoved,markAsModified:function(e,t){return l(e,ke(e),t)},_props:function(e,r){var i=arguments.length,o=e.getProvider().getFeatureProperties(e);if(i>1){if(2==i&&"string"==typeof r)return o[r];if(3==i){var n=r;(r={})[n]=arguments[2]}e._e().objects.history.origin(e),t.JSUtils.extend(o,r)}return o},highlight:function(e){var t=ke(e);if(!t.selector){var r={type:e.class+"_SELECTOR",parentType:e.class},i=e._e(),o=i.display.getLayers().indexOf(i.getLayer(e));r[e.class]={altitude:e._e().getStyleProperty(e,"altitude"),zLayer:o},t.selector=e._e().objects.overlay.addCircle(e.geometry.coordinates,ye,r)}},getRoutingProvider:function(e){var t=e._e(),r=e.getProvider().readRoutingProvider(e,t.layers.map((function(e){return e.getProvider()})));return t.getProviderById(r)},getRoutingData:function(e){return e.getProvider().readRoutingPoint(e)},setRoutingData:function(e){var t=Ee(e),r=t.getLink(),i=t.coord(),o=ke(e);o.cLink=r;var n=Number("1e"+e._e()._config.routingPointPrecision),s=function(e){return Math.round(e*n)/n},a=i?[s(i[0]),s(i[1]),0|i[2]]:[],p=Ne.getRoutingData(e),l=p.position||[],d=r?r.id:null;p.link==d&&a[0]==s(l[0])&&a[1]==s(l[1])||(e._e().objects.history.ignore((function(){o.writeProp=!0,e.getProvider().writeRoutingPoint(e,r,i?a:i),delete o.writeProp})),Ne._setCoords(e,e.geometry.coordinates))},connect:function(e,t,r){var i=ke(e);if(!i.writeProp){var o=Ee(e),n=o.getLink(),s=(Ne.getRoutingData(e).position||[]).slice();n&&ge.defaults(n),t?i.cLink=o.setRoutingPoint(t,r):(i.cLink=o.updateRoutingPoint())||!1===t||(i.cLink=o.setRoutingPoint()),(xe(e)||i.cLink)&&Ne.setRoutingData(e),i.isSelected&&(i.cLink?Ce(e):Pe(e));var a=Ne.getRoutingData(e).position||[];n==i.cLink&&s[0]==a[0]&&s[1]==a[1]||Ne.markAsModified(e,!1)}},disconnect:function(e){var t=ke(e);t.writeProp||(Pe(e),Ee(e).clearRoutingPoint(),t.cLink=null,xe(e)||Ee(e).setRoutingPoint(),Ne.setRoutingData(e),Ne.markAsModified(e,!1))},getRoutingPosition:function(e){var t=Ee(e),r=t.coord();return r||(t.updateRoutingPoint(),r=t.coord()),r&&[r[0],r[1],r[2]||0]||ye}},Fe=function(){function e(e,t,r,i){}return e.prototype.isPntInFence=function(){return!0},e.prototype.isHidden=function(){return!0},e.prototype.remove=function(){},e}(),Te="@ns:com:here:editor",Me=function(e){return e.__||(e.__={})};function De(e,t){Me(this).line._e().listeners.trigger(e,this,t)}function Be(e){var t=this,r=(o=Me(t)).line,i=r._e();o._cls=o.cLinks.map((function(e){return e.link})),o.drg=!1;var o,n=this.geometry.coordinates,s=i.display.geoToPixel.apply(i.display,n);(o=Me(t)).x=s.x,o.y=s.y,o.z=n[2],i.dump(t),we.removeShapePnts(r,!0),i.listeners.trigger("_clearOverlay"),we.hideDirection(r),Oe=new Fe(i,n[0],n[1]),De.call(t,e,"pointerdown")}function je(e,r,i){var o=this,n=Me(o),s=n.line,a=s._e(),p=a._config,l=we.ignoreZ(s),d=o.geometry.coordinates.slice(0,l?2:3),u=ct(e.mapX,e.mapY,o,d,a);if(!p.editRestrictions(s,1))if(Oe.isPntInFence(u)){if(!Oe.isHidden()&&Oe.hide(),p.snapOnDrag&&s.behavior("snapCoordinates")&&(u=we.snapShape(o,u,l,p.snapTolerance)||u),we.moveShapeAtIndexTo(s,n.index,u),this.isSelected())for(var c=a.display,h=c._g2w(d),f=c._g2w(u),v=t.vec3.sub(f,f,h),g=0,y=function(e,t){for(var r=we.private(e,"selectedShapes"),i=we.private(e,"shps"),o=[],n=0;n<r.length;n++)!r[n]||void 0!==t&&t==n||o.push(i[n]);return o}(s,n.index);g<y.length;g++){var A=y[g],m=c._g2w(A.geometry.coordinates);t.vec3.add(m,m,v);var S=c._w2g(m);we.moveShapeAtIndexTo(s,Me(A).index,S)}n.drg||(n.drg=!0,De.call(o,e,"dragStart"))}else Oe.isHidden()&&Oe.show()}function Ge(e){var t,r,i=Me(this),o=i.index,n=i.drg,s=!1,a=i.line,p=!1,l=!1,d=i.cLinks;i._cls=null,n&&("boolean"==typeof(r=we.fixGeo(a,o))?p=!r:(p=r>=0,(l=o!=r)&&(o=r))),we.showDirection(a),a.behavior("snapCoordinates")&&Oe.isHidden()&&!p&&n&&(t=function(e,t){var r,i,o=e.coord()[t],n=we.ignoreZ(e),s=e.getConnectedLinks(t),a=e._e();return s.push(e),null!=(r=a.objects.getNearestLine(o,e.getProvider(),{maxDistance:a._config.snapTolerance,ignore:function(e){return"NAVLINK"==e.class&&(-1!=s.indexOf(e)||!e.behavior("snapCoordinates"))},ignoreZ:n}))&&((i=r.point)[2]||(i[2]=0),null===we.connectShpToLink(e,t,r=r.line,i,void 0,n)&&(r=null)),r}(a,o)),t||(n&&((!1===r?d:a.getConnectedLinks(o,!0)).forEach((function(e){var t=we.fixGeo(e.link,e.index);l="number"==typeof t||!t||l,we.markAsModified(e.link,!1,!1)})),s=!0),we.createAddShapePnts(a)),Oe&&Oe.remove(),i.drg=!1,(l||n)&&we.refreshGeometry(a),a._e().listeners.trigger(e,a.editState("removed")?this:we.private(a,"shps")[o],n?"dragStop":void 0),s&&we.markAsModified(a,!0,!1)}function ze(){var e=Me(this);document.body.style.cursor="default",e.cLinks.forEach((function(e){we.defaults(e.link)})),delete this.properties[Te].hovered,e.line._e().setStyle(this)}function Ke(){var e=Me(this),t=e.line._e();document.body.style.cursor="move",e.cLinks.forEach((function(e){for(var r=t.getStyle(e.link),i=0;i<r.length;i++)r[i].opacity=.5;t.setStyle(e.link,r)})),this.properties[Te].hovered=!0,t.setStyle(this)}var He,Ve=function(e){function r(r,i,o,n){var s;we=n;var a=r._e(),p=r.getConnectedLinks(o,!0),l=0==o||o==r.geometry.coordinates.length-1,d={type:"Feature",geometry:{type:"Point",coordinates:i.slice()},properties:{isNode:l,isConnected:!!p.length,NAVLINK:{properties:t.JSUtils.extend(!0,{},r.properties),style:a.getStyle(r)},parent:r,"@ns:com:here:editor":{selected:!!we.private(r,"selectedShapes")[o]}}};s=e.call(this,d,a.objects.overlay.layer.getProvider())||this;var u=Me(s);return u.index=o,u.line=r,u.drg=!1,u.cLinks=p,u.dblclick=De,u.pressmove=je,u.pointerdown=Be,u.pointerup=Ge,a._config.editRestrictions(r,1)||(u.pointerenter=Ke,u.pointerleave=ze),s}return n(r,e),r.prototype.behavior=function(e,t){var r=we.private(this,"b")||s({},oe);switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];break;case 2:var i={};i[e]=t,e=i}r=s(s({},r),e),e.dragPlane?delete r.dragAxis:e.dragAxis&&delete r.dragPlane,this.__.b=r},r.prototype.getLink=function(){return this.properties.parent},r.prototype.isNode=function(){return this.properties.isNode},r.prototype.isOverlapping=function(){return we.checkOverlapping(this.properties.parent,this.getIndex())},r.prototype.getIndex=function(){return Me(this).index},r.prototype.editTurnRestrictions=function(){if(this.isNode())return this.getLink().editTurnRestrictions(this.getIndex())[0]},r.prototype.getConnectedLinks=function(){return this.getLink().getConnectedLinks(this.getIndex())},r.prototype.remove=function(){var e=this.getLink();e._e()._config.editRestrictions(e||this,2)||we.deleteShape(e,this)},r.prototype.disconnect=function(){var e=Me(this),r=e.line._e();if(this.isNode()&&e.cLinks.length){var i=e.line,o=e.index,n=i.coord(),s=n[o],a=n[o+(o?-1:1)],p=90-t.geotools.calcBearing(s,a),l=r.map.movePoint(s,r._config.disconnectShapeDistance,p);r.hooks.trigger("Navlink.disconnect",{link:i,index:o},i.getProvider()),n[o][0]=l[0],n[o][1]=l[1],we._setCoords(i,n),we.fixGeo(i),we.refreshGeometry(i),we.markAsModified(i)}},r.prototype.select=function(){var e=this,t=e.getLink();we.private(t,"selectedShapes")[Me(e).index]=!0,e.properties[Te].selected=!0,we.refreshGeometry(t)},r.prototype.unselect=function(){var e=this,t=e.getLink();e.properties[Te].selected=!1,we.private(t,"selectedShapes")[Me(e).index]=!1,we.refreshGeometry(t)},r.prototype.splitLink=function(){var e,t=this.getLink(),r=t._e();return this.isNode()||(e=r.objects.splitLinkAt({link:t,index:this.getIndex()})).length&&r.objects.history.saveChanges(),e},r.prototype.isSelected=function(){return!!we.private(this.getLink(),"selectedShapes")[Me(this).index]},r}(r.Feature);Ve.prototype.class="NAVLINK_SHAPE";var Ue,Ye=function(e){function r(r,i,o,n){var s,a,p=r._e(),l=p.display;var d=s=e.call(this,{type:"Feature",geometry:{type:"Point",coordinates:i.slice()},properties:{type:"NAVLINK_VIRTUAL_SHAPE",NAVLINK:{properties:t.JSUtils.extend(!0,{},r.properties),style:p.getStyle(r)},parent:r}},p.objects.overlay.layer.getProvider())||this;return d.pointerdown=function(){var e=d.properties.parent,t=d.geometry.coordinates;d.moved=!1,n.hideDirection(e);var r=l.geoToPixel.apply(l,t);a=new Fe(p,d.x=r.x,d.y=r.y,d.z=t[2])},d.pressmove=function(e,t,r,i,s){var p=d.properties.parent,l=d.geometry.coordinates.slice();if(a.isPntInFence(l)){a.isHidden()||a.hide();var u=n.private(p,"shps");if(!d.moved){n.addShp(p,l,o,!1,!0),n.removeShapePnts(p,!0,d.id),d.pointerenter=d.pointerleave=He,d.moved=!0;var c=u[o];c.x=d.x,c.y=d.y,c.z=d.z,c.__.pointerdown.apply(c,arguments)}var h=u[o];h.__.pressmove.apply(h,arguments)}else a.isHidden()&&a.show()},d.pointerup=function(e){var t=d.properties.parent,r=n.private(t);if(d.moved){var i=r.shps[o];i.__.pointerup.call(i,e),this.getProvider().removeFeature(this)}else r.isSelected&&n.showDirection(t)},p._config.editRestrictions(r,1)||(d.pointerenter=d.pointerleave=function(e){var t="pointerenter"==e.type;document.body.style.cursor=t?"move":"default",this.properties["@ns:com:here:editor"].hovered=t,p.setStyle(this)}),s}return n(r,e),r.prototype.getLink=function(){return this.properties.parent},r}(r.Feature),Ze=function(){},Je=function(e,t){var r=e.__;return r||(r=e.__={isSelected:!1,isEditable:!0,allowEdit:!0,shps:[],vShps:[],selectedShapes:[],isHovered:null,_cPnt:null,arrows:null,prevBBox:null,isGeoMod:!1,dh:null,xt:null}),t?r[t]:r};function We(e,r){var i=arguments.length,o=e.getProvider().getFeatureProperties(e);if(i>1){if(2==i&&"string"==typeof r)return o[r];if(3==i){var n=r;(r={})[n]=arguments[2]}e._e().objects.history.origin(e),t.JSUtils.extend(o,r)}return o}function Qe(e){var t=this,r=e.type;Je(t,"allowEdit")&&t._e()._config.featureSelectionByDefault&&("dbltap"==r||"pointerup"==r)&&ot._select(t),t._e().listeners.trigger(e,t)}function Xe(e,t){if(t)for(var r in t)e.editState(r,t[r]);e._e().setStyle(e,"default")}function qe(e){var r=Je(e);return ot.getConnectedObjects(e,t.geotools.mergeBBoxes(r.prevBBox=r.prevBBox||e.bbox.slice(),e.bbox))}function $e(e,t){Je(e).isGeoMod=!0,e._e().objects.history.origin(e),e._provider.setFeatureCoordinates(e,t)}function et(e,t){if(e._e().objects.overlay.remove(t),t.class){for(var r in t)"id"!=r&&"type"!=r&&"class"!=r&&"properties"!=r&&"geometry"!=r&&(t[r]=Ue);t.isDeleted=!0}}function tt(e,t){var r=e.__.ol;e.properties.isOverlapping=t,r!=(e.__.ol=t)&&e.getLink()._e().setStyle(e,Ue)}function rt(e){e.listeners.trigger("featureUnselected",{featureUnselected:!0})}function it(e){var t=this,r=Je(t);r.allowEdit&&(document.body.style.cursor="default",Qe.call(t,e),r.isSelected||function(e){for(var t=ot.getConnectedObjects(e),r=0;r<t.length;r++)if(Ne.private(t[r],"isSelected"))return!0}(t)||Xe(t,{hovered:!1}),r.isHovered=null)}var ot={private:Je,_evl:{pointerenter:function(e){var t=this,r=Je(t);r.allowEdit&&(document.body.style.cursor="Pointer",r.isHovered=e,Qe.call(t,e),Xe(t,{hovered:!0}))},pointerleave:it,dbltap:Qe,pointerup:Qe},deHighlight:function(e){return Je(e,"isSelected")&&(Xe(e,{selected:!1,hovered:!1}),ot.removeShapePnts(e),ot.hideDirection(e)),e},_editable:function(e,t){var r=Je(e);if(t!=r.allowEdit){if(!t){var i=r.isHovered;i&&(i.type="mouseout",it.call(i.target,i)),ot.deHighlight(e)}r.allowEdit=t}},_select:function(e){Je(e,"isSelected")||(Je(e,"selectedShapes").length=0,e._e().objects.selection.select(e),e._e().dump(e,"info"),ot.refreshGeometry(e))},_setCoords:function(e,t){for(var r=t.length;r--;)t[r][2]=t[r][2]||0;qe(e),$e(e,t),ot.refreshGeometry(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),ot.hideDirection(e),qe(e).forEach((function(e){Ne.disconnect(e)})),ot._editable(e,!1);var t=e.coord(),r=t[0],i=t[t.length-1];r[0]==i[0]&&r[1]==i[1]&&(t[0][0]+=1e-5,t[0][1]+=1e-5,$e(e,t))},markAsModified:function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=!0);var i=e.editState("modified"),o=Je(e);if(o.isGeoMod){var n=e.coord();qe(e).forEach((function(t){var r=F(n,N(n)*_e(n,Ne.getRoutingPosition(t)).offset);Ne.connect(t,e,r)}))}return l(e,o,t),i||(Xe(e),!o.isSelected&&r&&ot.defaults(e)),e},ignoreZ:function(e){return!e._e().getStyleProperty(e,"altitude")},_props:We,getConnectedObjects:function(e,r){var i=e._e();return i.objects.getInBBox(t.geotools.extendBBox(r||e.bbox,i._config.maxRoutingPointDistance)).filter((function(t){var r=t.class;if("PLACE"==r||"ADDRESS"==r)return t.getLink()==e}))},refreshGeometry:function(e){ot.removeShapePnts(e),Je(e,"isSelected")&&(ot.displayAsSelected(e),ot.showDirection(e),ot.createShapes(e),ot.createAddShapePnts(e))},checkOverlapping:function(e,t){var r=e.coord(),i=t==Ue,o=i?1:t,n=i?r.length-1:o+1,s=[];n==r.length&&n--;for(var a,p=e._e().objects.getInBBox(e.bbox,e.getProvider()),l=p.length;l--;)if((a=p[l]).id!=e.id&&"NAVLINK"==a.class)for(var d=o;d<n;d++)for(var u=0,c=a.coord();u<c.length;u++)if(r[d][0]==c[u][0]&&r[d][1]==c[u][1]){s.push(d);break}return i?s:!!s.pop()},createLinkShape:function(e,t,r){return e._e().objects.overlay.addFeature(new Ve(e,t,r,ot))},createShapes:function(e){var t=Je(e,"shps"),r=e.geometry.coordinates,i=r.length;if(!e.editState("removed")){var o=ot.checkOverlapping(e);if(t.length)t.forEach((function(t,r){t.__.cLinks=e.getConnectedLinks(r,!0)}));else for(var n=0;n<i;n++){var s=ot.createLinkShape(e,a([],r[n],!0),n);tt(s,o.indexOf(n)>=0),t[n]=s}}},createAddShapePnts:function(e){var t=Je(e,"vShps");if(!t.length&&!e.editState("removed")&&!e._e()._config.editRestrictions(e,1))for(var r=e.geometry.coordinates,i=1,o=void 0,n=void 0;i<r.length;i++)o=r[i-1],n=r[i],t.push(e._e().objects.overlay.addFeature(new Ye(e,P(o,n,.5),i,ot)))},removeShapePnts:function(e,t,r){function i(t){for(var i=0;i<t.length;i++)t[i].id!=r&&et(e,t[i]);t.length=0}var o=Je(e),n=o.vShps;return t||i(o.shps),(n.length||t)&&i(n),e},moveShapeAtIndexTo:function(e,t,r,i){var o=e.coord(),n=Je(e,"shps"),s=(r=a([],r,!0))[0],p=r[1],l=r[2],d=o[t][0]!=s||o[t][1]!=p||(o[t][2]||0)!=(l||0);o[t][0]=s,o[t][1]=p,"number"==typeof l&&(o[t][2]=l),qe(e),$e(e,o),ot.hideDirection(e);var u=n[t];return!i&&u&&(e._e().objects.overlay.setFeatureCoordinates(u,r),u.__.cLinks.forEach((function(t){var i=t.link;!e._e()._config.editRestrictions(i,1)&&ot.moveShapeAtIndexTo(i,t.index,r)})),tt(u,ot.checkOverlapping(e,t))),d},deleteShape:function(e,t,r){var i="number"==typeof t?t:t.getIndex(),o=e.coord();if(o.length>2){o.splice(i,1);var n=Je(e),s=n.shps;s.length&&(et(e,s[i]),s.splice(i,1),s.forEach((function(e){e.__.index-=Number(e.getIndex()>=i)})),Je(e,"selectedShapes").splice(i,1)),qe(e),$e(e,o);var a=e.getZLevels();a.splice(i,1),e._e().objects.history.ignore((function(){e.getProvider().writeZLevels(e,a)})),r||ot.markAsModified(e),n.isSelected&&ot.refreshGeometry(e)}},showDirection:function(e){if(!e.editState("removed")){var r=(""+e.getProvider().readDirection(e)).toUpperCase(),i=void 0,o=void 0,n=void 0,s=void 0,a=void 0;if(ot.hideDirection(e),"START_TO_END"==r?s=90:"END_TO_START"==r&&(s=-90),s!=Ue){var p=Je(e).arrows=[];i=e.geometry.coordinates;for(var l=0;l<i.length-1;l++)o=i[l],n=i[l+1],a=t.geotools.calcBearing(o,n)-s,p.push(e._e().objects.overlay.addPoint(P(o,n,.5),{type:"NAVLINK_DIRECTION",bearing:a}))}}return e},displayAsSelected:function(e,t,r){var i=Je(e);i.isSelected||(i._cPnt=t),Xe(e,{selected:!0})},addShp:function(e,t,r,i,o,n){var s=e.coord(),a=e._e(),p=ot.ignoreZ(e),l=a.map.searchPointOnLine(s,t,a._config.snapTolerance,n,Ue,p);if(r="number"==typeof r?r:null==l?void 0:l.index,!(null==l?void 0:l.existingShape)||o){var d=e.getZLevels();(null==l?void 0:l.existingShape)&&(r=L(s,t)+1),a.map.clipGeoCoord(t),s.splice(r,0,t),function(e,t){for(var r=We(e,"bn")||[],i=0;i<r.length;i++)r[i]+=r[i]>=t}(e,r),qe(e),$e(e,s);var u=Math.round(t[2]<10&&t[2])||0;d.splice(r,0,u),a.objects.history.ignore((function(){e.getProvider().writeZLevels(e,d)}));var c=Je(e,"shps");c.length&&(c.splice(r,0,ot.createLinkShape(e,t,r)),c.forEach((function(e){e.__.index+=Number(e.getIndex()>r)})),c.forEach((function(t){tt(t,ot.checkOverlapping(e,t.getIndex()))})),Je(e,"selectedShapes").splice(r,0,!1)),ot.refreshGeometry(e)}else if(!i)return!1;return r},snapShape:function(e,t,r,i){for(var o,n=e.getLink(),s=Je(e),a=n._e(),p=n.getProvider().search({point:t,radius:i}),l=p.length;o=p[--l];)if("NAVLINK"==o.class&&o.id!=n.id&&-1==s._cls.indexOf(o)&&o.behavior("snapCoordinates")){var d=a.map.searchPointOnLine(o.geometry.coordinates,t,i,Ue,i,r);if(d)return d.point}},defaults:function(e,t){var r=Je(e);return(!t||t==r._cPnt)&&(r._cPnt=null,Xe(e,{selected:!1,hovered:!1}),e)},hideDirection:function(e){var t=Je(e,"arrows");if(t){for(var r=0;r<t.length;r++)e._e().objects.overlay.remove(t[r]);t.length=0}return e},fixGeo:function(e,t,r,i){return nt(e,t,r,i)},connectShpToLink:function(e,t,r,i,o,n){void 0===n&&(n=ot.ignoreZ(e));var s,a=new Ze,p=e._e().objects;if(r.id!=e.id){var l=function(e,t,r,i,o,n){var s=e._e(),a=e.coord(),p=null,l=e.getConnectedLinks(t,!0),d=i[0],u=i[1],c=i[2],h=s._config.snapTolerance,f=s.map.searchPointOnLine(r.coord(),i,h,o,Ue,n);if(a[t][0]=d,a[t][1]=u,a[t][2]=c||0,ot._setCoords(e,a),f){var v=s.map.clipGeoCoord(f.point),g=f.existingShape;p=s.objects.splitLinkAt(g?{link:r,index:f.index,avoidSnapping:!0,ignoreZ:n}:{link:r,point:v,preferSegment:o,avoidSnapping:!0,ignoreZ:n}),ot.moveShapeAtIndexTo(e,t,v),l.forEach((function(e){var t=e.link;ot.moveShapeAtIndexTo(t,e.index,v),nt(t,e.index),ot.markAsModified(t,!1,!1),ot.defaults(t)}))}return p}(e,t,r,i,o,n);if(null===l)return null;t>0&&t<e.geometry.coordinates.length-1&&(Je(e,"isSelected")&&rt(e._e()),ot.deHighlight(e),s=p.splitLinkAt({link:e,index:t}));var d=e.geometry.coordinates;2==d.length&&d[0][0]==d[1][0]&&d[0][1]==d[1][1]&&p.remove(e),ot.markAsModified(e),Je(e,"isSelected")&&ot.refreshGeometry(e),l&&(a.targetSplittedInto=l),s&&(a.splittedInto=s)}return a},isIntersection:function(e,t,r,i){var o=Math.pow(10,e._config.intersectionScale),n=function(e){return Math.round(e*o)};return n(t[0])==n(r[0])&&n(t[1])==n(r[1])&&(i||n(t[2]||0)==n(r[2]||0))}};function nt(e,t,r,i){var o=e._e(),n=o.objects,s=!r,a=t||0,p=e.getZLevels(),l=p.length,d=t===Ue?l:a+1,u=!0,c=o._config.snapTolerance;function h(a){if(i==a)return!0;function l(e){return 0==e||e==g-1}function d(t){for(var r=e.getConnectedLinks(t,!0),i=0,o=r;i<o.length;i++){var n=o[i],s=n.link,a=n.index;ot.moveShapeAtIndexTo(s,a,h,!0)&&ot.markAsModified(s,!1)}return r}for(var u,h,f=e.coord(),v=Je(e),g=f.length,y=!1,A=!1,m=function(i){if(a!=i&&function(e,t,r,i,n){return void 0===n&&(n=1),Number(r)==Number(i)&&o.map.distance(e,t)<=n}(f[i],f[a],p[i],p[a],c)){if(u=Math.abs(a-i)-1,l(i)&&l(a)?1==u?y=a:A=i:l(a)?u<=1?y=a:A=i:l(i)?(1==u&&a>i&&(y=i),0==u?y=a:u>0?A=a:y=i):0==u?y=a:A=i,!1!==A){var m,S,_=void 0;if(h=f[A],2==g){var L=d(t);ot.moveShapeAtIndexTo(e,a==A?i:a,h),rt(e._e()),n.remove(ot.deHighlight(e)),L.forEach((function(e){s||nt(e.link,e.index)}))}else d(a),ot.moveShapeAtIndexTo(e,a,h),(S=n.splitLinkAt({link:e,index:A===g-1||0===A?~~(g/2):A})).forEach((function(t,i){nt(t,Ue,r.concat(e,S[Number(0==i)]))})),!(_=S[Number(a>=A)]).editState("removed")&&Math.abs(a-A)>=2&&(_.coord().forEach((function(e,t){e[0]==h[0]&&e[1]==h[1]&&(m=t)})),m&&n.splitLinkAt({link:_,index:m}));return{value:!1}}if(!1!==y){var b=f[i][0],k=f[i][1],x=!1;e.getConnectedLinks(y,!0).forEach((function(e){var t,i=e.link;ot.markAsModified(i,!1),ot.moveShapeAtIndexTo(i,e.index,[b,k],!0),t=i,x=!(s||-1!=r.indexOf(t))})),ot.moveShapeAtIndexTo(e,a==i?i:a,[b,k],!0),ot.deleteShape(e,y,!0),l(y)&&(!l(a)&&a-1>0&&ot.moveShapeAtIndexTo(e,a-1,[b,k],!0),v.isSelected&&ot.refreshGeometry(e),x&&f.length>2&&n.splitLinkAt({link:e,index:i-Number(0===y)}));var E=a-i,C=void 0;return E>0?C=a-1-u:E<0&&(C=a+u),{value:C}}}},S=0;S<g;S++){var _=m(S);if("object"==typeof _)return _.value}return!0}if(c==Ue&&(c=2),!e.editState("removed")&&a<l)for(r=s||!r?[]:r;a<d&&!0===(u=h(a));a++);return u}var st={MARKER:f,AREA:ie,LINE:Ae,NAVLINK:ot,PLACE:Ne,ADDRESS:Ne};Ne.setLinkTools(ot);var at=function(e){return function(t){var r=t.class,i=st[r][e];if(i)return i.apply(i,arguments)}},pt={getTools:function(e){return st[e.class]},getTool:function(e,t){var r=this.getTools(e);return r&&t?r[t]:r},private:at("private"),getEventListener:function(e,t){var r=this.getTools(e);return r?r._evl[t]||r.private(e,t):e.__&&e.__[t]||e[t]}};for(var lt in st)for(var dt in st[lt])pt[dt]||(pt[dt]=at(dt));var ut,ct=function(e,r,i,o,n,s){void 0===s&&(s=function(e){var t=function(t,r){var i=e.behavior&&e.behavior(t);if(i)return"string"==typeof i&&(i=r[i.split("").sort().join("").toUpperCase()]),i},r=t("dragPlane",{XY:[0,0,1],XZ:[0,1,0],YZ:[1,0,0]});if(r)return{plane:r};var i=t("dragAxis",{X:[1,0,0],Y:[0,1,0],Z:[0,0,1]});return i?{axis:i}:{plane:[0,0,1]}}(i));var a,p=(n=n||i._e()).display,l=p._unprj(e,r,-1),d=p._unprj(e,r,0),u=t.vec3.sub([],d,l),c=p._g2w(o),h=void 0===o[2];if(s.plane)a=C(u,l,s.plane,c);else{var f=s.axis,v=p._prj(c)[2],g=c,y=t.vec3.add([],c,f),A=p._unprj(e,r,v),m=t.vec3.normalize([],t.vec3.cross([],t.vec3.sub([],A,y),t.vec3.sub([],g,y))),S=C(u,l,m,c);if(S){var _=t.vec3.add([],c,f);a=E(_,c,S)}}return a&&((o=n.map.clipGeoCoord(p._w2g(a),!0))[2]<0&&(o[2]=0),h&&0===o[2]&&o.pop()),o},ht=function(){},ft=ht.prototype;ft.created=!1,ft.modified=!1,ft.removed=!1,ft.split=!1,ft.selected=!1,ft.hovered=!1;var vt=function(e){return 3==e.length?[e[0],e[1],e[2]]:[e[0],e[1]]},gt=function(e){for(var t=[],r=0;r<e.length;r++)for(var i=e[r],o=t[t.length]=[],n=0;n<i.length;n++)o[n]=vt(i[n]);return t},yt=function(e){function r(t,r){var i=e.call(this,t,r)||this;return i.properties=i.properties||{},i.properties["@ns:com:here:editor"]=new ht,i}return n(r,e),r.prototype.toString=function(){return this.class+" 🌎 "+this.id},r.prototype.getProvider=function(){return this._provider},r.prototype._e=function(){return this._provider._e},r.prototype._t=function(e){return e?pt.getTool(this,e):pt.getTools(this)},r.prototype.editState=function(e,t){var r=arguments.length,i=this,o=i.properties["@ns:com:here:editor"];if(!r)return o;if(2==r){if(this._esu)return;t?o[e]=t:delete o[e],"hovered"!=e&&"selected"!=e&&i._e().objects.history.ignore((function(){i._esu=!0,i.getProvider().writeEditState(i,e),i._esu=ut}))}return o[e]},r.prototype.style=function(e){var t=this;if("string"==typeof e||0==arguments.length)return this._e().getStyle(t,ut);this._e().setStyle(t,e,!0)},r.prototype.prop=function(e,r){var i=this,o=!1,n=arguments.length,s=i.getProvider().getFeatureProperties(i);if(!n||1==n&&"string"==typeof e)return"object"==typeof(e=e?s[e]:s)?t.JSUtils.extend(!0,new e.constructor,e):e;if(2==n){var a={};a[e]=arguments[1],e=a}for(var p in e){var l=e[p],d="object"==typeof l,u=s[p];(d&&JSON.stringify(l)!=JSON.stringify(u)||!d&&u!==l)&&(o||(this._e().objects.history.origin(i),o=!0),s[p]=l)}o&&(this._e().setStyle(i),pt.markAsModified(i))},r.prototype.getCoordinates=function(){return this.coord()},r.prototype.coord=function(e){var t=this,r=t.geometry.type;if(!(e instanceof Array))return e=t.getProvider().decCoord(t),"Point"==r?vt(e):"Polygon"==r||"MultiLineString"==r?gt(e):"MultiPolygon"==r?e.map((function(e){return gt(e)})):gt([e])[0];pt.deHighlight(t),pt._setCoords(t,e),pt.markAsModified(t)},r.prototype.editable=function(e){return pt._editable(this,e),this.unselect(),this},r.prototype.select=function(){pt._select(this)},r.prototype.unselect=function(){pt.private(this,"isSelected")&&this._e().objects.selection.clearSelected()},r.prototype.transform=function(){this._e().transformer.show(this)},r.prototype.remove=function(){this._e().objects.remove(this,{save:!0})},r}(r.Feature);yt.prototype.id=null;var At=null,mt=function(e,t,r,i,o,n,s){this.type=e,this.timeStamp=Date.now(),this.mapX=t,this.mapY=r,this.nativeEvent=i,this.button=o,this.target=n,this.detail=s},St=mt.prototype;St.nativeEvent=At,St.detail=At,St.target=At,St.mapX=At,St.mapY=At,St.type=At,St.button=At,St.timeStamp=At,St.toString=function(){return"EditorEvent "+this.type};var _t=function(e){function r(r,i,o,n,s){var a=e.call(this,{type:"Feature",geometry:{type:"Point",coordinates:n},properties:{"@ns:com:here:editor":{},index:o,isMoved:!1}},r.overlay.getProvider())||this,p=r.getFeature().geojson,l=a,d=s.toUpperCase();return l.properties[d]={properties:t.JSUtils.extend(!0,{},p.properties),style:i.getStyle(p)},l._b=r,l.__={pointerdown:function(){this.properties.isMoved=!1,this.properties.p=i.display.geoToPixel.apply(i.display,this.geometry.coordinates)},pressmove:function(e,t,o,n,s){var a=this,p=this.properties.p,l=i.map.getGeoCoord(p.x+t,p.y+o);r.getFeature().update(this.properties.index,l),a._provider.setFeatureCoordinates(a,l.slice()),a.isMoved=!0},pointerup:function(e){this.properties.isMoved||i.listeners.trigger(e,this)}},a.class=d+"_SHAPE",a}return n(r,e),r.prototype.remove=function(){var e=this;e.__=null,e._b.removeShape(e.properties.index)},r.prototype.getLength=function(){return this._b.getLength()},r.prototype.getIndex=function(){return this.properties.index},r}(r.Feature),Lt=function(){function e(e,t){this.type="LineString",this.path=[],this.geojson=e.addFeature({type:"feature",geometry:{type:"LineString",coordinates:[t,[t[0]-1e-6,t[1]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}return e.prototype.update=function(e,t){var r=this.path;t&&(r[e]=t),r.length>1&&this.overlay.setFeatureCoordinates(this.geojson,this.createGeo(r))},e.prototype.removeAt=function(e){this.path.splice(e,1)},e.prototype.createGeo=function(e){if(e.length>1)return e.slice()},e.prototype.isValid=function(e){return!!e||this.path.length>1},e}(),bt=function(){function e(e,t){this.path=[],this.type="MultiPolygon",this.geojson=e.addFeature({type:"feature",geometry:{type:"MultiPolygon",coordinates:[[[t,[t[0]-1e-6,t[1]],[t[0]-1e-6,t[1]-1e-6],t]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}return e.prototype.update=function(e,t){var r=this.path;if(t&&(r[e]=t),r.length>2){var i=this.createGeo(r);i&&this.overlay.setFeatureCoordinates(this.geojson,i)}},e.prototype.createGeo=function(e){if(e.length>2)return[[e.concat([e[0]])]]},e.prototype.removeAt=function(e){this.path.splice(e,1)},e.prototype.isValid=function(e){return e?(e.push(e[0].slice()),e.length<4||ie.validateGeometry(e)):this.path.length>2},e}(),kt=[{type:"Circle",zIndex:0,stroke:"#FFFFFF",fill:"#000000",strokeWidth:2,radius:6}],xt=[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#ffffff"}];function Et(e,r){var i=t.JSUtils.clone(e||kt);return i.forEach((function(e){return e.zIndex=(0^e.zIndex)+r})),i}var Ct,Pt=function(){function e(e,t,r){this.shapes=[],this.originLink=null,this.originPos=null;var i=this;i.overlay=e,i.iEdit=t,i.display=r,i.onBoardUp=i.onBoardUp.bind(i),i.updateCursor=i.updateCursor.bind(i)}return e.prototype.onBoardUp=function(){this.mousedown=!1},e.prototype.updateCursor=function(e){var t=this,r=t.iEdit,i=t.feature,o=t.shapes,n=t.display,a=t.cursor,p=t.mousedown,l=t.overlay;if(p){var d=r.map.getEventsMapXY(e),u=a.properties.prevPos;n.lockViewport().pan||n.pan(d[0]-u[0],d[1]-u[1],0,0),u[0]=d[0],u[1]=d[1]}else{var c=r.map.getGeoCoord(r.map.getEventsMapXY(e)),h=o.map((function(e){return e.geometry.coordinates}));h.push(c);var f=i.isValid(h);if(f!=!this.inValid){var v=this.style.feature;f?(v=this.inValid,this.inValid=!1):(this.inValid=v,v=[s(s({},v[0]),{fill:"rgba(0,0,0,0)"})]),r.setStyle(i.geojson,v)}i.update(o.length,c),l.setFeatureCoordinates(a,c)}},e.prototype.init=function(){var e=this,r=e.iEdit,i=e.display,o=e.overlay,n=e.updateCursor,s=i.getViewBounds(),a=[s.minLon,s.maxLat];this.feature=new this.FeatureClass(o,a);var p=o.addCircle(a,Et(kt,1));p.pointerdown=function(t){var i=p.properties;i.prevPos=r.map.getEventsMapXY(t),e.mousedown=!0,i.panned=!1},p.pressmove=function(e){n(e),p.properties.panned=!0},p.pointerup=function(t){p.properties.panned||e.addShape(r.map.getGeoCoord(t.mapX,t.mapY),Ct,t),e.onBoardUp()},this.cursor=p,this.inValid=!1,t.global.addEventListener("mousemove",this.updateCursor),t.global.addEventListener("mouseup",this.onBoardUp)},e.prototype.addShape=function(e,t,r){var i,o=this,n=o.iEdit,s=o.settings,a=o.shapes,p=o.feature;if(t){if(this.originLink=t,i=t.geometry.coordinates,"number"==typeof e)e=i[e].slice(0);else{var l=n.map.searchPointOnLine(i,e,n._config.snapTolerance);!(null==l?void 0:l.existingShape)||0!=l.index&&l.index!=i.length-1||(this.originLink=null),e=null==l?void 0:l.point}this.originPos=e}var d=this.overlay.addFeature(new _t(this,n,a.length,e,s.mode),Et(this.style.shape,9));return p.update(a.length,e),a.push(d),s.onShapeAdd&&s.onShapeAdd(new mt("onShapeAdd",e[0],e[1],r,r&&r.button,d,{index:d.properties.index})),d},e.prototype.setGeom=function(e,t){var r=this.settings;if(e==this.feature.type){this.hide(),this.show(r);var i="LineString"==e?t:t[0][0].slice(0,-1),o=r.onShapeAdd;r.onShapeAdd=null;for(var n=0,s=i;n<s.length;n++){var a=s[n];this.addShape(a)}r.onShapeAdd=o}},e.prototype.removeShape=function(e){var t=this,r=t.shapes,i=t.iEdit,o=t.overlay,n=t.feature,s=t.settings;e==Ct&&(e=r.length-1);var a=r[e],p=i.map.getGeoCoord(a.geometry.coordinates);o.remove(a),r.splice(e,1),n.removeAt(e);for(var l=e;l<r.length;l++)r[l].properties.index--;n.update(),s.onShapeRemove&&s.onShapeRemove(new mt("onShapeRemove",p[0],p[1],Ct,Ct,Ct,{index:e}))},e.prototype.getFeature=function(){return this.feature},e.prototype.getLength=function(){return this.shapes.length},e.prototype.setAttributes=function(e){var r=this,i=r.feature,o=r.iEdit,n=r.cursor,s=r.settings,a=r.shapes;if(e){t.JSUtils.extend(i.properties,e);var p=function(e,r){var i,o,n,s,a=e.mode;if(e.styleGroup)i=e.styleGroup;else if("Navlink"!=a&&"Area"!=a||(r.editState=function(){return{}},r.class=a),i=e.layer.getStyleGroup(r),"Area"!=a)return(s=t.JSUtils.clone(kt))[0].fill=i[0].stroke,(n=t.JSUtils.clone(xt))[0].stroke=(i[1]||i[0]).stroke,{feature:n,shape:s};var p=function(e){return-1!=["Circle","Image","Rect","Text"].indexOf(e.type)};if(n=i.filter((function(e){return!p(e)})),s=i.filter(p),n.length||(n=e.layer.getStyleGroup(r)),!e.styleGroup||!s.length){s=t.JSUtils.clone(kt);var l=n[0];o=l.stroke;var d=void 0;"Area"==a?(d=l.fill,o&&(s[0].stroke=o)):d=o,d&&(s[0].fill=d)}return{feature:n,shape:s}}(s,i.geojson);this.style=p,i.geojson.class=Ct,o.setStyle(i.geojson,p.feature),a.concat(n).forEach((function(e){o.setStyle(e,Et(p.shape,o.getStyle(e)[0].zIndex))}))}},e.prototype.createGeom=function(){var e=this,t=e.feature,r=e.shapes,i=e.settings,o=i.tolerance,n=r.map((function(e){return e.geometry.coordinates}));"Area"!=i.mode&&o&&(n=m(n,o));var s=t.createGeo(n);if(s)return{type:t.type,coordinates:s}},e.prototype.create=function(e){var t=this,r=t.iEdit,i=t.FeatureClass,o=t.shapes,n=t.feature,s=t.originLink,a=t.originPos,p=t.settings;if(this.setAttributes(e),i==Lt){var l=o[0].geometry.coordinates;s&&a[0]==l[0]&&a[1]==l[1]&&r.objects.splitLinkAt({link:r.objects.get(s),point:l})}var d=o.map((function(e){return e.geometry.coordinates}));if(n.isValid(d)){var u=this.createGeom(),c=void 0;return u&&((c=r.objects.create({feature:{type:"Feature",geometry:u,properties:n.properties},provider:p.layer.getProvider()}))&&r.objects.history.saveChanges(),this.hide()),c}throw new Error("Invalid Geometry")},e.prototype.isActive=function(){return this.active},e.prototype.show=function(e){if(!this.active){var t=this.overlay.layer,r=this.iEdit,i=this.display;r.objects.listenDisplay(!1),i.removeLayer(t),i.addLayer(t),r.objects.listenDisplay(!0),this.settings=e,"Area"==e.mode?this.FeatureClass=bt:this.FeatureClass=Lt,this.originLink=null,this.originPos=null,this.active=!0,this.init(),this.setAttributes(e.attributes)}},e.prototype.hide=function(){var e=this,r=e.display,i=e.overlay,o=e.shapes,n=e.feature;if(e.active){e.active=!1;var s=i.layer;r.removeLayer(s),r.addLayer(s),i.remove(n.geojson),e.feature=null,o.forEach((function(e){return i.remove(e)})),o.length=0,i.remove(e.cursor),e.cursor=null,t.global.removeEventListener("mousemove",e.updateCursor),t.global.removeEventListener("mouseup",e.onBoardUp)}},e}(),It="Area",Rt="Navlink",wt=t.global.here.xyz.maps.editor,Ot=function(){function e(e){this._e=e,this._b=new Pt(e.objects.overlay,e,e.display),this._a=!1}return e.prototype.addShape=function(e,t){if(this._a)return this._b.addShape(this._e.map.getGeoCoord(e),t)},e.prototype.removeShape=function(e){this._a&&this._b.removeShape(e)},e.prototype.getLength=function(){return this._b.getLength()},e.prototype.cancel=function(){this._b.hide(),this._a=!1},e.prototype.setProperties=function(e){this._a&&this._b.setAttributes(e)},e.prototype.setAttributes=function(e){return this.setProperties(e)},e.prototype.create=function(e){if(this._a){var t=this._b.create(e);return t&&(this._a=!1),t}},e.prototype.start=function(e){var t=(e=s({tolerance:1},e||{})).connectTo,r=e.mode||Rt;return r="string"!=typeof r?r===wt.features.Area?It:Rt:r.charAt(0).toUpperCase()+r.slice(1).toLowerCase(),e.mode=r,e.attributes=e.properties||e.attributes||{},this.cancel(),e.layer=e.layer||this._e.getLayerForClass(r.toUpperCase()),(r!=It||e.layer)&&(this._e.listeners.trigger("_clearOverlay"),this._b.show(e),this._a=!0,e.position&&this.addShape(e.position,t)),this._a},e.prototype.isActive=function(){return this._a},e.prototype.getGeometry=function(){return this._b.createGeom()},e.prototype.setGeometry=function(e){this._b.setGeom(e.type,e.coordinates)},e}();function Nt(e,t){var i,o=4096,n=e.coord().map((function(e){var t=r.webMercator.geoToPixel(e[0],e[1],o);return[t.x,t.y]}));if("number"==typeof t)i=t;else{var s=r.webMercator.geoToPixel(t.longitude,t.latitude,o);i=_e(n,[s.x,s.y]).offset}var a=F(n,N(n)*i),p=r.webMercator.pixelToGeo(a[0],a[1],o);return{coordinate:[p.longitude,p.latitude],offset:i}}var Ft,Tt,Mt=function(e){function r(t,i,o,n,s,a,p,l){var d=e.call(this,{type:"Feature",properties:{relPos:o,dragged:!1,style:r.initStyle(n)},geometry:{type:"Point",coordinates:Nt(i.getMultiLink(),o).coordinate}})||this;return d.snapped=[],d.range=i,d.iEditor=t,d.isLocked=s,d.dragStart=a,d.dragMove=p,d.dragEnd=l,t.objects.overlay.addFeature(d,d.properties.style),d.updatePosition(d.geometry.coordinates,o),d}return n(r,e),r.initStyle=function(e){for(var r=0,i=e=t.JSUtils.clone(e);r<i.length;r++){var o=i[r];o._offsetX=o.offsetX||0,o._offsetY=o.offsetY||0}return e},r.prototype.isSnapped=function(e){return e?this.snapped.indexOf(e)>=0:Boolean(this.snapped.length)},r.prototype.getSnapped=function(e){return this.snapped.find((function(t){return t.range==e}))},r.prototype.snap=function(e){if(!this.isSnapped(e)){for(var t=0,r=this.snapped;t<r.length;t++){if(r[t].range==e.range)return!1}return this.snapped.push(e),!0}},r.prototype.validatePosition=function(e,r){var i,o=this,n=o.range,s=n.options.snapTolerance||1,a={coordinate:e=e||o.geometry.coordinates,offset:r,adjusted:!1},p=n.getOffsets(),l=n.getFromMarker()==this;p[Number(!l)]=r,p=p.sort((function(e,t){return e-t}));for(var d=0,u=o.range.getMultiLink().getRanges();d<u.length;d++){var c=u[d];if(c!=o.range){var h=c.getOffsets(),f=c.getMarkers(),v=f[0],g=f[1],y=c.getSide();if(n.allowSnap(y)&&!this.isSnapped(v)&&!this.isSnapped(g)){var A=t.geotools.distance(e,v.geometry.coordinates),m=t.geotools.distance(e,g.geometry.coordinates);if(Math.min(A,m)<s||n.overlaps(h,p)){var S=A<m?v:g;this.snap(S)}}var _=this.getSnapped(c);if(_){var L=h.indexOf(_.getRelPos());h[L]=r,h=h.sort((function(e,t){return e-t}))}if(!n.allowOverlap(y)&&n.overlaps(h,p)){i=c;break}}}if(i){var b=i.getMarkers(),k=(v=b[0],g=b[1],this.range.getFromMarker()==this?g:v);a.offset=k.getRelPos(),a.coordinate=k.geometry.coordinates,a.adjusted=!0}return a},r.prototype.updatePosition=function(e,t){var r=this,i=r.properties.style,o=r.range.getMultiLink().coord(),n=L(o,e),s=r.range.getSide(),a=o[n],p=o[n+1],l=p[0]-a[0],d=p[1]-a[1],u=180*-Math.atan2(d,l)/Math.PI,c=Math.sqrt(l*l+d*d),h=d,f=l;c&&(h/=c,f/=c);for(var v=0,g=i;v<g.length;v++){var y=g[v];if(y.rotation=u,"B"!=s){var A=y._offsetX,m=y._offsetY;m+=y.lineOffset,y.offsetX=h*m+f*A,y.offsetY=f*m+-h*A}}r.getProvider().setFeatureCoordinates(r,e),r.properties.relPos=t;for(var S=0,_=this.snapped;S<_.length;S++){var b=_[S];b.updatePosition([e[0],e[1]],t),b.range.update()}return e.slice()},r.prototype.pressmove=function(e){var t=this;if(!t.isLocked()){var r=e.detail.display,i=Nt(t.range.getMultiLink(),r.pixelToGeo(e.mapX,e.mapY)),o=i.offset,n=i.coordinate,s=this.validatePosition(n,o);t.updatePosition(s.coordinate,s.offset),t.dragMove(e),t.properties.dragged=!0}},r.prototype.pointerdown=function(e){this.dragStart(e),this.properties.dragged=!1,this.validatePosition(this.geometry.coordinates,this.getRelPos())},r.prototype.pointerup=function(e){this.properties.dragged&&this.dragEnd(e),this.snapped.length=0},r.prototype.remove=function(){this.getProvider().removeFeature(this)},r.prototype.getRelPos=function(){return this.properties.relPos},r.prototype.getRelPosOfSubLink=function(e){var t=this.iEditor,r=this.geometry.coordinates,i=t.map.getPixelCoord(r),o=L(this.range.getMultiLink().coord().map((function(e){return t.map.getPixelCoord(e)})),i);if(o>=e.from&&o<e.to){var n=e.lineString.map((function(e){return t.map.getPixelCoord(e)})),s=Se(i,e.reversed?n.reverse():n);return s>.995?1:Math.round(1e9*s)/1e9}return o<e.from?0:1},r}(r.Feature);!function(e){e.L="#ff4040",e.R="#4cdd4c",e.B="#35b2ee"}(Tt||(Tt={}));var Dt=function(){function e(e,t,r){var i=this;this.options=s({_dragStart:function(e,t){},_dragMove:function(e,t){},_dragStop:function(e,t){}},r);var o=r.id;o!=Ft&&(this.id=o);var n=JSON.parse(JSON.stringify(r.style||{}));this.ml=e;var a=this.getSide(),p=n.opacity,l=n.fill,d=n.stroke;l&&!d&&(d=l,l=!1),l||(l=d,d="#fff"),l=l||Tt[a];var u=r.lineStyle||function(e,t,r){return void 0===t&&(t=.75),[{zIndex:4,type:"Line",strokeWidth:9,opacity:t,stroke:e}]}(l,p);this.line=t.addPath(e.coord(),this.style=u);for(var c=0,h=0,f=u;h<f.length;h++){c=f[h].offset||c}for(var v=r.markerStyle||function(e,t,r,i){var o="R"==i?8:"L"==i?-8:0;return[{zIndex:110,type:"Rect",fill:t,width:2,height:20,alignment:"map",offsetY:o},{zIndex:111,type:"Circle",fill:e,radius:7,alignment:"map",stroke:t,strokeWidth:1,offsetY:2.5*o},{zIndex:110,type:"Circle",stroke:t,radius:5,alignment:"map"}]}(l,d,0,a),g=0,y=v;g<y.length;g++){var A=y[g];A.lineOffset==Ft&&(A.lineOffset=c)}this.markers=["from","to"].map((function(t){return new Mt(e.iEdit,i,r[t],v,(function(){return i.locked()}),(function(e){i.options._dragStart(e,i)}),(function(e){i.update(),i.updateSegments(),i.options._dragMove(e,i)}),(function(e){i.options._dragStop(e,i)}))})),this.overlay=t,this.updateSegments()}return e.prototype.updateSegments=function(){this.segments=this.ml.getZoneSegments(this)},e.prototype.getSide=function(){return this.options.side.toUpperCase()},e.prototype.getOffsets=function(){var e=this.markers[0].getRelPos(),t=this.markers[1].getRelPos();if(e>t){var r=e;e=t,t=r}return[e,t]},e.prototype.allowSide=function(e,t){var r=[];return"boolean"==typeof(t=t||[])?t:("string"==typeof t?r.push(t):Array.isArray(t)&&(r=t),-1!=r.indexOf(e))},e.prototype.allowOverlap=function(e){return this.allowSide(e,this.options.allowOverlap)},e.prototype.allowSnap=function(e){return this.allowSide(e,this.options.snap)},e.prototype.getMarkers=function(){return this.markers.sort((function(e,t){return e.getRelPos()-t.getRelPos()}))},e.prototype.getFromMarker=function(){var e=this.markers,t=e[0].getRelPos(),r=e[1].getRelPos();return e[Number(t>r)]},e.prototype.getMultiLink=function(){return this.ml},e.prototype.remove=function(){this.overlay.remove(this.line),this.markers[0].remove(),this.markers[1].remove()},e.prototype.locked=function(){return!!this.options.locked},e.prototype.overlaps=function(e,t){t=Array.isArray(t)?t:this.getOffsets(),e=Array.isArray(e)?e:e.getOffsets();var r=t.sort((function(e,t){return e-t})),i=r[0],o=r[1],n=e.sort((function(e,t){return e-t})),s=n[0],a=n[1];return Math.max(0,Math.min(o,a)-Math.max(i,s))>0},e.prototype.update=function(){for(var e=this.getOffsets(),t=e[0],r=e[1],i=0,o=this.style;i<o.length;i++){var n=o[i];n.from=t,n.to=r}this.overlay.layer.setStyleGroup(this.line,this.style),this.updateSegments()},e}();function Bt(e,t){return e.concat(t.slice(1))}function jt(e,t,r,i){return{zIndex:e,type:"Line",stroke:t,strokeWidth:r,strokeDasharray:i||"none",strokeLinejoin:"round",strokeLinecap:i?"butt":"round"}}var Gt,zt,Kt=function(){return[jt(0,"white",23),jt(1,"grey",20),jt(2,"white",3,[5,4])]},Ht=function(){function e(e,t,r,i){this.ranges=[],this.links=[];var o=e.objects.overlay;this.iEdit=e,this.completePath=t;var n=this.style=r||Kt();this.overlay=o,this.feature=o.addPath(t,n),this.hide(),this.links.push({from:0,to:t.length-1,feature:i,lineString:t,reversed:!1}),o.setFeatureCoordinates(this.feature,this.completePath)}return e.prototype.updateStyle=function(e){e=e||Kt(),this.style=e,this.overlay.layer.setStyleGroup(this.feature,e)},e.prototype.removeZones=function(){this.ranges.forEach((function(e){e.remove()})),this.ranges.length=0},e.prototype.coord=function(){return this.completePath.map((function(e){return e.slice()}))},e.prototype.hide=function(){this.overlay.remove(this.feature)},e.prototype.show=function(e){var t=this,r=this.overlay;this.removeZones(),r.addFeature(this.feature,this.style),e.forEach((function(e){if(-1!=["L","R","B"].indexOf(e.side)){var i=new Dt(t,r,e);t.ranges.push(i),i.update()}}))},e.prototype.addLink=function(e,i){var o=this,n=this.links;function s(e,t){return e[0]===t[0]&&e[1]===t[1]}i instanceof r.Feature&&ot.defaults(i);var a=function(r,s,a){var l=t.JSUtils.clone(e);if(a&&l.reverse(),0===r){for(var d=0;d<n.length;d++)n[d].from+=s,n[d].to+=s;o.completePath=Bt(l,p)}else o.completePath=Bt(p,l);n.unshift({from:r,to:s,feature:i,lineString:e,reversed:!!a})},p=this.completePath;s(e[e.length-1],p[0])?a(0,e.length-1):s(e[0],p[0])?a(0,e.length-1,!0):s(e[0],p[p.length-1])?a(p.length-1,p.length+e.length-2):s(e[e.length-1],p[p.length-1])&&a(p.length-1,p.length+e.length-2,!0),this.overlay.setFeatureCoordinates(this.feature,this.completePath)},e.prototype.destroy=function(){this.hide(),this.removeZones()},e.prototype.getRanges=function(){return this.ranges},e.prototype.getZoneSegments=function(e){var t=e.markers[0],r=e.markers[1],i=[];function o(e){var t=e[0];e[0]=e[1],e[1]=t}return this.links.forEach((function(e){var n=[t.getRelPosOfSubLink(e),r.getRelPosOfSubLink(e)];n[0]>n[1]&&o(n),e.reversed&&(o(n),n[0]=1-n[0],n[1]=1-n[1]),i.push({navlink:e.feature,feature:e.feature,from:n[0],to:n[1],reversed:e.reversed})})),i},e}(),Vt=function(){function e(e){this.multiLink=null,this.lines=[],this.iEditor=e,this.display=e.display}return e.prototype.isConnected=function(e,t,r){for(var i=[0,e.length-1],o=0,n="number"==typeof r?[r]:[0,t.length-1];o<n.length;o++)for(var s=n[o],a=t[s],p=0,l=i;p<l.length;p++){var d=l[p];if(ot.isIntersection(this.iEditor,e[d],a))return{i1:d,i2:s}}return null},e.prototype.getOppositeNodeIndex=function(e,t){return 0==t?e.length-1:0},e.prototype.getCollection=function(){return this.multiLink},e.prototype.show=function(e){this.multiLink&&this.multiLink.show(e)},e.prototype.hide=function(){for(var e=this.multiLink,t=0,r=this.lines;t<r.length;t++){var i=r[t].feature;i instanceof yt&&ot.defaults(i)}this.lines=[],e&&(e.destroy(),this.multiLink=null)},e.prototype.addLineSegment=function(e){var t,r,i=this.multiLink,o=this.lines,n=e.coordinates,s=e.feature;if(null!=n){if(t=!o.length)i=new Ht(this.iEditor,n,this.mlStyle,s),this.multiLink=i,this.first={lineString:n,index:null},r=!0;else{for(var a=0,p=o;a<p.length;a++){var l=p[a].id;if(e.id==l)return!1}var d=this.first.lineString,u=this.isConnected(n,d,this.first.index);u?this.last?this.first={lineString:n,index:this.getOppositeNodeIndex(n,u.i1)}:(this.first.index=this.getOppositeNodeIndex(d,u.i2),this.last={lineString:n,index:this.getOppositeNodeIndex(n,u.i1)}):this.last&&(u=this.isConnected(n,this.last.lineString,this.last.index))&&(this.last={lineString:n,index:this.getOppositeNodeIndex(n,u.i1)}),u&&i.addLink(n,s)}r&&(s instanceof yt&&ot.deHighlight(s),o.push(e))}return!!t},e.prototype.setMLStyle=function(e){this.mlStyle=e,this.multiLink&&this.multiLink.updateStyle(e)},e}(),Ut=function(){function e(){this.listeners=new t.Listener(["tap","dbltap","pointerdown","pointerup","pointerenter","pointerleave","dragStart","dragStop","dragMove","featureUnselected","error","_domResize","_panMap","_layerAdd","_layerRemove","_clearOverlay","_beforeSubmit","_afterSubmit"]).sync(!0)}return e.createEditorEvent=function(e,t,r,i){return new mt(r||e.type,e.mapX,e.mapY,e.nativeEvent,e.button,t,i||e.detail)},e.prototype.trigger=function(t,r,i){var o,n,s,a,p=i||t.type||t;return(a=r)&&a.class?(n=t.detail,s=r):n=r,"touchend"==t.type&&(t=t.changedTouches[0]),o=this.listeners.trigger(p,e.createEditorEvent(t,s,p,n),function(e){return"_"==e[0]}(p)),"pointerup"==p&&(o=this.listeners.trigger("tap",[new mt("tap",t.mapX,t.mapY,t.nativeEvent,t.button,s,n)],!1)||o),o},e.prototype.add=function(e,t,r){return this.listeners.add(e,t,r)},e.prototype.remove=function(e,t,r){return this.listeners.remove(e,t,r)},e.prototype.supported=function(){return this.listeners.getEvents()},e.prototype.destroy=function(){this.listeners=null},e}(),Yt=function(e){var t=e.options;return{id:t.id,from:t.from,to:t.to,side:t.side,style:t.style,segments:e.segments}},Zt=function(){function e(e){this.links=new Vt(e)}return e.prototype.add=function(e){for(var t,r=Array.isArray(e)?e:[].slice.call(arguments),i=0,o=r;i<o.length;i++){var n=o[i],s=void 0;(n instanceof yt||"LineString"==(null===(t=n.geometry)||void 0===t?void 0:t.type))&&(s=n.geometry.coordinates),s&&this.links.addLineSegment({id:n.id||1e9*Math.random()^0,coordinates:s,feature:n})}},e.prototype.show=function(e){var t=this.ranges=e instanceof Array?e:[].slice.call(arguments);t.forEach((function(e){e.from=e.from||0,e.to=(e.to==Gt?1:e.to)||0,e.allowOverlap==Gt&&(e.allowOverlap=!0);for(var t=0,r=["markerStyle","lineStyle"];t<r.length;t++){var i=r[t],o=e[i];o&&!Array.isArray(o)&&(e[i]=[o])}for(var n=function(t){var r=e[t];r&&(e["_"+t]=function(e,i){e.detail.range=e.detail.zone=Yt(i),r(Ut.createEditorEvent(e,e.target,t))})},s=0,a=["dragStart","dragMove","dragStop"];s<a.length;s++){n(a[s])}})),this.links.show(t)},e.prototype.hide=function(){return this.links.hide()},e.prototype.info=function(){var e=[],t=this.links.getCollection();t&&t.getRanges().forEach((function(t){e.push(Yt(t))}));return e},e.prototype.setStyleGroup=function(e){this.links.setMLStyle(e)},e}(),Jt=function(e){function t(t,r,i,o,n,s){void 0===n&&(n={});var a=this,p={type:"Feature",geometry:{type:"Point",coordinates:r},properties:n};return(a=e.call(this,p,i.layer.getProvider())||this)._o=i,a.transformer=o,i.addFeature(a,s),a}return n(t,e),t.prototype.setPosition=function(e,t){this.getProvider().setFeatureCoordinates(this,[e,t])},t.prototype.getCenter=function(){return this.geometry.coordinates.slice()},t.prototype.hide=function(){this._o.hideFeature(this)},t.prototype.show=function(){this._o.showFeature(this)},t.prototype.remove=function(){this._o.remove(this)},t.prototype.enableHover=function(e,t){var r=this;this.__.pointerenter=this.__.pointerleave=function(t){var i="pointerenter"==t.type;document.body.style.cursor=i?e:"default",r.properties["@ns:com:here:editor"].hovered=i,r.properties.hovered=i,r._o.layer.setStyleGroup(r)}},t}(r.Feature),Wt=function(e){function r(r,i,o,n){var s,a,p,l,d=e.call(this,r,i,o,n,{type:"TRANSFORMER_ROTATE_KNOB"})||this,u=null;return l=0,d.__={pressmove:function(e,i,o){s=!0;var d=t.geotools.calcBearing(p,r.map.getGeoCoord(e.mapX,e.mapY))-u;n.setRotation(d);for(var c=0,h=a;c<h.length;c++){var f=h[c];pt._setCoords(f,r.map.rotateGeometry(f.geometry,p,d-l))}l=d},pointerdown:function(e){s=!1,p=n.getCenter(),null==u&&(u=t.geotools.calcBearing(p,r.map.getGeoCoord(e.mapX,e.mapY))),a=n.getFeatures()},pointerup:function(){s&&(a.length>1||"Point"!=a[0].geometry.type)&&n.markObjsAsMod(),a=null,p=null}},d.enableHover("move"),d}return n(r,e),r.prototype.update=function(){var e=this.transformer.getCorner(zt.bottomRight,15,15);this.setPosition(e[0],e[1])},r}(Jt),Qt=function(e){function t(t,r,i,o){var n,s,a,p,l,d,u=e.call(this,t,r,i,o,{type:"TRANSFORMER_SCALE_KNOB"})||this;return u.__={pressmove:function(e,r,i){var a=t.map.getGeoCoord(e.mapX,e.mapY),u=E(l,p,a),c=w(u,p)/d,h=c/s;n||o.visible(!(n=!0)),o.scale(h,h),s=c},pointerdown:function(e){n=!1,(p=o.getCenter())[2]=0,(l=u.geometry.coordinates.slice(0,2))[2]=0,d=w(l,p),a=o.getFeatures(),s=1},pointerup:function(){n&&(a.length>1||"Point"!=a[0].geometry.type)&&o.markObjsAsMod(),a=null,p=null,o.visible(!0)}},u.enableHover("nwse-resize"),u}return n(t,e),t.prototype.update=function(){var e=this.transformer.getCorner(zt.topLeft,-15,-15);this.setPosition(e[0],e[1])},t}(Jt),Xt=function(e){function t(t,r,i,o){var n=e.call(this,t,r,i,o,{type:"TRANSFORMER_TRANSLATE_KNOB"})||this;return n.internalEditor=t,n.__={pointerdown:function(){var e=n.properties;e.moved=!1,e._dx=0,e._dy=0},pressmove:function(e,t,r){var i=n.properties;i.moved=!0,o.pan(t-i._dx,r-i._dy),i._dx=t,i._dy=r},pointerup:function(){n.properties.moved&&o.markObjsAsMod()}},n.enableHover("move"),n}return n(t,e),t.prototype.update=function(){var e=this.transformer.getRotatedBoundingBox(),t=[e[0],e[2]],r=F(t,.5*N(t));this.setPosition(r[0],r[1])},t}(Jt),qt=function(){function e(e,t,r,i){var o,n=this,s=r.map,a=!1;this.transformer=e,this.buffer=t;for(var p,l=[i.addRect(0,0,0,0,{type:"TRANSFORMER_SCALE_BOX"})],d=r.getStyle(l[0]),u=0;u<4;u++)l.push(i.addPath([[0,0],[0,0]],[{zIndex:d[0].zIndex+1,zLayer:d[0].zLayer||0,type:"Line",strokeWidth:6}],{index:u,vertical:u%2}));var c=!1;function h(t,r,i){if(!a){var d=this.properties,u=d.index,h=d.vertical,f=u==zt.topLeft?zt.bottomLeft:u-1,v=l[f+1].geometry.coordinates;c&&(v=v.reverse(),f=h?f==zt.bottomRight?zt.bottomLeft:zt.bottomRight:f==zt.bottomLeft?zt.topRight:zt.bottomRight);var g=v[0],y=v[1],A=e.getCenter(),m=e.rotation,S=s.getPixelCoord(A),_=s.getPixelCoord(g),L=s.getPixelCoord(y),b=E(_,L,[t.mapX,t.mapY,0]);_=T(_,m,S),L=T(L,m,S),b=T(b,m,S);var k,x=1,C=1;if(h){var P=L[0]-_[0];x=(k=b[0]-_[0])/P}else{var I=L[1]-_[1];C=(k=b[1]-_[1])/I}p!=k>0&&(p=!p,c=!c),Math.abs(k)>n.buffer+6&&(e.scale(x,C,e.getCorner(f)),o=!0)}}function f(){var t=e.getFeatures();a=1==t.length&&"Point"==t[0].geometry.type,o=!1;var r=this.properties,i=r.index,n=r.vertical,d=i==zt.topLeft?zt.bottomLeft:i-1,u=l[d+1].geometry.coordinates,h=u[0],f=u[1],v=s.getPixelCoord(h),g=s.getPixelCoord(f),y=e.getCenter(),A=e.rotation,m=s.getPixelCoord(y);v=T(v,A,m),g=T(g,A,m),p=n?g[0]-v[0]>0:g[1]-v[1]>0,c=!1}function v(){o&&e.markObjsAsMod()}function g(){document.body.style.cursor="move"}function y(){document.body.style.cursor="default"}for(u=1;u<l.length;u++){var A=l[u];A.pointerdown=f,A.pressmove=h,A.pointerup=v,A.pointerenter=g,A.pointerleave=y}this.overlay=i,this.features=l,this.iEdit=r,this.update()}return e.prototype.setScale=function(e,t,r){this.transformer.scaleFeatures(this.features,e,t,r)},e.prototype.setRotation=function(e,t){for(var r=0,i=this.features;r<i.length;r++){var o=i[r];o.getProvider().setFeatureCoordinates(o,this.iEdit.map.rotateGeometry(o.geometry,t,e))}},e.prototype.update=function(){var e=this,t=e.buffer,r=e.transformer,i=e.features,o=e.overlay.getProvider(),n=r.getCorner(zt.topLeft,-t,-t),s=r.getCorner(zt.topRight,t,-t),a=r.getCorner(zt.bottomRight,t,t),p=r.getCorner(zt.bottomLeft,-t,t);o.setFeatureCoordinates(i[0],[[n,s,a,p,n]]),o.setFeatureCoordinates(i[1],[n,s]),o.setFeatureCoordinates(i[2],[s,a]),o.setFeatureCoordinates(i[3],[a,p]),o.setFeatureCoordinates(i[4],[p,n])},e.prototype.hide=function(){var e=this.overlay,t=this.features;e.hideFeature(t)},e.prototype.show=function(){var e=this.overlay,t=this.features;e.showFeature(t)},e.prototype.remove=function(){var e=this.overlay,t=this.features;e.remove(t)},e.prototype.pan=function(e,t){for(var r=0,i=this.features;r<i.length;r++){var o=i[r];this.iEdit.map.pixelMove(o,e,t)}},e}();!function(e){e[e.topLeft=0]="topLeft",e[e.topRight=1]="topRight",e[e.bottomRight=2]="bottomRight",e[e.bottomLeft=3]="bottomLeft"}(zt||(zt={}));var $t,er,tr,rr,ir,or,nr=function(){function e(e){this.buffer=15,this.features=null,this.scaleBox=null,this.moveKnob=null,this.rotateKnob=null,this.scaleKnob=null,this.allowEditIds=[],this.rotation=0,this.iEditor=e}return e.prototype.scaleFeatures=function(e,t,r,i){var o=[t,r],n=this.iEditor.map,s=this.rotation,a=this.getCenter();i=n.rotatePoint(i,a,-s);for(var p=0,l=e;p<l.length;p++){var d=l[p],u={type:d.geometry.type,coordinates:d.geometry.coordinates};u.coordinates=n.rotateGeometry(u,a,-s),u.coordinates=n.scaleGeometry(u,o,i),u.coordinates=n.rotateGeometry(u,a,s);try{pt._setCoords(d,u.coordinates)}catch(e){d.geometry.coordinates=u.coordinates}}},e.prototype.restoreFeaturesEditable=function(){for(var e=0,t=this.features;e<t.length;e++){var r=t[e];this.allowEditIds.indexOf(r.id)>=0&&pt._editable(r,!0)}},e.prototype.setRotation=function(e){var t=e-this.rotation,r=this.getCenter(),i=this.bbox.geometry;i.coordinates=this.iEditor.map.rotateGeometry(i,r,t),this.scaleBox.setRotation(t,r),this.scaleKnob.update(),this.rotateKnob.update(),this.rotation=e},e.prototype.markObjsAsMod=function(){for(var e=this.features,t=0,r=e;t<r.length;t++){var i=r[t];pt.markAsModified(i,!1)}e.length&&this.iEditor.objects.history.saveChanges()},e.prototype.getFeatures=function(){return this.features},e.prototype.visible=function(e){var t=this,r=t.rotateKnob,i=t.scaleKnob,o=t.moveKnob,n=t.scaleBox;r&&(e?(n.show(),r.show(),i.show(),o.show()):(n.hide(),r.hide(),i.hide(),o.hide()))},e.prototype.isActive=function(){return null!==this.scaleBox},e.prototype.hide=function(){var e=this,t=e.features,r=e.rotateKnob,i=e.scaleKnob,o=e.moveKnob,n=e.scaleBox;n&&(n.remove(),r.remove(),i.remove(),o.remove()),this.scaleBox=this.moveKnob=this.rotateKnob=null,this.rotation=0,null!=t&&(this.restoreFeaturesEditable(),this.allowEditIds.length=0,this.features=null)},e.prototype.update=function(){this.scaleBox.update(),this.scaleKnob.update(),this.rotateKnob.update(),this.moveKnob.update()},e.prototype.offsetCorner=function(e,t,r){var i=this.iEditor.map,o=this.getCenter(),n=this.rotation;return e=i.rotateGeometry({type:"Point",coordinates:e},o,-n),e=[(e=i.getPixelCoord(e))[0]-t,e[1]-r],e=i.getGeoCoord(e),i.rotateGeometry({type:"Point",coordinates:e},o,n)},e.prototype.scale=function(e,t,r){void 0===r&&(r=this.getCenter()),this.scaleFeatures(this.getFeatures(),e,t,r),this.scaleFeatures([this.bbox],e,t,r),this.update()},e.prototype.getCorner=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=0);var i=this.bbox.geometry.coordinates[e][0];return(t||r)&&(i=this.offsetCorner(i,-t,-r)),i},e.prototype.getRotatedBoundingBox=function(e){return e?this.bbox.geometry.coordinates.slice():this.bbox.geometry.coordinates.map((function(e){return e[0]}))},e.prototype.pan=function(e,t){for(var r=this.iEditor.map,i=0,o=this.getFeatures();i<o.length;i++){var n=o[i];r.pixelMove(n,e,t)}var s=this.bbox.geometry;s.coordinates=r.translateGeo(s.coordinates,e,t),this.update()},e.prototype.getCenter=function(){return this.moveKnob.getCenter()},e.prototype.getBBox=function(){for(var e=[1/0,1/0,-1/0,-1/0],t=0,r=this.features;t<r.length;t++){var i=r[t],o=i.getBBox?i.getBBox():i.bbox;o[0]<e[0]&&(e[0]=o[0]),o[1]<e[1]&&(e[1]=o[1]),o[2]>e[2]&&(e[2]=o[2]),o[3]>e[3]&&(e[3]=o[3])}return e},e.prototype.show=function(e){Array.isArray(e)||(e=[e]);var t,r=this.allowEditIds;this.iEditor.listeners.trigger("_clearOverlay"),null!=this.features&&this.restoreFeaturesEditable(),r.length=0,this.features=e;for(var i=0,o=void 0;i<e.length;i++)t=e[i],o=pt.private(t),pt.deHighlight(t),o.isSelected=!1,o.allowEdit&&(r.push(t.id),pt._editable(t,!1));this.initUI()},e.prototype.initUI=function(){var e=this,t=e.iEditor,r=t.objects.overlay;if(!this.scaleBox){var i=this.getBBox(),o=i[0],n=i[1],s=i[2],a=i[3],p=o+(s-o)/2,l=n+(a-n)/2,d=function(e,t,r,i){return[[[e,i],[r,i]],[[r,i],[r,t]],[[r,t],[e,t]],[[e,t],[e,i]]]}(o,n,s,a);this.bbox={type:"Feature",geometry:{type:"MultiLineString",coordinates:d}};var u=new Xt(t,[p,l],r,e);u.update(),e.moveKnob=u;var c=new qt(e,e.buffer,t,r),h=new Wt(t,[s,n],r,e),f=new Qt(t,[o,a],r,e);h.update(),f.update(),e.rotateKnob=h,e.scaleKnob=f,e.scaleBox=c}},e}(),sr=["ready","active","history.current","history.length","changes.length"],ar={ready:void 0,active:null},pr=function(){function e(){this.listeners=new t.Listener(sr).sync(!0),this.val={};for(var e,r,i=this.val,o=sr.length;e=sr[--o];)r=ar[e],i[e]=undefined!==r&&r}return e.prototype.addObserver=function(e,t,r){var i=this,o=i.val;if("*"==e)for(var n in o)i.addObserver(n,t,r);else i.listeners.add(e,t,r)},e.prototype.removeObserver=function(e,t,r){var i=this,o=i.val;if("*"==e)for(var n in o)i.removeObserver(n,t,r);else i.listeners.remove(e,t,r)},e.prototype.get=function(e){return this.val[e]},e.prototype.change=function(e,t,r){var i=this,o=i.val[e];(r||o!=t&&i.get("active"))&&(i.val[e]=t,i.listeners.trigger(e,[e,t,o]))},e}(),lr=function(){function e(e,t){this.s=[],this.zClearFeat=null,this.ie=e,this.display=t;var r=this;if(e._config.keepFeatureSelection){var i=t.getZoomlevel();t.addEventListener("mapviewchangeend",(function(){var e=t.getZoomlevel();if(e!=i){var o=r.getCurSelObj()||r.zClearFeat,n=void 0;o&&(n=o.getProvider().minLevel,i>=n?e<n&&(r.clearSelected(),r.zClearFeat=o):e>=n&&pt._select(o))}i=e}))}}return e.prototype.add=function(e){pt.private(e).isSelected=!0,this.s.push(e)},e.prototype.remove=function(e){var t=this.s;pt.private(e).isSelected=!1,t.splice(t.indexOf(e),1)},e.prototype.select=function(e){var t=this,r=t.display.getZoomlevel(),i=e.getProvider();if(r>=i.minLevel&&r<=i.maxLevel)return t.clearSelected(),this.add(e),!0;t.zClearFeat=e},e.prototype.getCurSelObj=function(){return this.s[0]},e.prototype.unselectFeature=function(e){var t,r=this,i=r.ie;if(e||!i._config.keepFeatureSelection){if(t=r.getCurSelObj()){var o=pt.private(t,"xt");o&&o.clear(),i.listeners.trigger("featureUnselected",{featureUnselected:!0})}r.clearSelected()}},e.prototype.clearSelected=function(){var e,t,r=this,i=this.s,o=this.ie;return o.listeners.trigger("_clearOverlay"),i.forEach((function(e){var i=pt.getTool(e,"deHighlight");i&&(t=e,i(e,!0),r.remove(e)),pt.private(e).isSelected=!1})),i.length=0,this.zClearFeat=null,o.transformer.hide(),null===(e=o._rngSel)||void 0===e||e.hide(),t},e}(),dr="@ns:com:here:editor",ur=function(){function e(){this.steps={}}return e.prototype.clone=function(e){return e?JSON.parse(JSON.stringify(e)):e},e.prototype.add=function(e,t,r){var i=this.steps[e]||{},o=i[t]=i[t]||{},n=r.id;if(!o[n])return o[n]=r,this.set(e,i),!0},e.prototype.remove=function(e,t,r){try{var i=this.steps[e][t],o=r.id;if(i[o])return delete i[o],this.set(e,this.steps[e]),!0}catch(e){}return!1},e.prototype.get=function(e){return this.clone(this.steps[e])},e.prototype.set=function(e,t){this.steps[e]=this.clone(t)},e.prototype.clear=function(){var e=this.steps;for(var t in e)delete e[t]},e}(),cr=function(e){return e.properties[dr]},hr=function(e){var t=e.toJSON(),r=cr(t);return t.class=e.class,r&&(delete r.hovered,delete r.selected),t},fr=function(e){var t=cr(e);return t.modified||t.removed||t.split||t.created},vr=function(){function e(e){this.current=0,this.total=0,this.changes={},this.cached=null,this._a=!0;this.iEdit=e,this.storage=new ur}return e.prototype.updateObservers=function(e){var t=this,r=t.iEdit.observers;r.change("changes.length",t.getLength()),r.change("history.length",t.total),r.change("history.current",t.current,e)},e.prototype.getTotal=function(){return this.total},e.prototype.getLength=function(){var e=this.getChanges(),t=0;for(var r in e)for(var i in e[r])cr(e[r][i]).origin||t++;return t},e.prototype.remove=function(e){var t=e.getProvider().id;this.storage.remove(this.current,t,e)&&(delete this.changes[t][e.id],this.cached=null)},e.prototype.origin=function(e,t){var r=e.id,i=e.getProvider().id,o=this.storage,n=this.changes,s=this.current,a=o[s],p=n[i];if(p||(p=n[i]={}),p[r]=e,!a||!a[i]||!a[i][r]){var l=hr(e),d=cr(l);t&&(d.removed=!0),d.origin=!0,o.add(s,i,l)}},e.prototype.saveChanges=function(){var e=this,t=0;if(e.active()){e.cached=null;var r=function(e){var t={},r=0;for(var i in e)for(var o in t[i]={},e[i])t[i][o]=hr(e[i][o]),r++;return{data:t,length:r}}(e.changes);if(t=r.length){var i=++e.current;e.storage.set(i,r.data),i>e.total?e.total++:e.total=i,e.iEdit.dump("History step saved...",i,"warn"),e.changes={},e.updateObservers()}}return t},e.prototype.getHistoryFeature=function(e,t){void 0===t&&(t=this.current);var r=this.storage.get(t),i=e.getProvider().id;return r&&r[i][e.id]},e.prototype.getChanges=function(){if(!this.cached){for(var e=this.storage,t=this.current,r={},i=1,o=void 0;i<=t;i++)for(var n in o=e.get(i))for(var s in o[n]){var a=o[n][s];p=void 0,(p=cr(a)).created&&p.removed?r[n]&&r[n][s]&&delete r[n][s]:fr(a)&&((r[n]=r[n]||{})[s]=a)}this.cached=r}var p;return this.cached},e.prototype.clear=function(){var e=this;e.storage.clear(),e.current=0,e.total=0,e.changes={},e.cached=null,this.updateObservers(!0)},e.prototype.import=function(e){var r=this,i=r.storage;for(var o in e)for(var n in e[o]){var s=r.iEdit.objects.get(n,o);if(s)r.origin(s);else{var a=t.JSUtils.extend(!0,{},e[o][n]),p=a.properties[dr]=a.properties[dr]||{};p.removed=!0,p.origin=!0,i.add(r.current,o,a)}}r.total=++r.current,i.set(r.current,e),r.recoverViewport(0)},e.prototype.recoverViewport=function(e,t){var r=+new Date,i=this.current+e,o=this.storage.get(i),n=this.iEdit;if(this.cached=null,i>=0&&i<=this.total){n.objects.selection.unselectFeature(),n.dump(arguments,i,"REBUILDED VIEW IN",+new Date-r,"ms"),n.objects.selection.getCurSelObj()&&n.listeners.trigger("featureUnselected",{featureUnselected:!0}),n.objects.selection.clearSelected();var s=[];for(var a in o){var p=o[a];for(var l in p){s["NAVLINk"==(h=p[l]).class?"unshift":"push"]({provider:n.getProviderById(a),feature:h})}}for(var d=0,u=s;d<u.length;d++){var c=u[d],h=c.feature,f=c.provider,v=f.search(h.id);v&&f.removeFeature(v);var g=cr(h);if(!g.removed){for(var y in h=n.objects.create({feature:h,provider:f,history:!0}),g)h.properties[dr][y]=g[y];n.setStyle(h)}}this.current=i,t||this.updateObservers()}},e.prototype.active=function(e){return arguments.length&&(this._a=!!e),this._a},e.prototype.ignore=function(e){var t=this.active();this.active(!1),e(),this.active(t)},e}(),gr=function(){function e(e){this.type="CONTAINER",this.length=0,this._e=e}return e.prototype.push=function(e,t){var r,i,o=this,n={};t&&"Feature"==t.type&&(e=arguments,t=$t),e.length==$t&&(e=[e]);for(var s=o._e,a=0,p=e;a<p.length;a++){var l=p[a];(i=s.objects.add(l,t,n))&&(l=i,r=!0),o[o.length++]=l}return r&&s.objects.history.saveChanges(),o.length},e.prototype.forEach=function(e,t){for(var r=0;r<this.length;r++)e.call(t,this[r],r)},e.prototype.toArray=function(){for(var e=[],t=0;t<this.length;t++)e[e.length]=this[t];return e},e.prototype.highlight=function(){for(var e,t=this.length;e=this[--t];)pt.highlight(e)},e.prototype.remove=function(){for(var e=this,t=e._e.objects,r=!1,i=e.length;i--;)r=t.remove(e[i],{animation:!1,save:!1})||r,delete e[i];r&&(e.length=0,t.history.saveChanges())},e.prototype.transform=function(){var e=this;e.length&&e._e.transformer.show(e.toArray())},e.prototype.unHighlight=function(){for(var e,t=this.length;e=this[--t];)pt.deHighlight(e)},e.prototype.unhighlight=function(){return this.unHighlight()},e.prototype.pop=function(){var e=this;if(e.length){var t=e[--e.length];return delete e[e.length],t}},e.prototype.getBBox=function(){for(var e,t=this,r=[1/0,1/0,-1/0,-1/0],i=0;i<t.length;i++)(e=t[i].getBBox?t[i].getBBox():t[i].bbox)[0]<r[0]&&(r[0]=e[0]),e[1]<r[1]&&(r[1]=e[1]),e[2]>r[2]&&(r[2]=e[2]),e[3]>r[3]&&(r[3]=e[3]);return t.length?r:[0,0,0,0]},e}(),yr=function(e,t,r){return{geometry:{coordinates:t,type:e},type:"Feature",properties:r||{}}},Ar=function(e,t){for(var r=0;r<e.length;r++)e[r].opacity!=er&&(e[r]._opacity=e[r]._opacity||e[r].opacity),e[r].opacity=t;return e},mr=function(e){for(var t=0;t<e.length;t++)e[t].opacity=e[t]._opacity==er?1:e[t]._opacity,delete e[t]._opacity;return e},Sr=function(e){return e=e?e instanceof Array?e:[e]:er},_r=function(e,t,r,i){return[[[e,t],[e,i],[r,i],[r,t],[e,t]]]},Lr=function(){function e(e){this.layer=e}return e.prototype.getProvider=function(){return this.layer.getProvider()},e.prototype.hideFeature=function(){for(var e,t=this,r=t.layer,i=0;i<arguments.length;i++)(e=arguments[i])instanceof gr&&(e=e.toArray()),e instanceof Array?t.hideFeature.apply(t,e):r.setStyleGroup(e,Ar(r.getStyleGroup(e),0))},e.prototype.showFeature=function(){for(var e,t=this,r=t.layer,i=0;i<arguments.length;i++)(e=arguments[i])instanceof gr&&(e=e.toArray()),e instanceof Array?t.showFeature.apply(t,e):r.setStyleGroup(e,mr(r.getStyleGroup(e)))},e.prototype.addFeature=function(e,t){var r=this.layer.addFeature(e,Sr(t));return r.properties["@ns:com:here:editor"]=r.properties["@ns:com:here:editor"]||new ht,r},e.prototype.addCircle=function(e,t,r){return this.addFeature(yr("Point",e,r),t)},e.prototype.remove=function(e){var t=this.layer;if(e instanceof gr)for(var r=0;r<e.length;r++)t.removeFeature(e[r]);else e&&t.removeFeature(e)},e.prototype.setFeatureCoordinates=function(e,t){e._provider.setFeatureCoordinates(e,t)},e.prototype.getStyles=function(e){return this.layer.getStyleGroup(e)},e.prototype.modifyRect=function(e,t,r,i,o){this.setFeatureCoordinates(e,_r(t,r,i,o))},e.prototype.addRect=function(e,t,r,i,o){return this.addFeature(yr("Polygon",_r(e,t,r,i),o))},e.prototype.addPolygon=function(e,t,r){return this.addFeature(yr("Polygon",[e],r),t)},e.prototype.addSquare=function(e,r,i,o,n){var s=t.geotools.movePoint;return i^=0,this.addPolygon([s(e,r,-45+i),s(e,r,45+i),s(e,r,135+i),s(e,r,225+i),s(e,r,-45+i)],o,n)},e.prototype.addPath=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"LineString"},type:"Feature",properties:r||{}},Sr(t))},e.prototype.addPoint=function(e,t,r){t instanceof Array||(r=t,t=er);var i={geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}};return this.addFeature(i,Sr(t))},e.prototype.addImage=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}},Sr(t))},e}(),br="data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO8AAPACAvoCAvoMDPAODvASEvoXF/oZGfAdHfAkJPAqKv1BQf1KSv5QUP9dXf9paf9zc/95ef+Ghv+Njf+Skv+dnf+lpf+rq/vFxf3MzPzW1vfa2vvc3P3i4v7q6v/y8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACIALAAAAAAYABgAAAb/QJFwKAyBOpnMBhQiOp2hDSZSsVgqkYum+SR6LoJAoBMKecICCrkbbQQECwHZLFAkAoPtcxNeFARyZWcCBnECekMeboYGgXSEdYAdQyEXAYYCBWOCgI1wARRcGwOZgKVzg54BjRoiIRgBCqannJCACgEWZRMBCbMGm4+eAr4QHx8Pq78BHLXDjQgbHQzKpn/NwtaNHdPVgH+ondpyHsnDtNmdAQcbIby+1o6ppsUfr7Gz4M6muLoiGwRKfXPUQdzAVq4sYdIXgoPBBaC4iPDg4FImhh3eNMI1YBIRPpcKMEwF8ZDEIhvcRAqXABgBRE88WAgTzIMYARXWdEGJQUKVDStZYO6kdCRJByY7gwAAOw==",kr="#111111",xr=function(e){return e.properties["@ns:com:here:editor"].hovered},Er=function(e){return e.properties["@ns:com:here:editor"].selected},Cr=function(e,t,r){return"function"==typeof e?e(t,r):e},Pr=function(e){return[{zLayer:function(e){return e.properties.zLayer},zIndex:999990,type:"Line",strokeWidth:2,stroke:"#FF0000",altitude:!!e}]},Ir=function(e){var t=[{zIndex:4,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20,pointerEvents:!1,altitude:e}];return e&&t.push({zIndex:3,type:"VerticalLine",stroke:kr,altitude:function(e){var t=e.properties;return t[t.parentType].altitude}},{zIndex:1,type:"Circle",radius:4,fill:kr,opacity:.6,zLayer:function(e){var t=e.properties;return t[t.parentType].zLayer}}),t},Rr=function(e){return e?[{zLayer:function(e){return e.properties.zLayer},zIndex:999992,type:"Sphere",radius:8,fill:"#FF0000",stroke:"#FF0000",altitude:function(e){var t=e.properties;return t[t.parentType].altitude}},{zLayer:function(e){return e.properties.zLayer},zIndex:999991,type:"VerticalLine",stroke:"#000",altitude:!0},{zIndex:999990,type:"Circle",radius:4,fill:kr,opacity:.6,altitude:0,zLayer:function(e){return e.properties.zLayer}}]:[{zLayer:function(e){return e.properties.zLayer},zIndex:999991,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zLayer:function(e){return e.properties.zLayer},zIndex:999992,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}]},wr=function(e){return[{zIndex:0,type:"Circle",radius:13,fill:"#ffffff",stroke:kr,strokeWidth:1.5},{zIndex:1,type:"Text",fill:kr,font:"normal 16px Arial",text:e}]},Or=function(e){return[{zIndex:1,type:"Image",src:e,width:24,height:24,alignment:"map",rotation:function(e){return e.properties.rotation}}]},Nr=function(){function e(){this.styleGroups={ADDRESS_LINE:Pr(),ADDRESS_LINE_3D:Pr(!0),ADDRESS_ROUTING_POINT:Rr(),ADDRESS_ROUTING_POINT_3D:Rr(!0),ADDRESS_SELECTOR:Ir(),ADDRESS_SELECTOR_3D:Ir(!0),PLACE_LINE:Pr(),PLACE_LINE_3D:Pr(!0),PLACE_ROUTING_POINT:Rr(),PLACE_ROUTING_POINT_3D:Rr(!0),AREA_SHAPE:[{zIndex:0,zLayer:function(e){return e.properties.AREA.zLayer},type:"Circle",strokeWidth:2,stroke:kr,radius:function(e){return xr(e)?8:6},fill:function(e,t){var r=e.properties.AREA.style[0],i=r.fill,o=r.stroke;return xr(e)?kr:Cr(i,e,t)||Cr(o,e,t)}}],AREA_VIRTUAL_SHAPE:[{zIndex:0,zLayer:function(e){return e.properties.AREA.zLayer},type:"Circle",strokeWidth:1,fill:kr,stroke:kr,radius:function(e){return xr(e)?6:4}}],AREA_HEIGHT_KNOB:[{zIndex:4,type:"Sphere",altitude:!0,fill:function(e,t){var r=e.properties.AREA.style[0],i=r.fill,o=r.stroke;return xr(e)?"#777":Cr(i,e,t)||Cr(o,e,t)},radius:10,offsetZ:50},{zIndex:3,type:"VerticalLine",stroke:"#000",offsetZ:50}],LINE_SHAPE_3D:[{zIndex:4,type:function(e){return Er(e)?"Sphere":null},radius:function(e,t){var r=e.properties.LINE.style;return 6+(i.styleTools.getLineWidth(r,e.getLine(),t,0)[0]/2+4^0)},fill:"red",opacity:.5,strokeWidth:5,altitude:!0},{zIndex:3,type:"Sphere",alignment:"map",radius:function(e,t){var r=e.properties.LINE.style;return i.styleTools.getLineWidth(r,e.getLine(),t,0)[0]/2+4^0},stroke:function(e,t){var r=e.properties.LINE.style.filter((function(e){return"Line"==e.type})),i=r.length-1;return Cr(r[i].stroke,e,t)||"BLACK"},fill:function(e,t){var r=e.properties.LINE.style;return r.length>1?Cr(r[0].stroke,e,t):"#e9e9e9"},strokeWidth:2,altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:kr,opacity:.6,zLayer:function(e){return e.properties.LINE.zLayer}}],LINE_SHAPE:[{zIndex:0,type:"Circle",radius:function(e,t){var r=e.properties.LINE.style;return i.styleTools.getLineWidth(r,e.getLine(),t,0)[0]/2+4^0},stroke:function(e,t){var r=e.properties.LINE.style.filter((function(e){return"Line"==e.type})),i=r.length-1;return Cr(r[i].stroke,e,t)||"BLACK"},fill:function(e,t){var r=e.properties.LINE.style;return r.length>1?Cr(r[0].stroke,e,t):"#151515"},strokeWidth:2},{zIndex:4,type:function(e){return Er(e)?"Circle":null},radius:function(e,t){var r=e.properties.LINE.style;return 6+(i.styleTools.getLineWidth(r,e.getLine(),t,0)[0]/2+4^0)},stroke:"red",strokeWidth:3}],LINE_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",radius:function(e,t){var r=e.properties.LINE.style;return i.styleTools.getLineWidth(r,e.getLine(),t,0)[0]/2^0},fill:"#151515"}],LINE_VIRTUAL_SHAPE_3D:[{zIndex:3,type:"Sphere",radius:function(e,t){var r=e.properties.LINE.style;return i.styleTools.getLineWidth(r,e.getLine(),t,0)[0]/2^0},fill:"red",altitude:function(e){var t;return null===(t=e.properties.LINE.style.find((function(e){return e.altitude})))||void 0===t?void 0:t.altitude}},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:kr,opacity:.6,zLayer:function(e){return e.properties.LINE.zLayer}}],MARKER_SELECTOR:Ir(),MARKER_SELECTOR_3D:Ir(!0),PLACE_SELECTOR:Ir(),PLACE_SELECTOR_3D:Ir(!0),NAVLINK_SHAPE:[{zIndex:0,type:function(e){return e.properties.isConnected?"Rect":"Circle"},width:function(e){return xr(e)?18:12},rotation:45,radius:function(e){return xr(e)?9:6},strokeWidth:2,fill:function(e,t){return e.isOverlapping()?"#FFFFFF":Cr(e.properties.NAVLINK.style[0].stroke,e,t)},stroke:function(e){return e.isOverlapping()?"#FF0000":"#FFFFFF"}},{zIndex:1,type:function(e){return Er(e)?"Circle":null},radius:function(e){return xr(e)?18:14},stroke:"red",strokeWidth:3}],NAVLINK_SHAPE_3D:[{zIndex:0,type:function(e){return e.properties.isConnected?"Box":"Sphere"},width:function(e){return xr(e)?18:12},rotation:45,radius:function(e){return xr(e)?9:6},strokeWidth:2,fill:function(e,t){return e.isOverlapping()?"#FFFFFF":Cr(e.properties.NAVLINK.style[0].stroke,e,t)},stroke:function(e){return e.isOverlapping()?"#FF0000":"#FFFFFF"},alignment:"map",altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:kr,opacity:.6,zLayer:function(e){return e.properties.NAVLINK.zLayer}}],NAVLINK_VIRTUAL_SHAPE:[{zIndex:1,type:"Circle",radius:function(e,t){var r=e.properties.NAVLINK.style;return i.styleTools.getLineWidth(r,e.getLink(),t,0)[0]/5},opacity:.7,fill:kr,stroke:kr,strokeWidth:2}],NAVLINK_VIRTUAL_SHAPE_3D:[{zIndex:1,type:"Sphere",radius:function(e,t){var r=e.properties.NAVLINK.style;return i.styleTools.getLineWidth(r,e.getLink(),t,0)[0]/5},opacity:.7,fill:kr,stroke:kr,strokeWidth:2,alignment:"map",altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:kr,opacity:.6,zLayer:function(e){return e.properties.NAVLINK.zLayer}}],NAVLINK_DIRECTION_HINT_1WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACUcHCMfICMgICklJSsnKS4qKzMvLzMvMTo3OD05OlpXWGVjY2pnZ25rbHFub5mXmJ6dncXExMjHx9bV1eXl5e7u7vHx8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABkALAAAAAAfAAwAAAVcYCaO5FgUZaquo7EQyMDOQ20PBGVFikHMKkHDQSQ+KpjkxEE4BIAjwSVJrVItkIQPKrV6qxJGU7bqfr/hMct8TmK1P6CwaEQqmU6o6GbL7XpxeiwuMGSCMwQohyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_2WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACMeISMfHyQhISklJisnKS0pKjIuLjMvMUNAQElFRVJPUG5rbHh1do2LjJORkrWztM/OztbW1uvr6////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABUALAAAAAAfAAwAAAV6YCWOpBgYoxGUbEsWhnKMh2IUbl4dBBNRicAgkKBEGISZTjQ4IB4TitTBqDqklMkDcRi4bgsIdkwmQxawkQBBaEjK8LikQUAIBDx3fD+eJwUpBWF8cGdpLU1PUVNVDFdSWlxeSzs9P0FDRUdJlCwwMjQ2OJ0uJykrSyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_BLOCKED:[{zIndex:1,type:"Image",src:br,rotation:90,width:24,height:24,alignment:"map"}],NAVLINK_DIRECTION_HINT_A:wr("A"),NAVLINK_DIRECTION_HINT_B:wr("B"),NAVLINK_DIRECTION:[{zIndex:0,type:"Image",src:"data:image/gif;base64,R0lGODdhEAAcALMAAAAAACgbGxwcHCMfHyMfICMhISsrK////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAAAgALAAAAAAQABwAAAQ/EMlJq5WE3Jt3HdngTVk3FiVRjGApbmkKx2ZFy9Qd53pJ9jggjjfk7Dy0URJ5nBUtS6eP+bQ1jVXiVFrDbiURADs=",width:16,height:28,rotation:function(e){return-e.properties.bearing},opacity:.7,alignment:"map"}],NAVLINK_DIRECTION_NONE:[{zIndex:0,type:"Image",src:br,width:24,height:24,rotation:90,alignment:"map"}],TURN_RESTRICTION_START:[{type:"Image",zIndex:1,src:"data:image/gif;base64,R0lGODdhJAAUAMQAAAAAAAAA/wBAvwBA/wBNzBRO2ABV/wtV2gxVzgdW0wpX1ApY1Qpa3BJbyABd0Qtd4wtf6Ath6wBmzABm/wBt2wCAgACA/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABgALAAAAAAkABQAAAW/ICZiC6Ocijmu43KaqMq+aMwwT6Tv0fPANZlIAQGmaidSjeRCniKK4aPWvNFYypeveZpijqjH4quYpm5oXGna5Lq+XCHZGUtKa2Z8dKXgBvcjZVRODGOBeUheKwuIdIaHdIIzjUhvfJRdgHeRfZpfmJKXnCePm06KkKOFi6CoIoyjoYF+dZODnVeBqnafeoJhY5lnaWo4t529KFUwqzMxW3pDRX9UTAvXcJERpS5GLzc5PDo+3kdYX0ZyWHUxpSEAOw==",width:36,height:20,rotation:function(e){return e.properties.rotation},alignment:"map"}],TURN_RESTRICTION_LINE:[{type:"Line",zIndex:0,strokeWidth:5,strokeLinecap:"round",stroke:function(e){return"TURN_RESTRICTION_ALLOWED"==e.properties.sign?"#0000ff":"#ff0000"}}],TURN_RESTRICTION_ONEWAY:Or(br),TURN_RESTRICTION_FORBIDDEN:Or("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO0AAO4ACPAAAPYlK/YpL/YrMO4sMu9VV/tVV/xWWfxYWu9aW/BaXPBkZvBnafBpav9zdf93efOOj/+Oj/OPkP+PkP+RkvOSk/SenvSfoPSjo/WnqPWpqfe/v/XDxP/Dw/bHyPnOzvnR0fni4v309P749////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACgALAAAAAAYABgAAAb2QJRwKDyRRp/PiHQiOp2lz2VhGAwIi8un9CSeRpKAeEyOjJrPE2gQEAQYGA4HwxgPQOihOnAIOEQlJ4InJSIPfAF4RCMDfRmDkIMZfAMjQyURYo+RnJMBEVwoH2IOnKYnhwEeKCcXYiKnnCJiF0YLAQiBsZF1CkcFARW7nBgBBCIhbBvDkR1iScrMkM4BSgYBE9KDxcckCri60g0BCUyuAbDSI2IWTaN+2hBiqyiYYsvDGmKgQyKNAfhObaAkwgsIRA5GmIBUSF4fRQbZiGmAoUMHDOPGQHRyQkQmMiAjwOpyyQOFBATEEEhAwUMokl6OhFDChGQQADs="),TURN_RESTRICTION_ALLOWED:Or("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAAA/qgBFqgBLrABTrgBWsQBZrwBdsQJlswBnuAtnsxFntBNoswBpuR5qtSNrtClstj10uEt+w0+AxFCBxG6Pwm6TzXWTxHKVznuXxnyYxoGax4OcyIym1Y+p15Cp1papz5ms0KGy06q41q672LG+2bTA2rzH3r7I3r/J4MLL37/M6MHO6cXO4MfQ4c7V5tDX59DY59Tb6d7j7uDl7uLm8OXp8uns9PHz9/P0+f///wAAAAAAAAAAAAAAAAAAACH5BAkKADsALAAAAAAYABgAAAb/wJ1wKNTVZK0WrKYjOp05VGfSOBwaFA8K9yTqXpgB4YBgMBAHwgDzaj51rALh4VgoEAjFwvEYs9xDcAIKD3iGCw90CA8KAn9ELwV6hngKBwNiDmUIBS9DOBZzlGUHFSUjHKJ9GFw7KAOFo3cRMzo6ILCLBCo7Oh0EEA7Cww4QaDK2IbAOBB5GElYE0tPSlwNttwMQBxM1MAkIFRoZ4xrm4xsXGje2IAIODTEuBQg2tvf4+bYiBgctLgTq6Rt4j98BFS/AXeCwgYPDhw3NsdOhDN4SaGmoTbOGTdm2br6AERtm7AAyigLoEPjQ5EQuWQhoJcv1YEAKIaAIaKLEoJQJThKpCjHDkGNIJAYLRi04ICDTpk5eWAyKdSiRJgcKAjzyskIOnTuU+BAosNXJFwtiyAhDo4YNoC44pEhIIC2BhA5bunTRQeNFkhc03hIJAgA7"),TURN_RESTRICTION_PEDESTRIAN:Or("data:image/gif;base64,R0lGODdhGAAYAOYAAAAAAO0AAO4ACPAAAPYlK/YpLy0rK/YrMO4tMjMxMUVDRFRTU+9UVvtVV/xVWF9WVvxYWvBZW+9bXWNdXfBjZe9kZmhnZ/BnafBpa2xsbHJxcv9zdf93eX18fISEhIuLi/OOj/+Oj/OPkP+PkP+RkvOSk5iVlZ2dnfSenvSkpPWpqaysrLO0tLy8vPe/v8PDw//Dw/XExMjHyPbHyPnOzsbPz8/Pz8fQ0PnR0dPT09zc3Pri4uPj4+rq6vLy8v3z8////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKAEEALAAAAAAYABgAAAf/gEGCg4JAOzgxMzg7QISOjj8xJBAHAwMFECQxP4+EQDQbAaKjpBs4jY9AMAOjDCApKSIMowMwqIOqAQgBFDQ/QMBAPzQUugG2hDQDuynBzsEougM4gz+hASjP2kDRARycQS6iFdvbFAIBMUFAIaI4NT3OPNs0oiSGDQEMQCwAK8EvFuh49iNCAAiHCAQoAYxHBwUtgOnIwAJYDx9ARAQ4gGOGKBXOcmTw0GLFBwAedACYAERFgAExYnx85iPDAgAADAB48cFEy5cxcChkGIxFghM5ZNiwoMFZiQAEFuWTACyghoE9WKzIgBFYwYOM2gXAceNBjmA+WrCIF6xegHvhUERhKKftgih1QayJakYXWLcN4ILU25WNbjQE0zzBMIbh1DMadnchU8xKlIQSKlSUkEBrsqNP10iVOtWpmosRDRRCdUDCReDSuHbQiEmDUelAADs="),TRANSFORMER_TRANSLATE_KNOB:[{type:"Circle",zIndex:0,zLayer:1e4,stroke:"#FFFFFF",fill:"#010B1E",strokeWidth:3,opacity:.3,radius:9}],TRANSFORMER_ROTATE_KNOB:[{type:"Image",zIndex:4,zLayer:1e4,src:function(e){return e.properties.hovered?"data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAELHhAZKyApOTA4R0BHVlBXZGBmcnB1gICFjo+UnK+yuL/Cx8/R1d/g4+/w8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABEALAAAAAATABMAAAVpYCSOEWSaZDqeLKqWbQylck2aTgM5SqI4rZWJIUAEjkdEEAZhHAUHxkEQOLCYzacO8qBuYw+G+JsIJGq1hhktK5/ZrUGAcW0FCAtIwxAoXLEQB0hHBQ9/gA0JinSHgGw0cDMvaC+QJy8hADs=":"data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAAKIAELHhEaLCEqOjE5SEFIVlFYZXF2gYCFj5CVnaCkq7CzucDDx9DS1uDh5PDx8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABIALAAAAAATABMAAAVpoCSOkmCaZDqeLKqWbSykck2aRCEQSIIQrZXJAFFEjkdFECYwHCELwwISWbCYzadOMKBuYwOD+JuIJGq1ghktK5/ZrUfEcG1FHAdBgRFpXLECC0hHDQN/gAUJinSHgGw0cDMvaC+QJy8hADs="},width:18}],TRANSFORMER_SCALE_KNOB:[{type:"Circle",zIndex:4,zLayer:1e4,fill:function(e){return e.properties.hovered?"white":"black"},radius:9},{zIndex:5,zLayer:1e4,type:"Text",fill:function(e){return e.properties.hovered?"black":"white"},font:"20px Arial",text:"⤡"}],TRANSFORMER_SCALE_BOX:[{type:"Line",zIndex:0,zLayer:1e4,strokeDasharray:[4,4],strokeWidth:2,stroke:"#010B1E"}],UNKNOWN:[{zIndex:0,type:"Circle",strokeWidth:1,stroke:"#FF0000",fill:"#0000FF",radius:10}]}}return e.prototype.assign=function(e){var t,r,i=this.styleGroups,o=e.properties,n=e.class||o.type,s=!1;if("LINE_SHAPE"==n||"LINE_VIRTUAL_SHAPE"==n||"NAVLINK_SHAPE"==n||"NAVLINK_VIRTUAL_SHAPE"==n?s=null===(t=(o.LINE||o.NAVLINK).style.find((function(e){return e.altitude})))||void 0===t?void 0:t.altitude:"MARKER_SELECTOR"==n?(s=o.MARKER.altitude)==tr&&(s=!!e.geometry.coordinates[2]):s=null===(r=o[o.parentType])||void 0===r?void 0:r.altitude,s){var a=n+"_3D";n=i[a]?a:n}return i[n]!==tr?n:"UNKNOWN"},e}(),Fr=function(e){function t(t){void 0===t&&(t={});var r=this;return t.name="EOP",(r=e.call(this,t)||this).id="EOP-"+r.id,r}return n(t,e),t}(r.LocalProvider),Tr="pointerenter pointerleave pointerup pressmove pointerdown dbltap",Mr="addLayer removeLayer",Dr=function(e){return e.class},Br=function(){function e(e,i){this.listen=!1;var o=this;o.iEdit=e,o.display=i,o.history=new vr(e),o.selection=new lr(e,i);var n,s,a=(n=e,(s=new Fr)._e=function(){return n},new r.TileLayer({name:"EditorOverlay",min:1,max:28,style:new Nr,provider:s}));o.overlay=new Lr(a);var p=new t.Map([[a.id,a]]);this.layers=p,i.addLayer(a,function(e){for(var t,r=e.length;r--;)if((t=e[r].getProvider())&&"NAVLINK"==t.class)return r+1;return e.length}(i.getLayers())),o.arrangeOverlay=o.arrangeOverlay.bind(o),o.pointerListener=o.pointerListener.bind(o),e.listeners.add("_layerAdd",(function(e){var t=e.detail.layer;p.set(t.id,t)})),e.listeners.add("_layerRemove",(function(t){var r=t.detail.layer;p.delete(r.id);var i=e.objects.selection.getCurSelObj();i&&e.getLayer(i)==r&&e.objects.selection.clearSelected()})),o.onMVCStart=o.onMVCStart.bind(o)}return e.prototype.onMVCStart=function(){this.selection.unselectFeature()},e.prototype.splitLinkAt=function(e){return function(e,r){var i,o,n,s=r.link,a=r.index,p=r.preferSegment,l=r.avoidSnapping,d=s.coord(),u=d.length-1,c=ot._props(s),h=s.getProvider().readZLevels(s),f=e._config.snapTolerance,v=r.point,g=r.ignoreZ;if(v&&(i=v[0],o=v[1],n=v[2]||0),0===a||a===u||i==d[0][0]&&o==d[0][1]||i==d[u][0]&&o==d[u][1])return!1;if(e.objects.history.origin(s),a===rr){var y=e.map.searchPointOnLine(d,v,f,p,rr,g);if((0===(a=null==y?void 0:y.index)||a===u)&&y.existingShape)return!1;a=ot.addShp(s,[i,o,n],null,!0,null,p),d=s.coord()}ot.deHighlight(s);var A=s.getProvider(),m=function(r,i,o){var n=t.JSUtils.extend(!0,{},c),s={type:"Feature",geometry:{type:"LineString",coordinates:r},properties:n};return delete n["@ns:com:here:editor"],e.objects.create({feature:s,provider:A,zLevels:i,preferIndex:o})},S=m(d.slice(0,a+1),h.slice(0,a+1),l&&a),_=m(d.slice(a),h.slice(a),l&&0),L=Se(d[a],d);L>.995&&(L=1);var b=_e(d,d[a]).offset,k=ot.getConnectedObjects(s);for(var x in k){var E=k[x],C=Ne.getRoutingPosition(E),P=b>_e(d,C).offset?S:_;Ne.connect(E,P,C),Ne.markAsModified(E,!1)}return e.hooks.trigger("Navlink.split",{link:s,index:a,children:[S,_],relativePosition:L},A),s.editState("split",Date.now()),e.objects.remove(s,{animation:!1,split:!0}),[S,_]}(this.iEdit,e)},e.prototype.destroy=function(){this.display.removeLayer(this.overlay.layer)},e.prototype.arrangeOverlay=function(e){var t=e&&e.detail.layer,r=this.display,i=this.overlay.layer;if(r.getLayers){var o=r.getLayers();if(!(t.getProvider()instanceof Fr)){var n=o.map((function(e){var t=e.getProvider();return t&&t.class})).indexOf("NAVLINK");r.removeLayer(i),n>=0?r.addLayer(i,n+1):r.addLayer(i)}}},e.prototype.pointerListener=function(e){var t=this.iEdit,r=e.target,i=e.type;if(r){var o=e.detail.layer;if(!this.layers.has(o.id))return;var n=pt.getEventListener(r,i);if(n)return e.stopPropagation(),n.apply(r,arguments)}"pointerup"!=i&&"dbltap"!=i||t.objects.selection.unselectFeature("viewportChange"==t._config.keepFeatureSelection),t.listeners.trigger(e,null)},e.prototype.listenDisplay=function(e){var t=this.display,r=this.listen,i=this.pointerListener,o=this.arrangeOverlay;e?r||(this.listen=!0,t.addEventListener("mapviewchangestart",this.onMVCStart),t.addEventListener(Tr,i),t.addEventListener(Mr,o)):r&&(this.listen=!1,t.removeEventListener("mapviewchangestart",this.onMVCStart),t.removeEventListener(Tr,i),t.removeEventListener(Mr,o))},e.prototype.get=function(e,t){var r=this.iEdit;return t?"object"!=typeof t&&(t=r.getLayer(t)):t=r.getLayer(e),"object"!=typeof e&&t&&(e=t.search(e)),e&&t?e:null},e.prototype.getInBBox=function(e,t,r){e||(e=[(e=this.display.getViewBounds()).minLon,e.minLat,e.maxLon,e.maxLat]);var i=1/Math.pow(10,this.iEdit._config.intersectionScale);e=[e[0]-i,e[1]-i,e[2]+i,e[3]+i];for(var o,n=[],s=0,a=(t=t||this.layers.values())instanceof Array?t:[t];s<a.length;s++){if(o=a[s].search(e))for(var p=0,l=o;p<l.length;p++){var d=l[p];r&&!r(d)||n.push(d)}}return n},e.prototype.remove=function(e,t){var r=this,i=!1;if((t=t||{}).split||!r.iEdit._config.editRestrictions(e,2)){var o=null==t.animation||t.animation;o&&pt.private(e,"isSelected")&&r.selection.clearSelected(),Dr(e)&&(r.history.origin(e),pt.markAsRemoved(e,o),t.save&&r.history.saveChanges(),i=!0);var n=e.getProvider();return e.editState&&!e.editState("created")&&n.blockFeature(e,!0),n.removeFeature(e),i}},e.prototype.add=function(e,t,r){var i=this.iEdit;if(!e.getProvider()&&("string"==typeof t?t=this.layers.get(t):t||(t=i.getLayerForClass(Dr(e))),t)){var o=e.id,n=o!=ir&&t.search(o);return o!=ir&&n?n:this.create({feature:e,provider:t.getProvider(),idMap:r})}},e.prototype.create=function(e){var t=this.iEdit,r=t.objects.history,i=[],o=e.feature;Array.isArray(o)||(o=[o]);for(var n=e.idMap||{},s=e.provider,a=e.preferIndex,p=e.history,l=e.zLevels,d=function(e){var d,u=o[e],c=u.id;if(p||s.enforceRandomFeatureId&&(u.id=ir),u=s.prepareFeature(u),d=s.detectFeatureClass(u),c==ir&&(c=u.id),n[c]=u.id,u=function(e){return p&&s.blockFeature(e,!1),e=s.addFeature(e),e=s.search(e.id),p||(e.editState("created",Date.now()),pt.markAsModified(e,!1),r.origin(e,!0),l&&r.ignore((function(){s.writeZLevels(e,l)}))),i.push(e),e}(u),"NAVLINK"===d)u.geometry.coordinates.forEach((function(e){return e[2]||(e[2]=0)})),p||!1===ot.fixGeo(u,ir,ir,a)&&(r.remove(u),s.removeFeature(i.pop()));else if("PLACE"===d||"ADDRESS"===d){var h=Ne.getRoutingData(u),f=h.link;if(n[f]){var v=Ne.getRoutingProvider(u),g=v&&v.search(n[f]);r.ignore((function(){u.getProvider().writeRoutingPoint(u,g,h.position)}))}"ADDRESS"!==d||p||(Ne.connect(u),u.getLink()||(r.remove(u),s.removeFeature(i.pop()),t.dump("No Link found within "+t._config.maxRoutingPointDistance+" meters","warn")))}},u=0;u<o.length;u++)d(u);return i.length>1?i:i[0]},e.prototype.getNearestLine=function(e,i,o){var n=this.iEdit,s={line:null,point:null,distance:1/0,shpIndex:null,segmentNumber:null},a=(o=t.JSUtils.extend({maxDistance:1/0,shapeThreshold:0,ignoreZ:!1},o||{})).maxDistance,p=a<1/0?t.geotools.getPointBBox(e,a):null;i instanceof r.EditableFeatureProvider&&(i=this.getInBBox(p,i));for(var l=0,d=i;l<d.length;l++){var u=d[l];if(!o.ignore||!o.ignore(u)){var c=u.bbox;if(a==1/0||S(p[0],p[2],p[1],p[3],c[0],c[2],c[1],c[3])){var h=n.map.searchPointOnLine(u.geometry.coordinates,e,-1,ir,ir,o.ignoreZ);(null==h?void 0:h.distance)<Math.min(s.distance,o.maxDistance)&&(s.point=h.point,s.distance=h.distance,s.shpIndex=h.existingShape?h.index:null,s.segmentNumber=h.index-Number(!h.existingShape),s.line=u,a=t.geotools.distance(h.point,e),p=t.geotools.getPointBBox(e,a))}}}return s.line?s:null},e.prototype.searchLine=function(e,i,o,n){var s=this.iEdit,a={line:null,point:null,distance:1/0,shpIndex:null,segmentNumber:null},p=(o=t.JSUtils.extend({maxDistance:1/0,shapeThreshold:0,ignoreZ:!1},o||{})).maxDistance,l=o.ignoreZ,d=p<1/0?t.geotools.getPointBBox(e,p):null;i instanceof r.EditableFeatureProvider&&(i=this.getInBBox(d,i,(function(e){return"NAVLINK"==e.class})));for(var u=s.display,c=u.geoToPixel(e[0],e[1]),h=c.x,f=c.y,v=u._unprj(h,f,-1),g=u._unprj(h,f,1),y=t.vec3.sub([],g,v),A=0,m=i;A<m.length;A++){var _=m[A];if(!o.ignore||!o.ignore(_)){var L=_.bbox;if(!d||S(d[0],d[2],d[1],d[3],L[0],L[2],L[1],L[3]))for(var b=_.geometry.coordinates,k=b[0],x=u._g2w(k[0],k[1],l?0:k[2]),P=void 0,I=1;I<b.length;I++){k=b[I],P=x,x=u._g2w(k[0],k[1],l?0:k[2]);var R=t.vec3.sub([],P,x),w=R[0],O=R[1];if(w||O){var N=P,F=t.vec3.add([],P,[-O,w,0]),T=x,M=t.vec3.normalize([],t.vec3.cross([],t.vec3.sub([],T,F),t.vec3.sub([],N,F))),D=C(y,v,M,N),B=u._w2g(D);D=E(N,T,D,!0);var j=u._w2g(D),G=t.geotools.distance(j,B);G<Math.min(a.distance,p)&&(a.point=j,a.distance=G,a.line=_)}}}}return a.line?a:null},e}(),jr=function(){function e(e,t){var r=this;this.busy=null,this.display=t,this.iEdit=e,this.observers=e.observers,this.onStart=this.onStart.bind(this),this.onStop=this.onStop.bind(this),e.listeners.add("_layerAdd",(function(e){r.observers.change("ready",!1),r.display.setCenter(r.display.getCenter()),e.detail.layer.addEventListener("viewportReady",r.onStop)})),e.listeners.add("_layerRemove",(function(e){e.detail.layer.removeEventListener("viewportReady",r.onStop)}))}return e.prototype.onStart=function(){if(!this.busy){var e=this.iEdit.layers;this.busy=new t.Set(e),e.length&&this.observers.change("ready",!1)}},e.prototype.onStop=function(e){var t=e.detail.layer,r=this.busy;r&&(r.delete(t),r.size||(this.observers.change("ready",!0),this.busy=null))},e.prototype.start=function(){this.display.addEventListener("mapviewchangestart",this.onStart)},e.prototype.stop=function(){this.display.removeEventListener("mapviewchangestart",this.onStart)},e}(),Gr=["Navlink.split","Navlink.disconnect","Feature.remove","Coordinates.update"],zr=function(e,t){var r=e.__=e.__||String(1e9*Math.random()^0);return t&&(r+=";"+t.id),r},Kr=function(){function e(e){this.h=new t.Listener(Gr),this.h.sync(!0),this.history=e,this.w=new Map}return e.prototype.add=function(e,t,r){var i=zr(t,r),o=this.w.get(i);return o||this.w.set(i,o=function(e,t){var r=function(r,i){t&&i!=t||e(r)};return r.h=e,r}(t,r)),this.h.add(e,o)},e.prototype.remove=function(e,t,r){return this.h.remove(e,this.w.get(zr(t,r)))},e.prototype.get=function(e){return this.h.get(e).map((function(e){return e[0].h}))},e.prototype.trigger=function(e,t,r){var i=this.history,o=i.active();i.active(!1),this.h.trigger(e,[t,r]),i.active(o)},e}(),Hr=1e9,Vr=Math.PI/180,Ur=function(e,t,r,i){this.point=e,this.index=t,this.distance=r,this.existingShape=i};function Yr(e,t){if("number"==typeof e[0])return t(e);for(var r=[],i=e.length;i--;)r[i]=Yr(e[i],t);return r}var Zr,Jr,Wr=function(){function e(e){this.display=e}return e.prototype.distance=function(e,r){return t.geotools.distance(e,r)},e.prototype.rotatePoint=function(e,t,r){return this.clipGeoCoord(function(e,t,r){var i=e[0]-t[0],o=e[1]-t[1],n=r*Vr;return[t[0]+(Math.cos(n)*i-Math.sin(n)*o/Math.abs(Math.cos(t[1]*Vr))),t[1]+(Math.sin(n)*i*Math.abs(Math.cos(t[1]*Vr))+Math.cos(n)*o),0^e[2]]}(e,t,r))},e.prototype.movePoint=function(e,r,i,o){return this.clipGeoCoord(t.geotools.movePoint(e,r,i,o))},e.prototype.scaleGeometry=function(e,t,r){var i=this;return Yr(e.coordinates,(function(e){return i.clipGeoCoord([r[0]+(e[0]-r[0])*t[0],r[1]+(e[1]-r[1])*t[1],0^e[2]])}))},e.prototype.rotateGeometry=function(e,t,r){var i=this;return Yr(e.coordinates,(function(e){return i.rotatePoint(e,t,r)}))},e.prototype.getClosestPoint=function(e,t,r){var i=e[0]-t[0],o=e[1]-t[1],n=e[1]*t[0]-e[0]*t[1],s=i*r[0]+o*r[1],a=1/(i*i+o*o);return[(s*i+n*o)*a,(s*o-n*i)*a]},e.prototype.searchPointOnLine=function(e,t,r,i,o,n){var s,a,p=this,l=null,d=o||1/0,u=!1,c=null,h=null,f=null;if(i!=or){var v=p.searchPointOnLine(e.slice(i,i+2),t,r,or,o,n);return v&&(v.index+=i),v}n&&(t=[t[0],t[1]]);for(var g=0;g<e.length;g++){var y=e[g];n&&(y=[y[0],y[1]]),(s=p.distance(y,t))<=d&&(d=s,c=y[0],h=y[1],f=y[2],l=g,u=!0)}if(d>r||!u)
// const path = pathGeo.map((c) => map.getPixelCoord(c));
for(var A=e.map((function(e){return p.display._g2w(e[0],e[1],n?or:e[2])})),m=p.display._g2w(t),S=0;S<A.length;S++)if(S<A.length-1&&(a=E(A[S],A[S+1],m,!0))){var _=p.clipGeoCoord(p.display._w2g(a));(s=p.distance(_,t))<d&&(d=s,l=S+1,c=_[0],h=_[1],f=a[2],u=!1)}return null===l?l:new Ur([c,h,f||0],l,d,u)},e.prototype.translateGeo=function(e,t,r){var i=this,o=i.display;return Yr(e,(function(e){var n=o.geoToPixel(e[0],e[1]);return i.getGeoCoord(n.x+t,n.y+r,e[2])}))},e.prototype.translateZ=function(e,t){return this.display._translateGeoCoord(e,0,0,t)},e.prototype.pixelMove=function(e,t,r){var i=e.getProvider(),o=this.translateGeo(i.decCoord(e),t,r),n=pt.getTool(e,"_setCoords");n?n(e,o):i.setFeatureCoordinates(e,o)},e.prototype.clipGeoCoord=function(e,t){var r=e[0],i=e[1],o=e[2];return e[0]=Math.round(r*Hr)/Hr,e[1]=Math.round(i*Hr)/Hr,t&&"number"==typeof o&&(e[2]=Math.round(1e3*o)/1e3),e},e.prototype.getGeoCoord=function(e,t,r){var i,o=this,n=o.display;return arguments.length>1?i=n.pixelToGeo(e,t):(i=e).x!=or&&i.y!=or?(r=i.z,i=n.pixelToGeo(i.x,i.y)):e[0]!=or&&e[1]!=or&&(r=i[2],i=n.pixelToGeo(i[0],i[1])),o.clipGeoCoord([i.longitude,i.latitude,0|r])},e.prototype.getPixelCoord=function(e,t,r){var i=this.display;return 2==arguments.length?e=i.geoToPixel(e,t):e.longitude!=or&&e.latitude!=or?e=i.geoToPixel(e.longitude,e.latitude):e[0]!=or&&e[1]!=or&&(e=i.geoToPixel(e[0],e[1])),[e.x,e.y,0|e.z]},e.prototype.getEventsMapXY=function(e){var t,r,i=this.display;if(e.mapX!=or)t=e.mapX,r=e.mapY;else{var o=i.getContainer().getBoundingClientRect();t=e.pageX-o.left,r=e.pageY-o.top}return[t,r]},e}(),Qr="error",Xr=function(){function e(e,r){this.isCommitInProcess=!1,this._config=e;var i=this;i.layers=[],i.layerMap={},i.observers=new pr,i.listeners=new Ut,i.objects=new Br(i,r),i.hooks=new Kr(i.objects.history),this._dListener=new jr(i,r),this._dListener.start();var o=i.objects.overlay.layer,n=this.prvIdLayerMap={};function s(e){i.listeners.trigger(Qr,e)}n[o.getProvider().id]=o,i.listeners.add("_layerAdd",(function(e){for(var t=e.detail.layer,r=t.getProvider(),i=0,o=["src","base","delta","id"];i<o.length;i++){var a=r[o[i]];a&&(n[a]=t)}t.removeEventListener(Qr,s),t.addEventListener(Qr,s)})),i.map=new Wr(r),i.transformer=new nr(i),i.display=r,i.dump=t.JSUtils.dump}return e.prototype.getLayerForClass=function(e){for(var t,r,i,o,n=0,s=this.layers;n<s.length;n++){var a=s[n];a.getProvider&&(o=a.getProvider()),(r=o.class)?e==r&&(i=a):t||(t=a)}return i||t},e.prototype.getProviderById=function(e){var t=this.prvIdLayerMap[e];if(t)return t.getProvider()},e.prototype.getLayerById=function(e){for(var t=0,r=this.layers;t<r.length;t++){var i=r[t];if(i.id==e)return i}},e.prototype.getLayer=function(e){var t;if("object"==typeof e){var r=e.getProvider();e=r.src||r.delta||r.base||r.id}return e&&(t=this.prvIdLayerMap[e]),t},e.prototype.destroy=function(){this._dListener.stop(),this.objects.destroy(),this.listeners.destroy()},e.prototype.getStyle=function(e,r){var i=this.getLayer(e).getStyleGroup(e,0^this.display.getZoomlevel(),r);return t.JSUtils.extend(!0,[],i)},e.prototype.getStyleProperty=function(e,t){for(var r=0,o=this.getStyle(e);r<o.length;r++){var n=o[r];if(n[t]!=Zr)return i.styleTools.getValue(t,n,e,0^this.display.getZoomlevel())}},e.prototype.getZLayer=function(e){return 1+this.display.getLayers().indexOf(this.getLayer(e))},e.prototype.setStyle=function(e,t,r){var i=this.getLayer(e);t==Zr?t=i._getCustomStyleGroup(e):"default"==t&&(t=Zr),i.setStyleGroup(e,t,r)},e}(),qr={debug:!0,editRestrictions:function(){return!1},services:{reverseGeocoder:{}},geoFence:!1,snapTolerance:2,intersectionScale:5,routingPointPrecision:5,disconnectShapeDistance:3,keepFeatureSelection:"viewportChange",featureSelectionByDefault:!0,maxRoutingPointDistance:1e3,snapOnDrag:!0},$r=function(e,t,r,i){return e.getProvider().readTurnRestriction({link:e,index:t},{link:r,index:i})},ei=function(e,t,r,i,o){t.getProvider().writeTurnRestriction(e,{link:t,index:r},{link:i,index:o})},ti={"Navlink.split":[function(e){for(var t=e.link,r=e.children,i=r[0],o=r[1],n=t.coord().length-1,s=i.coord().length-1,a=o.coord().length-1,p=0,l=t.getConnectedLinks(0,!0);p<l.length;p++){var d=l[p],u=d.link,c=d.index;$r(t,0,u,c)&&(ei(!0,i,0,u,c),ei(!1,o,0,u,c)),$r(u,c,t,0)&&(ei(!0,u,c,i,0),ei(!1,u,c,o,0))}for(var h=0,f=t.getConnectedLinks(n,!0);h<f.length;h++){var v=f[h];u=v.link,c=v.index;$r(t,n,u,c)&&(ei(!0,o,a,u,c),ei(!1,i,s,u,c)),$r(u,c,t,n)&&(ei(!0,u,c,o,a),ei(!1,u,c,i,s))}}],"Feature.remove":function(e){var t=e.feature;if("NAVLINK"==t.class){for(var r=t.coord().length-1,i=0,o=t.getConnectedLinks(0,!0);i<o.length;i++){var n=o[i],s=n.link,a=n.index;ei(!1,t,0,s,a)}for(var p=0,l=t.getConnectedLinks(r,!0);p<l.length;p++){var d=l[p];s=d.link,a=d.index;ei(!1,t,r,s,a)}}},"Navlink.disconnect":function(e){var t=e.link,r=e.index;t.getConnectedLinks(r,!0).forEach((function(e){var i=e.link,o=e.index;ei(!1,t,r,i,o),ei(!1,i,o,t,r)}))}},ri="info",ii=function(e){return e.properties["@ns:com:here:editor"]},oi=function(e){return!!ii(e).created},ni=function(e){return!!ii(e).removed},si=function(){function e(e){this.pIds={},this.iEdit=e}return e.prototype.reserveIds=function(e,r,i,o){var n=this.pIds,s=e.id,a=[];for(var p in r)oi(r[p])&&(n[s][p]||a.push(r[p]));a.length>0?e.reserveId(a,(function(e){for(var t in r){var o=r[t];oi(o)&&!n[s][t]&&(n[s][t]=e.shift())}i(n[s],s)}),o):t.global.setTimeout((function(){i(n[s],s)}),0)},e.prototype.replaceIds=function(e,r,i){var o,n,s,a=this.pIds,p=this.iEdit,l=0;for(var d in s=JSON.stringify(e),e){for(var u in l++,n=!1,e[d])if(oi(e[d][u])){n=!0;break}a[d]||(a[d]={}),n?(p.dump("REQUESTING PERMANENT IDs..",ri),this.reserveIds(p.getProviderById(d),e[d],(function(i,n){var a,d,u="#"+t.JSUtils.String.random()+"#";for(var c in i)(o=e[n][c])&&(a="number"==typeof i[c]?i[c]:'"'+i[c]+'"',"string"==typeof(d=o.id)&&(d='"'.concat(o.id.replace(/(?=[.\\+*?[^\]$(){}\|])/g,"\\"),'"')),a!=d&&(s=s.replace(d+":{",u).replace(new RegExp('"link":'+d,"g"),'"link":"'+a+'"').replace(new RegExp(d,"g"),a).replace(u,a+":{")),p.dump(o.id+" -> "+a,ri));--l||r(JSON.parse(s))}),i)):l--}!l&&r(e)},e.prototype.send=function(e,r,i,o){var n=this.pIds,s=this.iEdit,a=0;function p(){--a||r(t.JSUtils.clone(n))}for(var l in e){a++;var d=s.getProviderById(l),u=e[l],c=[],h=[],f=void 0;for(var v in u)f=u[v],(ni(f)?h:c).push(f);var g=n[l],y={};for(var A in g)y[g[A]]=A;c.length|h.length?d.commit({put:c,remove:h},p,(function(e){i&&i(e)}),o):p()}},e.prototype.submit=function(e,r,i,o){var n=this;void 0===o&&(o=t.JSUtils.String.random());var s=this.iEdit,a=s._config.services.reverseGeocoder.getISOCC,p=0;s.dump("COMMIT",o,ri);var l=function(){n.replaceIds(e,(function(e){n.send(e,r,i,o)}),i)};function d(e){if(e)return"number"==typeof e[0]?e:d(e[0])}for(var u in e){var c=function(t){var r=e[u][t],i=s.getProviderById(u);ni(r)?oi(r)&&delete e[u][t]:a&&(i.isoCC(r)||(p++,s.dump(r.id,"["+i.detectFeatureClass(r)+"] MISSING ISOCC -> REVERSE GEOCODING..",ri),function(e,t){a(t[0],t[1],(function(t){t&&i.isoCC(e,t),--p||l()}))}(r,d(r.geometry.coordinates))))};for(var h in e[u])c(h)}p||l()},e}(),ai="NAVLINK",pi=function(e){var t=e.class;return t==ai?ai:String(t)+(e.src||e.base+e.delta||e.id)},li=function(e,t,r){var i=t.hooks;if(i)for(var o in i){var n=i[o];n instanceof Array||(n=[n]);for(var s=0,a=n;s<a.length;s++){var p=a[s];r.hooks[e](o,p,t)}}},di=function(e){!function(e){var t,r,i=e.objects.history.getChanges(),o=[];for(var n in i)for(var s in r=e.getProviderById(n),i[n])t=r.search(s),r._clearOnCommit?(t&&(t.properties["@ns:com:here:editor"].drop=!0),o.push(r,i[n][s].bbox)):t&&(t.properties["@ns:com:here:editor"]={});for(var a=0;a<o.length;a+=2)(r=o[a]).clear.apply(r,o[a+1])}(e),e.objects.history.clear(),e.display.refresh()},ui=function(){function e(e,r){var i=this,o=this,n=(r=function(e){var r=t.JSUtils.extend(!0,{},qr);for(var i in e)switch(i){case"services":t.JSUtils.extend(!0,r[i],e[i]);break;case"editRestrictions":if("function"!=typeof e[i])break;default:r[i]=e[i]}return r}(r||{})).layers;delete r.layers,t.JSUtils.loglevel=r.debug&&"debug";var s,a=new Xr(r,e);o._i=function(){return a},s=a,function(e){var t;for(var r in e){"function"==typeof(t=e[r])&&(t=[t]);for(var i=0,o=t;i<o.length;i++){var n=o[i];s.hooks.add(r,n)}}}(ti),o.container=e.getContainer(),n instanceof Array&&n.forEach((function(e){return i.addLayer(e)})),o.active(!0),setTimeout((function(){var e=a.observers,t=e.get("active"),r=t;e.change("active",t,r),a.layers.length||e.change("ready",!0)}),0)}return e.prototype.active=function(e){var t=this._i(),r=t.observers.get("active");return null!=e&&(e=!!e)!=r&&(r=e,t.objects.listenDisplay(e),t.observers.change("active",e,!0)),r},e.prototype.addEventListener=function(e,r,i){var o=this._i().listeners,n=o.supported().filter((function(e){return"_"!=e[0]}));String(e).split(" ").forEach((function(e){n.indexOf(e)>-1?o.add.call(o,e,r,i):t.JSUtils.dump(e+" is not a valid event. Use: "+n.join(", "),"warn")}))},e.prototype.removeEventListener=function(e,t){var r=this._i().listeners;r.remove.apply(r,arguments)},e.prototype.addFeature=function(e,t,r){var i,o,n=this._i(),s=arguments,a=[],p={},l={},d=function(e){return e.x!=Jr&&e.y!=Jr||e.longitude!=Jr&&e.latitude!=Jr},u=function(e,t){if(d(e)&&(e=n.map.getGeoCoord(e)),"number"==typeof e[0])return e[0]+=t[0],e[1]+=t[1],n.map.clipGeoCoord(e);for(var r=[],i=0;i<e.length;i++)r[i]=u(e[i],t);return r},c=function(e,t){var r=t&&t.id;(l[r]=l[r]||[]).push(e)};if("Feature"==e.type)c(e,t);else if(e instanceof Array)e.forEach((function(e){return c(e,t)}));else for(var h in l=e)"Feature"==(e=l[h]).type&&(l[h]=[e]);if(r=s[s.length-1],d(r)){r=n.map.getGeoCoord(r);var f=n.display.getViewBounds();o=[r[0]-f.minLon,r[1]-f.maxLat]}else o=[0,0];var v=function(e){l[e].forEach((function(t){var r=t.geometry;r.coordinates=u(r.coordinates,o),"Feature"!=t.type||t instanceof yt||(t=new yt(t)),(t=n.objects.add(t,"undefined"==e?Jr:e,p))&&(i=!0,a.push(t))}))};for(var g in l)v(g);return i&&n.objects.history.saveChanges(),a.length>1?this.createFeatureContainer.apply(this,a):a[0]},e.prototype.addHook=function(e,t,r){return this._i().hooks.add(e,t,r)},e.prototype.removeHook=function(e,t,r){return this._i().hooks.remove(e,t,r)},e.prototype.getHooks=function(e){return this._i().hooks.get(e)},e.prototype.getFeature=function(e,t){return this._i().objects.get(e,t)||null},e.prototype.config=function(e,t){var r=this._i()._config;switch(arguments.length){case 2:r[e]=t;break;case 1:return r[e];case 0:return s({},r)}},e.prototype.createFeatureContainer=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=new gr(this._i());return r.push(e.flat()),r},e.prototype.clearFeatureSelection=function(){return this._i().objects.selection.clearSelected()||null},e.prototype.search=function(e){var t,r=this._i(),i=[];if("object"==typeof e)for(var o=e.filter,n=e.layers||r.layers,s=n.length;s--;){var a=n[s].search(e);a instanceof Array||(a=[a]);for(var p=a.length;t=a[--p];)o&&!o(t)||i.push(t)}return i},e.prototype.addLayer=function(e){if(e){var t=this._i(),r=t.layerMap,i=e.getProvider();if(i&&"FeatureProvider"==i.__type&&i.editable&&(!r[pi(i)]||i.class==ai)){if(i._e instanceof Xr){if(i._e===t)return!1;throw new Error("Provider already in use by another editor")}return i._e=t,e.class=i.class,t.listeners.trigger("_layerAdd",{layer:e}),r[pi(i)]=e,t.layers.push(e),li("add",i,t),!0}}return!1},e.prototype.getLayers=function(e){var t=this._i().layers;return e?t[e]:t.slice()},e.prototype.removeLayer=function(e){if(e){var t=this._i(),r=t.layerMap,i=t.layers,o=e.getProvider(),n=pi(o);if("FeatureProvider"==o.__type&&o.editable&&r[n])return t.listeners.trigger("_layerRemove",{layer:e}),delete r[n],i.splice(i.indexOf(e),1),li("remove",o,t),delete o._e,!0}return!1},e.prototype.addObserver=function(e,t){this._i().observers.addObserver(e,t,arguments[2])},e.prototype.get=function(e){return this._i().observers.get(e)},e.prototype.removeObserver=function(e,t){this._i().observers.removeObserver(e,t,arguments[2])},e.prototype.destroy=function(){var e=this,t=e._i();for(var r in e.getLayers().forEach((function(t){return e.removeLayer(t)})),e.active(!1),t.destroy(),e)delete e[r];return e.__proto__={},null},e.prototype.setZoomLevel=function(e){this._i().display.setZoomlevel(e)},e.prototype.getZoomLevel=function(){return this._i().display.getZoomlevel()},e.prototype.pixelToGeo=function(e){var t=this._i().map.getGeoCoord(e);return t?new r.GeoPoint(t[0],t[1]):null},e.prototype.geoToPixel=function(e){var t=this._i().map.getPixelCoord(e);return t?new r.PixelPoint(t[0],t[1]):null},e.prototype.revert=function(){for(var e=this._i(),t=e.observers.get("history.current");t--;)e.objects.history.recoverViewport(-1,!0);di(e)},e.prototype.getDrawingBoard=function(){var e=this._i();return e._db=e._db||new Ot(e)},e.prototype.getZoneSelector=function(){return this.getRangeSelector()},e.prototype.getRangeSelector=function(){var e=this._i();return e._rngSel=e._rngSel||new Zt(e)},e.prototype.getOverlay=function(){return this._i().objects.overlay.layer},e.prototype.undo=function(e){for(e=Math.min(this.get("history.current"),e||1);e--;)this._i().objects.history.recoverViewport(-1,!!e)},e.prototype.redo=function(e){for(e=Math.min(this.get("history.length"),e||1);e--;)this._i().objects.history.recoverViewport(1,!!e)},e.prototype.submit=function(e){var t,i=!1,o=[],n=(e=e||{}).ignoreEventBlock,s=e.layer,a=e.onError,p=e.onSuccess,l=e.transactionId,d=this._i();if("function"==typeof n)throw new Error("Invalid parameter!");if(n||!d.isCommitInProcess){for(var u in s=s instanceof Array?s:[s]){var c=s[u];c&&c instanceof r.TileLayer&&"MARKER"==c.type&&(c.base&&o.push(c.base),c.delta&&o.push(c.delta),c.src&&o.push(c.src))}for(var h in t=d.objects.history.getChanges())o.length>0&&o.indexOf(h)<0?delete t[h]:i=!0;if(i)return d.listeners.trigger("_beforeSubmit"),function(e,t,r,i,o){e.isCommitInProcess||(e.objects.selection.clearSelected(),e.observers.change("ready",e.isCommitInProcess),e.isCommitInProcess=!0,new si(e).submit(t,(function(t){e.isCommitInProcess=!1,r.call(null,t)}),(function(t){e.isCommitInProcess=!1,i.call(null,t)}),o))}(d,t,(function(e){di(d),d.listeners.trigger("_afterSubmit"),p&&p({permanentIDMap:e})}),(function(e){d.listeners.trigger("_afterSubmit"),a&&a(e)}),l),!0}return!1},e.prototype.info=function(){var e=[],r=this._i().objects.history.getChanges();for(var i in r)for(var o in r[i])e[e.length]=t.JSUtils.clone(r[i][o]);return e},e.prototype.export=function(){var e=this._i();return JSON.stringify(e.objects.history.getChanges())},e.prototype.import=function(e){var t=this._i();return"string"==typeof e&&(e=JSON.parse(e)),t.objects.history.import(e)},e.prototype.toGeoJSONCoordinates=function(e){if(Array.isArray(e)&&"number"!=typeof e[0]){for(var t=[],r=0,i=e;r<i.length;r++){var o=i[r];t.push(this.toGeoJSONCoordinates(o))}return t}return this._i().map.getGeoCoord(e)},e}();ui.prototype.clearObjectSelection=ui.prototype.clearFeatureSelection;var ci={dragPlane:"XY"},hi=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.behavior=function(e,t){var r=ie.private(this,"b")||s({},ci);switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];break;case 2:var i={};i[e]=t,e=i}r=s(s({},r),e),e.dragPlane?delete r.dragAxis:e.dragAxis&&delete r.dragPlane,this.__.b=r},t}(yt);hi.prototype.class="MARKER";var fi=function(e){function t(t,r){return e.call(this,t,r)||this}return n(t,e),t.prototype.coord=function(t){return e.prototype.coord.call(this,t)},t.prototype.getBBox=function(){var e=this.geometry.coordinates;return[e[0],e[1],e[0],e[1]]},t.prototype.getLink=function(){var e,t=Ne.getRoutingData(this);if(t.link){var r=Ne.getRoutingProvider(this);e=r&&r.search(t.link)}return e||null},t}(hi),vi=function(e){function r(t,r){return e.call(this,t,r)||this}return n(r,e),r.prototype.createRoutingPoint=function(){var e=this;Ne.getRoutingData(e).link||(Ne.connect(e),Ne.getRoutingData(e).link&&Ne.markAsModified(e))},r.prototype.removeRoutingPoint=function(){var e=this;Ne.getRoutingData(e).link&&(Ne.disconnect(e),Ne.markAsModified(e))},r.prototype.prop=function(e,r){var i=this,o=arguments.length,n=i.getProvider().getFeatureProperties(i),s=!1;if(!o||1==o&&"string"==typeof e)return null!=(e=e?n[e]:n)&&"object"==typeof e?t.JSUtils.extend(!0,new e.constructor,e):e;if(2==o){var a={};a[e]=arguments[1],e=a}for(var p in e){var l=e[p],d="object"==typeof l,u=n[p];(d&&JSON.stringify(l)!=JSON.stringify(u)||!d&&u!==l)&&(s||(i._e().objects.history.origin(i),s=!0),n[p]=l)}Ne.getRoutingData(i).link?Ne.connect(i,null):Ne.disconnect(i),s&&(i._e().setStyle(i),Ne.markAsModified(i))},r}(fi);vi.prototype.class="PLACE";var gi,yi=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return n(r,e),r.prototype.prop=function(e,r){var i=this,o=!1,n=arguments.length,s=i.getProvider().getFeatureProperties(i);if(!n||1==n&&"string"==typeof e)return null!=(e=e?s[e]:s)&&"object"==typeof e?t.JSUtils.extend(!0,new e.constructor,e):e;if(2==n){var a={};a[e]=arguments[1],e=a}for(var p in e){var l=e[p],d="object"==typeof l,u=s[p];(d&&JSON.stringify(l)!=JSON.stringify(u)||!d&&u!==l)&&(o||(i._e().objects.history.origin(i),o=!0),s[p]=l)}Ne.connect(i,null),o&&(i._e().setStyle(i),Ne.markAsModified(i))},r}(fi);yi.prototype.class="ADDRESS",function(e){e.CROSSING="CROSSING",e.CROSSING_CANDIDATE="CROSSING_CANDIDATE"}(gi||(gi={}));var Ai,mi="#FFFFFF",Si="#FF0000",_i={zIndex:0,type:"Line",stroke:Si,strokeWidth:22,strokeLinecap:"round",opacity:.5},Li={zIndex:1,type:"Line",stroke:mi,strokeWidth:18,strokeLinecap:"round",opacity:.8},bi={zIndex:2,type:"Line",stroke:"#000000",strokeWidth:14,strokeLinecap:"round",opacity:.8},ki={zIndex:3,type:"Circle",stroke:Si,strokeWidth:1,opacity:.5,radius:12,fill:Si},xi={zIndex:4,type:"Circle",stroke:mi,strokeWidth:2,opacity:1,radius:10,fill:mi},Ei={zIndex:5,type:"Circle",stroke:mi,radius:3,fill:mi};function Ci(e,t){for(var r=e.coord(),i=0;i<r.length;i++)if(t[0]==r[i][0]&&t[1]==r[i][1])return i;return L(r,t)}var Pi,Ii=function(){function e(e,t,r,i,o){this.type="Feature";var n=e.iEditor,s=o||i,a=[(s[0]-i[0])/2+i[0],(s[1]-i[1])/2+i[1]],p=n.map.getPixelCoord(a);this._={iEditor:n,xTester:e,link:t,candidate:r,searchPnt:i,foundPnt:o},this.x=p[0],this.y=p[1];var l=!!o;o=o||i;var d=n.display.geoToPixel(i[0],i[1]),u=n.display.geoToPixel(o[0],o[1]);this.distance=w([d.x,d.y],[u.x,u.y]),this.class=l?gi.CROSSING_CANDIDATE:gi.CROSSING,this.type="Feature",this.geometry=l?{type:"LineString",coordinates:[i,o]}:{type:"Point",coordinates:a}}return e.prototype.getLinkIndex=function(){var e=this._;return Ci(e.link,e.searchPnt)},e.prototype.getCandidateIndex=function(){var e=this._;return Ci(e.candidate,e.foundPnt||e.searchPnt)},e.prototype.getRelatedLink=function(){return this._.candidate},e.prototype.connect=function(){var e=this.getRelatedLink(),t=this._,r=t.iEditor,i=t.xTester,o=this.getLink();if(!e.id||!o.id||e.editState("removed")||e.editState("modified")>i.createTS||o.editState("removed")||o.editState("modified")>i.createTS)return!1;var n,s,a=this.class==gi.CROSSING_CANDIDATE,p=this.getCandidateIndex(),l=(t.foundPnt||t.searchPnt).slice(),d=[];(a||(s=ot.addShp(o,r.map.clipGeoCoord(l),null,!0)),n=a?this.getLinkIndex():s,!1!==this.getLinkIndex())&&(a&&o.getConnectedLinks(n).forEach((function(e){ot.markAsModified(e,!1,!1)})),(ot.connectShpToLink(o,n,e,r.map.clipGeoCoord(l),"number"==typeof p?p:Ai).splittedInto||[]).forEach((function(e){null!=e&&d.push(e)})));for(var u in this.hide(),this)"type"!==u&&(this[u]=Ai);return i.getCrossings({links:d,croLink:o})},e.prototype.show=function(){var e=this,t=e._,r=t.iEditor,i=t.xTester,o=r.objects.overlay,n=t.foundPnt||t.searchPnt,a=t.set=t.set||function(t,n,a,p){var l=i.getStyle(),d=r.getStyle(a)[0].stroke,u=r.getStyle(p)[0].stroke,c=function(e){return o.addPath([t,n],e)},h=function(e,t){return o.addCircle(e,t)},f=function(t){return r.listeners.trigger(t,e)},v=r.getStyleProperty(a,"altitude");if(d&&u){var g=[c(s(s(s({},_i),l.connector1),{altitude:v})),c(s(s(s({},Li),l.connector2),{altitude:v})),c(s(s(s({},bi),l.connector3),{altitude:v})),h(t,s(s(s({},ki),l.search1),{altitude:v})),h(t,s(s(s(s({},xi),{fill:d}),l.search2),{altitude:v})),h(n,s(s(s(s({},Ei),{fill:u,stroke:u}),l.found),{altitude:v}))];return g.forEach((function(e){return e.pointerup=f})),g}}(t.searchPnt,n,this.getLink(),this.getRelatedLink());r.objects.overlay.showFeature(a)},e.prototype.hide=function(){var e=this._,t=e.set;t&&t.forEach((function(e){e._provider.removeFeature(e)})),e.set=null},e.prototype.getLink=function(){return this._.link},e.prototype.getConnectedLinks=function(){return this.class==gi.CROSSING_CANDIDATE?this.getLink().getConnectedLinks(this.getLinkIndex()):[]},e}();var Ri,wi="CROSSING",Oi="CROSSING_CANDIDATE",Ni=function(){function e(e,t){this.foundCrossings=[],this.simpleCrossings=[],this.iEditor=e,this.setRelatedLink(t)}return e.prototype.clear=function(){var e=this.foundCrossings,t=this.simpleCrossings;t.forEach((function(e){e.hide&&e.hide()})),e.length=0,t.length=0,this.createTS=0},e.prototype.checkRealCrossing=function(e,t){var r=this,i=[],o=e._e().getStyleProperty(e,"altitude")?void 0:0,n=function(e,t){for(var r=[],i="number"==typeof t,o=0,n=e;o<n.length;o++){var s=n[o],a=i?t:s[2]||0;r[r.length]=[s[0],s[1],a]}return r},s=n(e.geometry.coordinates,o),a=function(t,i){for(var a=!1,p=[],l=function(e,t){for(var r=[],i=0;i<e.length-1;i++)for(var o=0;o<t.length-1;o++){var n=b(e[i],e[i+1],t[o],t[o+1]);n.intersects&&n.onSegment&&r.push({point:n.p0,s1:i+1,s2:o+1})}return r}(s,n(t.geometry.coordinates,o)),d=0,u=0,c=l.length;d<c-1;u=++d)for(var h=l[d],f=h.point,v=void 0;++u<c;){var g=(v=l[u]).point;f[0]==g[0]&&f[1]==g[1]&&Math.abs(v.s1-h.s1)<=1&&Math.abs(v.s2-h.s2)<=1&&(l.splice(u--,1),c--)}for(d=0;d<l.length;d++){f=l[d].point;a=!1;for(var y=0,A=void 0;y<i.length;y++)if((A=i[y]).link.id==t.id&&ot.isIntersection(r.iEditor,f,A.link.coord()[A.index],!o)){a=!0;break}a||p.push(new Ii(r,e,t,f))}return p};if(!e.editState("removed")){var p=e.getConnectedLinks(0,!0).concat(e.getConnectedLinks(s.length-1,!0));t.forEach((function(e){i=i.concat(a(e,p))}))}return i},e.prototype.getNearestLineCandidate=function(e,t,r,i){if(i===Pi){i=[e.id];var o=e.getConnectedLinks(t,!0);for(var n in o)i.push(o[n].link.id)}var s=e.coord(),a=this.iEditor.objects.getNearestLine(s[t],r,{ignore:function(e){return-1!=i.indexOf(e.id)},maxDistance:this.maxDistance});if(null!=a&&function(e,t){for(var r in e)if(-1!=t.indexOf(e[r].link.id))return!0;return!1}(a.line.getConnectedLinks(a.shpIndex,!0),i))return i.push(a.line.id),this.getNearestLineCandidate(e,t,r,i);return a},e.prototype.calculateCrossings=function(e,r){var i,o=this,n=[];return this.createTS=+new Date,(Array.isArray(e)?e:[e]).forEach((function(e){if(!(e.editState("removed")||r&&r!=wi&&r!=Oi)){var s=t.geotools.extendBBox(e.getBBox(),o.maxDistance),a=o.iEditor.objects.getInBBox(s,e.getProvider()),p=a.indexOf(e);-1!=p&&a.splice(p,1),r!=Oi&&(n=n.concat(o.checkRealCrossing(e,a))),r!=wi&&e.coord().forEach((function(t,r){(i=o.getNearestLineCandidate(e,r,a))&&i.distance>.001&&n.push(new Ii(o,e,i.line,t,i.point))}))}})),n},e.prototype.getRelatedLink=function(){return this.linkOrig},e.prototype.getCrossings=function(e){var t=this;return e=e||{},t.setRelatedLink(Pi),e.links?e.croLink&&e.links.length&&(t.relatedLink=t.relatedLink.concat(e.links)):(t.searchType==e.class&&t.maxDistance==e.maxDistance||(t.createTS=0),t.cStyles=e.styles||{},t.searchType=e.class),t.maxDistance=e.maxDistance||t.iEditor._config.snapTolerance||3,(!t.createTS||t.linkOrig.editState("modified")>t.createTS||e.links)&&(t.clear(),t.foundCrossings=t.calculateCrossings(t.relatedLink,t.searchType)),t.getSimplifiedCrossings()},e.prototype.getSimplifiedCrossings=function(){this.simpleCrossings.length=0;for(var e=0,t=this.foundCrossings;e<t.length;e++){var r=t[e];this.simpleCrossings.push(r)}return this.simpleCrossings},e.prototype.setRelatedLink=function(e){e&&(this.linkOrig=e,this.relatedLink=[e])},e.prototype.getStyle=function(){return this.cStyles},e}(),Fi=function(e){return e.getProvider().readPedestrianOnly(e)},Ti=function(e){return e.getProvider().readDirection(e)},Mi=function(e,t,r,i){var o=Ti(r);return r.getZLevels()[i]===e.getZLevels()[t]&&("BOTH"==o||(0==i?"START_TO_END":"END_TO_START")==o)},Di="TURN_RESTRICTION_",Bi=function(){function e(e,r,i,o,n,s){var a=e.objects.overlay,p=0==n?1:o.coord().length-2,l=o.coord(),d=l[n].slice(),u=l[p].slice();ot.ignoreZ(r)&&(d[2]=0,u[2]=0);var c=_(d,u,8e-5),h=function(e,t,r,i){var o=function(e,t,r,i){return e.getProvider().readTurnRestriction({link:e,index:t},{link:r,index:i})}(e,t,r,i);return Mi(e,t,r,i)?o?"FORBIDDEN":Fi(r)?"PEDESTRIAN":"ALLOWED":"ONEWAY"}(r,i,o,n),f=a.addPath([c,d,s],null,{type:"TURN_RESTRICTION_LINE",sign:Di+h}),v=a.addImage(c,null,{type:Di+h,rotation:-t.geotools.calcBearing(d,c)});this.sign=v,this.line=f,this.overlay=a,this.to=o,this.from=r,ot.showDirection(o),a.remove(f),v.pointerenter=function(){a.addFeature(f)},v.pointerleave=function(){a.remove(f)},v.pointerup=function(){Mi(r,i,o,n)&&!Fi(o)&&(e.objects.history.ignore((function(){!function(e,t,r,i,o){t.getProvider().writeTurnRestriction(e,{index:r,link:t},{index:o,link:i})}("ALLOWED"==h,r,i,o,n)})),h="ALLOWED"==h?"FORBIDDEN":"ALLOWED",e.objects.history.saveChanges()&&(v.properties.type=Di+h,f.properties.sign=v.properties.type,e.setStyle(v),e.setStyle(f)))}}return e.prototype.hide=function(){ot.hideDirection(this.to),this.overlay.remove(this.sign),this.overlay.remove(this.line),this.sign=null,this.line=null},e}();!function(e){e.BOTH="BOTH",e.FROM_RN="START_TO_END",e.TO_RN="END_TO_START"}(Ri||(Ri={}));var ji,Gi=function(){function e(e,t){var r=this,i=e._e();this._overlay=i.objects.overlay,this._trs=[];var o=function(){r.hide(),i.listeners.remove("_clearOverlay",o)};i.listeners.add("_clearOverlay",o),this._l=e,this._i=t,this.show()}return e.prototype._hideOrigin=function(){this._origin&&this._overlay.remove(this._origin),this._origin=null},e.prototype._showOrigin=function(e,r){var i=e.coord(),o=0==r?1:i.length-2,n=i[r],s=i[o];ot.ignoreZ(e)&&(n=[n[0],n[1],0],s=[s[0],s[1],0]);var a={geometry:{coordinates:_(n,s,1e-4),type:"Point"},type:"Feature",properties:{type:"TURN_RESTRICTION_START",rotation:-t.geotools.calcBearing(n,s)}};this._origin=this._overlay.addFeature(a)},e.prototype.show=function(){var e=this,t=this._l,r=this._i,i=Ti(t),o=0==r?Ri.FROM_RN:Ri.TO_RN;if(!(i!=Ri.BOTH&&o==i||Fi(t))){var n=t.getConnectedLinks(r,!0);n.length&&this._showOrigin(t,r),this._trs=n.map((function(i){return new Bi(t._e(),t,r,i.link,i.index,e._origin.geometry.coordinates)}))}},e.prototype.hide=function(){var e=this._trs;for(var t in e)e[t].hide(),e[t]=null;e.length=0,this._hideOrigin()},e.prototype.isActive=function(){return this._trs.length>0},e}(),zi=function(){function e(e,r,i,o){var n=r.coord(),s="END_TO_START"==i?180:0,a=[];o||a.push(e.addPoint(n[0].slice(),{type:"NAVLINK_DIRECTION_HINT_A"}),e.addPoint(n[n.length-1].slice(),{type:"NAVLINK_DIRECTION_HINT_B"}));for(var p=0;p<n.length-1;p++){var l=n[p],d=n[p+1],u={type:"BLOCKED"==i?"NAVLINK_DIRECTION_HINT_BLOCKED":"BOTH"==i?"NAVLINK_DIRECTION_HINT_2WAY":"NAVLINK_DIRECTION_HINT_1WAY"};"BLOCKED"!=i&&(u.bearing=s-t.geotools.calcBearing(l,d)),a.push(e.addPoint(P(l,d,.5),u))}this.overlay=e,this.points=a}return e.prototype.destroy=function(){this.overlay.remove(this.points),this.points=null},e}(),Ki=function(e){throw new Error(e)},Hi={snapCoordinates:!0},Vi=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.setGeoFence=function(e){(isNaN(e)||e<0)&&Ki("Geofence radius should be a positive Number"),t._e()._config.geoFence=+e},t}return n(r,e),r.prototype.coord=function(t){return e.prototype.coord.call(this,t)},r.prototype.checkCrossings=function(e){var t=this,r=ot.private(t),i=r.xt||new Ni(t._e(),t);return r.xt=i,i.getCrossings(e)},r.prototype.showDirectionHint=function(e,t){e={B:"BOTH",F:"START_TO_END",T:"END_TO_START",N:"BLOCKED"}[e]||e;var r=ot.private(this),i=r.dh;i&&i.destroy(),r.dh=e&&new zi(this._e().objects.overlay,this,e,t)},r.prototype.addShape=function(e,t){var r=!1,i=this._e().map.getGeoCoord(e);return i?!1!==(r=ot.addShp(this,i,t,ji,!0))&&ot.markAsModified(this):Ki("Invalid coordinate"),r},r.prototype.behavior=function(e,t){var r=ot.private(this,"b")||s({},Hi);switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];r=s(s({},r),e);break;case 2:r[e]=t}this.__.b=r},r.prototype.getConnectedLinks=function(e,t){void 0===t&&(t=!1);var r,i,o=this,n=o._e(),s=o.coord(),a=s[e],p=[],l=0==e||e==s.length-1,d=ot.ignoreZ(o);if(l)for(var u=0,c=n.objects.getInBBox(o.bbox,o.getProvider());u<c.length;u++){var h=c[u];h.id!=o.id&&"NAVLINK"==h.class&&(i=(r=h.coord()).length-1,null!=(e=ot.isIntersection(n,r[0],a,d)?0:ot.isIntersection(n,r[i],a,d)?i:null)&&p.push(t?{index:e,link:h}:h))}return p},r.prototype.getZLevels=function(e){var t=this.getProvider().readZLevels(this);return"number"==typeof e?t[e]:t.slice(0)},r.prototype.getSelectedShapes=function(){for(var e=ot.private(this,"selectedShapes"),t=this.geometry.coordinates,r=[],i=0;i<t.length;i++)r[i]=!!e[i];return r},r.prototype.setSelectedShapes=function(e){for(var t=this,r=ot.private(t,"selectedShapes"),i=t.geometry.coordinates,o=0;o<i.length;o++)r[o]=Boolean(e[o]);ot.refreshGeometry(t)},r.prototype.setZLevels=function(e){var t=this,r=t.getZLevels(),i=t._e().objects.history,o=t.geometry.coordinates.length;e instanceof Array||Ki("Invalid 'zlevel' argument given, no array"),e.length!==o&&Ki("Given 'zlevel' argument is of an invalid size, a length of "+o+" is required!"),i.origin(t);for(var n=!1,s=0,a=void 0;s<e.length;s++)(a=0^e[s])!=r[s]&&(e[s]=a,n=!0);n&&(i.ignore((function(){t.getProvider().writeZLevels(t,e)})),ot.refreshGeometry(this),ot.markAsModified(this))},r.prototype.editTurnRestrictions=function(e){var t=this,r=t.coord(),i=t._e(),o=0==e||e==r.length-1?[e]:e===ji?[0,r.length-1]:[];i.listeners.trigger("_clearOverlay");var n=o.map((function(e){return new Gi(t,e)}));return e===ji?n:n[0]},r.prototype.prop=function(e,r){var i=this,o=i._e(),n=!1,s=arguments.length,a=i.getProvider().getFeatureProperties(i);if(0==s||1==s&&"string"==typeof e){var p=e?a[e]:a;return"object"==typeof p?t.JSUtils.extend(!0,new p.constructor,p):p}var l=e;if(2==s){var d={};d[e]=arguments[1],l=d}for(var u in l){var c=l[u],h="object"==typeof c,f=a[u];(h&&JSON.stringify(c)!=JSON.stringify(f)||!h&&f!==c)&&(n||(o.objects.history.origin(i),n=!0),a[u]=c)}n&&(o.setStyle(i),i.editState("selected")&&ot.showDirection(i),ot.markAsModified(i))},r}(yt);Vi.prototype.class="NAVLINK";var Ui=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.addShape=function(e,t,r){var i=this,o=i._e().map.getGeoCoord(e),n=r;return o?((n=Ae.addCoord(i,o,n,t||0))&&(Ae.displayShapes(i),Ae.markAsModified(i)),n):(function(e){throw new Error(e)}("Invalid coordinate"),!1)},t.prototype.coord=function(t){return e.prototype.coord.call(this,t)},t.prototype.getSelectedShapes=function(){for(var e,t=this,r=Ae.private(t,"selectedShapes"),i=Ae.getCoordinates(t),o=[],n=0;n<i.length;n++){o[n]=[];for(var s=0;s<i[n].length;s++)o[n][s]=!!(null===(e=r[n])||void 0===e?void 0:e[s])}return Ae.isMultiLineString(t)?o:o[0]},t.prototype.setSelectedShapes=function(e){var t,r=this,i=Ae.private(r,"selectedShapes"),o=Ae.getCoordinates(r);Array.isArray(null==e?void 0:e[0])||(e=[e]);for(var n=0;n<o.length;n++){i[n]||(i[n]=[]);for(var s=0;s<o[n].length;s++)i[n][s]=Boolean(null===(t=null==e?void 0:e[n])||void 0===t?void 0:t[s])}Ae.displayShapes(r)},t}(yt);Ui.prototype.class="LINE";var Yi=function(e){throw new Error(e)},Zi={snapCoordinates:!0},Ji=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.addShape=function(e,t,r){var i=!1,o=this._e().map.getGeoCoord(e);return e?(1==arguments.length&&(t=ie.getPoly(this,o)),!1!==(i=ie.addShp(this,o,0^t,0,r))&&ie.markAsModified(this)):Yi("Invalid coordinate"),i},t.prototype.addHole=function(e){var t=this;if(e){e=this._e().map.getPixelCoord(e);for(var r=this,i=ie.getPoly(r,e),o=ie.getCoords(r),n=o[i],s=1/0,a=0;a<n.length;a++){var p=ie.getMaxSpace(r,e,n[a]);p<s&&(s=p)}if(s!=1/0&&(s=Math.floor(.5*s))>8){var l=e[0],d=e[1],u=[[l-s,d+s],[l+s,d+s],[l+s,d-s],[l-s,d-s],[l-s,d+s]].map((function(e){return t._e().map.getGeoCoord(e)}));return ie.isClockwise(n[0])||u.reverse(),n.push(u),ie._setCoords(r,o,!0),ie.markAsModified(r),!0}return!1}},t.prototype.behavior=function(e,t){var r=ie.private(this,"b")||s({},Zi);switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];r=s(s({},r),e);break;case 2:r[e]=t}this.__.b=r},t.prototype.coord=function(t){return e.prototype.coord.call(this,t)},t}(yt);Ji.prototype.class="AREA";var Wi,Qi={};Qi.NAVLINK="Navlink",Qi.AREA="Area",Qi.PLACE="Place",Qi.ADDRESS="Address",Qi.MARKER="Marker",Qi.LINE="Line";for(var Xi=function(){function e(e){var r=function(e){if("number"==typeof(e.x!=Wi?e.x:e.longitude!=Wi?e.longitude:e[0]))return e;for(var t=[],i=0,o=e;i<o.length;i++){var n=o[i];t[t.length]=r(n)}return t};function i(i,o,n){var s=this;"number"!=typeof i&&"string"!=typeof i?(n=o,o=i):s.id=i,s.type="Feature",s.class=e,s.properties=t.JSUtils.extend({"@ns:com:here:editor":new ht},n||{}),s.geometry={type:"PLACE"==e||"ADDRESS"==e||"MARKER"==e?"Point":"AREA"==e?"MultiPolygon":"LineString",coordinates:r(o)}}return i.prototype=yt.prototype,i}var r={};for(var i in Qi)r[Qi[i]]=e(i);return r}(),qi="here.xyz.maps.editor".split("."),$i=t.global,eo=0;eo<qi.length-1;eo++)$i=$i[qi[eo]]=$i[qi[eo]]||{};var to=$i[qi.pop()]={Editor:ui,features:Xi,PixelCoordinate:function(e,t,r){this.x=e,this.y=t,this.z=r||0},GeoCoordinate:function(e,t,r){this.longitude=e,this.latitude=t,this.z=r||0}};t.global.here.xyz.maps.providers.EditableFeatureProvider.prototype.getFeatureClass=function(e){switch(this.detectFeatureClass(e)){case"NAVLINK":return Vi;case"PLACE":return vi;case"ADDRESS":return yi;case"AREA":return Ji;case"MARKER":return hi;case"LINE":return Ui;default:return this.Feature}},e.Address=yi,e.Area=Ji,e.AreaShape=K,e.Crossing=Ii,e.DefaultEditorProperties=ht,e.DrawingBoard=Ot,e.DrawingShape=_t,e.Editor=ui,e.EditorEvent=mt,e.Feature=yt,e.Line=Ui,e.LineShape=ae,e.Marker=hi,e.Navlink=Vi,e.NavlinkShape=Ve,e.Place=vi,e.RangeSelector=Zt,e.default=to,e.defaultBehavior=oe,e.features=Xi,Object.defineProperty(e,"__esModule",{value:!0})}));
